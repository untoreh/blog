<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/main.css"> <link rel=stylesheet  href="/css/menu.css"> <link rel=stylesheet  href="/css/pages.css"> <link rel=stylesheet  href="/css/footer.css"> <link rel=stylesheet  href="/css/responsive.css"> <link rel=stylesheet  href="/css/animations.css"> <link rel=icon  href="/assets/favicon.png"> <!--[if IE ]> <![endif]--> <title>Alpine</title> <!DOCTYPE html> <title></title> <body onload="toggle_theme();" class=""> <div class=masthead > <div class=masthead__inner-wrap > <div class=masthead__menu > <a class=site-title  href="/"></a> <div itemscope class=author__wrap  itemtype= "https://schema.org/Person"> <ul> <li onclick="toggle_theme()" class=author__avatar ><img class=flip-front  src= "/assets/appa.png" alt=untoreh-light  itemprop=image > <li class=author__content > <h3 class=author__name  itemprop=name >untoreh</h3> <p class="author__bio .hvr-bubble-float-top" itemprop=description >I am Francesco Giannelli. The website «unto.re» is the place where I put stuff I should remember...or forget. Located in south italy. Born in the early nineties.</p> <li class="author__urls social-icons"> <a href="https://twitter.com/untoreh" rel= "nofollow noopener noreferrer"><i class= "fab fa-fw fa-twitter-square" aria-hidden=true ></i></a> <li class="author__urls social-icons"> <a href="https://github.com/untoreh" rel= "nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden=true ></i></a> <li class="author__urls social-icons"> <a href="mailto:contact@unto.re"><i class= "fas fa-envelope"></i></a> <li itemprop=homeLocation  itemscope itemtype= "https://schema.org/Place" class="author__place hvr-buzz-out"> <div class="author__bio .hvr-bubble-float-top" itemprop=description >I am Francesco Giannelli. The website «unto.re» is the place where I put stuff I should remember...or forget. Located in south italy. Born in the early nineties.</div> <a rel="nofollow noopener noreferrer" href="https://goo.gl/maps/E3Si7WzG4LX7wpNJ6" target=_blank ><i class= "fas fa-fw fa-map-marker-alt" aria-hidden=true ></i><span itemprop=name >italy</span></a> </ul> </div> <nav id=site-nav > <div class=horiz > <ul> <li class="masthead__menu-item hvr-outline-in"> <a href="/posts/"><i class="fas fa-pen menu-icons"></i>posts</a> <li class="masthead__menu-item hvr-outline-in"> <a href="/tag/lightbulbs/"><i class="fas fa-lightbulb menu-icons"></i>bulbs</a> <li class="masthead__menu-item hvr-outline-in"> <a href="/reads/"><i class="fas fa-book menu-icons"></i>reads</a> <li class="masthead__menu-item hvr-outline-in"> <a href="/tag/about/"><i class="fas fa-wrench menu-icons"></i>about</a> </ul> </div><button class=ham ><i class= "fas fa-bars ham-icon"></i></button> <div class=vert > <ul> <li class="masthead__menu-item hvr-outline-in"> <a href="/posts/"><i class="fas fa-pen menu-icons"></i>posts</a> <li class="masthead__menu-item hvr-outline-in"> <a href="/tag/lightbulbs/"><i class="fas fa-lightbulb menu-icons"></i>bulbs</a> <li class="masthead__menu-item hvr-outline-in"> <a href="/reads/"><i class="fas fa-book menu-icons"></i>reads</a> <li class="masthead__menu-item hvr-outline-in"> <a href="/tag/about/"><i class="fas fa-wrench menu-icons"></i>about</a> </ul> </div> </nav> </div> </div> </div> <div> <h1 id=title ><a href="">Alpine</a></h1> <blockquote id=page-description  style="font-style: italic;"> Pine, Alpine linux based on OSTree </blockquote> </div> <div class=franklin-content > <p>Choosing what <a href="https://en.wikipedia.org/wiki/Operating_system">OS</a> runs on your servers is a matter of convenience and familiarity. Convenience means you want something that gives you as less troubles as possible, familiarity means that you would prefer <em>not</em> to learn additional things if you don&#39;t have to.</p> <p>My servers are <a href="https://devops.stackexchange.com/questions/653/what-is-the-definition-of-cattle-not-pets">pets</a> so I am ok manually issuing a few commands every once in a while, and don&#39;t require complete automation.</p> <p>After trying out <a href="https://en.wikipedia.org/wiki/Container_Linux">CoreOS</a> for a year I switched to my own simplified <a href="https://en.wikipedia.org/wiki/Linux_distribution">distro</a> based on alpine and <a href="https://en.wikipedia.org/wiki/OSTree">ostree</a>.</p> <h2 id=goals ><a href="#goals" class=header-anchor >Goals</a></h2> <p>This version of alpine takes cues from <a href="https://kinvolk.io/flatcar-container-linux/">flatcar</a> and <a href="https://www.projectatomic.io/">project-atomic</a> and is supposed to be installed as a read-only root file-system with updates happening atomically, that is, either they succeed or the system swaps back to the previous state. For this to be possible to system has to always have at least <strong>two snapshots</strong> of the released file-system version, available on storage.</p> <h2 id=targets ><a href="#targets" class=header-anchor >Targets</a></h2> <p>In what environments will the system run? I targeted <a href="https://en.wikipedia.org/wiki/OpenVZ">OVZ</a> and &#91;KVM&#93;, but in general you can say <em>containers</em> and <em>virtual machines</em> with the main difference being that containers don&#39;t run their own kernel, in particular they don&#39;t have a boot process, they call directly into the <em>init</em> system &#40;which for example in a <code><a href="https://en.wikipedia.org/wiki/Docker_&#40;software&#41;">Dockerfile</a></code> it would be defined by the <code>CMD</code> or <code>ENTRYPOINT</code> statements&#41;, which is responsible to manage the tree of prcesses that will keep the container running &#40;just like a normal session, if the init process dies, the container terminates&#41;. Also containers can&#39;t configure system knobs, and can have additional restrictions on capabilities.</p> <h2 id=bisecting_the_build_process ><a href="#bisecting_the_build_process" class=header-anchor >Bisecting the build process</a></h2> <p>How is the image built?</p> <h3 id=dependencies ><a href="#dependencies" class=header-anchor >Dependencies</a></h3> <p>The <code>prepare.sh</code> script handles dependencies, most of which are the packages to offer common cli tools like <code>coreutils</code>, <code>util-linux</code>, <code>binutils</code>, utilities to operate with block devices like <code>blkid</code>, <code>sfdisk</code>, <code>multipath-tools</code> and file systems with <code>xfsprogs</code> and <code>e2fsprogs</code>. The <code>squashfs-tools</code> package is used at the end to compress the built root file system. A <code>glib</code> compatibility package is also installed by default because alpine is based on <code><a href="https://musl.libc.org/">musl</a></code>, the compatibility package works by providing some libraries built against .</p> <h3 id=the_tree ><a href="#the_tree" class=header-anchor >The tree</a></h3> <p>File trees for both VMs and containers are build with respectively <code>make.sh</code> and <code>make_ovz.sh</code>. This is a simplified description of the steps</p> <ul> <li><p>set the version to be built according to repository tag</p> <li><p>create a directory for the new tree and clear the environment</p> <li><p>create base target directories and directories required by ostree, like <code>sysroot</code></p> <li><p>create symlinks to conform with the <a href="https://www.freedesktop.org/software/systemd/man/file-hierarchy.html">filesystem hierarchy standard</a></p> <li><p>copy custom services and custom configs</p> <li><p>setup chroot with mounted system directories</p> <li><p>bootstrap an alpine rootfs with base packages</p> <li><p>apply minimal configuration to the rootfs like credentials, timezone, hostname.</p> <li><p>copy services to be started by init</p> <li><p>setup the boot configuration with the specified kernel image</p> <li><p>optionally add custom kernel modules</p> <li><p>perform cleanups</p> <li><p>commit the rootfs <sup id="fnref:rootfs"><a href="#fndef:rootfs" class=fnref >[1]</a></sup> to the ostree repository</p> </ul> <p>For containers, the sequence is the same, but configuration changes, because with a system not booted from a <a href="https://en.wikipedia.org/wiki/Bootloader">bootloader</a> ostree has troubles verifying the environment, we have to apply some <a href="https://github.com/untoreh/pine/blob/e65f12be70fd91edfd935e3ae9854c7be555ec73/make_ovz.sh#L73">workarounds</a> and setup some devices which are usually handled by the <a href="https://en.wikipedia.org/wiki/Initial_ramdisk">initramfs</a> step. This is how <a href="https://en.wikipedia.org/wiki/OpenVZ">OVZ</a> or <a href="https://en.wikipedia.org/wiki/LXC">LXC</a> templates are configured.</p> <h3 id=packaging ><a href="#packaging" class=header-anchor >Packaging</a></h3> <p>Once we have our ostree committed files tree <code>build.sh</code> or <code>build-update.sh</code> takes care of producing the artifact that will be distributed. The difference between the scripts is that the update version starts from a previous ostree repository, and <em>also</em> produces a delta artifact that a running system can apply on its ostree instance to perform upgrades. This is a simplified description of the build steps</p> <ul> <li><p>if new build</p> <ul> <li><p>create new partitions on a new image mounted as a loop device</p> </ul> <li><p>else</p> <ul> <li><p>mount sysroot and boot partitions of previous build</p> </ul> <li><p>clean up previous ostree deployments &#40;link farms&#41; on mounted build</p> <li><p>commit new built tree on mounted build</p> <li><p>verify integrity and checksums</p> <li><p>create new delta for upgrades</p> <li><p>execute ostree deployment to regenerate boot configuration</p> <li><p>remove old ostree commits</p> <li><p>verify boot partition integrity</p> <li><p>unmount new updated build image</p> <li><p>generate image checksum and compress it &#40;with <code>squashfs</code> for containers&#41;</p> </ul> <p>The partitions configuration is applied with a fdisk <code>layout.cfg</code> file which defines the partition sizes, we have one partition for the rootfs &#40;<code>~430M</code>&#41;, the boot partition &#40;<code>~40M</code>&#41; and a swap partition &#40;<code>~40M</code>&#41;. With containers with just skip mounting the previous build over a loop device, and just pull the new ostree commit over the old &#40;extracted&#41; ostree repository.</p> <h2 id=customizations ><a href="#customizations" class=header-anchor >Customizations</a></h2> <p>What am I bundling in this image &#40;apart from installed packages&#41;?</p> <ul> <li><p>A small lib in <code>functions.sh</code> for common tasks executed within the shell</p> <li><p>ostree based upgrade scripts with locking mechanism based on KV store</p> <li><p>monitoring scripts for IO both local &#40;<code>iomon</code>&#41; and network &#40;<code>tcpmon</code>&#41;</p> <li><p>setup scripts for container runtimes other than <code>bubblewrap</code>: <code>podman</code>, <code>toolbox</code></p> </ul> <p>What used to be and isn&#39;t anymore</p> <ul> <li><p><code>sup</code>: <a href="https://github.com/pressly/sup/">Sup</a> was used for orchestration &#40;deploy containers&#41; and configuration of the host machine, but then I switched to <a href="https://www.ansible.com/">ansible</a> because there were long standing bugs in sup that were lacking a fix, I did not choose ansible from the start because I didn&#39;t want a python dependency to install on every server, eventually I settled with a secondary alpine <a href="https://en.wikipedia.org/wiki/Chroot">chroot</a> on the host machines, located in <code>/opt/alp</code> were I install additional less critical software. Today, however, I would again switch from ansible to <a href="https://github.com/Fizzadar/pyinfra">pyinfra</a>, because</p> <ul> <li><p>it is python without boilerplate &#40;ansible has pseudo <code>DSL</code> that causes more headaches than the ones it solves&#41;</p> <li><p>it executes its recipes with plain ssh commands, so there isn&#39;t a python dependency requirement on target hosts</p> </ul> <li><p><code>containerpilot</code>: The use case for container pilot is to manage complex dependencies between containers without shell scripts...it stopped getting updates from <a href="https://github.com/joyent/containerpilot">joyent</a> and was put in maintenance mode, I also didn&#39;t like the memory requirements and memory usage would happen to constantly increase for long period of uptime. I switched it for simple shell scripts with <a href="https://www.consul.io/">consul</a>, I might look into more proper alternatives if shell scripts start to grow too much. Heavier solutions like <a href="https://kubernetes.io/">kubernetes</a>, <a href="https://docs.docker.com/engine/swarm/">swarm</a> or <a href="https://www.nomadproject.io/">nomad</a> were discarded from the get-go.</p> <li><p><code>beegfs</code>: I used to ship the kernel module necessary for <a href="https://en.wikipedia.org/wiki/BeeGFS">beegfs</a> but after a while it broke compatibility, and the fact that there wasn&#39;t a properly supported <a href="https://en.wikipedia.org/wiki/Filesystem_in_Userspace">fuse</a> module made be drop it altogether, I am currently not running a &#91;DFS&#93; on my servers, but the possibility of having a ready to go file-system to plug in a network is still appealing.</p> <li><p></p> </ul> <h2 id=installation ><a href="#installation" class=header-anchor >Installation</a></h2> <p>To install the image you can either upload it to the hosting provider and install from VNC, in case of virtual machines, but I usually hijack an existing installation, because it is always possible, well as long I have tested the setup script against version of the linux distribution, generally I use debian-8 or ubuntu-14, haven&#39;t tested other ones since these I have always found these to be available. The setup steps follows</p> <ul> <li><p>ensure https support for downloads</p> <li><p>download a busybox version</p> <li><p>install a busybox link-farm</p> <li><p>determine ipv4/ipv6 addresses for network config</p> <li><p>ensure chroot capabilities</p> <li><p>download the pine image and extract it</p> <li><p>if VM</p> <ul> <li><p>flash over target device</p> <li><p>mount over a loop device</p> </ul> <li><p>write the local network configuration over the <em>to be flashed</em> rootfs</p> <li><p>if container</p> <ul> <li><p>copy the init service &#40;for containers&#41; over the main root mount point <code>/sbin/init</code></p> </ul> <li><p>if VM</p> <ul> <li><p>partition the left over disk with standard &#40;<code>xfs</code>&#41; partitions</p> <li><p>unmount</p> <li><p>verify partitions integrity</p> </ul> <li><p>reboot</p> </ul> <h2 id=conclusions ><a href="#conclusions" class=header-anchor >Conclusions</a></h2> <p>I made <a href="https://github.com/untoreh/pine">pine</a> 5 years from time of writing and I am still using it, and I see no reasons to switch to anything else. Alpine as a linux distro is great, simple, and I have never experienced breakage. I can easily deploy on <a href="https://en.wikipedia.org/wiki/Network_address_translation">NATed</a> servers which tend to offer ultra-low resources, actually I have a box running with just <code>64M</code> of RAM, and still have all the features I need.</p> <p><table class=fndef  id="fndef:rootfs"> <tr> <td class=fndef-backref ><a href="#fnref:rootfs">[1]</a> <td class=fndef-content >root file system </table> </p> <div class=page-foot > <div class=copyright > edited: May 24, 2021 </div> </div> </div><div class=page__footer > <footer> <div class=page__footer-copyright > © untoreh - Powered by <a href= "https://github.com/tlienart/Franklin.jl">Franklin</a> </div> <div class=page__footer-links > - <ul> <li> <a href="/sitemap.xml">Sitemap</a> | <li> <a href="/tag">Tags</a> | <li> <a href="/feed.xml">RSS</a> </ul> </div> <ul class=author__wrap > <li class="author__urls social-icons"> <a href="https://twitter.com/untoreh" rel= "nofollow noopener noreferrer"><i class= "fab fa-fw fa-twitter-square" aria-hidden=true ></i></a> <li class="author__urls social-icons"> <a href="https://github.com/untoreh" rel= "nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden=true ></i></a> <li class="author__urls social-icons"> <a href="mailto:contact@unto.re"><i class= "fas fa-envelope"></i></a> <li itemprop=homeLocation  itemscope itemtype= "https://schema.org/Place" class="author__place hvr-buzz-out"> <div class="author__bio .hvr-bubble-float-top" itemprop=description >I am Francesco Giannelli. The website «unto.re» is the place where I put stuff I should remember...or forget. Located in south italy. Born in the early nineties.</div> <a rel="nofollow noopener noreferrer" href="https://goo.gl/maps/E3Si7WzG4LX7wpNJ6" target=_blank ><i class= "fas fa-fw fa-map-marker-alt" aria-hidden=true ></i><span itemprop=name >italy</span></a> </ul> </footer> </div> <script defer src= "https://use.fontawesome.com/releases/v5.8.2/js/all.js" integrity= "sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH" crossorigin=anonymous ></script> <script src="/libs/colors.js"></script> <script src="/libs/menu.js"></script>