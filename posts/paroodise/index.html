<!doctype html> <html lang=en > <meta charset=UTF-8 > <script type="application/ld+json">{"copyrightHolder":"untoreh","@id":"https://unto.re","url":"https://unto.re","copyrightYear":2021,"@context":"https://schema.org/","@type":"WebSite"}</script> <script type="application/ld+json">{"audience":"cool people","url":"https://unto.re/posts/paroodise/index.html","mainContentOfPage":{"@type":"WebPageElement","cssSelector":".franklin-content"},"accessMode":["textual","visual"],"accessibilitySummary":"Visual elements are tentatively described.","author":"untoreh","description":"A small utility for live modification of file systems","mentions":[],"accessModeSufficient":{"itemListElement":["textual","visual"],"description":"text and images","@type":"itemList"},"lastReviewed":"April 08, 2021","@type":"https://schema.org/WebPage","dateCreated":"April 24, 2021","@id":"https://unto.re/posts/paroodise/index.html","dateModified":"April 08, 2021","abstract":"A small utility for live modification of file systems","headline":"Paroodise","creativeWorkStatus":"Published","availableLanguage":[{"name":"English","@type":"Language"},{"name":"German","@type":"Language"},{"name":"Italian","@type":"Language"},{"name":"Mandarin Chinese","@type":"Language"},{"name":"Spanish","@type":"Language"},{"name":"Hindi","@type":"Language"},{"name":"Arabic","@type":"Language"},{"name":"Portuguese","@type":"Language"},{"name":"Bengali","@type":"Language"},{"name":"Russian","@type":"Language"},{"name":"Japanese","@type":"Language"},{"name":"Punjabi","@type":"Language"},{"name":"Javanese","@type":"Language"},{"name":"Vietnamese","@type":"Language"},{"name":"French","@type":"Language"},{"name":"Urdu","@type":"Language"},{"name":"Turkish","@type":"Language"},{"name":"Polish","@type":"Language"},{"name":"Ukranian","@type":"Language"},{"name":"Dutch","@type":"Language"},{"name":"Greek","@type":"Language"},{"name":"Swedish","@type":"Language"},{"name":"Zulu","@type":"Language"},{"name":"Romanian","@type":"Language"},{"name":"Malay","@type":"Language"},{"name":"Korean","@type":"Language"},{"name":"Thai","@type":"Language"},{"name":"Filipino","@type":"Language"}],"keywords":["tools","hosting","about"],"datePublished":"April 24, 2021","inLanguage":"English","name":"Paroodise","identifier":"https://unto.re/posts/paroodise/index.html"}</script> <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/main.css"> <link rel=stylesheet  href="/css/menu.css"> <link rel=stylesheet  href="/css/pages.css"> <link rel=stylesheet  href="/css/lunr.css"> <link rel=stylesheet  href="/css/footer.css"> <link rel=stylesheet  href="/css/responsive.css"> <link rel=stylesheet  href="/css/animations.css"> <link rel=stylesheet  href="/css/docco.css"> <link rel=stylesheet  href="/css/flags-sprite.css"> <link rel=icon  href="/assets/favicon.png"> <!--[if IE ]> <![endif]--> <title>Paroodise</title> <script src="/libs/lunr/lunr.min.js"></script> <script src="/libs/lunr/lunr_index.js"></script> <script src="/libs/lunr/lunrclient.min.js"></script> <script src="/libs/load.js"></script> <body class=""> <div class=masthead > <div class=masthead__inner-wrap > <div class=masthead__menu > <a class=site-title  href="/"></a> <div class=author__wrap > <script type="application/ld+json">{"sameAs":["https://github.com/untoreh","https://twitter.com/untoreh"],"description":"<ul>\n<li><p><strong>Name</strong>: Francesco Giannelli</p>\n\n<li><p><strong>Website</strong>: &#91;«https://unto.re»&#93;, the place where I put stuff I should remember...or forget</p>\n\n<li><p><strong>Location</strong>: south italy {{bio_link}}</p>\n\n<li><p><strong>Year</strong>: &#39;91</p>\n\n</ul>\n","image":"/assets/appa.png","name":"untoreh","@type":"https://schema.org/Person","email":"contact@unto.re"}</script> <ul> <li onclick="toggleTheme()" class=author__avatar > <img class=flip-front  src="/assets/appa.png" alt= "untoreh-light"><li class="author__urls social-icons"> <a href="https://twitter.com/untoreh" rel= "nofollow noopener noreferrer"><i class= "fab fa-fw fa-twitter-square" aria-hidden=true ></i></a> <li class="author__urls social-icons"> <a href="https://github.com/untoreh" rel= "nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden=true ></i></a> <li class="author__urls social-icons"> <a href="mailto:contact@unto.re"><i class= "fas fa-envelope"></i></a> <li><script type="application/ld+json">{"potentialAction":{"query-input":"required maxlength=100 name=query","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":"https://unto.re/search?&q={query}"}}</script> </ul> </div> <nav id=site-nav > <div class=horiz > <ul> <li id=lunrSearch  class="masthead__menu-item hvr-outline-in"><form id=lunrSearchForm  name=lunrSearchForm > <button class=search-button  type=submit  value=Search  formaction="/search/index.html"> <i class= "fas fa-search menu-icons"></i></button> <input class=search-input  name=q  placeholder="Search&#8230;" type=text > </form> <li class="masthead__menu-item hvr-outline-in"> <a href="/posts/" title="All the articles that I have written"><i class="fas fa-pen menu-icons"></i>posts</a> <li class="masthead__menu-item hvr-outline-in"> <a href="/about/" title="Things about me, what I have read, past projects and ideas for future ones"><i class="fas fa-user-alt menu-icons"></i>about</a> <li class="masthead__menu-item hvr-outline-in menu-lang-btn" title="Change website's language"> <button class=langs-dropdown-wrapper > <i class="fas fa-language menu-icons"></i> Lang <div id=langs-dropdown-menu  class=langs-dropdown-content > <ul id=lang-list ><a class=lang-link  id=lang-ar  href="/ar/posts/paroodise"><span class="flag flag-sa"></span>Arabic</a><a class=lang-link  id=lang-bn  href="/bn/posts/paroodise"><span class="flag flag-bd"></span>Bengali</a><a class=lang-link  id=lang-nl  href="/nl/posts/paroodise"><span class="flag flag-nl"></span>Dutch</a><a class=lang-link  id=lang-en  href="/en/posts/paroodise"><span class="flag flag-gb"></span>English</a><a class=lang-link  id=lang-tl  href="/tl/posts/paroodise"><span class="flag flag-ph"></span>Filipino</a><a class=lang-link  id=lang-fr  href="/fr/posts/paroodise"><span class="flag flag-fr"></span>French</a><a class=lang-link  id=lang-de  href="/de/posts/paroodise"><span class="flag flag-de"></span>German</a><a class=lang-link  id=lang-el  href="/el/posts/paroodise"><span class="flag flag-gr"></span>Greek</a><a class=lang-link  id=lang-hi  href="/hi/posts/paroodise"><span class="flag flag-in"></span>Hindi</a><a class=lang-link  id=lang-it  href="/it/posts/paroodise"><span class="flag flag-it"></span>Italian</a><a class=lang-link  id=lang-ja  href="/ja/posts/paroodise"><span class="flag flag-jp"></span>Japanese</a><a class=lang-link  id=lang-jw  href="/jw/posts/paroodise"><span class="flag flag-id"></span>Javanese</a><a class=lang-link  id=lang-ko  href="/ko/posts/paroodise"><span class="flag flag-kr"></span>Korean</a><a class=lang-link  id=lang-ms  href="/ms/posts/paroodise"><span class="flag flag-ms"></span>Malay</a><a class=lang-link  id=lang-zh  href="/zh/posts/paroodise"><span class="flag flag-cn"></span>Mandarin Chinese</a><a class=lang-link  id=lang-pl  href="/pl/posts/paroodise"><span class="flag flag-pl"></span>Polish</a><a class=lang-link  id=lang-pt  href="/pt/posts/paroodise"><span class="flag flag-pt"></span>Portuguese</a><a class=lang-link  id=lang-pa  href="/pa/posts/paroodise"><span class="flag flag-in"></span>Punjabi</a><a class=lang-link  id=lang-ro  href="/ro/posts/paroodise"><span class="flag flag-ro"></span>Romanian</a><a class=lang-link  id=lang-ru  href="/ru/posts/paroodise"><span class="flag flag-ru"></span>Russian</a><a class=lang-link  id=lang-es  href="/es/posts/paroodise"><span class="flag flag-es"></span>Spanish</a><a class=lang-link  id=lang-sv  href="/sv/posts/paroodise"><span class="flag flag-se"></span>Swedish</a><a class=lang-link  id=lang-th  href="/th/posts/paroodise"><span class="flag flag-th"></span>Thai</a><a class=lang-link  id=lang-tr  href="/tr/posts/paroodise"><span class="flag flag-tr"></span>Turkish</a><a class=lang-link  id=lang-uk  href="/uk/posts/paroodise"><span class="flag flag-ua"></span>Ukranian</a><a class=lang-link  id=lang-ur  href="/ur/posts/paroodise"><span class="flag flag-pk"></span>Urdu</a><a class=lang-link  id=lang-vi  href="/vi/posts/paroodise"><span class="flag flag-vn"></span>Vietnamese</a><a class=lang-link  id=lang-zu  href="/zu/posts/paroodise"><span class="flag flag-za"></span>Zulu</a></ul> </div> </button> </ul> </div><button class=ham ><i class= "fas fa-bars ham-icon"></i></button> <div class=vert > <ul> <li id=lunrSearch  class="masthead__menu-item hvr-outline-in"><form id=lunrSearchForm  name=lunrSearchForm > <button class=search-button  type=submit  value=Search  formaction="/search/index.html"> <i class= "fas fa-search menu-icons"></i></button> <input class=search-input  name=q  placeholder="Search&#8230;" type=text > </form> <li class="masthead__menu-item hvr-outline-in"> <a href="/posts/" title="All the articles that I have written"><i class="fas fa-pen menu-icons"></i>posts</a> <li class="masthead__menu-item hvr-outline-in"> <a href="/about/" title="Things about me, what I have read, past projects and ideas for future ones"><i class="fas fa-user-alt menu-icons"></i>about</a> <li class="masthead__menu-item hvr-outline-in menu-lang-btn" title="Change website's language"> <button class=langs-dropdown-wrapper > <i class="fas fa-language menu-icons"></i> Lang <div id=langs-dropdown-menu  class=langs-dropdown-content > <ul id=lang-list ><a class=lang-link  id=lang-ar  href="/ar/posts/paroodise"><span class="flag flag-sa"></span>Arabic</a><a class=lang-link  id=lang-bn  href="/bn/posts/paroodise"><span class="flag flag-bd"></span>Bengali</a><a class=lang-link  id=lang-nl  href="/nl/posts/paroodise"><span class="flag flag-nl"></span>Dutch</a><a class=lang-link  id=lang-en  href="/en/posts/paroodise"><span class="flag flag-gb"></span>English</a><a class=lang-link  id=lang-tl  href="/tl/posts/paroodise"><span class="flag flag-ph"></span>Filipino</a><a class=lang-link  id=lang-fr  href="/fr/posts/paroodise"><span class="flag flag-fr"></span>French</a><a class=lang-link  id=lang-de  href="/de/posts/paroodise"><span class="flag flag-de"></span>German</a><a class=lang-link  id=lang-el  href="/el/posts/paroodise"><span class="flag flag-gr"></span>Greek</a><a class=lang-link  id=lang-hi  href="/hi/posts/paroodise"><span class="flag flag-in"></span>Hindi</a><a class=lang-link  id=lang-it  href="/it/posts/paroodise"><span class="flag flag-it"></span>Italian</a><a class=lang-link  id=lang-ja  href="/ja/posts/paroodise"><span class="flag flag-jp"></span>Japanese</a><a class=lang-link  id=lang-jw  href="/jw/posts/paroodise"><span class="flag flag-id"></span>Javanese</a><a class=lang-link  id=lang-ko  href="/ko/posts/paroodise"><span class="flag flag-kr"></span>Korean</a><a class=lang-link  id=lang-ms  href="/ms/posts/paroodise"><span class="flag flag-ms"></span>Malay</a><a class=lang-link  id=lang-zh  href="/zh/posts/paroodise"><span class="flag flag-cn"></span>Mandarin Chinese</a><a class=lang-link  id=lang-pl  href="/pl/posts/paroodise"><span class="flag flag-pl"></span>Polish</a><a class=lang-link  id=lang-pt  href="/pt/posts/paroodise"><span class="flag flag-pt"></span>Portuguese</a><a class=lang-link  id=lang-pa  href="/pa/posts/paroodise"><span class="flag flag-in"></span>Punjabi</a><a class=lang-link  id=lang-ro  href="/ro/posts/paroodise"><span class="flag flag-ro"></span>Romanian</a><a class=lang-link  id=lang-ru  href="/ru/posts/paroodise"><span class="flag flag-ru"></span>Russian</a><a class=lang-link  id=lang-es  href="/es/posts/paroodise"><span class="flag flag-es"></span>Spanish</a><a class=lang-link  id=lang-sv  href="/sv/posts/paroodise"><span class="flag flag-se"></span>Swedish</a><a class=lang-link  id=lang-th  href="/th/posts/paroodise"><span class="flag flag-th"></span>Thai</a><a class=lang-link  id=lang-tr  href="/tr/posts/paroodise"><span class="flag flag-tr"></span>Turkish</a><a class=lang-link  id=lang-uk  href="/uk/posts/paroodise"><span class="flag flag-ua"></span>Ukranian</a><a class=lang-link  id=lang-ur  href="/ur/posts/paroodise"><span class="flag flag-pk"></span>Urdu</a><a class=lang-link  id=lang-vi  href="/vi/posts/paroodise"><span class="flag flag-vn"></span>Vietnamese</a><a class=lang-link  id=lang-zu  href="/zu/posts/paroodise"><span class="flag flag-za"></span>Zulu</a></ul> </div> </button> </ul> </div> </nav> </div> </div> </div> <div> <h1 id=title ><a href="/posts/paroodise">Paroodise</a></h1> <blockquote id=page-description  style="font-style: italic;"> A small utility for live modification of file systems </blockquote> </div> <div class=franklin-content > <p>When I was first settling on what linux distribution use for my remote servers I needed a way to quickly install different root file systems on a target host, so I wrote &#91;paroodise&#93;.</p> <p>To be able to flash a booted block device you need to <em>unmount</em>. You can only unmount if you stop using it. To stop using it you need to restart your services in place, from another root file system. This is akin to what the <a href="https://en.wikipedia.org/wiki/Initial_ramdisk">initramfs</a> does when it boots a linux based OS, the kernel executes a boot image which setups the file system from where the true <a href="https://en.wikipedia.org/wiki/Init">init</a> service is launched.</p> <p>To achieve this on an <em>already running</em> system we have to be careful how we restart our processes. We can&#39;t kill ssh unless we are sure our script will run until successful.</p> <p>The whole process is much easier on non systemd based distros, since systemd hooks deeply into the linux kernel, mangling with its processes recklessly can cause kernel panics...in fact on more recent distributions that&#39;s what usually happens :&#41;</p> <p>When I wrote this mini utility it seems I didn&#39;t know stable ways to spawn processes that outlived the original ssh sessions, It should be rewritten with more consistent methods.</p> <p>The whole process consists of</p> <ul> <li><p>copying the minimal files required to re-bootstrap the file system on memory</p> <li><p>moving &#40;or recreating&#41; the kernel mount points &#40;<code>/dev</code>, <code>/proc</code>, <code>/sys</code>&#41;</p> <li><p>killing previous services spawned by the standing systemd process tree</p> <li><p>re-executing systemd unto the new pivoted file-system, <a href="https://www.freedesktop.org/software/systemd/man/systemctl.html#Manager&#37;20State&#37;20Commands"><code>systemctl daemon-reexec</code></a></p> </ul> <p>If everything completes successfully it is possible at this point to spawn a new ssh service and login into a session where the original mount points are available for modifications.</p> <p></p> <div id=post-tags-list > Post Tags: <span class=post-tag ><a href="/posts/tag/tools" style=""> tools </a>, </span> <span class=post-tag ><a href="/posts/tag/hosting" style=""> hosting </a>, </span> <span class=post-tag ><a href="/posts/tag/about" style=""> about </a></span></div> <div class=page-foot > <div class=copyright > April 08, 2021 </div> <script src="https://utteranc.es/client.js" repo="untoreh/untoreh.github.io" issue-term=pathname  label=Comment  crossorigin=anonymous  async> </script> </div> </div><div class=page__footer > <footer> <div class=page__footer-copyright > © untoreh - Powered by <a href= "https://github.com/tlienart/Franklin.jl">Franklin</a> </div> <div class=page__footer-links > - <ul> <li> <a href="/sitemap.xml">Sitemap</a> | <li> <a href="/tag">Tags</a> | <li> <a href="/feed.xml">RSS</a> </ul> </div> <ul class=author__wrap > <li class="author__urls social-icons"> <a href="https://twitter.com/untoreh" rel= "nofollow noopener noreferrer"><i class= "fab fa-fw fa-twitter-square" aria-hidden=true ></i></a> <li class="author__urls social-icons"> <a href="https://github.com/untoreh" rel= "nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden=true ></i></a> <li class="author__urls social-icons"> <a href="mailto:contact@unto.re"><i class= "fas fa-envelope"></i></a> <li><script type="application/ld+json">{"potentialAction":{"query-input":"required maxlength=100 name=query","actionStatus":"https://schema.org/PotentialActionStatus","query":"required","@type":"SearchAction","target":"https://unto.re/search?&q={query}"}}</script> </ul> </footer> </div> <script id=fa  defer src= "https://use.fontawesome.com/releases/v5.8.2/js/all.js" integrity= "sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH" crossorigin=anonymous ></script> <script src="/libs/colors.js"></script> <script src="/libs/menu.js"></script> <script defer src="/libs/lunr/lunr.min.js"></script>